<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒãƒ£ãƒƒãƒˆ - ã‚­ãƒ¥ãƒ¼ãƒ”ãƒƒã‚º</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', sans-serif;
      background: #F0F0F0;
      height: 100vh;
      overflow: hidden;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: white;
    }
    .header {
      background: linear-gradient(135deg, #E967A5 0%, #B565D8 100%);
      color: white;
      padding: 12px 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .back-button {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .fortune-teller-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .ft-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #FFD700, #FFA500);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 18px;
      overflow: hidden;
    }
    .ft-details { display: flex; flex-direction: column; }
    .ft-name { font-size: 16px; font-weight: bold; }
    .ft-points { font-size: 12px; opacity: 0.9; }
    .header-right { display: flex; gap: 8px; }
    .exit-button, .karte-button {
      background: white;
      color: #E967A5;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .chat-area {
      flex: 1;
      overflow-y: auto;
      padding: 20px 15px;
      background: #F5F5F5;
    }
    .system-message { text-align: center; margin: 20px 0; }
    .system-message-text {
      background: #E0E0E0;
      color: #666;
      padding: 8px 20px;
      border-radius: 15px;
      font-size: 13px;
      display: inline-block;
    }
    .message {
      margin-bottom: 15px;
      display: flex;
      gap: 10px;
    }
    .message.sent { flex-direction: row-reverse; }
    .message-content { max-width: 70%; }
    .message-bubble {
      background: white;
      padding: 10px 14px;
      border-radius: 15px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      word-wrap: break-word;
      line-height: 1.5;
    }
    .message-bubble.paid {
      background: #E967A5;
      color: white;
    }
    .message.sent .message-bubble {
      background: #E967A5;
      color: white;
    }
    .message.sent .message-bubble.free,
    .message .message-bubble.free {
      background: white;
      color: #333;
      border: 1px solid #E0E0E0;
    }
    .message-time {
      font-size: 11px;
      color: #999;
      margin-top: 4px;
      padding: 0 5px;
    }
    .tabs {
      background: white;
      display: flex;
      border-bottom: 1px solid #E0E0E0;
      padding: 0 15px;
    }
    .tab {
      flex: 1;
      padding: 12px 0;
      text-align: center;
      border: none;
      background: none;
      color: #999;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      position: relative;
      transition: color 0.2s;
    }
    .tab.active { color: #E967A5; }
    .tab.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: #E967A5;
    }
    .input-area {
      background: white;
      padding: 12px 15px;
      border-top: 1px solid #E0E0E0;
    }
    .input-wrapper {
      display: flex;
      gap: 10px;
      align-items: flex-end;
    }
    .input-box { flex: 1; position: relative; }
    .message-input {
      width: 100%;
      border: 1px solid #DDD;
      border-radius: 20px;
      padding: 10px 15px;
      padding-bottom: 25px;
      font-size: 14px;
      outline: none;
      resize: none;
      font-family: inherit;
      line-height: 1.5;
    }
    .message-input:focus { border-color: #E967A5; }
    .char-counter {
      position: absolute;
      bottom: 8px;
      left: 15px;
      font-size: 11px;
      color: #999;
    }
    .send-button {
      background: linear-gradient(135deg, #E967A5, #B565D8);
      color: white;
      border: none;
      width: 42px;
      height: 42px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      position: relative;
      box-shadow: 0 2px 8px rgba(233,103,165,0.3);
      transition: all 0.2s;
    }
    .send-button:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(233,103,165,0.4);
    }
    .send-button svg {
      width: 20px;
      height: 20px;
      fill: white;
      transform: rotate(45deg);
    }
    .send-button:disabled { opacity: 0.5; cursor: not-allowed; }
    .templates-area {
      background: white;
      padding: 15px;
      max-height: 300px;
      overflow-y: auto;
      display: none;
    }
    .templates-area.active { display: block; }
    .template-item {
      background: #F5F5F5;
      padding: 12px 15px;
      border-radius: 10px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 14px;
      line-height: 1.5;
    }
    .template-item:hover { background: #E8E8E8; }
    .add-template-button {
      background: #E967A5;
      color: white;
      border: none;
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: #2C2C3E;
      border-radius: 15px;
      padding: 20px;
      max-width: 400px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-header {
      color: white;
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 20px;
    }
    .template-edit-item {
      background: #3C3C4E;
      color: white;
      padding: 12px 15px;
      border-radius: 10px;
      margin-bottom: 10px;
      font-size: 14px;
      line-height: 1.5;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }
    .template-edit-text { flex: 1; cursor: pointer; }
    .template-edit-text:hover { text-decoration: underline; }
    .template-edit-buttons { display: flex; gap: 5px; }
    .template-edit-btn, .template-delete-btn {
      padding: 5px 10px;
      border: none;
      border-radius: 5px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .template-edit-btn { background: #4A90E2; color: white; }
    .template-edit-btn:hover { background: #357ABD; }
    .template-delete-btn { background: #E74C3C; color: white; }
    .template-delete-btn:hover { background: #C0392B; }
    .template-edit-item:hover { background: #4C4C5E; }
    .hidden { display: none; }
    .review-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .review-modal.active { display: flex; }
    .review-content {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 400px;
      width: 100%;
      text-align: center;
    }
    .review-title {
      font-size: 20px;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
    }
    .review-subtitle {
      font-size: 14px;
      color: #666;
      margin-bottom: 25px;
    }
    .review-comment {
      width: 100%;
      border: 1px solid #DDD;
      border-radius: 10px;
      padding: 15px;
      font-size: 14px;
      resize: vertical;
      min-height: 100px;
      margin-bottom: 20px;
      font-family: inherit;
    }
    .review-buttons { display: flex; gap: 10px; }
    .review-button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }
    .review-button.submit {
      background: linear-gradient(135deg, #E967A5, #B565D8);
      color: white;
    }
    .review-button.submit:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(233,103,165,0.4);
    }
    .review-button.skip { background: #F0F0F0; color: #666; }
    .review-button.skip:hover { background: #E0E0E0; }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="header-left">
      <button class="back-button" onclick="goBack()">â†</button>
      <div class="fortune-teller-info">
        <div class="ft-avatar" id="ftAvatar">?</div>
        <div class="ft-details">
          <div class="ft-name" id="ftName">èª­ã¿è¾¼ã¿ä¸­...</div>
          <div class="ft-points" id="userPoints">æ‰€æŒãƒã‚¤ãƒ³ãƒˆ 0pt</div>
        </div>
      </div>
    </div>
    <div class="header-right" id="headerButtons"></div>
  </div>

  <div class="chat-area" id="chatArea"></div>

  <div class="tabs" id="chatTabs">
    <button class="tab" id="freeTab" data-tab="free">ç„¡æ–™ãƒãƒ£ãƒƒãƒˆ</button>
    <button class="tab active" data-tab="paid">æœ‰æ–™ãƒãƒ£ãƒƒãƒˆ</button>
    <button class="tab" data-tab="templates">å®šå‹æ–‡ï¼ˆç„¡æ–™ï¼‰</button>
  </div>

  <div class="templates-area" id="templatesArea">
    <div class="template-item" data-text="ã”ç›¸è«‡ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚è©³ã—ããŠè©±ã‚’ä¼ºã‚ã›ã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ">
      ã”ç›¸è«‡ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚è©³ã—ããŠè©±ã‚’ä¼ºã‚ã›ã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ
    </div>
    <div class="template-item" data-text="é‘‘å®šã•ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚å°‘ã€…ãŠå¾…ã¡ãã ã•ã„ã€‚">
      é‘‘å®šã•ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚å°‘ã€…ãŠå¾…ã¡ãã ã•ã„ã€‚
    </div>
    <div class="template-item" data-text="ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚ã¾ãŸã„ã¤ã§ã‚‚ã”ç›¸è«‡ãã ã•ã„ã€‚">
      ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚ã¾ãŸã„ã¤ã§ã‚‚ã”ç›¸è«‡ãã ã•ã„ã€‚
    </div>
    <button class="add-template-button" id="editTemplatesButton">+ å®šå‹æ–‡ã‚’ç·¨é›†</button>
  </div>

  <div class="templates-area" id="clientTemplatesArea">
    <div class="template-item" data-text="ã‚ˆã‚ã—ããŠã­ãŒã„ã—ã¾ã™">ã‚ˆã‚ã—ããŠã­ãŒã„ã—ã¾ã™</div>
    <div class="template-item" data-text="ãã†ã§ã™">ãã†ã§ã™</div>
    <div class="template-item" data-text="æœ¬æ—¥ã¯ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸ">æœ¬æ—¥ã¯ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸ</div>
    <div class="template-item" data-text="ãƒã‚¤ãƒ³ãƒˆãŒè¶³ã‚Šãªã„ç‚ºã“ã‚Œã§å¤±ç¤¼ã—ã¾ã™">ãƒã‚¤ãƒ³ãƒˆãŒè¶³ã‚Šãªã„ç‚ºã“ã‚Œã§å¤±ç¤¼ã—ã¾ã™</div>
  </div>

  <div class="input-area">
    <div class="input-wrapper">
      <div class="input-box">
        <textarea
          class="message-input"
          id="messageInput"
          placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."
          rows="1"
          maxlength="500"
        ></textarea>
        <div class="char-counter" id="charCounter">0 / 500</div>
      </div>
      <button class="send-button" id="sendButton">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M3 21l18-9L3 3v7l13 2-13 2z" transform="rotate(-45 12 12)"/>
        </svg>
      </button>
    </div>
  </div>
</div>

<div class="modal" id="templateModal">
  <div class="modal-content">
    <div class="modal-header">å®šå‹æ–‡ã‚’ç·¨é›†</div>
    <div id="templateEditList">
      <div class="template-edit-item">ã”ç›¸è«‡ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚è©³ã—ããŠè©±ã‚’ä¼ºã‚ã›ã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ</div>
      <div class="template-edit-item">é‘‘å®šã•ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚å°‘ã€…ãŠå¾…ã¡ãã ã•ã„ã€‚</div>
      <div class="template-edit-item">ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚ã¾ãŸã„ã¤ã§ã‚‚ã”ç›¸è«‡ãã ã•ã„ã€‚</div>
    </div>
    <button class="add-template-button" style="margin-top: 20px;">+ å®šå‹æ–‡ã‚’è¿½åŠ </button>
  </div>
</div>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getAuth } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
  import {
    getFirestore,
    doc,
    getDoc,
    setDoc,
    collection,
    addDoc,
    query,
    where,
    onSnapshot,
    getDocs
  } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

  const firebaseConfig = {
    apiKey: "AIzaSyA52uJ31HzLkbz32lA-3WWSmhM10xYjjCg",
    authDomain: "cupids-chat.firebaseapp.com",
    projectId: "cupids-chat",
    storageBucket: "cupids-chat.firebasestorage.app",
    messagingSenderId: "44532110483",
    appId: "1:44532110483:web:d6266e8abba8582b8b6966"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  window.firebaseAuth = auth;
  window.firebaseDB = db;
  window.firebaseDoc = doc;
  window.firebaseGetDoc = getDoc;
  window.firebaseSetDoc = setDoc;
  window.firebaseCollection = collection;
  window.firebaseAddDoc = addDoc;
  window.firebaseQuery = query;
  window.firebaseWhere = where;
  window.firebaseOnSnapshot = onSnapshot;
  window.firebaseGetDocs = getDocs;

  window.firebaseReady = true;
  window.dispatchEvent(new Event('firebaseReady'));
  console.log('âœ… FirebaseåˆæœŸåŒ–å®Œäº†!');
</script>

<script>
  const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
  if (!currentUser) {
    alert('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
    window.location.href = 'cupids-login.html';
  }

  const conversationId = localStorage.getItem('selectedConversationId');
  let conversationStatus = 'not-started';
  let isBlocked = false;
  let totalPointsSpent = 0;
  let reviewModalShown = false;

  let fortuneTellerId = '';
  let fortuneTellerPrice = 10;
  let fortuneTellerName = 'å ã„å¸«';
  let fortuneTellerImageUrl = '';

  async function loadConversationStatus() {
    try {
      const collectionName = currentUser.type === 'fortune-teller' ? 'fortuneTellers' : 'users';
      const userRef = window.firebaseDoc(window.firebaseDB, collectionName, currentUser.uid);
      const userDoc = await window.firebaseGetDoc(userRef);
      if (userDoc.exists()) {
        const userData = userDoc.data();
        currentUser.points = userData.points || 0;
        document.getElementById('userPoints').textContent = 'æ‰€æŒãƒã‚¤ãƒ³ãƒˆ ' + currentUser.points + 'pt';
      }
    } catch (e) {
      console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒã‚¤ãƒ³ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', e);
    }

    if (!conversationId) {
      updateHeaderButtons();
      return;
    }

    try {
      const convRef = window.firebaseDoc(window.firebaseDB, 'conversations', conversationId);
      const convSnap = await window.firebaseGetDoc(convRef);

      if (convSnap.exists()) {
        const data = convSnap.data();

        if (currentUser.type === 'fortune-teller' && data.clientId) {
          let clientPoints = data.clientPoints;
          if (clientPoints === undefined) {
            try {
              const clientDoc = await window.firebaseGetDoc(
                window.firebaseDoc(window.firebaseDB, 'users', data.clientId)
              );
              if (clientDoc.exists()) {
                clientPoints = clientDoc.data().points || 0;
              }
            } catch (err) {
              console.error('ãŠå®¢æ§˜ãƒã‚¤ãƒ³ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', err);
              clientPoints = 0;
            }
          }
          document.getElementById('userPoints').textContent = 'æ‰€æŒãƒã‚¤ãƒ³ãƒˆ ' + clientPoints + 'pt';
          window.firebaseOnSnapshot(convRef, (doc) => {
            if (doc.exists() && currentUser.type === 'fortune-teller') {
              const convData = doc.data();
              if (convData.clientPoints !== undefined) {
                document.getElementById('userPoints').textContent =
                  'æ‰€æŒãƒã‚¤ãƒ³ãƒˆ ' + convData.clientPoints + 'pt';
              }
            }
          });
        }

        if (currentUser.type === 'client' && data.blocked) {
          isBlocked = true;
          conversationStatus = 'ended';
          alert('ãƒãƒ£ãƒƒãƒˆãŒçµ‚äº†ã—ã¾ã—ãŸã€‚\nå ã„å¸«ãŒã“ã®ä¼šè©±ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¾ã—ãŸã€‚');
          const systemMsg = document.createElement('div');
          systemMsg.className = 'system-message';
          systemMsg.innerHTML = '<div class="system-message-text">ãƒãƒ£ãƒƒãƒˆãŒçµ‚äº†ã—ã¾ã—ãŸ</div>';
          const chatArea = document.getElementById('chatArea');
          if (chatArea) chatArea.appendChild(systemMsg);
          updateHeaderButtons();
          return;
        }

        conversationStatus = data.status || 'not-started';
        totalPointsSpent = data.totalPointsSpent || 0;

        if (currentUser.type === 'client') {
          const reviewsRef = window.firebaseCollection(window.firebaseDB, 'reviews');
          const reviewQuery = window.firebaseQuery(
            reviewsRef,
            window.firebaseWhere('conversationId', '==', conversationId),
            window.firebaseWhere('clientId', '==', currentUser.uid)
          );
          const reviewSnapshot = await window.firebaseGetDocs(reviewQuery);
          reviewModalShown = !reviewSnapshot.empty;
        }
      } else {
        conversationStatus = 'not-started';
      }

      updateHeaderButtons();
      loadMessages();

    } catch (err) {
      console.error('ä¼šè©±çŠ¶æ…‹ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err);
      conversationStatus = 'not-started';
      updateHeaderButtons();
    }
  }

  function updateHeaderButtons() {
    const headerButtons = document.getElementById('headerButtons');
    headerButtons.innerHTML = '';

    if (currentUser.type === 'client' &&
        (conversationStatus === 'not-started' || conversationStatus === 'ended') &&
        !isBlocked) {
      const enterBtn = document.createElement('button');
      enterBtn.className = 'exit-button';
      enterBtn.textContent = 'å…¥å®¤';
      enterBtn.style.background = '#16a34a';
      enterBtn.style.color = 'white';
      enterBtn.onclick = handleEnterChat;
      headerButtons.appendChild(enterBtn);
    }

    if (conversationStatus === 'active') {
      const exitBtn = document.createElement('button');
      exitBtn.className = 'exit-button';
      exitBtn.textContent = 'é€€å®¤';
      exitBtn.style.background = '#dc2626';
      exitBtn.style.color = 'white';
      exitBtn.onclick = handleExitChat;
      headerButtons.appendChild(exitBtn);
    }

    const karteBtn = document.createElement('button');
    karteBtn.className = 'karte-button';
    karteBtn.textContent = 'ğŸ“‹ ã‚«ãƒ«ãƒ†';
    karteBtn.onclick = goToKarte;
    headerButtons.appendChild(karteBtn);
  }

  async function handleEnterChat() {
    if (currentUser.type === 'client' && currentUser.points < 1) {
      alert('ãƒã‚¤ãƒ³ãƒˆãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ãƒã‚¤ãƒ³ãƒˆã‚’è³¼å…¥ã—ã¦ãã ã•ã„ã€‚');
      return;
    }
    conversationStatus = 'active';
    try {
      const convRef = window.firebaseDoc(window.firebaseDB, 'conversations', conversationId);
      await window.firebaseSetDoc(convRef, {
        status: 'active',
        startedAt: new Date().toISOString()
      }, { merge: true });
    } catch (err) {
      console.error('å…¥å®¤çŠ¶æ…‹ã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:', err);
    }
    updateHeaderButtons();

    const systemMsg = document.createElement('div');
    systemMsg.className = 'system-message';
    systemMsg.innerHTML = '<div class="system-message-text">ãƒãƒ£ãƒƒãƒˆãŒé–‹å§‹ã—ã¾ã—ãŸ</div>';
    chatArea.appendChild(systemMsg);
    scrollToBottom();
    checkPointsAvailability();
  }

  async function handleExitChat() {
    if (!confirm('é€€å®¤ã™ã‚‹ã¨å ã„å¸«ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå±Šã‹ãªããªã‚Šã¾ã™ã€‚\næœ¬å½“ã«é€€å®¤ã—ã¾ã™ã‹ï¼Ÿ')) {
      return;
    }
    conversationStatus = 'ended';
    try {
      const convRef = window.firebaseDoc(window.firebaseDB, 'conversations', conversationId);
      await window.firebaseSetDoc(convRef, {
        status: 'ended',
        endedAt: new Date().toISOString()
      }, { merge: true });
    } catch (err) {
      console.error('é€€å®¤çŠ¶æ…‹ã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:', err);
    }
    updateHeaderButtons();

    const systemMsg = document.createElement('div');
    systemMsg.className = 'system-message';
    systemMsg.innerHTML = '<div class="system-message-text">ãƒãƒ£ãƒƒãƒˆãŒçµ‚äº†ã—ã¾ã—ãŸ</div>';
    chatArea.appendChild(systemMsg);
    scrollToBottom();

    if (currentUser.type === 'client') {
      setTimeout(() => { showReviewModal(); }, 500);
    }
  }

  function showReviewModal() {
    const modal = document.getElementById('reviewModal');
    const starSelect = document.getElementById('starRating');
    const commentInput = document.getElementById('reviewComment');
    starSelect.value = '5';
    commentInput.value = '';
    modal.classList.add('active');
  }
  function skipReview() {
    document.getElementById('reviewModal').classList.remove('active');
  }

  async function submitReview() {
    const starSelect = document.getElementById('starRating');
    const rating = parseInt(starSelect.value);
    if (!rating || rating < 1 || rating > 5) {
      alert('è©•ä¾¡ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }
    const comment = document.getElementById('reviewComment').value.trim();
    const modal = document.getElementById('reviewModal');

    try {
      const reviewId = `${conversationId}_${Date.now()}`;
      const reviewRef = window.firebaseDoc(window.firebaseDB, 'reviews', reviewId);
      await window.firebaseSetDoc(reviewRef, {
        reviewId,
        conversationId,
        fortuneTellerId,
        clientId: currentUser.uid,
        rating,
        comment,
        createdAt: new Date().toISOString()
      });
      await updateFortuneTellerRating(fortuneTellerId);
      const ftRef = window.firebaseDoc(window.firebaseDB, 'fortuneTellers', fortuneTellerId);
      const ftDoc = await window.firebaseGetDoc(ftRef);
      if (ftDoc.exists()) {
        const ftData = ftDoc.data();
        const existingReviews = ftData.reviews || [];
        existingReviews.push({
          id: reviewId,
          clientName: currentUser.name || 'åŒ¿å',
          rating,
          comment,
          date: new Date().toISOString(),
          visible: true
        });
        await window.firebaseSetDoc(ftRef, { reviews: existingReviews }, { merge: true });
      }
      modal.classList.remove('active');
    } catch (err) {
      console.error('ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¿å­˜ã‚¨ãƒ©ãƒ¼:', err);
      alert('ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }

  async function updateFortuneTellerRating(ftId) {
    try {
      const reviewsRef = window.firebaseCollection(window.firebaseDB, 'reviews');
      const q = window.firebaseQuery(
        reviewsRef,
        window.firebaseWhere('fortuneTellerId', '==', ftId)
      );
      const querySnapshot = await window.firebaseGetDocs(q);
      let totalRating = 0;
      let reviewCount = 0;
      querySnapshot.forEach((doc) => {
        const review = doc.data();
        totalRating += review.rating;
        reviewCount++;
      });

      const ftRef = window.firebaseDoc(window.firebaseDB, 'fortuneTellers', ftId);
      const ftDoc = await window.firebaseGetDoc(ftRef);
      const baseReviewCount = ftDoc.exists() ? (ftDoc.data().baseReviewCount || 0) : 0;
      const displayReviewCount = reviewCount + baseReviewCount;
      const averageRating = reviewCount > 0 ? (totalRating / reviewCount).toFixed(1) : 0;

      await window.firebaseSetDoc(ftRef, {
        averageRating: parseFloat(averageRating),
        totalReviews: displayReviewCount,
        actualReviewCount: reviewCount
      }, { merge: true });
    } catch (err) {
      console.error('è©•ä¾¡æ›´æ–°ã‚¨ãƒ©ãƒ¼:', err);
    }
  }

  function goToKarte() {
    if (conversationId) {
      localStorage.setItem('karteReferrer', 'chat');
      window.location.href = 'cupids-karte.html';
    } else {
      alert('ä¼šè©±IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    }
  }

  function goBack() {
    if (currentUser.type === 'fortune-teller') {
      window.location.href = 'cupids-fortune-lobby.html';
    } else {
      window.location.href = 'cupids-top.html';
    }
  }

  function initializeChat() {
    if (!window.firebaseReady) {
      window.addEventListener('firebaseReady', initializeChat, { once: true });
      return;
    }
    loadConversationStatus();
  }

  async function loadFortuneTellerInfo() {
    if (!window.firebaseDB) {
      window.addEventListener('firebaseReady', loadFortuneTellerInfo, { once: true });
      return;
    }

    const urlParams = new URLSearchParams(window.location.search);
    fortuneTellerId =
      urlParams.get('fortuneTellerId') ||
      localStorage.getItem('selectedFortuneTellerId') ||
      '';

    // â˜…ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆï¼šå ã„å¸«ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã¯è‡ªåˆ†ã®UIDã‚’ä½¿ã†
    if (!fortuneTellerId && currentUser && currentUser.type === 'fortune-teller') {
      fortuneTellerId = currentUser.uid;
      console.log('ğŸ‘¤ å ã„å¸«ãƒ­ã‚°ã‚¤ãƒ³ãªã®ã§ã€è‡ªåˆ†ã®UIDã‚’å ã„å¸«IDã¨ã—ã¦ä½¿ç”¨:', fortuneTellerId);
    }

    if (fortuneTellerId) {
      localStorage.setItem('selectedFortuneTellerId', fortuneTellerId);
    }

    if (!fortuneTellerId && currentUser.type === 'client') {
      alert('å ã„å¸«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
      window.location.href = 'cupids-top.html';
      return;
    }

    fortuneTellerName = 'å ã„å¸«';
    fortuneTellerPrice = 10;
    fortuneTellerImageUrl = '';

    try {
      if (fortuneTellerId) {
        const ftDoc = await window.firebaseGetDoc(
          window.firebaseDoc(window.firebaseDB, 'fortuneTellers', fortuneTellerId)
        );
        if (ftDoc.exists()) {
          const ftData = ftDoc.data();
          fortuneTellerName = ftData.name || ftData.displayName || 'å ã„å¸«';
          fortuneTellerPrice = ftData.pricePerChar || ftData.price || ftData.pricePerCharacter || 10;
          fortuneTellerImageUrl = ftData.photoURL || ftData.imageUrl || '';
        }
      }
    } catch (err) {
      console.error('å ã„å¸«æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
    }

    if (currentUser.type === 'fortune-teller') {
      const clientId = urlParams.get('clientId') || localStorage.getItem('selectedClientId');
      let clientName = 'ãŠå®¢æ§˜';
      let clientPoints = 0;
      if (clientId) {
        try {
          const clientDoc = await window.firebaseGetDoc(
            window.firebaseDoc(window.firebaseDB, 'users', clientId)
          );
          if (clientDoc.exists()) {
            const clientData = clientDoc.data();
            clientName = clientData.name || 'ãŠå®¢æ§˜';
            clientPoints = clientData.points || 0;
          }
        } catch (err) {
          console.error('ãŠå®¢æ§˜æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
        }
      }
      document.getElementById('ftName').textContent = clientName;
      document.getElementById('ftAvatar').textContent = clientName[0] || 'å®¢';
      document.getElementById('userPoints').textContent = 'æ‰€æŒãƒã‚¤ãƒ³ãƒˆ ' + clientPoints + 'pt';
    } else {
      document.getElementById('ftName').textContent = fortuneTellerName;
      const avatarElement = document.getElementById('ftAvatar');
      if (fortuneTellerImageUrl) {
        avatarElement.innerHTML =
          `<img src="${fortuneTellerImageUrl}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
      } else {
        avatarElement.textContent = fortuneTellerName[0] || 'å ';
      }
      document.getElementById('userPoints').textContent =
        'æ‰€æŒãƒã‚¤ãƒ³ãƒˆ ' + (currentUser.points || 0) + 'pt';
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      initializeChat();
      loadFortuneTellerInfo();
    });
  } else {
    initializeChat();
    loadFortuneTellerInfo();
  }

  if (currentUser.type === 'client') {
    const freeTab = document.getElementById('freeTab');
    if (freeTab) freeTab.style.display = 'none';
    const fortuneTellerTemplates = document.getElementById('templatesArea');
    if (fortuneTellerTemplates) fortuneTellerTemplates.remove();
  } else {
    const clientTemplates = document.getElementById('clientTemplatesArea');
    if (clientTemplates) clientTemplates.remove();
  }

  const chatArea = document.getElementById('chatArea');
  const messageInput = document.getElementById('messageInput');
  const sendButton = document.getElementById('sendButton');
  const charCounter = document.getElementById('charCounter');
  const tabs = document.querySelectorAll('.tab');
  const templatesArea =
    currentUser.type === 'client'
      ? document.getElementById('clientTemplatesArea')
      : document.getElementById('templatesArea');
  const templateItems = templatesArea.querySelectorAll('.template-item');
  const editTemplatesButton = document.getElementById('editTemplatesButton');
  const templateModal = document.getElementById('templateModal');

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');

      const tabName = tab.dataset.tab;
      if (tabName === 'templates') {
        templatesArea.classList.add('active');
        messageInput.disabled = true;
        messageInput.placeholder = 'å®šå‹æ–‡ã‚’é¸æŠã—ã¦ãã ã•ã„';
        sendButton.disabled = true;
      } else {
        templatesArea.classList.remove('active');
        messageInput.disabled = false;
        messageInput.placeholder = 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...';
        sendButton.disabled = false;
      }
      setTimeout(() => checkPointsAvailability(), 100);
    });
  });

  messageInput.addEventListener('input', () => {
    const length = messageInput.value.length;
    charCounter.textContent = `${length} / 500`;
    if (conversationId) {
      const key = `draft_message_${conversationId}`;
      if (messageInput.value.trim()) {
        localStorage.setItem(key, messageInput.value);
      } else {
        localStorage.removeItem(key);
      }
    }
    messageInput.style.height = 'auto';
    messageInput.style.height = Math.min(messageInput.scrollHeight, 100) + 'px';
  });

  function formatTimestamp(timestamp) {
    if (!timestamp) return '';
    let date;
    if (timestamp.toDate) {
      date = timestamp.toDate();
    } else if (timestamp instanceof Date) {
      date = timestamp;
    } else {
      date = new Date(timestamp);
    }
    return `${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
  }

  async function loadMessages() {
    if (!conversationId) return;
    try {
      const messagesRef = window.firebaseCollection(window.firebaseDB, 'messages');
      const q = window.firebaseQuery(
        messagesRef,
        window.firebaseWhere('conversationId', '==', conversationId)
      );
      const existingMessages = new Set();
      window.firebaseOnSnapshot(q, (snapshot) => {
        const newMessages = [];
        snapshot.docChanges().forEach((change) => {
          if (change.type === 'added') {
            const data = change.doc.data();
            const id = change.doc.id;
            if (!existingMessages.has(id)) {
              existingMessages.add(id);
              const ts = data.timestamp?.toMillis
                ? data.timestamp.toMillis()
                : new Date(data.timestamp).getTime();
              newMessages.push({ id, data, timestamp: ts });
            }
          }
        });
        newMessages.sort((a, b) => a.timestamp - b.timestamp);
        newMessages.forEach(msg => displayMessage(msg.data));
      });

      if (currentUser.type === 'client') {
        setupConversationListener();
      }
    } catch (err) {
      console.error('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err);
    }
  }

  function setupConversationListener() {
    try {
      const convRef = window.firebaseDoc(window.firebaseDB, 'conversations', conversationId);
      window.firebaseOnSnapshot(convRef, (doc) => {
        if (doc.exists()) {
          const data = doc.data();
          if (currentUser.type === 'client' && data.blocked && !isBlocked) {
            isBlocked = true;
            conversationStatus = 'ended';
            alert('ãƒãƒ£ãƒƒãƒˆãŒçµ‚äº†ã—ã¾ã—ãŸã€‚\nå ã„å¸«ãŒã“ã®ä¼šè©±ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¾ã—ãŸã€‚');
            const systemMsg = document.createElement('div');
            systemMsg.className = 'system-message';
            systemMsg.innerHTML = '<div class="system-message-text">ãƒãƒ£ãƒƒãƒˆãŒçµ‚äº†ã—ã¾ã—ãŸ</div>';
            chatArea.appendChild(systemMsg);
            scrollToBottom();
            updateHeaderButtons();
          }
        }
      });
    } catch (err) {
      console.error('ä¼šè©±ãƒªã‚¹ãƒŠãƒ¼ã‚¨ãƒ©ãƒ¼:', err);
    }
  }

  function displayMessage(messageData) {
    const isSent = messageData.senderId === currentUser.uid;
    const messageType = messageData.messageType || 'paid';
    let bubbleClass = 'message-bubble';
    if (messageType === 'free' || messageType === 'templates') {
      bubbleClass = 'message-bubble free';
    } else if (messageType === 'paid') {
      bubbleClass = 'message-bubble paid';
    }
    const messageDiv = document.createElement('div');
    messageDiv.className = isSent ? 'message sent' : 'message';
    messageDiv.innerHTML = `
      <div class="message-content">
        <div class="${bubbleClass}">${(messageData.text || '').replace(/\n/g, '<br>')}</div>
        <div class="message-time">${formatTimestamp(messageData.timestamp)}</div>
      </div>
    `;
    chatArea.appendChild(messageDiv);
    scrollToBottom();
  }

  function scrollToBottom() {
    chatArea.scrollTop = chatArea.scrollHeight;
  }

  function checkPointsAvailability() {
    const activeTab = document.querySelector('.tab.active');
    const currentTab = activeTab ? activeTab.dataset.tab : 'paid';

    if (currentTab === 'free' || currentTab === 'templates') {
      messageInput.disabled = false;
      messageInput.placeholder = 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...';
      sendButton.disabled = false;
      sendButton.style.opacity = '1';
      return true;
    }

    if (currentTab === 'paid' && currentUser.type === 'client') {
      if (currentUser.points < fortuneTellerPrice) {
        messageInput.disabled = true;
        messageInput.placeholder = 'ãƒã‚¤ãƒ³ãƒˆãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ãƒã‚¤ãƒ³ãƒˆã‚’è³¼å…¥ã—ã¦ãã ã•ã„ã€‚';
        sendButton.disabled = true;
        sendButton.style.opacity = '0.5';
        return false;
      }
    }

    messageInput.disabled = false;
    messageInput.placeholder = 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...';
    sendButton.disabled = false;
    sendButton.style.opacity = '1';
    return true;
  }

  async function sendMessage() {
    if (conversationStatus !== 'active') {
      alert('ãƒãƒ£ãƒƒãƒˆã«å…¥å®¤ã—ã¦ã‹ã‚‰é€ä¿¡ã—ã¦ãã ã•ã„');
      return;
    }
    const text = messageInput.value.trim();
    if (!text) return;

    const activeTab = document.querySelector('.tab.active');
    const currentTab = activeTab ? activeTab.dataset.tab : 'paid';
    if (currentTab === 'templates') {
      alert('å®šå‹æ–‡ã‚¿ãƒ–ã§ã¯å®šå‹æ–‡ã®ã¿é€ä¿¡ã§ãã¾ã™');
      return;
    }

    let pointsSpent = 0;

    if (currentTab === 'paid' && currentUser.type === 'client') {
      const messageLength = text.length;
      const requiredPoints = messageLength * fortuneTellerPrice;
      if (currentUser.points < requiredPoints) {
        alert(`ãƒã‚¤ãƒ³ãƒˆãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚å¿…è¦ãƒã‚¤ãƒ³ãƒˆ: ${requiredPoints}ptï¼ˆæ®‹ã‚Š: ${currentUser.points}ptï¼‰`);
        return;
      }
      currentUser.points -= requiredPoints;
      pointsSpent = requiredPoints;
      document.getElementById('userPoints').textContent =
        'æ‰€æŒãƒã‚¤ãƒ³ãƒˆ ' + currentUser.points + 'pt';
      updateUserPointsInFirebase(currentUser.uid, currentUser.points);
      if (fortuneTellerId) {
        updateFortuneTellerSales(fortuneTellerId, requiredPoints);
      }
      checkPointsAvailability();
    }

    try {
      const messagesRef = window.firebaseCollection(window.firebaseDB, 'messages');
      await window.firebaseAddDoc(messagesRef, {
        conversationId,
        senderId: currentUser.uid,
        senderName: currentUser.name || currentUser.email,
        text,
        messageType: currentTab,
        pointsSpent,
        timestamp: new Date(),
        isRead: false
      });

      const convRef = window.firebaseDoc(window.firebaseDB, 'conversations', conversationId);
      const convSnap = await window.firebaseGetDoc(convRef);
      const convData = convSnap.exists() ? convSnap.data() : {};
      const updateData = { lastMessageAt: new Date().toISOString() };

      if (currentUser.type === 'client' && currentTab === 'paid' && pointsSpent > 0) {
        totalPointsSpent += pointsSpent;
        updateData.totalPointsSpent = totalPointsSpent;
      }
      await window.firebaseSetDoc(convRef, updateData, { merge: true });

    } catch (err) {
      console.error('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚¨ãƒ©ãƒ¼:', err);
      alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
      return;
    }

    messageInput.value = '';
    charCounter.textContent = '0 / 500';
    messageInput.style.height = 'auto';
    if (conversationId) {
      localStorage.removeItem(`draft_message_${conversationId}`);
    }
  }

  async function updateUserPointsInFirebase(uid, points) {
    try {
      const userRef = window.firebaseDoc(window.firebaseDB, 'users', uid);
      await window.firebaseSetDoc(userRef, { points }, { merge: true });
      if (conversationId && currentUser.type === 'client') {
        const convRef = window.firebaseDoc(window.firebaseDB, 'conversations', conversationId);
        await window.firebaseSetDoc(convRef, {
          clientPoints: points,
          lastUpdatedAt: new Date().toISOString()
        }, { merge: true });
      }
    } catch (err) {
      console.error('ãƒã‚¤ãƒ³ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:', err);
    }
  }

  async function updateFortuneTellerSales(ftId, salesAmount) {
    try {
      const ftRef = window.firebaseDoc(window.firebaseDB, 'fortuneTellers', ftId);
      const ftDoc = await window.firebaseGetDoc(ftRef);
      if (ftDoc.exists()) {
        const currentSales = ftDoc.data().currentMonthSales || 0;
        await window.firebaseSetDoc(ftRef, {
          currentMonthSales: currentSales + salesAmount
        }, { merge: true });
      }
    } catch (err) {
      console.error('å£²ä¸Šæ›´æ–°ã‚¨ãƒ©ãƒ¼:', err);
    }
  }

  sendButton.addEventListener('click', sendMessage);
  messageInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  templateItems.forEach(item => {
    item.addEventListener('click', async () => {
      if (conversationStatus !== 'active') {
        alert('ãƒãƒ£ãƒƒãƒˆã«å…¥å®¤ã—ã¦ã‹ã‚‰é€ä¿¡ã—ã¦ãã ã•ã„');
        return;
      }
      const text = item.dataset.text;
      if (!text) return;
      try {
        const messagesRef = window.firebaseCollection(window.firebaseDB, 'messages');
        await window.firebaseAddDoc(messagesRef, {
          conversationId,
          senderId: currentUser.uid,
          senderName: currentUser.name || currentUser.email,
          text,
          messageType: 'templates',
          timestamp: new Date(),
          isRead: false
        });
        const convRef = window.firebaseDoc(window.firebaseDB, 'conversations', conversationId);
        await window.firebaseSetDoc(convRef, {
          lastMessageAt: new Date().toISOString()
        }, { merge: true });
      } catch (err) {
        console.error('å®šå‹æ–‡é€ä¿¡ã‚¨ãƒ©ãƒ¼:', err);
        alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
        return;
      }

      tabs.forEach(t => t.classList.remove('active'));
      if (currentUser.type === 'client') {
        document.querySelector('.tab[data-tab="paid"]').classList.add('active');
      } else {
        document.querySelector('.tab[data-tab="free"]').classList.add('active');
      }
      templatesArea.classList.remove('active');
      messageInput.disabled = false;
      messageInput.placeholder = 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...';
      sendButton.disabled = false;
      checkPointsAvailability();
    });
  });

  if (editTemplatesButton) {
    editTemplatesButton.addEventListener('click', () => {
      templateModal.classList.add('active');
    });
  }

  templateModal.addEventListener('click', (e) => {
    if (e.target === templateModal) {
      templateModal.classList.remove('active');
    }
  });

  scrollToBottom();
  checkPointsAvailability();

  if (conversationId) {
    const key = `draft_message_${conversationId}`;
    const draft = localStorage.getItem(key);
    if (draft) {
      messageInput.value = draft;
      charCounter.textContent = `${draft.length} / 500`;
      messageInput.style.height = 'auto';
      messageInput.style.height = Math.min(messageInput.scrollHeight, 100) + 'px';
    }
  }
</script>

<div class="review-modal" id="reviewModal">
  <div class="review-content">
    <div class="review-title">é‘‘å®šã¯ã„ã‹ãŒã§ã—ãŸã‹?</div>
    <div class="review-subtitle">å ã„å¸«ã•ã‚“ã¸ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãŠé¡˜ã„ã—ã¾ã™</div>
    <div style="margin-bottom:25px;">
      <label style="display:block;margin-bottom:8px;font-weight:bold;color:#333;">è©•ä¾¡ã‚’é¸æŠ</label>
      <select id="starRating"
              style="width:100%;padding:12px;border:1px solid #DDD;border-radius:10px;font-size:16px;background:white;cursor:pointer;">
        <option value="5">â˜…â˜…â˜…â˜…â˜… (5)</option>
        <option value="4">â˜…â˜…â˜…â˜…â˜† (4)</option>
        <option value="3">â˜…â˜…â˜…â˜†â˜† (3)</option>
        <option value="2">â˜…â˜…â˜†â˜†â˜† (2)</option>
        <option value="1">â˜…â˜†â˜†â˜†â˜† (1)</option>
      </select>
    </div>
    <textarea
      class="review-comment"
      id="reviewComment"
      placeholder="ã‚ˆã‹ã£ãŸç‚¹ã‚„æ„Ÿæƒ³ã‚’ãŠèã‹ã›ãã ã•ã„(ä»»æ„)"
      maxlength="500"
    ></textarea>
    <div class="review-buttons">
      <button class="review-button skip" onclick="skipReview()">ã‚¹ã‚­ãƒƒãƒ—</button>
      <button class="review-button submit" onclick="submitReview()">é€ä¿¡ã™ã‚‹</button>
    </div>
  </div>
</div>
</body>
</html>

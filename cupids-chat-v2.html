<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒãƒ£ãƒƒãƒˆ - ã‚­ãƒ¥ãƒ¼ãƒ”ãƒƒã‚º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', sans-serif;
            background: #F0F0F0;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: white;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            background: linear-gradient(135deg, #E967A5 0%, #B565D8 100%);
            color: white;
            padding: 12px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .back-button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fortune-teller-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ft-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
        }

        .ft-details {
            display: flex;
            flex-direction: column;
        }

        .ft-name {
            font-size: 16px;
            font-weight: bold;
        }

        .ft-points {
            font-size: 12px;
            opacity: 0.9;
        }

        .header-right {
            display: flex;
            gap: 8px;
        }

        .exit-button, .karte-button {
            background: white;
            color: #E967A5;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ */
        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px 15px;
            background: #F5F5F5;
        }

        /* è¿”ä¿¡å¾…ã¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒŠãƒ¼ */
        .waiting-status-banner {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            padding: 12px 16px;
            margin-bottom: 15px;
            border-radius: 0 0 12px 12px;
            display: none;
            align-items: center;
            gap: 12px;
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
            animation: slideDown 0.5s ease;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .waiting-status-banner.active {
            display: flex;
        }

        .waiting-status-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .waiting-status-text {
            flex: 1;
            font-size: 13px;
            line-height: 1.5;
        }

        .waiting-status-time {
            font-weight: bold;
            font-size: 14px;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .system-message {
            text-align: center;
            margin: 20px 0;
        }

        .system-message-text {
            background: #E0E0E0;
            color: #666;
            padding: 8px 20px;
            border-radius: 15px;
            font-size: 13px;
            display: inline-block;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
        }

        .message.sent {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, #E967A5, #B565D8);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .message-content {
            max-width: 70%;
        }

        .message-bubble {
            background: white;
            padding: 10px 14px;
            border-radius: 15px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            word-wrap: break-word;
            line-height: 1.5;
        }
        
        /* æœ‰æ–™ãƒãƒ£ãƒƒãƒˆï¼šé€å—ä¿¡ã¨ã‚‚ãƒ”ãƒ³ã‚¯ */
        .message-bubble.paid {
            background: #E967A5;
            color: white;
        }

        .message.sent .message-bubble {
            background: #E967A5;
            color: white;
        }

        /* ç„¡æ–™ãƒãƒ£ãƒƒãƒˆãƒ»å®šå‹æ–‡ã¯ç™½ã„å¹ãå‡ºã— */
        .message.sent .message-bubble.free {
            background: white;
            color: #333;
            border: 1px solid #E0E0E0;
        }
        
        .message .message-bubble.free {
            background: white;
            color: #333;
            border: 1px solid #E0E0E0;
        }

        .message-time {
            font-size: 11px;
            color: #999;
            margin-top: 4px;
            padding: 0 5px;
        }

        /* ã‚¿ãƒ–ã‚¨ãƒªã‚¢ */
        .tabs {
            background: white;
            display: flex;
            border-bottom: 1px solid #E0E0E0;
            padding: 0 15px;
        }

        .tab {
            flex: 1;
            padding: 12px 0;
            text-align: center;
            border: none;
            background: none;
            color: #999;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            position: relative;
            transition: color 0.2s;
        }

        .tab.active {
            color: #E967A5;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: #E967A5;
        }

        /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
        .input-area {
            background: white;
            padding: 12px 15px;
            border-top: 1px solid #E0E0E0;
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .input-box {
            flex: 1;
            position: relative;
        }

        .message-input {
            width: 100%;
            border: 1px solid #DDD;
            border-radius: 20px;
            padding: 10px 15px;
            padding-bottom: 25px;
            font-size: 14px;
            outline: none;
            resize: none;
            font-family: inherit;
            line-height: 1.5;
        }

        .message-input:focus {
            border-color: #E967A5;
        }

        .char-counter {
            position: absolute;
            bottom: 8px;
            left: 15px;
            font-size: 11px;
            color: #999;
        }

        .send-button {
            background: linear-gradient(135deg, #E967A5, #B565D8);
            color: white;
            border: none;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            position: relative;
            box-shadow: 0 2px 8px rgba(233, 103, 165, 0.3);
            transition: all 0.2s;
        }

        .send-button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(233, 103, 165, 0.4);
        }

        .send-button svg {
            width: 20px;
            height: 20px;
            fill: white;
            transform: rotate(45deg);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* å®šå‹æ–‡ã‚¨ãƒªã‚¢ */
        .templates-area {
            background: white;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }

        .templates-area.active {
            display: block;
        }

        .template-item {
            background: #F5F5F5;
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 14px;
            line-height: 1.5;
        }

        .template-item:hover {
            background: #E8E8E8;
        }

        .add-template-button {
            background: #E967A5;
            color: white;
            border: none;
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }

        /* å®šå‹æ–‡ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #2C2C3E;
            border-radius: 15px;
            padding: 20px;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            color: white;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .template-edit-item {
            background: #3C3C4E;
            color: white;
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            font-size: 14px;
            line-height: 1.5;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        
        .template-edit-text {
            flex: 1;
            cursor: pointer;
        }
        
        .template-edit-text:hover {
            text-decoration: underline;
        }
        
        .template-edit-buttons {
            display: flex;
            gap: 5px;
        }
        
        .template-edit-btn, .template-delete-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .template-edit-btn {
            background: #4A90E2;
            color: white;
        }
        
        .template-edit-btn:hover {
            background: #357ABD;
        }
        
        .template-delete-btn {
            background: #E74C3C;
            color: white;
        }
        
        .template-delete-btn:hover {
            background: #C0392B;
        }

        .template-edit-item:hover {
            background: #4C4C5E;
        }

        .hidden {
            display: none;
        }

        /* ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .review-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .review-modal.active {
            display: flex;
        }

        .review-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        .review-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .review-subtitle {
            font-size: 14px;
            color: #666;
            margin-bottom: 25px;
        }

        .star-rating {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-bottom: 25px;
            padding: 10px;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
        }

        .star-rating .star {
            font-size: 48px;
            color: #DDD;
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
        }

        .star-rating .star.active {
            color: #FFB800;
            transform: scale(1.1);
            text-shadow: 0 0 10px rgba(255, 184, 0, 0.5);
        }

        .star-rating .star:hover {
            transform: scale(1.15);
        }

        .review-comment {
            width: 100%;
            border: 1px solid #DDD;
            border-radius: 10px;
            padding: 15px;
            font-size: 14px;
            resize: vertical;
            min-height: 100px;
            margin-bottom: 20px;
            font-family: inherit;
        }

        .review-buttons {
            display: flex;
            gap: 10px;
        }

        .review-button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .review-button.submit {
            background: linear-gradient(135deg, #E967A5, #B565D8);
            color: white;
        }

        .review-button.submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(233, 103, 165, 0.4);
        }

        .review-button.skip {
            background: #F0F0F0;
            color: #666;
        }

        .review-button.skip:hover {
            background: #E0E0E0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="header">
            <div class="header-left">
                <button class="back-button" onclick="goBack()">â†</button>
                <div class="fortune-teller-info">
                    <div class="ft-avatar" id="ftAvatar">?</div>
                    <div class="ft-details">
                        <div class="ft-name" id="ftName">èª­ã¿è¾¼ã¿ä¸­...</div>
                        <div class="ft-points" id="userPoints">æ‰€æŒãƒã‚¤ãƒ³ãƒˆ 0pt</div>
                    </div>
                </div>
            </div>
            <div class="header-right" id="headerButtons">
                <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
            </div>
        </div>

        <!-- ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ -->
        <div class="chat-area" id="chatArea">
            <!-- ã€å‰Šé™¤ã€‘è¿”ä¿¡å¾…ã¡ã‚¿ã‚¤ãƒãƒ¼ãƒãƒŠãƒ¼ï¼ˆé‹ç”¨ä¸Šä¸è¦ï¼‰ -->
            <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯JavaScriptã§å‹•çš„ã«è¿½åŠ  -->
        </div>

        <!-- ã‚¿ãƒ– -->
        <div class="tabs" id="chatTabs">
            <button class="tab" id="freeTab" data-tab="free">ç„¡æ–™ãƒãƒ£ãƒƒãƒˆ</button>
            <button class="tab active" data-tab="paid">æœ‰æ–™ãƒãƒ£ãƒƒãƒˆ</button>
            <button class="tab" data-tab="templates">å®šå‹æ–‡ï¼ˆç„¡æ–™ï¼‰</button>
        </div>

        <!-- å®šå‹æ–‡ã‚¨ãƒªã‚¢ï¼ˆå ã„å¸«ç”¨ï¼‰ -->
        <div class="templates-area" id="templatesArea">
            <div class="template-item" data-text="ã”ç›¸è«‡ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚è©³ã—ããŠè©±ã‚’ä¼ºã‚ã›ã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ">
                ã”ç›¸è«‡ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚è©³ã—ããŠè©±ã‚’ä¼ºã‚ã›ã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ
            </div>
            <div class="template-item" data-text="é‘‘å®šã•ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚å°‘ã€…ãŠå¾…ã¡ãã ã•ã„ã€‚">
                é‘‘å®šã•ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚å°‘ã€…ãŠå¾…ã¡ãã ã•ã„ã€‚
            </div>
            <div class="template-item" data-text="ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚ã¾ãŸã„ã¤ã§ã‚‚ã”ç›¸è«‡ãã ã•ã„ã€‚">
                ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚ã¾ãŸã„ã¤ã§ã‚‚ã”ç›¸è«‡ãã ã•ã„ã€‚
            </div>
            <button class="add-template-button" id="editTemplatesButton">+ å®šå‹æ–‡ã‚’ç·¨é›†</button>
        </div>

        <!-- å®šå‹æ–‡ã‚¨ãƒªã‚¢ï¼ˆãŠå®¢æ§˜ç”¨ï¼‰ -->
        <div class="templates-area" id="clientTemplatesArea">
            <div class="template-item" data-text="ã‚ˆã‚ã—ããŠã­ãŒã„ã—ã¾ã™">
                ã‚ˆã‚ã—ããŠã­ãŒã„ã—ã¾ã™
            </div>
            <div class="template-item" data-text="ãã†ã§ã™">
                ãã†ã§ã™
            </div>
            <div class="template-item" data-text="æœ¬æ—¥ã¯ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸ">
                æœ¬æ—¥ã¯ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸ
            </div>
            <div class="template-item" data-text="ãƒã‚¤ãƒ³ãƒˆãŒè¶³ã‚Šãªã„ç‚ºã“ã‚Œã§å¤±ç¤¼ã—ã¾ã™">
                ãƒã‚¤ãƒ³ãƒˆãŒè¶³ã‚Šãªã„ç‚ºã“ã‚Œã§å¤±ç¤¼ã—ã¾ã™
            </div>
        </div>

        <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
        <div class="input-area">
            <div class="input-wrapper">
                <div class="input-box">
                    <textarea 
                        class="message-input" 
                        id="messageInput" 
                        placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."
                        rows="1"
                        maxlength="500"
                    ></textarea>
                    <div class="char-counter" id="charCounter">0 / 500</div>
                </div>
                <button class="send-button" id="sendButton">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 21l18-9L3 3v7l13 2-13 2z" transform="rotate(-45 12 12)"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- å®šå‹æ–‡ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="templateModal">
        <div class="modal-content">
            <div class="modal-header">å®šå‹æ–‡ã‚’ç·¨é›†</div>
            <div id="templateEditList">
                <div class="template-edit-item">ã”ç›¸è«‡ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚è©³ã—ããŠè©±ã‚’ä¼ºã‚ã›ã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ</div>
                <div class="template-edit-item">é‘‘å®šã•ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚å°‘ã€…ãŠå¾…ã¡ãã ã•ã„ã€‚</div>
                <div class="template-edit-item">ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚ã¾ãŸã„ã¤ã§ã‚‚ã”ç›¸è«‡ãã ã•ã„ã€‚</div>
            </div>
            <button class="add-template-button" style="margin-top: 20px;">+ å®šå‹æ–‡ã‚’è¿½åŠ </button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, setDoc, collection, addDoc, query, where, orderBy, onSnapshot, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyA52uJ31HzLkbz32lA-3WWSmhM10xYjjCg",
            authDomain: "cupids-chat.firebaseapp.com",
            projectId: "cupids-chat",
            storageBucket: "cupids-chat.firebasestorage.app",
            messagingSenderId: "44532110483",
            appId: "1:44532110483:web:d6266e8abba8582b8b6966"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.firebaseAuth = auth;
        window.firebaseDB = db;
        window.firebaseDoc = doc;
        window.firebaseGetDoc = getDoc;
        window.firebaseSetDoc = setDoc;
        window.firebaseCollection = collection;
        window.firebaseAddDoc = addDoc;
        window.firebaseQuery = query;
        window.firebaseWhere = where;
        window.firebaseOrderBy = orderBy;
        window.firebaseOnSnapshot = onSnapshot;
        window.firebaseGetDocs = getDocs;
        
        // FirebaseåˆæœŸåŒ–å®Œäº†ã‚’é€šçŸ¥
        window.firebaseReady = true;
        window.dispatchEvent(new Event('firebaseReady'));
        console.log('âœ… FirebaseåˆæœŸåŒ–å®Œäº†!');
    </script>

    <script>
        // ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
        const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
        if (!currentUser) {
            alert('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
            window.location.href = 'cupids-login.html';
        }

        // ä¼šè©±ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ ('not-started', 'active', 'ended')
        // ä¼šè©±ã®çŠ¶æ…‹ã‚’Firebaseã‹ã‚‰å–å¾—
        const conversationId = localStorage.getItem('selectedConversationId');
        let conversationStatus = 'not-started';
        let isBlocked = false; // ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹
        
        // ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨: ç´¯ç©æ¶ˆè²»ãƒã‚¤ãƒ³ãƒˆã¨è¡¨ç¤ºæ¸ˆã¿ãƒ•ãƒ©ã‚°
        let totalPointsSpent = 0;
        let reviewModalShown = false;
        
        // å ã„å¸«æƒ…å ±ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ï¼‰
        let fortuneTellerId = '';
        let fortuneTellerPrice = 10;
        let fortuneTellerName = 'å ã„å¸«';
        let fortuneTellerImageUrl = '';

        // Firebaseã‹ã‚‰ä¼šè©±çŠ¶æ…‹ã‚’èª­ã¿è¾¼ã¿
        async function loadConversationStatus() {
            // ã¾ãšæœ€æ–°ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒã‚¤ãƒ³ãƒˆã‚’å–å¾—
            try {
                const collectionName = currentUser.type === 'fortune-teller' ? 'fortuneTellers' : 'users';
                const userRef = window.firebaseDoc(window.firebaseDB, collectionName, currentUser.uid);
                const userDoc = await window.firebaseGetDoc(userRef);
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    currentUser.points = userData.points || 0;
                    // ãƒã‚¤ãƒ³ãƒˆæ®‹é«˜ã¯Firebaseã‹ã‚‰å–å¾—ã™ã‚‹ãŸã‚localStorageã«ã¯ä¿å­˜ã—ãªã„
                    
                    // ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤ºã‚’æ›´æ–°
                    document.getElementById('userPoints').textContent = 'æ‰€æŒãƒã‚¤ãƒ³ãƒˆ ' + currentUser.points + 'pt';
                    console.log('âœ… æœ€æ–°ãƒã‚¤ãƒ³ãƒˆå–å¾—:', currentUser.points);
                }
            } catch (error) {
                console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒã‚¤ãƒ³ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            }
            
            if (!conversationId) {
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éè¡¨ç¤º
                document.querySelector('.loading-overlay')?.classList.add('hidden');
                updateHeaderButtons();
                return;
            }
            
            try {
                const convRef = window.firebaseDoc(window.firebaseDB, 'conversations', conversationId);
                const convSnap = await window.firebaseGetDoc(convRef);
                
                if (convSnap.exists()) {
                    const data = convSnap.data();
                    
                    // å ã„å¸«ã®å ´åˆã€ãŠå®¢æ§˜ã®ãƒã‚¤ãƒ³ãƒˆã‚’è¡¨ç¤º
                    if (currentUser.type === 'fortune-teller' && data.clientId) {
                        // ä¼šè©±ãƒ‡ãƒ¼ã‚¿ã«ãƒã‚¤ãƒ³ãƒˆãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°Firestoreã‹ã‚‰å–å¾—
                        let clientPoints = data.clientPoints;
                        
                        if (clientPoints === undefined) {
                            try {
                                const clientDoc = await window.firebaseGetDoc(
                                    window.firebaseDoc(window.firebaseDB, 'users', data.clientId)
                                );
                                if (clientDoc.exists()) {
                                    const clientData = clientDoc.data();
                                    clientPoints = clientData.points || 0;
                                }
                            } catch (error) {
                                console.error('ãŠå®¢æ§˜ãƒã‚¤ãƒ³ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                                clientPoints = 0;
                            }
                        }
                        
                        document.getElementById('userPoints').textContent = 'æ‰€æŒãƒã‚¤ãƒ³ãƒˆ ' + clientPoints + 'pt';
                        console.log('âœ… ãŠå®¢æ§˜ã®ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤º:', clientPoints);
                        
                        // ä¼šè©±ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›´ã‚’ç›£è¦–ã—ã¦ãƒã‚¤ãƒ³ãƒˆã‚’è‡ªå‹•æ›´æ–°
                        window.firebaseOnSnapshot(convRef, (doc) => {
                            if (doc.exists() && currentUser.type === 'fortune-teller') {
                                const convData = doc.data();
                                if (convData.clientPoints !== undefined) {
                                    document.getElementById('userPoints').textContent = 'æ‰€æŒãƒã‚¤ãƒ³ãƒˆ ' + convData.clientPoints + 'pt';
                                    console.log('ğŸ”„ ãŠå®¢æ§˜ã®ãƒã‚¤ãƒ³ãƒˆæ›´æ–°:', convData.clientPoints);
                                }
                            }
                        });
                    }
                    
                    // ã€ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒƒã‚¯ã€‘ãŠå®¢æ§˜ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹å ´åˆ
                    if (currentUser.type === 'client' && data.blocked) {
                        console.log('ğŸš« ã“ã®ä¼šè©±ã¯ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™');
                        isBlocked = true; // ãƒ–ãƒ­ãƒƒã‚¯ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
                        conversationStatus = 'ended';
                        
                        // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã§é€šçŸ¥
                        alert('ãƒãƒ£ãƒƒãƒˆãŒçµ‚äº†ã—ã¾ã—ãŸã€‚\nå ã„å¸«ãŒã“ã®ä¼šè©±ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¾ã—ãŸã€‚');
                        
                        // ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                        const systemMsg = document.createElement('div');
                        systemMsg.className = 'system-message';
                        systemMsg.innerHTML = '<div class="system-message-text">ãƒãƒ£ãƒƒãƒˆãŒçµ‚äº†ã—ã¾ã—ãŸ</div>';
                        const chatArea = document.getElementById('chatArea');
                        if (chatArea) {
                            chatArea.appendChild(systemMsg);
                        }
                        
                        updateHeaderButtons();
                        
                        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ã¯ã‚¹ã‚­ãƒƒãƒ—
                        document.querySelector('.loading-overlay')?.classList.add('hidden');
                        return;
                    }
                    
                    conversationStatus = data.status || 'not-started';
                    
                    // ç´¯ç©æ¶ˆè²»ãƒã‚¤ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã¿
                    totalPointsSpent = data.totalPointsSpent || 0;
                    console.log('ğŸ’° ç´¯ç©æ¶ˆè²»ãƒã‚¤ãƒ³ãƒˆ:', totalPointsSpent);
                    
                    // ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯(ãŠå®¢æ§˜ã®ã¿)
                    if (currentUser.type === 'client') {
                        const reviewsRef = window.firebaseCollection(window.firebaseDB, 'reviews');
                        const reviewQuery = window.firebaseQuery(
                            reviewsRef,
                            window.firebaseWhere('conversationId', '==', conversationId),
                            window.firebaseWhere('clientId', '==', currentUser.uid)
                        );
                        const reviewSnapshot = await window.firebaseGetDocs(reviewQuery);
                        reviewModalShown = !reviewSnapshot.empty;
                        console.log('ğŸ“ ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿æ¸ˆã¿:', reviewModalShown);
                    }
                    
                    // ã€è‡ªå‹•è¿”é‡‘ãƒã‚§ãƒƒã‚¯ã€‘ãŠå®¢æ§˜ãŒé–‹ã„ãŸæ™‚ã®ã¿ãƒã‚§ãƒƒã‚¯
                    if (currentUser.type === 'client' && data.waitingForReply && data.lastClientMessageAt) {
                        await checkAndProcessRefund(convRef, data);
                        
                        // è¿”é‡‘å‡¦ç†å¾Œã€å†åº¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                        const updatedSnap = await window.firebaseGetDoc(convRef);
                        const updatedData = updatedSnap.exists() ? updatedSnap.data() : data;
                        
                        // ã€å‰Šé™¤ã€‘è¿”é‡‘å‡¦ç†ã•ã‚Œã¦ã„ãªã‘ã‚Œã°ãƒãƒŠãƒ¼è¡¨ç¤º
                        /*
                        if (!updatedData.refundProcessed && updatedData.waitingForReply) {
                            updateWaitingStatusBanner(updatedData.lastClientMessageAt, updatedData.pointsSinceLastReply || 0);
                        }
                        */
                    }
                } else {
                    conversationStatus = 'not-started';
                }
                updateHeaderButtons();
                
                // ä¼šè©±çŠ¶æ…‹èª­ã¿è¾¼ã¿å¾Œã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚èª­ã¿è¾¼ã‚€
                loadMessages();
                
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éè¡¨ç¤º
                document.querySelector('.loading-overlay')?.classList.add('hidden');
            } catch (error) {
                console.error('ä¼šè©±çŠ¶æ…‹ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                conversationStatus = 'not-started';
                updateHeaderButtons();
                // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã‚‚ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éè¡¨ç¤º
                document.querySelector('.loading-overlay')?.classList.add('hidden');
            }
        }

        // è¿”ä¿¡å¾…ã¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒŠãƒ¼ã‚’æ›´æ–°
        // ã€å‰Šé™¤ã€‘è¿”ä¿¡å¾…ã¡ãƒãƒŠãƒ¼æ›´æ–°æ©Ÿèƒ½ï¼ˆé‹ç”¨ä¸Šä¸è¦ï¼‰
        /*
        function updateWaitingStatusBanner(lastMessageAt, pointsAtRisk) {
            const banner = document.getElementById('waitingStatusBanner');
            const timeDisplay = document.getElementById('waitingTime');
            
            if (!banner || !timeDisplay) return;
            
            const lastMessageTime = new Date(lastMessageAt);
            const now = new Date();
            const hoursPassed = (now - lastMessageTime) / (1000 * 60 * 60);
            const hoursRemaining = Math.max(0, 24 - hoursPassed);
            
            // çµŒéæ™‚é–“ã‚’è¡¨ç¤º
            if (hoursPassed < 1) {
                const minutesPassed = Math.floor(hoursPassed * 60);
                timeDisplay.innerHTML = `çµŒéæ™‚é–“: ${minutesPassed}åˆ† | è¿”é‡‘å¯¾è±¡: <strong>${pointsAtRisk}pt</strong>`;
            } else {
                timeDisplay.innerHTML = `çµŒéæ™‚é–“: ${hoursPassed.toFixed(1)}æ™‚é–“ / æ®‹ã‚Š ${hoursRemaining.toFixed(1)}æ™‚é–“ | è¿”é‡‘å¯¾è±¡: <strong>${pointsAtRisk}pt</strong>`;
            }
            
            // ãƒãƒŠãƒ¼ã‚’è¡¨ç¤ºï¼ˆãŠå®¢æ§˜ã®ã¿ã€ã‹ã¤å…¥å®¤ä¸­ã®ã¿ï¼‰
            if (currentUser.type === 'client' && conversationStatus === 'active') {
                banner.classList.add('active');
            } else {
                banner.classList.remove('active');
            }
        }
        */


        // 24æ™‚é–“ãƒã‚§ãƒƒã‚¯ã¨è‡ªå‹•è¿”é‡‘å‡¦ç†
        async function checkAndProcessRefund(convRef, convData) {
            try {
                const lastMessageTime = new Date(convData.lastClientMessageAt);
                const now = new Date();
                const hoursPassed = (now - lastMessageTime) / (1000 * 60 * 60);
                
                console.log('â° æœ€å¾Œã®ãŠå®¢æ§˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰ã®çµŒéæ™‚é–“:', hoursPassed.toFixed(2), 'æ™‚é–“');
                
                // 24æ™‚é–“çµŒéã—ã¦ã„ã¦ã€ã¾ã å ã„å¸«ãŒè¿”ä¿¡ã—ã¦ã„ãªã„å ´åˆ
                if (hoursPassed >= 24 && !convData.refundProcessed) {
                    console.log('ğŸ”„ 24æ™‚é–“çµŒéã€è‡ªå‹•è¿”é‡‘ã‚’é–‹å§‹...');
                    
                    // å ã„å¸«ã®æœ€å¾Œã®è¿”ä¿¡ä»¥é™ã«ä½¿ã‚ã‚ŒãŸãƒã‚¤ãƒ³ãƒˆã®ã¿è¿”é‡‘
                    const pointsToRefund = convData.pointsSinceLastReply || 0;
                    
                    if (pointsToRefund > 0) {
                        // ãƒã‚¤ãƒ³ãƒˆã‚’è¿”é‡‘ï¼ˆFirebaseã®ã¿æ›´æ–°ï¼‰
                        currentUser.points += pointsToRefund;
                        // localStorageã«ã¯ä¿å­˜ã—ãªã„
                        
                        // Firebaseã®ãƒã‚¤ãƒ³ãƒˆã‚’æ›´æ–°
                        await updateUserPointsInFirebase(currentUser.uid, currentUser.points);
                        
                        // å ã„å¸«ã®å£²ä¸Šã‹ã‚‰ã‚‚æ¸›ç®—
                        if (fortuneTellerId) {
                            await updateFortuneTellerSales(fortuneTellerId, -pointsToRefund);
                        }
                        
                        // ä¼šè©±ã«è¿”é‡‘å‡¦ç†æ¸ˆã¿ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
                        await window.firebaseSetDoc(convRef, {
                            waitingForReply: false,
                            refundProcessed: true,
                            refundedAt: new Date().toISOString(),
                            refundedPoints: pointsToRefund,
                            pointsSinceLastReply: 0 // ãƒªã‚»ãƒƒãƒˆ
                        }, { merge: true });
                        
                        // ç”»é¢ã®ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤ºã‚’æ›´æ–°
                        document.getElementById('userPoints').textContent = 'æ‰€æŒãƒã‚¤ãƒ³ãƒˆ ' + currentUser.points + 'pt';
                        
                        // è¿”é‡‘é€šçŸ¥ã‚’è¡¨ç¤º
                        showRefundNotification(pointsToRefund);
                        
                        console.log('âœ… è¿”é‡‘å®Œäº†:', pointsToRefund, 'pt (å ã„å¸«ã®æœ€å¾Œã®è¿”ä¿¡ä»¥é™ã«ä½¿ç”¨ã•ã‚ŒãŸåˆ†)');
                    } else {
                        console.log('â„¹ï¸ è¿”é‡‘å¯¾è±¡ãƒã‚¤ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“');
                    }
                }
            } catch (error) {
                console.error('è¿”é‡‘å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // è¿”é‡‘é€šçŸ¥ã‚’è¡¨ç¤º
        function showRefundNotification(points) {
            // ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã—ã¦è¡¨ç¤º
            const systemMessage = document.createElement('div');
            systemMessage.className = 'system-message';
            systemMessage.style.cssText = `
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                padding: 16px;
                margin: 16px;
                border-radius: 12px;
                text-align: center;
                font-size: 14px;
                line-height: 1.6;
                box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
                animation: slideIn 0.5s ease;
            `;
            systemMessage.innerHTML = `
                <div style="font-size: 24px; margin-bottom: 8px;">ğŸ’°</div>
                <div style="font-weight: bold; margin-bottom: 4px;">è‡ªå‹•è¿”é‡‘ãŒå®Œäº†ã—ã¾ã—ãŸ</div>
                <div style="font-size: 13px; opacity: 0.95;">
                    å ã„å¸«ã®æœ€å¾Œã®è¿”ä¿¡ã‹ã‚‰24æ™‚é–“ä»¥å†…ã«è¿”ä¿¡ãŒãªã‹ã£ãŸãŸã‚ã€<strong>${points}pt</strong>ã‚’è¿”é‡‘ã„ãŸã—ã¾ã—ãŸã€‚
                </div>
            `;
            
            const chatArea = document.getElementById('chatArea');
            chatArea.insertBefore(systemMessage, chatArea.firstChild);
            
            // ã‚¢ãƒ©ãƒ¼ãƒˆã§ã‚‚é€šçŸ¥
            alert(`âš ï¸ å ã„å¸«ã‹ã‚‰24æ™‚é–“ä»¥å†…ã«è¿”ä¿¡ãŒãªã‹ã£ãŸãŸã‚ã€${points}ptã‚’è‡ªå‹•è¿”é‡‘ã„ãŸã—ã¾ã—ãŸã€‚`);
        }

        // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
        function updateHeaderButtons() {
            const headerButtons = document.getElementById('headerButtons');
            headerButtons.innerHTML = '';

            // å…¥å®¤ãƒœã‚¿ãƒ³ (ãŠå®¢æ§˜ã®ã¿ã€æœªå…¥å®¤ã¾ãŸã¯é€€å®¤æ¸ˆã¿ã®å ´åˆã€ã‹ã¤ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ãªã„)
            if (currentUser.type === 'client' && 
                (conversationStatus === 'not-started' || conversationStatus === 'ended') && 
                !isBlocked) {
                const enterBtn = document.createElement('button');
                enterBtn.className = 'exit-button';
                enterBtn.textContent = 'å…¥å®¤';
                enterBtn.style.background = '#16a34a';
                enterBtn.style.color = 'white';
                enterBtn.onclick = handleEnterChat;
                headerButtons.appendChild(enterBtn);
            }

            // é€€å®¤ãƒœã‚¿ãƒ³ (å…¥å®¤ä¸­ã®å ´åˆ)
            if (conversationStatus === 'active') {
                const exitBtn = document.createElement('button');
                exitBtn.className = 'exit-button';
                exitBtn.textContent = 'é€€å®¤';
                exitBtn.style.background = '#dc2626';
                exitBtn.style.color = 'white';
                exitBtn.onclick = handleExitChat;
                headerButtons.appendChild(exitBtn);
            }

            // ã‚«ãƒ«ãƒ†ãƒœã‚¿ãƒ³ (ãŠå®¢æ§˜ã‚‚å ã„å¸«ã‚‚ä¸¡æ–¹è¡¨ç¤º)
            const karteBtn = document.createElement('button');
            karteBtn.className = 'karte-button';
            karteBtn.textContent = 'ğŸ“‹ ã‚«ãƒ«ãƒ†';
            karteBtn.onclick = goToKarte;
            headerButtons.appendChild(karteBtn);
        }

        // å…¥å®¤å‡¦ç†
        async function handleEnterChat() {
            if (currentUser.type === 'client' && currentUser.points < 1) {
                alert('ãƒã‚¤ãƒ³ãƒˆãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ãƒã‚¤ãƒ³ãƒˆã‚’è³¼å…¥ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            conversationStatus = 'active';
            
            // Firebaseã«çŠ¶æ…‹ã‚’ä¿å­˜
            try {
                const convRef = window.firebaseDoc(window.firebaseDB, 'conversations', conversationId);
                await window.firebaseSetDoc(convRef, {
                    status: 'active',
                    startedAt: new Date().toISOString()
                }, { merge: true });
                
                // ã€å‰Šé™¤ã€‘å…¥å®¤å¾Œã€è¿”ä¿¡å¾…ã¡ã®çŠ¶æ…‹ãŒã‚ã‚Œã°ãƒãƒŠãƒ¼ã‚’è¡¨ç¤º
                /*
                const convSnap = await window.firebaseGetDoc(convRef);
                if (convSnap.exists()) {
                    const convData = convSnap.data();
                    if (currentUser.type === 'client' && convData.waitingForReply && convData.lastClientMessageAt) {
                        updateWaitingStatusBanner(convData.lastClientMessageAt, convData.pointsSinceLastReply || 0);
                    }
                }
                */
            } catch (error) {
                console.error('å…¥å®¤çŠ¶æ…‹ã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
            }
            
            updateHeaderButtons();

            // ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            const systemMsg = document.createElement('div');
            systemMsg.className = 'system-message';
            systemMsg.innerHTML = '<div class="system-message-text">ãƒãƒ£ãƒƒãƒˆãŒé–‹å§‹ã—ã¾ã—ãŸ</div>';
            chatArea.appendChild(systemMsg);
            scrollToBottom();
            
            // å…¥å®¤å¾Œã«ãƒã‚¤ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯
            checkPointsAvailability();
        }

        // é€€å®¤å‡¦ç†
        async function handleExitChat() {
            // ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            if (!confirm('é€€å®¤ã™ã‚‹ã¨å ã„å¸«ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå±Šã‹ãªããªã‚Šã¾ã™ã€‚\næœ¬å½“ã«é€€å®¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            conversationStatus = 'ended';
            
            // Firebaseã«çŠ¶æ…‹ã‚’ä¿å­˜
            try {
                const convRef = window.firebaseDoc(window.firebaseDB, 'conversations', conversationId);
                await window.firebaseSetDoc(convRef, {
                    status: 'ended',
                    endedAt: new Date().toISOString()
                    // ã€å‰Šé™¤ã€‘è¿”ä¿¡å¾…ã¡ã‚¿ã‚¤ãƒãƒ¼æ©Ÿèƒ½
                    // waitingForReply: false, // è¿”ä¿¡å¾…ã¡ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    // pointsSinceLastReply: 0 // è¿”é‡‘å¯¾è±¡ãƒã‚¤ãƒ³ãƒˆã‚‚ãƒªã‚»ãƒƒãƒˆ
                }, { merge: true });
                
                // console.log('âœ… é€€å®¤å®Œäº†ã€‚è¿”ä¿¡å¾…ã¡ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
                console.log('âœ… é€€å®¤å®Œäº†');
                
                // è¿”ä¿¡å¾…ã¡ãƒãƒŠãƒ¼ã‚’éè¡¨ç¤º
                const banner = document.getElementById('waitingStatusBanner');
                if (banner) {
                    banner.classList.remove('active');
                }
            } catch (error) {
                console.error('é€€å®¤çŠ¶æ…‹ã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
            }
            
            updateHeaderButtons();

            // ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            const systemMsg = document.createElement('div');
            systemMsg.className = 'system-message';
            systemMsg.innerHTML = '<div class="system-message-text">ãƒãƒ£ãƒƒãƒˆãŒçµ‚äº†ã—ã¾ã—ãŸ</div>';
            chatArea.appendChild(systemMsg);
            scrollToBottom();

            // ãŠå®¢æ§˜ã®å ´åˆã®ã¿ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            if (currentUser.type === 'client') {
                setTimeout(() => {
                    showReviewModal();
                }, 500);
            }
        }

        // ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showReviewModal() {
            const modal = document.getElementById('reviewModal');
            const starSelect = document.getElementById('starRating');
            const commentInput = document.getElementById('reviewComment');
            
            // åˆæœŸåŒ–
            starSelect.value = '5'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§â˜…5ã‚’é¸æŠ
            commentInput.value = '';
            
            modal.classList.add('active');
        }

        // ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¹ã‚­ãƒƒãƒ—
        function skipReview() {
            const modal = document.getElementById('reviewModal');
            modal.classList.remove('active');
        }

        // ãƒ¬ãƒ“ãƒ¥ãƒ¼é€ä¿¡
        async function submitReview() {
            const starSelect = document.getElementById('starRating');
            const selectedRating = parseInt(starSelect.value);
            
            if (!selectedRating || selectedRating < 1 || selectedRating > 5) {
                alert('è©•ä¾¡ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const comment = document.getElementById('reviewComment').value.trim();
            const modal = document.getElementById('reviewModal');

            try {
                // ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä¿å­˜
                const reviewId = `${conversationId}_${Date.now()}`;
                const reviewRef = window.firebaseDoc(window.firebaseDB, 'reviews', reviewId);
                
                await window.firebaseSetDoc(reviewRef, {
                    reviewId: reviewId,
                    conversationId: conversationId,
                    fortuneTellerId: fortuneTellerId,
                    clientId: currentUser.uid,
                    rating: selectedRating,
                    comment: comment,
                    createdAt: new Date().toISOString()
                });

                // å ã„å¸«ã®å¹³å‡è©•ä¾¡ã‚’æ›´æ–°
                await updateFortuneTellerRating(fortuneTellerId);
                
                // å ã„å¸«ã®reviewsãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã‚‚è¿½åŠ 
                const ftRef = window.firebaseDoc(window.firebaseDB, 'fortuneTellers', fortuneTellerId);
                const ftDoc = await window.firebaseGetDoc(ftRef);
                if (ftDoc.exists()) {
                    const ftData = ftDoc.data();
                    const existingReviews = ftData.reviews || [];
                    const newReview = {
                        id: reviewId,
                        clientName: currentUser.name || 'åŒ¿å',
                        rating: selectedRating,
                        comment: comment,
                        date: new Date().toISOString(),
                        visible: true
                    };
                    existingReviews.push(newReview);
                    await window.firebaseSetDoc(ftRef, {
                        reviews: existingReviews
                    }, { merge: true });
                }

                modal.classList.remove('active');
                // ã‚¢ãƒ©ãƒ¼ãƒˆå‰Šé™¤

            } catch (error) {
                console.error('ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // å ã„å¸«ã®å¹³å‡è©•ä¾¡ã‚’æ›´æ–°
        async function updateFortuneTellerRating(ftId) {
            try {
                // ã“ã®å ã„å¸«ã®ã™ã¹ã¦ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å–å¾—
                const reviewsRef = window.firebaseCollection(window.firebaseDB, 'reviews');
                const q = window.firebaseQuery(
                    reviewsRef,
                    window.firebaseWhere('fortuneTellerId', '==', ftId)
                );
                const querySnapshot = await window.firebaseGetDocs(q);

                let totalRating = 0;
                let reviewCount = 0;

                querySnapshot.forEach((doc) => {
                    const review = doc.data();
                    totalRating += review.rating;
                    reviewCount++;
                });

                // å¹³å‡è©•ä¾¡ã‚’è¨ˆç®—
                const averageRating = reviewCount > 0 ? (totalRating / reviewCount).toFixed(1) : 0;

                // å ã„å¸«ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
                const ftRef = window.firebaseDoc(window.firebaseDB, 'fortuneTellers', ftId);
                await window.firebaseSetDoc(ftRef, {
                    averageRating: parseFloat(averageRating),
                    totalReviews: reviewCount
                }, { merge: true });

            } catch (error) {
                console.error('è©•ä¾¡æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ã‚«ãƒ«ãƒ†ç”»é¢ã¸é·ç§»
        function goToKarte() {
            // ä¼šè©±IDã‚’localStorageã«ä¿å­˜ã—ã¦ã‚«ãƒ«ãƒ†ç”»é¢ã¸
            if (conversationId) {
                localStorage.setItem('karteReferrer', 'chat'); // æˆ»ã‚‹å…ˆã‚’è¨˜éŒ²
                window.location.href = 'cupids-karte.html';
            } else {
                alert('ä¼šè©±IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
        }

        // æˆ»ã‚‹ãƒœã‚¿ãƒ³
        function goBack() {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦é©åˆ‡ãªãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹
            if (currentUser.type === 'fortune-teller') {
                window.location.href = 'cupids-fortune-lobby.html';
            } else {
                window.location.href = 'cupids-top.html';
            }
        }

        // FirebaseåˆæœŸåŒ–ã‚’å¾…ã£ã¦ã‹ã‚‰å®Ÿè¡Œ
        function initializeChat() {
            if (!window.firebaseReady) {
                // FirebaseãŒã¾ã æº–å‚™ã§ãã¦ã„ãªã„å ´åˆã¯ã€ã‚¤ãƒ™ãƒ³ãƒˆã‚’å¾…ã¤
                window.addEventListener('firebaseReady', initializeChat, { once: true });
                return;
            }
            
            console.log('ğŸš€ ãƒãƒ£ãƒƒãƒˆåˆæœŸåŒ–é–‹å§‹...');
            loadConversationStatus();
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«åˆæœŸåŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeChat);
        } else {
            initializeChat();
        }

        // å ã„å¸«æƒ…å ±å–å¾—ã¨è¡¨ç¤ºï¼ˆFirebaseåˆæœŸåŒ–å¾Œï¼‰
        async function loadFortuneTellerInfo() {
            // FirebaseãŒæº–å‚™ã§ãã¦ã„ãªã„å ´åˆã¯å¾…ã¤
            if (!window.firebaseDB) {
                console.log('â³ Firebaseã®åˆæœŸåŒ–ã‚’å¾…ã£ã¦ã„ã¾ã™...');
                window.addEventListener('firebaseReady', loadFortuneTellerInfo, { once: true });
                return;
            }
            
            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å ã„å¸«IDã‚’å–å¾—
            const urlParams = new URLSearchParams(window.location.search);
            fortuneTellerId = urlParams.get('fortuneTellerId') || localStorage.getItem('selectedFortuneTellerId') || '';
            
            if (!fortuneTellerId) {
                alert('å ã„å¸«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
                window.location.href = 'cupids-top.html';
                return;
            }
            
            // å ã„å¸«æƒ…å ±ã‚’å–å¾—ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä»£å…¥ï¼‰
            fortuneTellerName = 'å ã„å¸«';
            fortuneTellerPrice = 10;
            fortuneTellerImageUrl = '';
            
            try {
                const ftDoc = await window.firebaseGetDoc(
                    window.firebaseDoc(window.firebaseDB, 'fortuneTellers', fortuneTellerId)
                );
                
                if (ftDoc.exists()) {
                    const ftData = ftDoc.data();
                    fortuneTellerName = ftData.name || ftData.displayName || 'å ã„å¸«';
                    fortuneTellerPrice = ftData.price || ftData.pricePerCharacter || 10;
                    fortuneTellerImageUrl = ftData.photoURL || ftData.imageUrl || '';
                    
                    console.log('ğŸ“¸ å ã„å¸«æƒ…å ±:', {
                        name: fortuneTellerName,
                        price: fortuneTellerPrice,
                        imageUrl: fortuneTellerImageUrl,
                        photoURL: ftData.photoURL,
                        imageUrlField: ftData.imageUrl
                    });
                }
            } catch (error) {
                console.error('å ã„å¸«æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            }
            
            // è¡¨ç¤ºå†…å®¹ã‚’åˆ‡ã‚Šæ›¿ãˆ
            if (currentUser.type === 'fortune-teller') {
                // å ã„å¸«ã®å ´åˆï¼šãŠå®¢æ§˜æƒ…å ±ã‚’è¡¨ç¤º
                // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¾ãŸã¯localStorageã‹ã‚‰ãŠå®¢æ§˜IDã‚’å–å¾—
                const urlParams = new URLSearchParams(window.location.search);
                const clientId = urlParams.get('clientId') || localStorage.getItem('selectedClientId');
                
                let clientName = 'ãŠå®¢æ§˜';
                let clientPoints = 0;
                
                if (clientId) {
                    try {
                        const clientDoc = await window.firebaseGetDoc(
                            window.firebaseDoc(window.firebaseDB, 'users', clientId)
                        );
                        if (clientDoc.exists()) {
                            const clientData = clientDoc.data();
                            clientName = clientData.name || 'ãŠå®¢æ§˜';
                            clientPoints = clientData.points || 0;
                        }
                    } catch (error) {
                        console.error('ãŠå®¢æ§˜æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                    }
                }
                
                document.getElementById('ftName').textContent = clientName;
                document.getElementById('ftAvatar').textContent = clientName[0];
                document.getElementById('userPoints').textContent = 'æ‰€æŒãƒã‚¤ãƒ³ãƒˆ ' + clientPoints + 'pt'; // ãŠå®¢æ§˜ã®ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤º
            } else {
                // ãŠå®¢æ§˜ã®å ´åˆï¼šå ã„å¸«æƒ…å ±ã‚’è¡¨ç¤º
                document.getElementById('ftName').textContent = fortuneTellerName;
                
                console.log('ğŸ–¼ï¸ ã‚¢ãƒã‚¿ãƒ¼è¡¨ç¤º:', {
                    fortuneTellerName,
                    fortuneTellerImageUrl,
                    hasImage: !!fortuneTellerImageUrl
                });
                
                const avatarElement = document.getElementById('ftAvatar');
                if (fortuneTellerImageUrl) {
                    console.log('âœ… ç”»åƒURLã‚ã‚Šã€ç”»åƒã‚’è¡¨ç¤º:', fortuneTellerImageUrl);
                    avatarElement.innerHTML = `<img src="${fortuneTellerImageUrl}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                } else {
                    console.log('âŒ ç”»åƒURLãªã—ã€ãƒ†ã‚­ã‚¹ãƒˆã‚’è¡¨ç¤º');
                    avatarElement.textContent = fortuneTellerName[0];
                }

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
                document.getElementById('userPoints').textContent = 'æ‰€æŒãƒã‚¤ãƒ³ãƒˆ ' + (currentUser.points || 0) + 'pt';
            }
        }
        
        // FirebaseåˆæœŸåŒ–å¾Œã«å®Ÿè¡Œ
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadFortuneTellerInfo);
        } else {
            loadFortuneTellerInfo();
        }

        // ãŠå®¢æ§˜ã®å ´åˆã®ç‰¹åˆ¥å‡¦ç†
        if (currentUser.type === 'client') {
            // ç„¡æ–™ãƒãƒ£ãƒƒãƒˆã‚¿ãƒ–ã‚’éè¡¨ç¤º
            const freeTab = document.getElementById('freeTab');
            if (freeTab) {
                freeTab.style.display = 'none';
            }

            // å ã„å¸«ç”¨ã®å®šå‹æ–‡ã‚¨ãƒªã‚¢ã‚’å®Œå…¨ã«å‰Šé™¤
            const fortuneTellerTemplates = document.getElementById('templatesArea');
            if (fortuneTellerTemplates) {
                fortuneTellerTemplates.remove();
            }
        } else {
            // å ã„å¸«ã®å ´åˆã€ãŠå®¢æ§˜ç”¨ã®å®šå‹æ–‡ã‚¨ãƒªã‚¢ã‚’å‰Šé™¤
            const clientTemplates = document.getElementById('clientTemplatesArea');
            if (clientTemplates) {
                clientTemplates.remove();
            }
        }

        // è¦ç´ å–å¾—
        const chatArea = document.getElementById('chatArea');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const charCounter = document.getElementById('charCounter');
        const tabs = document.querySelectorAll('.tab');
        const templatesArea = currentUser.type === 'client' ? document.getElementById('clientTemplatesArea') : document.getElementById('templatesArea');
        const templateItems = templatesArea.querySelectorAll('.template-item');
        const editTemplatesButton = document.getElementById('editTemplatesButton');
        const templateModal = document.getElementById('templateModal');

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                const tabName = tab.dataset.tab;
                if (tabName === 'templates') {
                    templatesArea.classList.add('active');
                    // å®šå‹æ–‡ã‚¿ãƒ–ã§ã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›ã‚’ç„¡åŠ¹åŒ–
                    messageInput.disabled = true;
                    messageInput.placeholder = 'å®šå‹æ–‡ã‚’é¸æŠã—ã¦ãã ã•ã„';
                    sendButton.disabled = true;
                } else {
                    templatesArea.classList.remove('active');
                    // ä»–ã®ã‚¿ãƒ–ã§ã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›ã‚’æœ‰åŠ¹åŒ–
                    messageInput.disabled = false;
                    messageInput.placeholder = 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...';
                    sendButton.disabled = false;
                }
                
                // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆå¾Œã«ãƒã‚¤ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯
                setTimeout(() => checkPointsAvailability(), 100);
            });
        });

        // æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ + å…¥åŠ›å†…å®¹ã‚’è‡ªå‹•ä¿å­˜
        messageInput.addEventListener('input', () => {
            const length = messageInput.value.length;
            charCounter.textContent = `${length} / 500`;
            
            // å…¥åŠ›å†…å®¹ã‚’localStorageã«ä¿å­˜ï¼ˆä¼šè©±ã”ã¨ï¼‰
            if (conversationId) {
                const storageKey = `draft_message_${conversationId}`;
                // ç©ºã§ãªã„å ´åˆã®ã¿ä¿å­˜ã€ç©ºã®å ´åˆã¯å‰Šé™¤
                if (messageInput.value.trim()) {
                    localStorage.setItem(storageKey, messageInput.value);
                } else {
                    localStorage.removeItem(storageKey);
                }
            }
        });

        // è‡ªå‹•ãƒªã‚µã‚¤ã‚º
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 100) + 'px';
        });

        // ç¾åœ¨æ™‚åˆ»ã‚’å–å¾—
        function getCurrentTime() {
            const now = new Date();
            return `${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;
        }
        
        // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’æ™‚åˆ»ã«å¤‰æ›
        function formatTimestamp(timestamp) {
            if (!timestamp) return getCurrentTime();
            
            let date;
            if (timestamp.toDate) {
                // Firebaseã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
                date = timestamp.toDate();
            } else if (timestamp instanceof Date) {
                date = timestamp;
            } else {
                date = new Date(timestamp);
            }
            
            return `${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
        }
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å–å¾—
        async function loadMessages() {
            if (!conversationId) return;
            
            try {
                // messagesã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰è©²å½“ã™ã‚‹ä¼šè©±ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
                const messagesRef = window.firebaseCollection(window.firebaseDB, 'messages');
                // orderByã‚’ä½¿ã‚ãšã«ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¯ã‚¨ãƒªã«ã—ã¦ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä¸è¦ã«
                const q = window.firebaseQuery(
                    messagesRef,
                    window.firebaseWhere('conversationId', '==', conversationId)
                );
                
                // æ—¢å­˜ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¿å­˜ã™ã‚‹é…åˆ—
                const existingMessages = new Set();
                
                // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                window.firebaseOnSnapshot(q, (snapshot) => {
                    const newMessages = [];
                    
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added') {
                            const messageData = change.doc.data();
                            const messageId = change.doc.id;
                            
                            // æ—¢ã«è¡¨ç¤ºæ¸ˆã¿ã§ãªã„å ´åˆã®ã¿è¿½åŠ 
                            if (!existingMessages.has(messageId)) {
                                existingMessages.add(messageId);
                                newMessages.push({
                                    id: messageId,
                                    data: messageData,
                                    timestamp: messageData.timestamp?.toMillis ? messageData.timestamp.toMillis() : new Date(messageData.timestamp).getTime()
                                });
                            }
                        }
                    });
                    
                    // timestampã§ã‚½ãƒ¼ãƒˆã—ã¦ã‹ã‚‰è¡¨ç¤º
                    newMessages.sort((a, b) => a.timestamp - b.timestamp);
                    newMessages.forEach(msg => displayMessage(msg.data));
                });
                
                // ãŠå®¢æ§˜ã®å ´åˆã€ä¼šè©±ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›´ã‚‚ç›£è¦–ï¼ˆãƒ–ãƒ­ãƒƒã‚¯æ¤œçŸ¥ç”¨ï¼‰
                if (currentUser.type === 'client') {
                    setupConversationListener();
                }
            } catch (error) {
                console.error('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // ä¼šè©±ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›´ã‚’ç›£è¦–ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒ–ãƒ­ãƒƒã‚¯æ¤œçŸ¥ï¼‰
        function setupConversationListener() {
            try {
                const convRef = window.firebaseDoc(window.firebaseDB, 'conversations', conversationId);
                
                window.firebaseOnSnapshot(convRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        
                        // ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã®å‡¦ç†ï¼ˆãŠå®¢æ§˜ã®ã¿ï¼‰
                        if (currentUser.type === 'client' && data.blocked && !isBlocked) {
                            console.log('ğŸš« ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒ–ãƒ­ãƒƒã‚¯ã‚’æ¤œçŸ¥ã—ã¾ã—ãŸ');
                            isBlocked = true;
                            conversationStatus = 'ended';
                            
                            // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã§é€šçŸ¥
                            alert('ãƒãƒ£ãƒƒãƒˆãŒçµ‚äº†ã—ã¾ã—ãŸã€‚\nå ã„å¸«ãŒã“ã®ä¼šè©±ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¾ã—ãŸã€‚');
                            
                            // ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                            const systemMsg = document.createElement('div');
                            systemMsg.className = 'system-message';
                            systemMsg.innerHTML = '<div class="system-message-text">ãƒãƒ£ãƒƒãƒˆãŒçµ‚äº†ã—ã¾ã—ãŸ</div>';
                            const chatArea = document.getElementById('chatArea');
                            if (chatArea) {
                                chatArea.appendChild(systemMsg);
                                scrollToBottom();
                            }
                            
                            // è¿”ä¿¡å¾…ã¡ãƒãƒŠãƒ¼ã‚’éè¡¨ç¤º
                            const banner = document.getElementById('waitingStatusBanner');
                            if (banner) {
                                banner.classList.remove('active');
                            }
                            
                            updateHeaderButtons();
                        }
                    }
                });
            } catch (error) {
                console.error('ä¼šè©±ãƒªã‚¹ãƒŠãƒ¼ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”»é¢ã«è¡¨ç¤º
        function displayMessage(messageData) {
            const isSent = messageData.senderId === currentUser.uid;
            const messageType = messageData.messageType || 'paid';
            
            // ç„¡æ–™ãƒãƒ£ãƒƒãƒˆã¾ãŸã¯å®šå‹æ–‡ã®å ´åˆã¯ç™½ã„å¹ãå‡ºã—ã€æœ‰æ–™ãƒãƒ£ãƒƒãƒˆã¯ãƒ”ãƒ³ã‚¯
            let bubbleClass = 'message-bubble';
            if (messageType === 'free' || messageType === 'templates') {
                bubbleClass = 'message-bubble free';
            } else if (messageType === 'paid') {
                bubbleClass = 'message-bubble paid';
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = isSent ? 'message sent' : 'message';
            
            // ã™ã¹ã¦ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã‚¢ãƒã‚¿ãƒ¼ãªã—
            if (isSent) {
                // é€ä¿¡å´ï¼šã‚¢ãƒã‚¿ãƒ¼ãªã—
                messageDiv.innerHTML = `
                    <div class="message-content">
                        <div class="${bubbleClass}">${messageData.text.replace(/\n/g, '<br>')}</div>
                        <div class="message-time">${formatTimestamp(messageData.timestamp)}</div>
                    </div>
                `;
            } else {
                // å—ä¿¡å´ï¼šã‚¢ãƒã‚¿ãƒ¼ãªã—
                messageDiv.innerHTML = `
                    <div class="message-content">
                        <div class="${bubbleClass}">${messageData.text.replace(/\n/g, '<br>')}</div>
                        <div class="message-time">${formatTimestamp(messageData.timestamp)}</div>
                    </div>
                `;
            }
            
            chatArea.appendChild(messageDiv);
            scrollToBottom();
        }

        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        function scrollToBottom() {
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // ãƒã‚¤ãƒ³ãƒˆæ®‹é«˜ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦å…¥åŠ›å¯å¦ã‚’åˆ¶å¾¡
        function checkPointsAvailability() {
            const activeTab = document.querySelector('.tab.active');
            const currentTab = activeTab ? activeTab.dataset.tab : 'paid';
            
            // ç„¡æ–™ãƒãƒ£ãƒƒãƒˆã¾ãŸã¯å®šå‹æ–‡ã®å ´åˆã¯å¸¸ã«åˆ©ç”¨å¯èƒ½
            if (currentTab === 'free' || currentTab === 'templates') {
                messageInput.disabled = false;
                messageInput.placeholder = 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...';
                sendButton.disabled = false;
                sendButton.style.opacity = '1';
                return true;
            }
            
            // æœ‰æ–™ãƒãƒ£ãƒƒãƒˆã§ãŠå®¢æ§˜ã®å ´åˆã®ã¿ãƒã‚¤ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯
            if (currentTab === 'paid' && currentUser.type === 'client') {
                // æœ€ä½1æ–‡å­—åˆ†ã®ãƒã‚¤ãƒ³ãƒˆãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                if (currentUser.points < fortuneTellerPrice) {
                    // ãƒã‚¤ãƒ³ãƒˆä¸è¶³ã®å ´åˆã€å…¥åŠ›ã¨é€ä¿¡ã‚’ç„¡åŠ¹åŒ–
                    messageInput.disabled = true;
                    messageInput.placeholder = 'ãƒã‚¤ãƒ³ãƒˆãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ãƒã‚¤ãƒ³ãƒˆã‚’è³¼å…¥ã—ã¦ãã ã•ã„ã€‚';
                    sendButton.disabled = true;
                    sendButton.style.opacity = '0.5';
                    return false;
                }
            }
            
            // ãƒã‚¤ãƒ³ãƒˆãŒã‚ã‚‹å ´åˆã€ã¾ãŸã¯å ã„å¸«ã®å ´åˆ
            messageInput.disabled = false;
            messageInput.placeholder = 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...';
            sendButton.disabled = false;
            sendButton.style.opacity = '1';
            return true;
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
        async function sendMessage() {
            // å…¥å®¤ãƒã‚§ãƒƒã‚¯
            if (conversationStatus !== 'active') {
                alert('ãƒãƒ£ãƒƒãƒˆã«å…¥å®¤ã—ã¦ã‹ã‚‰é€ä¿¡ã—ã¦ãã ã•ã„');
                return;
            }

            const text = messageInput.value.trim();
            if (!text) return;

            // ç¾åœ¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¿ãƒ–ã‚’å–å¾—
            const activeTab = document.querySelector('.tab.active');
            const currentTab = activeTab ? activeTab.dataset.tab : 'paid';
            
            // å®šå‹æ–‡ã‚¿ãƒ–ã§ã®è‡ªç”±å…¥åŠ›ã‚’æ‹’å¦
            if (currentTab === 'templates') {
                alert('å®šå‹æ–‡ã‚¿ãƒ–ã§ã¯å®šå‹æ–‡ã®ã¿é€ä¿¡ã§ãã¾ã™');
                return;
            }
            
            let pointsSpent = 0; // ä½¿ç”¨ã—ãŸãƒã‚¤ãƒ³ãƒˆã‚’è¨˜éŒ²
            
            // æœ‰æ–™ãƒãƒ£ãƒƒãƒˆã®å ´åˆã¯ãƒã‚¤ãƒ³ãƒˆæ¶ˆè²»
            if (currentTab === 'paid' && currentUser.type === 'client') {
                const messageLength = text.length;
                const requiredPoints = messageLength * fortuneTellerPrice;
                
                if (currentUser.points < requiredPoints) {
                    alert(`ãƒã‚¤ãƒ³ãƒˆãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚å¿…è¦ãƒã‚¤ãƒ³ãƒˆ: ${requiredPoints}ptï¼ˆæ®‹ã‚Š: ${currentUser.points}ptï¼‰`);
                    return;
                }
                
                // ãƒã‚¤ãƒ³ãƒˆã‚’æ¶ˆè²»
                currentUser.points -= requiredPoints;
                pointsSpent = requiredPoints;
                
                // localStorageã«ã¯ä¿å­˜ã—ãªã„ï¼ˆFirebaseã‹ã‚‰å–å¾—ã™ã‚‹ï¼‰
                
                // ç”»é¢ã®ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤ºã‚’æ›´æ–°
                document.getElementById('userPoints').textContent = 'æ‰€æŒãƒã‚¤ãƒ³ãƒˆ ' + currentUser.points + 'pt';
                
                // Firebaseã®ãƒã‚¤ãƒ³ãƒˆã‚’æ›´æ–°
                updateUserPointsInFirebase(currentUser.uid, currentUser.points);
                
                // å ã„å¸«ã®å£²ä¸Šã‚’æ›´æ–°ï¼ˆãƒã‚¤ãƒ³ãƒˆé¡ã‚’ãã®ã¾ã¾å£²ä¸Šã¨ã—ã¦åŠ ç®—ï¼‰
                if (fortuneTellerId) {
                    updateFortuneTellerSales(fortuneTellerId, requiredPoints);
                }
                
                // ãƒã‚¤ãƒ³ãƒˆæ®‹é«˜ã‚’ãƒã‚§ãƒƒã‚¯
                checkPointsAvailability();
            }
            
            // Firebaseã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¿å­˜
            try {
                const messagesRef = window.firebaseCollection(window.firebaseDB, 'messages');
                await window.firebaseAddDoc(messagesRef, {
                    conversationId: conversationId,
                    senderId: currentUser.uid,
                    senderName: currentUser.name || currentUser.email,
                    text: text,
                    messageType: currentTab, // 'paid', 'free', 'templates'
                    pointsSpent: pointsSpent, // ä½¿ç”¨ãƒã‚¤ãƒ³ãƒˆã‚’è¨˜éŒ²
                    timestamp: new Date(),
                    isRead: false
                });
                
                // ä¼šè©±ã®æœ€çµ‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ™‚åˆ»ã‚’æ›´æ–°
                const convRef = window.firebaseDoc(window.firebaseDB, 'conversations', conversationId);
                const convSnap = await window.firebaseGetDoc(convRef);
                const convData = convSnap.exists() ? convSnap.data() : {};
                
                const updateData = {
                    lastMessageAt: new Date().toISOString()
                };
                
                // ãŠå®¢æ§˜ã®æœ‰æ–™ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆ
                if (currentUser.type === 'client' && currentTab === 'paid' && pointsSpent > 0) {
                    // å ã„å¸«ãŒå‰å›è¿”ä¿¡ã—ãŸå¾Œã®ç´¯ç©ãƒã‚¤ãƒ³ãƒˆï¼ˆè¿”é‡‘å¯¾è±¡ãƒã‚¤ãƒ³ãƒˆï¼‰ã‚’æ›´æ–°
                    const pointsSinceLastReply = (convData.pointsSinceLastReply || 0) + pointsSpent;
                    updateData.pointsSinceLastReply = pointsSinceLastReply;
                    
                    // ç´¯ç©æ¶ˆè²»ãƒã‚¤ãƒ³ãƒˆã‚’æ›´æ–°(ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºç”¨)
                    totalPointsSpent += pointsSpent;
                    updateData.totalPointsSpent = totalPointsSpent;
                    console.log('ğŸ’° ç´¯ç©æ¶ˆè²»ãƒã‚¤ãƒ³ãƒˆæ›´æ–°:', totalPointsSpent);
                    
                    // ã€å‰Šé™¤ã€‘è¿”ä¿¡å¾…ã¡ã‚¿ã‚¤ãƒãƒ¼æ©Ÿèƒ½ï¼ˆé‹ç”¨ä¸Šãƒã‚°ã®å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ç„¡åŠ¹åŒ–ï¼‰
                    /*
                    // è¿”ä¿¡å¾…ã¡ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹ï¼ˆã¾ã ç«‹ã£ã¦ã„ãªã‘ã‚Œã°ï¼‰
                    if (!convData.waitingForReply) {
                        updateData.waitingForReply = true;
                        updateData.lastClientMessageAt = new Date().toISOString();
                        console.log('â° è¿”ä¿¡å¾…ã¡ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹:', new Date().toISOString());
                    } else {
                        // æ—¢ã«è¿”ä¿¡å¾…ã¡ä¸­ã®å ´åˆã¯ã€æœ€æ–°ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ™‚åˆ»ã‚’æ›´æ–°
                        updateData.lastClientMessageAt = new Date().toISOString();
                        console.log('â° è¿”ä¿¡å¾…ã¡ã‚¿ã‚¤ãƒãƒ¼ç¶™ç¶šä¸­ã€‚ç´¯ç©:', pointsSinceLastReply, 'pt');
                    }
                    */
                    
                    // ã€å‰Šé™¤ã€‘300ptåˆ°é”æ™‚ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
                    // ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯é€€å®¤æ™‚ã®ã¿è¡¨ç¤º
                }
                
                // å ã„å¸«ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆ
                if (currentUser.type === 'fortune-teller') {
                    // ã€å‰Šé™¤ã€‘è¿”ä¿¡å¾…ã¡ã‚¿ã‚¤ãƒãƒ¼æ©Ÿèƒ½
                    /*
                    // è¿”ä¿¡å¾…ã¡ãƒ•ãƒ©ã‚°ã‚’è§£é™¤
                    updateData.waitingForReply = false;
                    updateData.fortuneTellerLastReplyAt = new Date().toISOString();
                    // å ã„å¸«ãŒè¿”ä¿¡ã—ãŸã®ã§ã€è¿”é‡‘å¯¾è±¡ãƒã‚¤ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
                    updateData.pointsSinceLastReply = 0;
                    console.log('âœ… å ã„å¸«ãŒè¿”ä¿¡ã—ã¾ã—ãŸã€‚è¿”é‡‘å¯¾è±¡ãƒã‚¤ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ');
                    */
                }
                
                await window.firebaseSetDoc(convRef, updateData, { merge: true });
                
                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ãƒªã‚¹ãƒŠãƒ¼ã§è‡ªå‹•è¡¨ç¤ºã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã®è¡¨ç¤ºã¯ä¸è¦
                
            } catch (error) {
                console.error('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
                return;
            }
            
            // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
            messageInput.value = '';
            charCounter.textContent = '0 / 500';
            messageInput.style.height = 'auto';
            
            // ä¸‹æ›¸ãã‚‚å‰Šé™¤
            const storageKey = `draft_message_${conversationId}`;
            localStorage.removeItem(storageKey);
        }

        // Firebaseã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒã‚¤ãƒ³ãƒˆã‚’æ›´æ–°
        async function updateUserPointsInFirebase(uid, points) {
            try {
                const userRef = window.firebaseDoc(window.firebaseDB, 'users', uid);
                await window.firebaseSetDoc(userRef, { points: points }, { merge: true });
                
                // ä¼šè©±ãƒ‡ãƒ¼ã‚¿ã«ã‚‚æœ€æ–°ãƒã‚¤ãƒ³ãƒˆã‚’ä¿å­˜ï¼ˆå ã„å¸«ãŒè¦‹ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ï¼‰
                if (conversationId && currentUser.type === 'client') {
                    const convRef = window.firebaseDoc(window.firebaseDB, 'conversations', conversationId);
                    await window.firebaseSetDoc(convRef, { 
                        clientPoints: points,
                        lastUpdatedAt: new Date().toISOString()
                    }, { merge: true });
                }
            } catch (error) {
                console.error('ãƒã‚¤ãƒ³ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // å ã„å¸«ã®å£²ä¸Šã‚’æ›´æ–°
        async function updateFortuneTellerSales(ftId, salesAmount) {
            try {
                const ftRef = window.firebaseDoc(window.firebaseDB, 'fortuneTellers', ftId);
                const ftDoc = await window.firebaseGetDoc(ftRef);
                
                if (ftDoc.exists()) {
                    const currentSales = ftDoc.data().currentMonthSales || 0;
                    await window.firebaseSetDoc(ftRef, {
                        currentMonthSales: currentSales + salesAmount
                    }, { merge: true });
                }
            } catch (error) {
                console.error('å£²ä¸Šæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // é€ä¿¡ãƒœã‚¿ãƒ³
        sendButton.addEventListener('click', sendMessage);

        // Enterã‚­ãƒ¼ã§é€ä¿¡
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // å®šå‹æ–‡é¸æŠ
        templateItems.forEach(item => {
            item.addEventListener('click', async () => {
                // å…¥å®¤ãƒã‚§ãƒƒã‚¯
                if (conversationStatus !== 'active') {
                    alert('ãƒãƒ£ãƒƒãƒˆã«å…¥å®¤ã—ã¦ã‹ã‚‰é€ä¿¡ã—ã¦ãã ã•ã„');
                    return;
                }

                const text = item.dataset.text;
                if (!text) return;
                
                // Firebaseã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¿å­˜
                try {
                    const messagesRef = window.firebaseCollection(window.firebaseDB, 'messages');
                    await window.firebaseAddDoc(messagesRef, {
                        conversationId: conversationId,
                        senderId: currentUser.uid,
                        senderName: currentUser.name || currentUser.email,
                        text: text,
                        messageType: 'templates', // å®šå‹æ–‡
                        timestamp: new Date(),
                        isRead: false
                    });
                    
                    // ä¼šè©±ã®æœ€çµ‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ™‚åˆ»ã‚’æ›´æ–°
                    const convRef = window.firebaseDoc(window.firebaseDB, 'conversations', conversationId);
                    const updateData = {
                        lastMessageAt: new Date().toISOString()
                    };
                    
                    // ã€å‰Šé™¤ã€‘è¿”ä¿¡å¾…ã¡ã‚¿ã‚¤ãƒãƒ¼æ©Ÿèƒ½
                    /*
                    // å ã„å¸«ãŒå®šå‹æ–‡ã‚’é€ã£ãŸå ´åˆã‚‚è¿”é‡‘ã‚¿ã‚¤ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
                    if (currentUser.type === 'fortune-teller') {
                        updateData.waitingForReply = false;
                        updateData.fortuneTellerLastReplyAt = new Date().toISOString();
                        updateData.pointsSinceLastReply = 0;
                        console.log('âœ… å ã„å¸«ãŒå®šå‹æ–‡ã§è¿”ä¿¡ã—ã¾ã—ãŸã€‚è¿”é‡‘å¯¾è±¡ãƒã‚¤ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ');
                    }
                    */
                    
                    await window.firebaseSetDoc(convRef, updateData, { merge: true });
                    
                    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ãƒªã‚¹ãƒŠãƒ¼ã§è‡ªå‹•è¡¨ç¤ºã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã®è¡¨ç¤ºã¯ä¸è¦
                    
                } catch (error) {
                    console.error('å®šå‹æ–‡é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                    alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    return;
                }
                
                // ãŠå®¢æ§˜ã®å ´åˆã¯æœ‰æ–™ãƒãƒ£ãƒƒãƒˆã‚¿ãƒ–ã«ã€å ã„å¸«ã®å ´åˆã¯ç„¡æ–™ãƒãƒ£ãƒƒãƒˆã‚¿ãƒ–ã«æˆ»ã‚‹
                tabs.forEach(t => t.classList.remove('active'));
                if (currentUser.type === 'client') {
                    tabs[0].classList.add('active'); // æœ‰æ–™ãƒãƒ£ãƒƒãƒˆ(ãŠå®¢æ§˜ã®å ´åˆã¯0ç•ªç›®)
                } else {
                    tabs[0].classList.add('active'); // ç„¡æ–™ãƒãƒ£ãƒƒãƒˆ
                }
                templatesArea.classList.remove('active');
                
                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›ã‚’å†åº¦æœ‰åŠ¹åŒ–
                messageInput.disabled = false;
                messageInput.placeholder = 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...';
                sendButton.disabled = false;
            });
        });

        // å®šå‹æ–‡ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«(å ã„å¸«ã®ã¿)
        if (editTemplatesButton) {
            editTemplatesButton.addEventListener('click', () => {
                templateModal.classList.add('active');
            });
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        templateModal.addEventListener('click', (e) => {
            if (e.target === templateModal) {
                templateModal.classList.remove('active');
            }
        });

        // åˆæœŸã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        scrollToBottom();
        
        // åˆæœŸãƒã‚¤ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯
        checkPointsAvailability();
        
        // ä¸‹æ›¸ããƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¾©å…ƒ
        if (conversationId) {
            const storageKey = `draft_message_${conversationId}`;
            const draftMessage = localStorage.getItem(storageKey);
            if (draftMessage) {
                messageInput.value = draftMessage;
                // æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚‚æ›´æ–°
                charCounter.textContent = `${draftMessage.length} / 500`;
                // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®é«˜ã•ã‚‚èª¿æ•´
                messageInput.style.height = 'auto';
                messageInput.style.height = Math.min(messageInput.scrollHeight, 100) + 'px';
            }
        }

        // æˆ»ã‚‹ãƒœã‚¿ãƒ³
        function goBack() {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦é©åˆ‡ãªãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹
            if (currentUser.type === 'fortune-teller') {
                window.location.href = 'cupids-fortune-lobby.html';
            } else {
                window.location.href = 'cupids-top.html';
            }
        }
    </script>

    <!-- ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="review-modal" id="reviewModal">
        <div class="review-content">
            <div class="review-title">é‘‘å®šã¯ã„ã‹ãŒã§ã—ãŸã‹?</div>
            <div class="review-subtitle">å ã„å¸«ã•ã‚“ã¸ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãŠé¡˜ã„ã—ã¾ã™</div>
            
            <div style="margin-bottom: 25px;">
                <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">è©•ä¾¡ã‚’é¸æŠ</label>
                <select id="starRating" style="width: 100%; padding: 12px; border: 1px solid #DDD; border-radius: 10px; font-size: 16px; background: white; cursor: pointer;">
                    <option value="5">â˜…â˜…â˜…â˜…â˜… (5)</option>
                    <option value="4">â˜…â˜…â˜…â˜…â˜† (4)</option>
                    <option value="3">â˜…â˜…â˜…â˜†â˜† (3)</option>
                    <option value="2">â˜…â˜…â˜†â˜†â˜† (2)</option>
                    <option value="1">â˜…â˜†â˜†â˜†â˜† (1)</option>
                </select>
            </div>

            <textarea 
                class="review-comment" 
                id="reviewComment" 
                placeholder="ã‚ˆã‹ã£ãŸç‚¹ã‚„æ„Ÿæƒ³ã‚’ãŠèã‹ã›ãã ã•ã„(ä»»æ„)"
                maxlength="500"
            ></textarea>

            <div class="review-buttons">
                <button class="review-button skip" onclick="skipReview()">ã‚¹ã‚­ãƒƒãƒ—</button>
                <button class="review-button submit" onclick="submitReview()">é€ä¿¡ã™ã‚‹</button>
            </div>
        </div>
    </div>
</body>
</html>

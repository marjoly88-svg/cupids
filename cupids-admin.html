<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ç®¡ç†ç”»é¢ - ã‚­ãƒ¥ãƒ¼ãƒ”ãƒƒã‚º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Hiragino Sans", sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding-bottom: 20px;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            background: linear-gradient(to right, #ec4899, #a855f7);
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 24px;
            font-weight: bold;
            color: #fff;
        }

        .logout-button {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .logout-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* ã‚³ãƒ³ãƒ†ãƒŠ */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* çµ±è¨ˆã‚«ãƒ¼ãƒ‰ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #fff;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }

        /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .section {
            background: #fff;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        /* ãƒ†ãƒ¼ãƒ–ãƒ« */
        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            background: #f9fafb;
            padding: 12px;
            text-align: left;
            font-size: 14px;
            color: #666;
            font-weight: 600;
            border-bottom: 2px solid #e5e7eb;
        }

        .table td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 14px;
            color: #333;
        }

        .table tr:hover {
            background: #f9fafb;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç”¨ãƒ©ãƒƒãƒ‘ãƒ¼ */
        .users-table-wrapper,
        .fortunetellers-table-wrapper,
        .reviews-table-wrapper {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow-y: auto;
        }

        .users-table-wrapper {
            max-height: 260px; /* ã ã„ãŸã„5ä»¶åˆ† */
        }

        .fortunetellers-table-wrapper {
            max-height: 260px; /* 3ã€œ4ä»¶åˆ† */
        }

        .reviews-table-wrapper {
            max-height: 260px; /* 5ä»¶åˆ†ãã‚‰ã„ */
        }

        .users-table-wrapper::-webkit-scrollbar,
        .fortunetellers-table-wrapper::-webkit-scrollbar,
        .reviews-table-wrapper::-webkit-scrollbar {
            width: 8px;
        }

        .users-table-wrapper::-webkit-scrollbar-track,
        .fortunetellers-table-wrapper::-webkit-scrollbar-track,
        .reviews-table-wrapper::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .users-table-wrapper::-webkit-scrollbar-thumb,
        .fortunetellers-table-wrapper::-webkit-scrollbar-thumb,
        .reviews-table-wrapper::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        /* ãƒœã‚¿ãƒ³ */
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #3b82f6;
            color: #fff;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-danger {
            background: #ef4444;
            color: #fff;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-success {
            background: #10b981;
            color: #fff;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #d1d5db;
        }

        .star-display {
            color: #ffb800;
            font-size: 16px;
        }

        .fixed-badge {
            display: inline-block;
            padding: 2px 8px;
            background: #fef3c7;
            color: #92400e;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 6px;
        }

        /* ã‚¹ãƒãƒ›ç”¨å ã„å¸«ã‚«ãƒ¼ãƒ‰ï¼ˆãã®ã¾ã¾æ®‹ã—ï¼‰ */
        .fortunetellers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .ft-card {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
        }

        .ft-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .ft-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .ft-card-name {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
        }

        .ft-card-email {
            font-size: 13px;
            color: #666;
        }

        .ft-card-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .ft-card-status.active {
            background: #def7ec;
            color: #03543f;
        }

        .ft-card-status.inactive {
            background: #fee2e2;
            color: #991b1b;
        }

        .ft-card-info {
            margin: 15px 0;
            padding: 15px 0;
            border-top: 1px solid #f3f4f6;
            border-bottom: 1px solid #f3f4f6;
        }

        .ft-card-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .ft-card-info-label {
            font-size: 13px;
            color: #666;
        }

        .ft-card-info-value {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .ft-card-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 15px;
        }

        @media (min-width: 1024px) {
            .fortunetellers-grid {
                display: none;
            }
            .fortunetellers-table-wrapper {
                display: block;
            }
        }

        @media (max-width: 1023px) {
            .fortunetellers-grid {
                display: grid;
            }
            .fortunetellers-table-wrapper {
                display: none;
            }
        }

        /* ãƒ•ã‚©ãƒ¼ãƒ  */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .form-group small {
            display: block;
            margin-top: 4px;
        }

        /* ãƒ©ãƒ³ã‚­ãƒ³ã‚° */
        .ranking-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .ranking-item {
            background: #f9fafb;
            border-radius: 12px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.2s;
        }

        .ranking-item:hover {
            background: #f3f4f6;
            transform: translateX(5px);
        }

        .ranking-medal {
            font-size: 32px;
            min-width: 40px;
            text-align: center;
        }

        .ranking-number {
            font-size: 20px;
            font-weight: bold;
            color: #666;
            min-width: 40px;
            text-align: center;
        }

        .ranking-info {
            flex: 1;
        }

        .ranking-name {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
        }

        .ranking-email {
            font-size: 12px;
            color: #666;
        }

        .ranking-sales {
            text-align: right;
        }

        .ranking-amount {
            font-size: 20px;
            font-weight: bold;
            color: #10b981;
        }

        .ranking-commission {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«å…±é€š */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #fff;
            border-radius: 15px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3,
        .modal-header h2 {
            margin: 0;
            font-size: 20px;
            color: #333;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: #666;
        }

        .modal-body {
            padding: 20px;
        }
    </style>
</head>
<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="header">
        <div class="header-content">
            <div class="header-title">ğŸ”§ ç®¡ç†ç”»é¢</div>
            <button class="logout-button" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
    </div>

    <div class="container">
        <!-- çµ±è¨ˆã‚«ãƒ¼ãƒ‰ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°</div>
                <div class="stat-value" id="totalUsers">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">å ã„å¸«æ•°</div>
                <div class="stat-value" id="totalFortuneTellers">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ä»Šæœˆã®ç·å£²ä¸Š</div>
                <div class="stat-value" id="monthlyRevenue">Â¥0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ä»Šæœˆã®åˆ©ç›Š</div>
                <div class="stat-value" id="monthlyProfit">Â¥0</div>
            </div>
        </div>

        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ -->
        <div class="section" id="section-users">
            <div class="section-title">ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</div>
            <div class="users-table-wrapper">
                <table class="table">
                    <thead>
                        <tr>
                            <th>åå‰</th>
                            <th>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</th>
                            <th>ã‚¿ã‚¤ãƒ—</th>
                            <th>ãƒã‚¤ãƒ³ãƒˆ</th>
                            <th>ç™»éŒ²æ—¥</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="usersList">
                        <tr>
                            <td colspan="6" class="loading">èª­ã¿è¾¼ã¿ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- å ã„å¸«ä¸€è¦§ -->
        <div class="section" id="section-fortune-tellers">
            <div class="section-title">ğŸ”® å ã„å¸«ä¸€è¦§</div>

            <!-- PCç”¨ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º -->
            <div class="fortunetellers-table-wrapper">
                <table class="table">
                    <thead>
                        <tr>
                            <th>åå‰</th>
                            <th>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</th>
                            <th>å°‚é–€åˆ†é‡</th>
                            <th>æ–™é‡‘</th>
                            <th>è©•ä¾¡</th>
                            <th>å ±é…¬ç‡</th>
                            <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                            <th>é‘‘å®šä¸­ãƒ€ãƒŸãƒ¼</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="fortunetellersList">
                        <tr>
                            <td colspan="9" class="loading">èª­ã¿è¾¼ã¿ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- ã‚¹ãƒãƒ›ãƒ»ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç”¨ã‚«ãƒ¼ãƒ‰è¡¨ç¤º -->
            <div class="fortunetellers-grid" id="fortunetellersGrid">
                <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
        </div>

        <!-- ãƒ¬ãƒ“ãƒ¥ãƒ¼ç®¡ç† -->
        <div class="section" id="section-reviews">
            <div class="section-title">
                <span>â­ ãƒ¬ãƒ“ãƒ¥ãƒ¼ç®¡ç†</span>
                <button class="btn btn-primary" onclick="showAddReviewModal()" style="padding: 8px 16px; font-size: 14px;">
                    â• ãƒ¬ãƒ“ãƒ¥ãƒ¼è¿½åŠ 
                </button>
            </div>
            <div class="reviews-table-wrapper">
                <table class="table">
                    <thead>
                        <tr>
                            <th>å ã„å¸«</th>
                            <th>ãŠå®¢æ§˜</th>
                            <th>è©•ä¾¡</th>
                            <th>ã‚³ãƒ¡ãƒ³ãƒˆ</th>
                            <th>æŠ•ç¨¿æ—¥</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="reviewsList">
                        <tr>
                            <td colspan="6" class="loading">èª­ã¿è¾¼ã¿ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- å ã„å¸«å£²ä¸Šãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
        <div class="section" id="section-ranking">
            <div class="section-title">ğŸ† ä»Šæœˆã®å£²ä¸Šãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>
            <div class="ranking-list" id="rankingList">
                <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
        </div>

        <!-- å ã„å¸«ç™»éŒ²ï¼ˆã„ã¡ã°ã‚“ä¸‹ï¼‰ -->
        <div class="section" id="section-register">
            <div class="section-title">â• å ã„å¸«ã‚’ç™»éŒ²</div>
            <form id="addFortuneTellerForm" style="max-width: 600px;">
                <div class="form-row">
                    <div class="form-group">
                        <label>å ã„å¸«å *</label>
                        <input type="text" id="ftName" required />
                    </div>
                    <div class="form-group">
                        <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ *</label>
                        <input type="email" id="ftEmail" required />
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ *</label>
                        <input type="text" id="ftPassword" value="cupids123" required />
                        <small style="color: #666; font-size: 12px;">å¾Œã§å¤‰æ›´ã§ãã¾ã™</small>
                    </div>
                    <div class="form-group">
                        <label>1æ–‡å­—ã‚ãŸã‚Šã®æ–™é‡‘ï¼ˆptï¼‰ *</label>
                        <input type="number" id="ftPrice" min="1" value="10" required />
                    </div>
                </div>

                <div class="form-group">
                    <label>è‡ªå·±ç´¹ä»‹ãƒ»ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ *</label>
                    <textarea id="ftMessage" rows="4" required placeholder="ãŠå®¢æ§˜ã«å‘ã‘ãŸè‡ªå·±ç´¹ä»‹æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
                </div>

                <div class="form-group">
                    <label>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ</label>
                    <input type="file" id="ftImage" accept="image/*" />
                    <small style="color: #666; font-size: 12px; display: block; margin-top: 4px;">
                        â€» ç”»åƒã¯å††å½¢ã«ãƒˆãƒªãƒŸãƒ³ã‚°ã•ã‚Œã¦è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚
                    </small>
                    <div id="imagePreview" style="margin-top: 15px; display: none;">
                        <div style="font-size: 13px; color: #666; margin-bottom: 8px; font-weight: 600;">
                            ğŸ“· ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆå®Ÿéš›ã®è¡¨ç¤ºã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰
                        </div>
                        <!-- å††ã®ã‚µã‚¤ã‚ºèª¿æ•´ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ -->
                        <div style="margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                            <label style="font-size: 12px; color: #666; font-weight: 600; white-space: nowrap;">å††ã®ã‚µã‚¤ã‚º:</label>
                            <input type="range" id="circleSize" min="20" max="50" value="35" step="1" style="flex: 1; max-width: 200px;" />
                            <span id="circleSizeValue" style="font-size: 12px; color: #666; font-weight: 600; min-width: 40px;">35%</span>
                        </div>
                        <!-- ç”»åƒä½ç½®èª¿æ•´ -->
                        <div style="margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                            <label style="font-size: 12px; color: #666; font-weight: 600; white-space: nowrap;">ç”»åƒä½ç½®:</label>
                            <button type="button" onclick="moveImage('up')" style="padding: 4px 8px; font-size: 12px;">â†‘</button>
                            <button type="button" onclick="moveImage('down')" style="padding: 4px 8px; font-size: 12px;">â†“</button>
                            <button type="button" onclick="moveImage('left')" style="padding: 4px 8px; font-size: 12px;">â†</button>
                            <button type="button" onclick="moveImage('right')" style="padding: 4px 8px; font-size: 12px;">â†’</button>
                            <button type="button" onclick="resetImagePosition()" style="padding: 4px 8px; font-size: 12px;">ãƒªã‚»ãƒƒãƒˆ</button>
                        </div>
                        <!-- ç”»åƒã‚µã‚¤ã‚ºèª¿æ•´ -->
                        <div style="margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                            <label style="font-size: 12px; color: #666; font-weight: 600; white-space: nowrap;">ç”»åƒã‚µã‚¤ã‚º:</label>
                            <input type="range" id="imageScale" min="50" max="200" value="100" step="5" style="flex: 1; max-width: 200px;" />
                            <span id="imageScaleValue" style="font-size: 12px; color: #666; font-weight: 600; min-width: 45px;">100%</span>
                        </div>
                        <div style="position: relative; display: inline-block; overflow: hidden; border-radius: 10px; width: 200px; height: 200px; background: #f0f0f0;">
                            <img
                                id="previewImg"
                                style="position: absolute; width: 100%; height: auto; top: 0; left: 0; cursor: move;"
                                alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼"
                                draggable="true"
                            />
                            <!-- å††å½¢ã‚¬ã‚¤ãƒ‰ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
                            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
                                <svg width="100%" height="100%" style="position: absolute; top: 0; left: 0;">
                                    <rect width="100%" height="100%" fill="rgba(0,0,0,0.3)" />
                                    <mask id="circleMask">
                                        <rect width="100%" height="100%" fill="white" />
                                        <circle id="previewCircleFill" cx="50%" cy="50%" r="35%" fill="black" />
                                    </mask>
                                    <rect width="100%" height="100%" fill="rgba(0,0,0,0.5)" mask="url(#circleMask)" />
                                    <circle id="previewCircleStroke" cx="50%" cy="50%" r="35%" fill="none" stroke="#ec4899" stroke-width="3" stroke-dasharray="5,5" />
                                </svg>
                            </div>
                        </div>
                        <div style="font-size: 12px; color: #666; margin-top: 10px;">
                            ğŸ’¡ çŸ¢å°ãƒœã‚¿ãƒ³ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°ã§ç”»åƒã®ä½ç½®ã‚’èª¿æ•´ã§ãã¾ã™
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 12px; font-size: 16px;">
                    å ã„å¸«ã‚’ç™»éŒ²
                </button>
            </form>
        </div>
    </div>

    <!-- ãƒ¬ãƒ“ãƒ¥ãƒ¼è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="addReviewModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>â• ãƒ¬ãƒ“ãƒ¥ãƒ¼è¿½åŠ </h3>
                <button class="modal-close" onclick="closeAddReviewModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>å ã„å¸«ã‚’é¸æŠ</label>
                    <select id="reviewFortuneTeller" class="form-control">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ãŠå®¢æ§˜åï¼ˆä»»æ„ï¼‰</label>
                    <input type="text" id="reviewClientName" class="form-control" placeholder="åŒ¿å" value="åŒ¿å" />
                </div>
                <div class="form-group">
                    <label>è©•ä¾¡ï¼ˆâ˜…1ã€œ5ï¼‰</label>
                    <select id="reviewRating" class="form-control">
                        <option value="5">â˜…â˜…â˜…â˜…â˜… (5)</option>
                        <option value="4">â˜…â˜…â˜…â˜…â˜† (4)</option>
                        <option value="3">â˜…â˜…â˜…â˜†â˜† (3)</option>
                        <option value="2">â˜…â˜…â˜†â˜†â˜† (2)</option>
                        <option value="1">â˜…â˜†â˜†â˜†â˜† (1)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆä»»æ„ï¼‰</label>
                    <textarea id="reviewComment" class="form-control" rows="4" placeholder="ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆ"></textarea>
                </div>
                <button class="btn btn-primary" onclick="submitAddReview()" style="width: 100%; padding: 12px;">
                    âœ… ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¿½åŠ 
                </button>
            </div>
        </div>
    </div>

    <!-- ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="manageReviewCountModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3>ğŸ”¢ ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°ç®¡ç†</h3>
                <button class="modal-close" onclick="closeManageReviewCountModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label id="manageReviewCountLabel">å ã„å¸«: </label>
                    <input type="number" id="manageReviewCount" class="form-control" min="0" placeholder="ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°ã‚’å…¥åŠ›" />
                    <small style="color: #666; display: block; margin-top: 8px;">
                        â€» ã“ã®æ•°å€¤ã¯è¡¨ç¤ºç”¨ã®åŸºæº–å€¤ã§ã™ã€‚<br />
                        â€» ãŠå®¢æ§˜ãŒæ–°è¦ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æŠ•ç¨¿ã™ã‚‹ã¨ã€ã“ã®æ•°å€¤ã«+1ã•ã‚Œã¾ã™ã€‚
                    </small>
                </div>
                <button class="btn btn-primary" onclick="submitManageReviewCount()" style="width: 100%; padding: 12px;">
                    âœ… ä¿å­˜
                </button>
            </div>
        </div>
    </div>

    <!-- é‘‘å®šä¸­ãƒ€ãƒŸãƒ¼ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="dummyClientsModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3>ğŸ‘¥ é‘‘å®šä¸­ãƒ€ãƒŸãƒ¼è¨­å®š</h3>
                <button class="modal-close" onclick="closeDummyClientsModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label id="dummyClientsLabel">å ã„å¸«: </label>
                    <input type="number" id="dummyClientsCount" class="form-control" min="0" placeholder="ãƒ€ãƒŸãƒ¼äººæ•°ã‚’å…¥åŠ›" />
                    <small style="color: #666; display: block; margin-top: 8px;">
                        â€» å®Ÿéš›ã®é‘‘å®šä¸­äººæ•°ã«ã“ã®æ•°å€¤ãŒåŠ ç®—ã•ã‚Œã¦è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚<br />
                        ä¾‹: å®Ÿéš›1äººé‘‘å®šä¸­ + ãƒ€ãƒŸãƒ¼10äºº = è¡¨ç¤º11äººé‘‘å®šä¸­
                    </small>
                </div>
                <button class="btn btn-primary" onclick="submitDummyClients()" style="width: 100%; padding: 12px;">
                    âœ… ä¿å­˜
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK åˆæœŸåŒ– -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import {
            getAuth,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import {
            getFirestore,
            collection,
            getDocs,
            doc,
            getDoc,
            setDoc,
            updateDoc,
            deleteDoc,
            query,
            where,
            orderBy
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import {
            getStorage,
            ref,
            uploadBytes,
            getDownloadURL
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA52uJ31HzLkbz32lA-3WWSmhM10xYjjCg",
            authDomain: "cupids-chat.firebaseapp.com",
            projectId: "cupids-chat",
            storageBucket: "cupids-chat.firebasestorage.app",
            messagingSenderId: "44532110483",
            appId: "1:44532110483:web:d6266e8abba8582b8b6966"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // ç®¡ç†è€…èªè¨¼ï¼ˆæ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
        signInWithEmailAndPassword(auth, "admin@cupids-chat.com", "memetan1031admin")
            .then(() => console.log("âœ… ç®¡ç†è€…èªè¨¼æˆåŠŸ"))
            .catch(error => {
                if (error.code === "auth/user-not-found") {
                    createUserWithEmailAndPassword(auth, "admin@cupids-chat.com", "memetan1031admin")
                        .then(() => console.log("âœ… ç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ"))
                        .catch(e => console.error("ä½œæˆã‚¨ãƒ©ãƒ¼:", e));
                }
            });

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å‡ºã™
        window.firebaseAuth = auth;
        window.firebaseDB = db;
        window.firebaseStorage = storage;
        window.firebaseCreateUser = createUserWithEmailAndPassword;
        window.firebaseStorageRef = ref;
        window.firebaseUploadBytes = uploadBytes;
        window.firebaseGetDownloadURL = getDownloadURL;
        window.firebaseCollection = collection;
        window.firebaseGetDocs = getDocs;
        window.firebaseDoc = doc;
        window.firebaseGetDoc = getDoc;
        window.firebaseSetDoc = setDoc;
        window.firebaseUpdateDoc = updateDoc;
        window.firebaseDeleteDoc = deleteDoc;
        window.firebaseQuery = query;
        window.firebaseWhere = where;
        window.firebaseOrderBy = orderBy;

        window.firebaseReady = true;
        window.dispatchEvent(new Event("firebaseReady"));
        console.log("âœ… FirebaseåˆæœŸåŒ–å®Œäº†!");

        // å¿µã®ãŸã‚
        setTimeout(() => {
            if (window.loadData && typeof window.loadData === "function") {
                console.log("ğŸš€ loadDataå®Ÿè¡Œé–‹å§‹...");
                window.loadData();
            } else {
                console.error("âŒ loadDataé–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
            }
        }, 2000);
    </script>

    <!-- ã‚¢ãƒ—ãƒªæœ¬ä½“ -->
    <script>
        // ==== ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯ ====
        const currentUser = JSON.parse(localStorage.getItem("currentUser") || "null");
        if (!currentUser || currentUser.type !== "admin") {
            alert("ç®¡ç†è€…ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„");
            window.location.href = "cupids-top.html";
        }

        let cachedUsers = [];
        let cachedFortuneTellers = [];
        let currentManagingFortuneTellerId = null;
        let currentDummyFtId = null;

        // ==== ãƒ¡ã‚¤ãƒ³èª­ã¿è¾¼ã¿ ====
        window.loadData = async function () {
            if (!window.firebaseReady || !window.firebaseDB) {
                console.log("â³ FirebaseåˆæœŸåŒ–å¾…æ©Ÿä¸­...");
                setTimeout(loadData, 500);
                return;
            }

            console.log("ğŸ“Š ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹...");

            try {
                // users
                const usersSnapshot = await window.firebaseGetDocs(
                    window.firebaseCollection(window.firebaseDB, "users")
                );
                const users = [];
                usersSnapshot.forEach(docSnap => {
                    users.push({ id: docSnap.id, ...docSnap.data() });
                });

                // fortuneTellers
                const ftSnapshot = await window.firebaseGetDocs(
                    window.firebaseCollection(window.firebaseDB, "fortuneTellers")
                );
                const fortuneTellers = [];
                ftSnapshot.forEach(docSnap => {
                    fortuneTellers.push({ id: docSnap.id, ...docSnap.data() });
                });

                cachedUsers = users;
                cachedFortuneTellers = fortuneTellers;

                // çµ±è¨ˆ
                document.getElementById("totalUsers").textContent = users.length;
                document.getElementById("totalFortuneTellers").textContent = fortuneTellers.length;

                let monthlyRevenue = 0;
                let totalCommission = 0;

                fortuneTellers.forEach(ft => {
                    const revenue = ft.currentMonthRevenue || 0;
                    monthlyRevenue += revenue;

                    let commissionRate;
                    if (ft.fixedCommissionRate) {
                        commissionRate = ft.fixedCommissionRate;
                    } else {
                        const previousRevenue = ft.previousMonthRevenue || 0;
                        if (previousRevenue >= 270000) commissionRate = 40;
                        else if (previousRevenue >= 210000) commissionRate = 38;
                        else if (previousRevenue >= 150000) commissionRate = 36;
                        else if (previousRevenue >= 90000) commissionRate = 34;
                        else if (previousRevenue >= 30000) commissionRate = 32;
                        else commissionRate = 30;
                    }
                    totalCommission += revenue * (commissionRate / 100);
                });

                const monthlyProfit = monthlyRevenue - totalCommission;

                document.getElementById("monthlyRevenue").textContent =
                    "Â¥" + Math.floor(monthlyRevenue).toLocaleString();
                document.getElementById("monthlyProfit").textContent =
                    "Â¥" + Math.floor(monthlyProfit).toLocaleString();

                displayUsers(users);
                displayFortuneTellers(fortuneTellers);
                await loadReviews();
                displayRanking(fortuneTellers);
            } catch (error) {
                console.error("ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
                document.getElementById("totalUsers").textContent = "0";
                document.getElementById("totalFortuneTellers").textContent = "0";
                document.getElementById("monthlyRevenue").textContent = "Â¥0";
                document.getElementById("monthlyProfit").textContent = "Â¥0";
            }
        };

        // ==== ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ ====
        function displayUsers(users) {
            // createdAt ãŒæ–°ã—ã„é †
            users.sort((a, b) => {
                const aTime = a.createdAt ? new Date(a.createdAt).getTime() : 0;
                const bTime = b.createdAt ? new Date(b.createdAt).getTime() : 0;
                return bTime - aTime;
            });

            const tbody = document.getElementById("usersList");
            const wrapper = document.querySelector(".users-table-wrapper");

            if (wrapper) {
                wrapper.style.maxHeight = "260px";
                wrapper.style.overflowY = "auto";
            }

            if (!users.length) {
                tbody.innerHTML =
                    '<tr><td colspan="6" style="text-align:center;color:#999;">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã¾ã›ã‚“</td></tr>';
                return;
            }

            tbody.innerHTML = "";
            users.forEach(user => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${user.name || "-"}</td>
                    <td>${user.email || "-"}</td>
                    <td>${user.type === "client" ? "ãŠå®¢æ§˜" : user.type || "-"}</td>
                    <td>${user.points || 0}pt</td>
                    <td>${user.createdAt ? new Date(user.createdAt).toLocaleDateString("ja-JP") : "-"}</td>
                    <td>
                        <button onclick="addPointsToUser('${user.id}', '${user.name || ""}')" 
                                style="background:#4CAF50;color:#fff;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;">
                            â• ãƒã‚¤ãƒ³ãƒˆè¿½åŠ 
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ==== å ã„å¸«ä¸€è¦§ ====
        function calcCommissionRate(ft) {
            if (ft.fixedCommissionRate) return ft.fixedCommissionRate;
            const previousRevenue = ft.previousMonthRevenue || 0;
            if (previousRevenue >= 270000) return 40;
            if (previousRevenue >= 210000) return 38;
            if (previousRevenue >= 150000) return 36;
            if (previousRevenue >= 90000) return 34;
            if (previousRevenue >= 30000) return 32;
            return 30;
        }

        function displayFortuneTellers(fortuneTellers) {
            const tbody = document.getElementById("fortunetellersList");
            const cardsGrid = document.getElementById("fortunetellersGrid");
            const tableWrapper = document.querySelector(".fortunetellers-table-wrapper");

            if (tableWrapper) {
                tableWrapper.style.maxHeight = "260px";
                tableWrapper.style.overflowY = "auto";
            }

            if (!fortuneTellers.length) {
                tbody.innerHTML =
                    '<tr><td colspan="9" style="text-align:center;color:#999;">å ã„å¸«ãŒã„ã¾ã›ã‚“</td></tr>';
                cardsGrid.innerHTML = '<div class="loading">å ã„å¸«ãŒã„ã¾ã›ã‚“</div>';
                return;
            }

            tbody.innerHTML = "";
            fortuneTellers.forEach(ft => {
                const isNew = ft.isNew || false;
                const statusText =
                    ft.status === "available"
                        ? "âš¡ å¾…æ©Ÿä¸­"
                        : ft.status === "accepting"
                        ? "ğŸ“ å—ä»˜ä¸­"
                        : ft.status === "stopped"
                        ? "â¸ï¸ åœæ­¢ä¸­"
                        : "ä¸æ˜";

                const totalReviews = ft.totalReviews || 0;
                const baseReviewCount = ft.baseReviewCount || 0;

                const ratingDisplay = ft.ratingFixed
                    ? `<span class="star-display">â­ ${ft.averageRating || 0}</span><span class="fixed-badge">ğŸ”’ å›ºå®š</span><br>
                       <button class="btn btn-sm btn-info" onclick="showManageReviewCountModal('${ft.id}', '${ft.name || ""}', ${baseReviewCount})" style="margin-top:5px;">
                           é‘‘å®š ${totalReviews}ä»¶${baseReviewCount > 0 ? " (åŸºæº–:" + baseReviewCount + ")" : ""}
                       </button>`
                    : `<span class="star-display">â­ ${ft.averageRating || 0}</span><br>
                       <button class="btn btn-sm btn-info" onclick="showManageReviewCountModal('${ft.id}', '${ft.name || ""}', ${baseReviewCount})" style="margin-top:5px;">
                           é‘‘å®š ${totalReviews}ä»¶${baseReviewCount > 0 ? " (åŸºæº–:" + baseReviewCount + ")" : ""}
                       </button>`;

                const commissionRate = calcCommissionRate(ft);
                const commissionDisplay = ft.fixedCommissionRate
                    ? `<strong>${commissionRate}%</strong><span class="fixed-badge">ğŸ”’ å›ºå®š</span>`
                    : `${commissionRate}%`;

                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>
                        ${isNew ? '<span style="background:#ff4444;color:#fff;padding:2px 6px;border-radius:3px;font-size:10px;margin-right:5px;">NEW</span>' : ""}
                        <strong>${ft.name || "-"}</strong>
                    </td>
                    <td style="font-size:13px;color:#666;">${ft.email || "-"}</td>
                    <td style="font-size:13px;">${ft.specialty || "-"}</td>
                    <td><strong>${ft.price || 10}pt</strong>/æ–‡å­—</td>
                    <td>${ratingDisplay}</td>
                    <td>${commissionDisplay}</td>
                    <td>${statusText}</td>
                    <td>
                        <button class="btn btn-primary" onclick="showDummyClientsModal('${ft.id}', '${ft.name || "å ã„å¸«"}', ${ft.dummyActiveClients || 0})" style="font-size:13px;padding:6px 12px;">
                            ${ft.dummyActiveClients || 0}äºº
                        </button>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn ${isNew ? "btn-secondary" : "btn-primary"}"
                                onclick="toggleFortuneTellerNewMark('${ft.id}', ${!isNew})"
                                title="${isNew ? "NEWãƒãƒ¼ã‚¯ã‚’è§£é™¤" : "NEWãƒãƒ¼ã‚¯ã‚’ä»˜ä¸"}">
                                ${isNew ? "ğŸ·ï¸ NEWè§£é™¤" : "ğŸ·ï¸ NEWä»˜ä¸"}
                            </button>
                            <button class="btn btn-primary"
                                onclick="editPrice('${ft.id}', '${ft.name || ""}', ${ft.price || 10})"
                                title="æ–™é‡‘ã‚’å¤‰æ›´">
                                ğŸ’° æ–™é‡‘å¤‰æ›´
                            </button>
                            <button class="btn ${ft.isDummy ? "btn-success" : "btn-secondary"}"
                                onclick="toggleDummy('${ft.id}', ${!!ft.isDummy})"
                                title="${ft.isDummy ? "ãƒ€ãƒŸãƒ¼å ã„å¸«ã§ã™" : "ãƒ€ãƒŸãƒ¼ã«è¨­å®š"}">
                                ${ft.isDummy ? "âœ… ãƒ€ãƒŸãƒ¼" : "â• ãƒ€ãƒŸãƒ¼"}
                            </button>
                            <button class="btn ${ft.notifyEmail ? "btn-success" : "btn-secondary"}"
                                onclick="toggleNotify('${ft.id}', ${!!ft.notifyEmail})"
                                title="${ft.notifyEmail ? "ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ON" : "ãƒ¡ãƒ¼ãƒ«é€šçŸ¥OFF"}">
                                ${ft.notifyEmail ? "ğŸ”” ON" : "ğŸ”• OFF"}
                            </button>
                            <button class="btn ${ft.isDummy ? "btn-primary" : "btn-warning"}"
                                onclick="loginAsFortuneTeller('${ft.id}', '${ft.name || ""}')"
                                title="${ft.isDummy ? "ã“ã®å ã„å¸«ã¨ã—ã¦æ´»å‹•" : "ãªã‚Šã™ã¾ã—ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆæ³¨æ„ï¼‰"}">
                                ${ft.isDummy ? "âœ¨ ã“ã®å ã„å¸«ã§æ´»å‹•" : "âš ï¸ ãªã‚Šã™ã¾ã—"}
                            </button>
                            <button class="btn ${ft.ratingFixed ? "btn-danger" : "btn-primary"}"
                                onclick="fixRating('${ft.id}', ${ft.averageRating || 0}, ${!!ft.ratingFixed})"
                                title="${ft.ratingFixed ? "è©•ä¾¡ã®å›ºå®šã‚’è§£é™¤ã—ã¾ã™" : "è©•ä¾¡ã‚’å›ºå®šã—ã¾ã™"}">
                                ${ft.ratingFixed ? "â­ è§£é™¤" : "â­ å›ºå®š"}
                            </button>
                            <button class="btn ${ft.fixedCommissionRate ? "btn-danger" : "btn-success"}"
                                onclick="fixCommission('${ft.id}', ${commissionRate}, ${!!ft.fixedCommissionRate})"
                                title="${ft.fixedCommissionRate ? "å ±é…¬ç‡ã®å›ºå®šã‚’è§£é™¤ã—ã¾ã™" : "å ±é…¬ç‡ã‚’å›ºå®šã—ã¾ã™"}">
                                ${ft.fixedCommissionRate ? "ğŸ’° è§£é™¤" : "ğŸ’° å›ºå®š"}
                            </button>
                            <button class="btn btn-danger"
                                onclick="deleteFortuneTeller('${ft.id}', '${ft.email || ""}')"
                                title="ã“ã®å ã„å¸«ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™">
                                ğŸ—‘ï¸ å‰Šé™¤
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // ã‚¹ãƒãƒ›ã‚«ãƒ¼ãƒ‰è¡¨ç¤º
            cardsGrid.innerHTML = "";
            fortuneTellers.forEach(ft => {
                const status =
                    ft.status === "available"
                        ? { text: "âš¡ å¾…æ©Ÿä¸­", cls: "active" }
                        : ft.status === "accepting"
                        ? { text: "ğŸ“ å—ä»˜ä¸­", cls: "active" }
                        : ft.status === "stopped"
                        ? { text: "â¸ï¸ åœæ­¢ä¸­", cls: "inactive" }
                        : { text: "ä¸æ˜", cls: "inactive" };

                const commissionRate = calcCommissionRate(ft);

                const card = document.createElement("div");
                card.className = "ft-card";
                card.innerHTML = `
                    <div class="ft-card-header">
                        <div>
                            <div class="ft-card-name">${ft.name || "-"}</div>
                            <div class="ft-card-email">${ft.email || "-"}</div>
                        </div>
                        <span class="ft-card-status ${status.cls}">${status.text}</span>
                    </div>
                    <div class="ft-card-info">
                        <div class="ft-card-info-row">
                            <span class="ft-card-info-label">å°‚é–€åˆ†é‡</span>
                            <span class="ft-card-info-value">${ft.specialty || "-"}</span>
                        </div>
                        <div class="ft-card-info-row">
                            <span class="ft-card-info-label">æ–™é‡‘</span>
                            <span class="ft-card-info-value"><strong>${ft.price || 10}pt</strong>/æ–‡å­—</span>
                        </div>
                        <div class="ft-card-info-row">
                            <span class="ft-card-info-label">è©•ä¾¡</span>
                            <span class="ft-card-info-value">
                                <span class="star-display">â­ ${ft.averageRating || 0}</span>
                                ${ft.ratingFixed ? '<span class="fixed-badge">ğŸ”’ å›ºå®š</span>' : ""}
                            </span>
                        </div>
                        <div class="ft-card-info-row">
                            <span class="ft-card-info-label">å ±é…¬ç‡</span>
                            <span class="ft-card-info-value">
                                ${commissionRate}%
                                ${ft.fixedCommissionRate ? '<span class="fixed-badge">ğŸ”’ å›ºå®š</span>' : ""}
                            </span>
                        </div>
                    </div>
                    <div class="ft-card-actions">
                        <button class="btn btn-primary" style="width:100%;margin-bottom:4px;"
                            onclick="editPrice('${ft.id}', '${ft.name || ""}', ${ft.price || 10})">
                            ğŸ’° æ–™é‡‘å¤‰æ›´
                        </button>
                        <button class="btn ${ft.isDummy ? "btn-success" : "btn-secondary"}" style="flex:1;"
                            onclick="toggleDummy('${ft.id}', ${!!ft.isDummy})">
                            ${ft.isDummy ? "âœ… ãƒ€ãƒŸãƒ¼" : "â• ãƒ€ãƒŸãƒ¼"}
                        </button>
                        <button class="btn ${ft.notifyEmail ? "btn-success" : "btn-secondary"}" style="flex:1;"
                            onclick="toggleNotify('${ft.id}', ${!!ft.notifyEmail})">
                            ${ft.notifyEmail ? "ğŸ”” ON" : "ğŸ”• OFF"}
                        </button>
                        <button class="btn ${ft.isDummy ? "btn-primary" : "btn-warning"}" style="width:100%;margin-top:4px;"
                            onclick="loginAsFortuneTeller('${ft.id}', '${ft.name || ""}')">
                            ${ft.isDummy ? "âœ¨ ã“ã®å ã„å¸«ã§æ´»å‹•" : "âš ï¸ ãªã‚Šã™ã¾ã—"}
                        </button>
                        <button class="btn ${ft.ratingFixed ? "btn-danger" : "btn-primary"}"
                            onclick="fixRating('${ft.id}', ${ft.averageRating || 0}, ${!!ft.ratingFixed})">
                            ${ft.ratingFixed ? "â­ è§£é™¤" : "â­ å›ºå®š"}
                        </button>
                        <button class="btn ${ft.fixedCommissionRate ? "btn-danger" : "btn-success"}"
                            onclick="fixCommission('${ft.id}', ${commissionRate}, ${!!ft.fixedCommissionRate})">
                            ${ft.fixedCommissionRate ? "ğŸ’° è§£é™¤" : "ğŸ’° å›ºå®š"}
                        </button>
                        <button class="btn btn-danger"
                            onclick="deleteFortuneTeller('${ft.id}', '${ft.email || ""}')">
                            ğŸ—‘ï¸ å‰Šé™¤
                        </button>
                    </div>
                `;
                cardsGrid.appendChild(card);
            });
        }

        // ==== è©•ä¾¡å›ºå®š/è§£é™¤ ====
        async function fixRating(ftId, currentRating, isFixed) {
            if (isFixed) {
                if (!confirm("è©•ä¾¡ã®å›ºå®šã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ\nè§£é™¤ã™ã‚‹ã¨å®Ÿéš›ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‹ã‚‰è‡ªå‹•è¨ˆç®—ã•ã‚Œã¾ã™ã€‚")) return;
                try {
                    const ftRef = window.firebaseDoc(window.firebaseDB, "fortuneTellers", ftId);
                    await window.firebaseSetDoc(
                        ftRef,
                        {
                            ratingFixed: false
                        },
                        { merge: true }
                    );
                    alert("è©•ä¾¡å›ºå®šã‚’è§£é™¤ã—ã¾ã—ãŸ");
                    loadData();
                } catch (error) {
                    console.error("è©•ä¾¡å›ºå®šè§£é™¤ã‚¨ãƒ©ãƒ¼:", error);
                    alert("è©•ä¾¡å›ºå®šã®è§£é™¤ã«å¤±æ•—ã—ã¾ã—ãŸ");
                }
            } else {
                const newRating = prompt(
                    "å›ºå®šã™ã‚‹è©•ä¾¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆ0ï½5ï¼‰\n\nä¾‹: 4.8 ã¨å…¥åŠ›ã™ã‚‹ã¨â­4.8ã§å›ºå®šã•ã‚Œã¾ã™\nå°æ•°ç‚¹1æ¡ã¾ã§å…¥åŠ›å¯èƒ½ã§ã™",
                    currentRating
                );
                if (newRating === null) return;
                const rating = parseFloat(newRating);
                if (isNaN(rating) || rating < 0 || rating > 5) {
                    alert("0ã‹ã‚‰5ã®æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„\nä¾‹: 4.8");
                    return;
                }
                try {
                    const ftRef = window.firebaseDoc(window.firebaseDB, "fortuneTellers", ftId);
                    await window.firebaseSetDoc(
                        ftRef,
                        {
                            averageRating: rating,
                            ratingFixed: true
                        },
                        { merge: true }
                    );
                    alert(`è©•ä¾¡ã‚’â­${rating}ã«å›ºå®šã—ã¾ã—ãŸ`);
                    loadData();
                } catch (error) {
                    console.error("è©•ä¾¡å›ºå®šã‚¨ãƒ©ãƒ¼:", error);
                    alert("è©•ä¾¡ã®å›ºå®šã«å¤±æ•—ã—ã¾ã—ãŸ");
                }
            }
        }

        // ==== å ±é…¬ç‡å›ºå®š/è§£é™¤ ====
        async function fixCommission(ftId, currentRate, isFixed) {
            if (isFixed) {
                if (!confirm("å ±é…¬ç‡ã®å›ºå®šã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ\nè§£é™¤ã™ã‚‹ã¨é€šå¸¸ã®å ±é…¬ç‡è¨ˆç®—ï¼ˆ30%ï½40%ï¼‰ã«æˆ»ã‚Šã¾ã™ã€‚")) return;
                try {
                    const ftRef = window.firebaseDoc(window.firebaseDB, "fortuneTellers", ftId);
                    await window.firebaseSetDoc(
                        ftRef,
                        {
                            fixedCommissionRate: null
                        },
                        { merge: true }
                    );
                    alert("å ±é…¬ç‡å›ºå®šã‚’è§£é™¤ã—ã¾ã—ãŸ");
                    loadData();
                } catch (error) {
                    console.error("å ±é…¬ç‡å›ºå®šè§£é™¤ã‚¨ãƒ©ãƒ¼:", error);
                    alert("å ±é…¬ç‡å›ºå®šã®è§£é™¤ã«å¤±æ•—ã—ã¾ã—ãŸ");
                }
            } else {
                const newRate = prompt(
                    "å›ºå®šã™ã‚‹å ±é…¬ç‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆ%ï¼‰\n\nä¾‹: 60 ã¨å…¥åŠ›ã™ã‚‹ã¨60%å›ºå®šã«ãªã‚Šã¾ã™\né€šå¸¸ã¯30%ï½40%ã§ã™",
                    currentRate
                );
                if (newRate === null) return;
                const rate = parseFloat(newRate);
                if (isNaN(rate) || rate < 0 || rate > 100) {
                    alert("0ã‹ã‚‰100ã®æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                    return;
                }
                try {
                    const ftRef = window.firebaseDoc(window.firebaseDB, "fortuneTellers", ftId);
                    await window.firebaseSetDoc(
                        ftRef,
                        {
                            fixedCommissionRate: rate
                        },
                        { merge: true }
                    );
                    alert("å ±é…¬ç‡ã‚’å›ºå®šã—ã¾ã—ãŸ");
                    loadData();
                } catch (error) {
                    console.error("å ±é…¬ç‡å›ºå®šã‚¨ãƒ©ãƒ¼:", error);
                    alert("å ±é…¬ç‡ã®å›ºå®šã«å¤±æ•—ã—ã¾ã—ãŸ");
                }
            }
        }

        // ==== NEWãƒãƒ¼ã‚¯ ====
        async function toggleFortuneTellerNewMark(ftId, setNew) {
            try {
                await window.firebaseUpdateDoc(
                    window.firebaseDoc(window.firebaseDB, "fortuneTellers", ftId),
                    { isNew: setNew }
                );
                alert(setNew ? "NEWãƒãƒ¼ã‚¯ã‚’ä»˜ä¸ã—ã¾ã—ãŸ" : "NEWãƒãƒ¼ã‚¯ã‚’è§£é™¤ã—ã¾ã—ãŸ");
                window.loadData();
            } catch (error) {
                console.error("NEWãƒãƒ¼ã‚¯æ›´æ–°ã‚¨ãƒ©ãƒ¼:", error);
                alert("æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ");
            }
        }

        // ==== å ã„å¸«å‰Šé™¤ ====
        async function deleteFortuneTeller(ftId, email) {
            if (
                !confirm(
                    `æœ¬å½“ã«ã“ã®å ã„å¸«ã‚’å‰Šé™¤ã—ã¾ã™ã‹?\n\nå ã„å¸«: ${email}\n\nâš ï¸ è­¦å‘Š:\nãƒ»Firestoreã®ãƒ‡ãƒ¼ã‚¿ãŒã™ã¹ã¦å‰Šé™¤ã•ã‚Œã¾ã™\nãƒ»é–¢é€£ã™ã‚‹ãƒãƒ£ãƒƒãƒˆã€ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™\nãƒ»ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“\n\nâ€» Firebase Authenticationã‹ã‚‰ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ã¯ã€Firebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§æ‰‹å‹•ã§è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™`
                )
            ) {
                return;
            }

            try {
                const ftRef = window.firebaseDoc(window.firebaseDB, "fortuneTellers", ftId);
                await window.firebaseDeleteDoc(ftRef);

                const chatsRef = window.firebaseCollection(window.firebaseDB, "chats");
                const chatsQuery = window.firebaseQuery(chatsRef, window.firebaseWhere("fortuneTellerId", "==", ftId));
                const chatsSnapshot = await window.firebaseGetDocs(chatsQuery);
                for (const chatDoc of chatsSnapshot.docs) {
                    await window.firebaseDeleteDoc(chatDoc.ref);
                }

                const reviewsRef = window.firebaseCollection(window.firebaseDB, "reviews");
                const reviewsQuery = window.firebaseQuery(
                    reviewsRef,
                    window.firebaseWhere("fortuneTellerId", "==", ftId)
                );
                const reviewsSnapshot = await window.firebaseGetDocs(reviewsQuery);
                for (const reviewDoc of reviewsSnapshot.docs) {
                    await window.firebaseDeleteDoc(reviewDoc.ref);
                }

                alert(
                    "å ã„å¸«ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚\n\né‡è¦: Firebase Authenticationï¼ˆèªè¨¼ï¼‰ã‹ã‚‰ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ã¯ã€Firebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ« > Authentication > Users ã‹ã‚‰æ‰‹å‹•ã§å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚"
                );
                loadData();
            } catch (error) {
                console.error("å ã„å¸«å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", error);
                alert("å ã„å¸«ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
            }
        }

        // ==== ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒã‚¤ãƒ³ãƒˆè¿½åŠ  ====
        async function addPointsToUser(userId, userName) {
            const points = prompt(`${userName}ã•ã‚“ã«è¿½åŠ ã™ã‚‹ãƒã‚¤ãƒ³ãƒˆæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:`, "100");
            if (points === null) return;
            const pointsNum = parseInt(points);
            if (isNaN(pointsNum) || pointsNum <= 0) {
                alert("æ­£ã—ã„ãƒã‚¤ãƒ³ãƒˆæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                return;
            }
            if (!confirm(`${userName}ã•ã‚“ã«${pointsNum}ãƒã‚¤ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ`)) return;

            try {
                const userRef = window.firebaseDoc(window.firebaseDB, "users", userId);
                const userDoc = await window.firebaseGetDoc(userRef);

                if (!userDoc.exists()) {
                    alert("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
                    return;
                }

                const userData = userDoc.data();
                const currentPoints = Number(userData.points) || 0;
                const addPoints = Number(pointsNum) || 0;
                const newPoints = currentPoints + addPoints;

                await window.firebaseUpdateDoc(userRef, {
                    points: newPoints
                });

                alert(`${userName}ã•ã‚“ã®ãƒã‚¤ãƒ³ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ\n${currentPoints}pt â†’ ${newPoints}pt`);
                loadData();
            } catch (error) {
                console.error("ãƒã‚¤ãƒ³ãƒˆè¿½åŠ ã‚¨ãƒ©ãƒ¼:", error);
                alert("ãƒã‚¤ãƒ³ãƒˆã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
            }
        }

        // ==== ãƒ€ãƒŸãƒ¼ & é€šçŸ¥ ====
        async function toggleDummy(ftId, currentIsDummy) {
            const newIsDummy = !currentIsDummy;
            const action = newIsDummy ? "ãƒ€ãƒŸãƒ¼å ã„å¸«ã«è¨­å®š" : "ãƒ€ãƒŸãƒ¼è¨­å®šã‚’è§£é™¤";
            if (!confirm(`${action}ã—ã¾ã™ã‹ï¼Ÿ`)) return;

            try {
                const ftRef = window.firebaseDoc(window.firebaseDB, "fortuneTellers", ftId);
                await window.firebaseUpdateDoc(ftRef, {
                    isDummy: newIsDummy
                });
                alert(`${action}ã—ã¾ã—ãŸ`);
                loadData();
            } catch (error) {
                console.error("ãƒ€ãƒŸãƒ¼è¨­å®šã‚¨ãƒ©ãƒ¼:", error);
                alert("è¨­å®šã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ");
            }
        }

        async function toggleNotify(ftId, currentNotify) {
            const newNotify = !currentNotify;
            const action = newNotify ? "ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã‚’ON" : "ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã‚’OFF";
            if (!confirm(`${action}ã«ã—ã¾ã™ã‹ï¼Ÿ`)) return;

            try {
                const ftRef = window.firebaseDoc(window.firebaseDB, "fortuneTellers", ftId);
                await window.firebaseUpdateDoc(ftRef, {
                    notifyEmail: newNotify
                });
                alert(`${action}ã«ã—ã¾ã—ãŸ`);
                loadData();
            } catch (error) {
                console.error("é€šçŸ¥è¨­å®šã‚¨ãƒ©ãƒ¼:", error);
                alert("è¨­å®šã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ");
            }
        }

        // ==== æ–™é‡‘å¤‰æ›´ ====
        async function editPrice(ftId, ftName, currentPrice) {
            const newPrice = prompt(
                `${ftName}ã•ã‚“ã®æ–™é‡‘ã‚’å¤‰æ›´ã—ã¾ã™\n\n1æ–‡å­—ã‚ãŸã‚Šã®ãƒã‚¤ãƒ³ãƒˆæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:`,
                currentPrice || 10
            );
            if (newPrice === null) return;

            const priceNum = parseInt(newPrice);
            if (isNaN(priceNum) || priceNum <= 0) {
                alert("æ­£ã—ã„æ–™é‡‘ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆ1ä»¥ä¸Šã®æ•°å€¤ï¼‰");
                return;
            }

            if (!confirm(`${ftName}ã•ã‚“ã®æ–™é‡‘ã‚’ ${priceNum}pt/æ–‡å­— ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ`)) return;

            try {
                const ftRef = window.firebaseDoc(window.firebaseDB, "fortuneTellers", ftId);
                await window.firebaseUpdateDoc(ftRef, {
                    price: priceNum
                });
                alert(`æ–™é‡‘ã‚’ ${priceNum}pt/æ–‡å­— ã«å¤‰æ›´ã—ã¾ã—ãŸ`);
                loadData();
            } catch (error) {
                console.error("æ–™é‡‘å¤‰æ›´ã‚¨ãƒ©ãƒ¼:", error);
                alert("æ–™é‡‘ã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
            }
        }

        // ==== å ã„å¸«ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ ====
        function loginAsFortuneTeller(ftId, ftName) {
            if (!confirm(`ã€Œ${ftName}ã€ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯è¨˜éŒ²ã•ã‚Œã¾ã™ã€‚`)) return;

            localStorage.setItem(
                "currentUser",
                JSON.stringify({
                    uid: ftId,
                    type: "fortune-teller",
                    name: ftName,
                    _impersonatedBy: "admin",
                    _impersonatedAt: new Date().toISOString()
                })
            );
            window.location.href = "cupids-fortune-lobby.html";
        }

        // ==== ãƒ¬ãƒ“ãƒ¥ãƒ¼èª­ã¿è¾¼ã¿ ====
        async function loadReviews() {
            try {
                const reviewsRef = window.firebaseCollection(window.firebaseDB, "reviews");
                const q = window.firebaseQuery(reviewsRef, window.firebaseOrderBy("createdAt", "desc"));
                const snapshot = await window.firebaseGetDocs(q);

                const reviews = [];
                for (const docSnapshot of snapshot.docs) {
                    const review = docSnapshot.data();

                    const ftDoc = await window.firebaseGetDoc(
                        window.firebaseDoc(window.firebaseDB, "fortuneTellers", review.fortuneTellerId)
                    );
                    const ftName = ftDoc.exists() ? ftDoc.data().name : "ä¸æ˜";

                    const clientDoc = await window.firebaseGetDoc(
                        window.firebaseDoc(window.firebaseDB, "users", review.clientId)
                    );
                    const clientName = clientDoc.exists() ? clientDoc.data().name : "ä¸æ˜";

                    reviews.push({
                        id: docSnapshot.id,
                        ...review,
                        fortuneTellerName: ftName,
                        clientName: clientName
                    });
                }

                displayReviews(reviews);
            } catch (error) {
                console.error("ãƒ¬ãƒ“ãƒ¥ãƒ¼èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
            }
        }

        function displayReviews(reviews) {
            const tbody = document.getElementById("reviewsList");

            if (!reviews.length) {
                tbody.innerHTML =
                    '<tr><td colspan="6" style="text-align:center;color:#999;">ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                return;
            }

            tbody.innerHTML = "";
            reviews.forEach(review => {
                const tr = document.createElement("tr");
                const stars = "â­".repeat(review.rating);
                const date = review.createdAt
                    ? new Date(review.createdAt).toLocaleDateString("ja-JP")
                    : "";
                const shortComment = review.comment
                    ? review.comment.length > 30
                        ? review.comment.substring(0, 30) + "..."
                        : review.comment
                    : '<span style="color:#999;">ãªã—</span>';

                tr.innerHTML = `
                    <td><strong>${review.fortuneTellerName}</strong></td>
                    <td>${review.clientName}</td>
                    <td class="star-display">${stars} <span style="color:#666;">(${review.rating})</span></td>
                    <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${
                        review.comment || "ãªã—"
                    }">${shortComment}</td>
                    <td style="font-size:13px;color:#666;">${date}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteReview('${
                            review.id
                        }', '${review.fortuneTellerId}')" title="ã“ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã€‚å‰Šé™¤å¾Œã¯è©•ä¾¡ãŒè‡ªå‹•å†è¨ˆç®—ã•ã‚Œã¾ã™ã€‚">
                            ğŸ—‘ï¸ å‰Šé™¤
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function deleteReview(reviewId, fortuneTellerId) {
            if (!confirm("ã“ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nå‰Šé™¤ã™ã‚‹ã¨å ã„å¸«ã®å¹³å‡è©•ä¾¡ãŒå†è¨ˆç®—ã•ã‚Œã¾ã™ã€‚")) return;
            try {
                const reviewRef = window.firebaseDoc(window.firebaseDB, "reviews", reviewId);
                await window.firebaseDeleteDoc(reviewRef);
                await recalculateFortuneTellerRating(fortuneTellerId);
                alert("ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
                loadData();
            } catch (error) {
                console.error("ãƒ¬ãƒ“ãƒ¥ãƒ¼å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", error);
                alert("ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ");
            }
        }

        async function recalculateFortuneTellerRating(ftId) {
            try {
                const reviewsRef = window.firebaseCollection(window.firebaseDB, "reviews");
                const q = window.firebaseQuery(
                    reviewsRef,
                    window.firebaseWhere("fortuneTellerId", "==", ftId)
                );
                const snapshot = await window.firebaseGetDocs(q);

                let totalRating = 0;
                let reviewCount = 0;
                snapshot.forEach(docSnap => {
                    const review = docSnap.data();
                    totalRating += review.rating;
                    reviewCount++;
                });

                const averageRating = reviewCount > 0 ? (totalRating / reviewCount).toFixed(1) : 0;
                const ftRef = window.firebaseDoc(window.firebaseDB, "fortuneTellers", ftId);
                await window.firebaseSetDoc(
                    ftRef,
                    {
                        averageRating: parseFloat(averageRating),
                        totalReviews: reviewCount
                    },
                    { merge: true }
                );
            } catch (error) {
                console.error("è©•ä¾¡å†è¨ˆç®—ã‚¨ãƒ©ãƒ¼:", error);
            }
        }

        // ==== ãƒ©ãƒ³ã‚­ãƒ³ã‚° ====
        function displayRanking(fortuneTellers) {
            const rankingList = document.getElementById("rankingList");
            if (!fortuneTellers || !fortuneTellers.length) {
                rankingList.innerHTML =
                    '<div style="text-align:center;color:#999;padding:40px;">å ã„å¸«ãŒã„ã¾ã›ã‚“</div>';
                return;
            }

            const sorted = [...fortuneTellers].sort((a, b) => {
                const salesA = a.currentMonthRevenue || 0;
                const salesB = b.currentMonthRevenue || 0;
                return salesB - salesA;
            });

            rankingList.innerHTML = "";
            sorted.forEach((ft, index) => {
                const sales = ft.currentMonthRevenue || 0;
                const commissionRate = calcCommissionRate(ft);

                let medalIcon = "";
                if (index === 0) medalIcon = "ğŸ¥‡";
                else if (index === 1) medalIcon = "ğŸ¥ˆ";
                else if (index === 2) medalIcon = "ğŸ¥‰";

                const item = document.createElement("div");
                item.className = "ranking-item";
                item.innerHTML = `
                    ${medalIcon ? `<div class="ranking-medal">${medalIcon}</div>` : `<div class="ranking-number">${
                    index + 1
                }</div>`}
                    <div class="ranking-info">
                        <div class="ranking-name">${ft.name || "å ã„å¸«"}</div>
                        <div class="ranking-email">${ft.email || ""}</div>
                    </div>
                    <div class="ranking-sales">
                        <div class="ranking-amount">Â¥${sales.toLocaleString()}</div>
                        <div class="ranking-commission">å ±é…¬ç‡: ${commissionRate}%</div>
                    </div>
                `;
                rankingList.appendChild(item);
            });
        }

        // ==== ãƒ¬ãƒ“ãƒ¥ãƒ¼è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« ====
        async function showAddReviewModal() {
            const modal = document.getElementById("addReviewModal");
            const select = document.getElementById("reviewFortuneTeller");

            try {
                const ftRef = window.firebaseCollection(window.firebaseDB, "fortuneTellers");
                const snapshot = await window.firebaseGetDocs(ftRef);
                select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
                snapshot.forEach(docSnap => {
                    const ft = docSnap.data();
                    const option = document.createElement("option");
                    option.value = docSnap.id;
                    option.textContent = ft.name || ft.email || docSnap.id;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error("å ã„å¸«ãƒªã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:", error);
            }

            modal.classList.add("active");
        }

        function closeAddReviewModal() {
            const modal = document.getElementById("addReviewModal");
            modal.classList.remove("active");
            document.getElementById("reviewFortuneTeller").value = "";
            document.getElementById("reviewClientName").value = "åŒ¿å";
            document.getElementById("reviewRating").value = "5";
            document.getElementById("reviewComment").value = "";
        }

        async function submitAddReview() {
            const fortuneTellerId = document.getElementById("reviewFortuneTeller").value;
            const clientName = document.getElementById("reviewClientName").value.trim() || "åŒ¿å";
            const rating = parseInt(document.getElementById("reviewRating").value);
            const comment = document.getElementById("reviewComment").value.trim();

            if (!fortuneTellerId) {
                alert("å ã„å¸«ã‚’é¸æŠã—ã¦ãã ã•ã„");
                return;
            }

            try {
                const reviewId = `admin_${Date.now()}`;
                const reviewRef = window.firebaseDoc(window.firebaseDB, "reviews", reviewId);
                await window.firebaseSetDoc(reviewRef, {
                    reviewId,
                    fortuneTellerId,
                    clientId: "admin",
                    clientName,
                    rating,
                    comment,
                    createdAt: new Date().toISOString(),
                    isAdminReview: true
                });

                await updateFortuneTellerRating(fortuneTellerId);

                alert("ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¿½åŠ ã—ã¾ã—ãŸ!");
                closeAddReviewModal();
                loadData();
            } catch (error) {
                console.error("ãƒ¬ãƒ“ãƒ¥ãƒ¼è¿½åŠ ã‚¨ãƒ©ãƒ¼:", error);
                alert("ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ");
            }
        }

        async function updateFortuneTellerRating(ftId) {
            try {
                const reviewsRef = window.firebaseCollection(window.firebaseDB, "reviews");
                const q = window.firebaseQuery(
                    reviewsRef,
                    window.firebaseWhere("fortuneTellerId", "==", ftId)
                );
                const snapshot = await window.firebaseGetDocs(q);

                let totalRating = 0;
                let reviewCount = 0;
                snapshot.forEach(docSnap => {
                    const review = docSnap.data();
                    totalRating += review.rating;
                    reviewCount++;
                });

                const ftRef = window.firebaseDoc(window.firebaseDB, "fortuneTellers", ftId);
                const ftDoc = await window.firebaseGetDoc(ftRef);
                const baseReviewCount = ftDoc.exists() ? ftDoc.data().baseReviewCount || 0 : 0;
                const displayReviewCount = reviewCount + baseReviewCount;
                const averageRating = reviewCount > 0 ? (totalRating / reviewCount).toFixed(1) : 0;

                await window.firebaseSetDoc(
                    ftRef,
                    {
                        averageRating: parseFloat(averageRating),
                        totalReviews: displayReviewCount,
                        actualReviewCount: reviewCount
                    },
                    { merge: true }
                );

                console.log(`âœ… è©•ä¾¡æ›´æ–°: ${averageRating} (ãƒ¬ãƒ“ãƒ¥ãƒ¼${displayReviewCount}ä»¶)`);
            } catch (error) {
                console.error("è©•ä¾¡æ›´æ–°ã‚¨ãƒ©ãƒ¼:", error);
            }
        }

        // ==== ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« ====
        function showManageReviewCountModal(ftId, ftName, currentCount) {
            currentManagingFortuneTellerId = ftId;
            const modal = document.getElementById("manageReviewCountModal");
            document.getElementById("manageReviewCountLabel").textContent = `å ã„å¸«: ${ftName}`;
            document.getElementById("manageReviewCount").value = currentCount || 0;
            modal.classList.add("active");
        }

        function closeManageReviewCountModal() {
            const modal = document.getElementById("manageReviewCountModal");
            modal.classList.remove("active");
            currentManagingFortuneTellerId = null;
        }

        async function submitManageReviewCount() {
            if (!currentManagingFortuneTellerId) {
                alert("ã‚¨ãƒ©ãƒ¼: å ã„å¸«IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
                return;
            }
            const count = parseInt(document.getElementById("manageReviewCount").value) || 0;
            if (count < 0) {
                alert("ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°ã¯0ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„");
                return;
            }
            try {
                const ftRef = window.firebaseDoc(
                    window.firebaseDB,
                    "fortuneTellers",
                    currentManagingFortuneTellerId
                );
                await window.firebaseSetDoc(
                    ftRef,
                    {
                        baseReviewCount: count
                    },
                    { merge: true }
                );
                await updateFortuneTellerRating(currentManagingFortuneTellerId);
                alert("ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°ã®åŸºæº–å€¤ã‚’ä¿å­˜ã—ã¾ã—ãŸ!");
                closeManageReviewCountModal();
                loadData();
            } catch (error) {
                console.error("ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°ä¿å­˜ã‚¨ãƒ©ãƒ¼:", error);
                alert("ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ");
            }
        }

        // ==== é‘‘å®šä¸­ãƒ€ãƒŸãƒ¼ ====
        function showDummyClientsModal(ftId, ftName, currentCount) {
            currentDummyFtId = ftId;
            document.getElementById("dummyClientsLabel").textContent = `å ã„å¸«: ${ftName}`;
            document.getElementById("dummyClientsCount").value = currentCount || 0;
            document.getElementById("dummyClientsModal").classList.add("active");
        }

        function closeDummyClientsModal() {
            document.getElementById("dummyClientsModal").classList.remove("active");
            currentDummyFtId = null;
        }

        async function submitDummyClients() {
            if (!currentDummyFtId) return;
            const count = parseInt(document.getElementById("dummyClientsCount").value) || 0;
            if (count < 0) {
                alert("ãƒ€ãƒŸãƒ¼äººæ•°ã¯0ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„");
                return;
            }
            try {
                const ftRef = window.firebaseDoc(window.firebaseDB, "fortuneTellers", currentDummyFtId);
                await window.firebaseSetDoc(
                    ftRef,
                    {
                        dummyActiveClients: count
                    },
                    { merge: true }
                );
                alert("âœ… é‘‘å®šä¸­ãƒ€ãƒŸãƒ¼äººæ•°ã‚’ä¿å­˜ã—ã¾ã—ãŸ!");
                closeDummyClientsModal();
                loadData();
            } catch (error) {
                console.error("ãƒ€ãƒŸãƒ¼äººæ•°ä¿å­˜ã‚¨ãƒ©ãƒ¼:", error);
                alert("ãƒ€ãƒŸãƒ¼äººæ•°ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ");
            }
        }

        // ==== ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ ====
        function logout() {
            localStorage.removeItem("currentUser");
            window.location.href = "cupids-top.html";
        }

        // ==== ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ ====
        document.getElementById("ftImage").addEventListener("change", function (e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (ev) {
                document.getElementById("previewImg").src = ev.target.result;
                document.getElementById("imagePreview").style.display = "block";
            };
            reader.readAsDataURL(file);
        });

        document.getElementById("circleSize").addEventListener("input", function (e) {
            const size = e.target.value;
            document.getElementById("circleSizeValue").textContent = size + "%";
            document.getElementById("previewCircleFill").setAttribute("r", size + "%");
            document.getElementById("previewCircleStroke").setAttribute("r", size + "%");
        });

        let imageOffsetX = 0;
        let imageOffsetY = 0;
        let imageScale = 1;

        function updateImageTransform() {
            const img = document.getElementById("previewImg");
            img.style.transform = `translate(${imageOffsetX}px, ${imageOffsetY}px) scale(${imageScale})`;
        }

        function moveImage(direction) {
            const step = 10;
            if (direction === "up") imageOffsetY -= step;
            if (direction === "down") imageOffsetY += step;
            if (direction === "left") imageOffsetX -= step;
            if (direction === "right") imageOffsetX += step;
            updateImageTransform();
        }

        function resetImagePosition() {
            imageOffsetX = 0;
            imageOffsetY = 0;
            imageScale = 1;
            document.getElementById("imageScale").value = 100;
            document.getElementById("imageScaleValue").textContent = "100%";
            updateImageTransform();
        }

        document.getElementById("imageScale").addEventListener("input", function (e) {
            const scale = e.target.value;
            imageScale = scale / 100;
            document.getElementById("imageScaleValue").textContent = scale + "%";
            updateImageTransform();
        });

        let isDragging = false;
        let startX, startY;

        document.getElementById("previewImg").addEventListener("mousedown", function (e) {
            isDragging = true;
            startX = e.clientX - imageOffsetX;
            startY = e.clientY - imageOffsetY;
            e.preventDefault();
        });

        document.addEventListener("mousemove", function (e) {
            if (!isDragging) return;
            imageOffsetX = e.clientX - startX;
            imageOffsetY = e.clientY - startY;
            updateImageTransform();
        });

        document.addEventListener("mouseup", function () {
            isDragging = false;
        });

        // ==== å ã„å¸«ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ  ====
        document.getElementById("addFortuneTellerForm").addEventListener("submit", async function (e) {
            e.preventDefault();

            const name = document.getElementById("ftName").value;
            const email = document.getElementById("ftEmail").value;
            const password = document.getElementById("ftPassword").value;
            const price = parseInt(document.getElementById("ftPrice").value);
            const message = document.getElementById("ftMessage").value;
            const imageFile = document.getElementById("ftImage").files[0];

            if (!confirm(`å ã„å¸«ã€Œ${name}ã€ã‚’ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ`)) return;

            let userCredential = null;

            try {
                userCredential = await window.firebaseCreateUser(window.firebaseAuth, email, password);
                const uid = userCredential.user.uid;

                let imageUrl = "";
                if (imageFile) {
                    try {
                        const storageRef = window.firebaseStorageRef(
                            window.firebaseStorage,
                            `fortuneTellers/${uid}/${imageFile.name}`
                        );
                        await window.firebaseUploadBytes(storageRef, imageFile);
                        imageUrl = await window.firebaseGetDownloadURL(storageRef);
                    } catch (storageError) {
                        console.error("ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:", storageError);
                        alert(
                            "ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸãŒã€ç”»åƒãªã—ã§ç™»éŒ²ã‚’ç¶šè¡Œã—ã¾ã™ã€‚\n\nå¾Œã‹ã‚‰ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ã§ç”»åƒã‚’è¿½åŠ ã§ãã¾ã™ã€‚"
                        );
                    }
                }

                const ftRef = window.firebaseDoc(window.firebaseDB, "fortuneTellers", uid);
                await window.firebaseSetDoc(ftRef, {
                    uid,
                    name,
                    email,
                    type: "fortune-teller",
                    price,
                    message,
                    imageUrl,
                    photoURL: imageUrl,
                    status: "stopped",
                    averageRating: 0,
                    totalReviews: 0,
                    currentMonthSales: 0,
                    isDummy: false,
                    notifyEmail: false,
                    createdAt: new Date().toISOString()
                });

                alert(
                    `å ã„å¸«ã€Œ${name}ã€ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼\n\nãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±:\nãƒ¡ãƒ¼ãƒ«: ${email}\nãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: ${password}\n\nâ€»å ã„å¸«ã«ã“ã®æƒ…å ±ã‚’ä¼ãˆã¦ãã ã•ã„`
                );

                document.getElementById("addFortuneTellerForm").reset();
                document.getElementById("imagePreview").style.display = "none";
                resetImagePosition();
                loadData();
            } catch (error) {
                console.error("å ã„å¸«ç™»éŒ²ã‚¨ãƒ©ãƒ¼:", error);
                if (userCredential && userCredential.user) {
                    try {
                        await userCredential.user.delete();
                    } catch (deleteError) {
                        console.error("Authãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", deleteError);
                    }
                }
                if (error.code === "auth/email-already-in-use") {
                    alert("ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™");
                } else if (error.code === "auth/weak-password") {
                    alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§è¨­å®šã—ã¦ãã ã•ã„");
                } else {
                    alert("ç™»éŒ²ã‚¨ãƒ©ãƒ¼: " + error.message);
                }
            }
        });

        // ==== åˆæœŸåŒ– ====
        function initializePage() {
            if (!window.firebaseReady) {
                window.addEventListener("firebaseReady", initializePage, { once: true });
                return;
            }
            console.log("ğŸš€ ç®¡ç†ç”»é¢åˆæœŸåŒ–é–‹å§‹...");
            loadData();
        }

        initializePage();
    </script>
</body>
</html>

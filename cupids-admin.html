<script>
    // ==== ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯ ====
    const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
    if (!currentUser || currentUser.type !== 'admin') {
        alert('ç®¡ç†è€…ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
        window.location.href = 'cupids-top.html';
    }

    // ä¸€è¦§ã‚„ãƒ¢ãƒ¼ãƒ€ãƒ«ã§ä½¿ã†ãŸã‚ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    let cachedUsers = [];
    let cachedFortuneTellers = [];

    // ==== ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ ====
    window.loadData = async function () {
        if (!window.firebaseReady || !window.firebaseDB) {
            console.log('â³ FirebaseåˆæœŸåŒ–å¾…æ©Ÿä¸­...');
            setTimeout(loadData, 500);
            return;
        }

        console.log('ğŸ“Š ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹...');

        try {
            // users
            const usersSnapshot = await window.firebaseGetDocs(
                window.firebaseCollection(window.firebaseDB, 'users')
            );
            const users = [];
            usersSnapshot.forEach(doc => {
                users.push({ id: doc.id, ...doc.data() });
            });

            // fortuneTellers
            const fortuneTellersSnapshot = await window.firebaseGetDocs(
                window.firebaseCollection(window.firebaseDB, 'fortuneTellers')
            );
            const fortuneTellers = [];
            fortuneTellersSnapshot.forEach(doc => {
                fortuneTellers.push({ id: doc.id, ...doc.data() });
            });

            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¦ãŠã
            cachedUsers = users;
            cachedFortuneTellers = fortuneTellers;

            // çµ±è¨ˆ
            document.getElementById('totalUsers').textContent = users.length;
            document.getElementById('totalFortuneTellers').textContent = fortuneTellers.length;

            let monthlyRevenue = 0;
            let totalCommission = 0;

            fortuneTellers.forEach(ft => {
                const revenue = ft.currentMonthRevenue || 0;
                monthlyRevenue += revenue;

                let commissionRate;
                if (ft.fixedCommissionRate) {
                    commissionRate = ft.fixedCommissionRate;
                } else {
                    const previousRevenue = ft.previousMonthRevenue || 0;
                    if (previousRevenue >= 270000) {
                        commissionRate = 40;
                    } else if (previousRevenue >= 210000) {
                        commissionRate = 38;
                    } else if (previousRevenue >= 150000) {
                        commissionRate = 36;
                    } else if (previousRevenue >= 90000) {
                        commissionRate = 34;
                    } else if (previousRevenue >= 30000) {
                        commissionRate = 32;
                    } else {
                        commissionRate = 30;
                    }
                }
                totalCommission += revenue * (commissionRate / 100);
            });

            const monthlyProfit = monthlyRevenue - totalCommission;

            document.getElementById('monthlyRevenue').textContent =
                'Â¥' + Math.floor(monthlyRevenue).toLocaleString();
            document.getElementById('monthlyProfit').textContent =
                'Â¥' + Math.floor(monthlyProfit).toLocaleString();

            // ä¸€è¦§è¡¨ç¤º
            displayUsers(users);
            displayFortuneTellers(fortuneTellers);

            // ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸€è¦§ & ãƒ©ãƒ³ã‚­ãƒ³ã‚°
            await loadReviews();
            displayRanking(fortuneTellers);

        } catch (error) {
            console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            document.getElementById('totalUsers').textContent = '0';
            document.getElementById('totalFortuneTellers').textContent = '0';
            document.getElementById('monthlyRevenue').textContent = 'Â¥0';
            document.getElementById('monthlyProfit').textContent = 'Â¥0';
        }
    };

    // ==== ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è¡¨ç¤ºï¼‰ ====
    function displayUsers(users) {
        const tbody = document.getElementById('usersList');

        if (!users.length) {
            tbody.innerHTML =
                '<tr><td colspan="6" style="text-align:center; color:#999;">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã¾ã›ã‚“</td></tr>';
            return;
        }

        // lastLoginAt â†’ createdAt ã®é †ã§ã€æ–°ã—ã„é †ã«ã‚½ãƒ¼ãƒˆ
        users.sort((a, b) => {
            const aTime = a.lastLoginAt
                ? new Date(a.lastLoginAt).getTime()
                : a.createdAt ? new Date(a.createdAt).getTime() : 0;
            const bTime = b.lastLoginAt
                ? new Date(b.lastLoginAt).getTime()
                : b.createdAt ? new Date(b.createdAt).getTime() : 0;
            return bTime - aTime;
        });

        tbody.innerHTML = '';
        users.forEach(user => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${user.name || '-'}</td>
                <td>${user.email || '-'}</td>
                <td>${user.type === 'client' ? 'ãŠå®¢æ§˜' : (user.type || '-')}</td>
                <td>${typeof user.points === 'number' ? user.points : 0}pt</td>
                <td>${user.createdAt ? new Date(user.createdAt).toLocaleDateString('ja-JP') : '-'}</td>
                <td>
                    <button onclick="addPointsToUser('${user.id}', '${user.name || ''}')"
                        style="background:#4CAF50; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">
                        â• ãƒã‚¤ãƒ³ãƒˆè¿½åŠ 
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // ==== å ã„å¸«ä¸€è¦§ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ï¼‹ã‚«ãƒ¼ãƒ‰ï¼‰ ====
    function displayFortuneTellers(fortuneTellers) {
        const tbody = document.getElementById('fortunetellersList');
        const cardsGrid = document.getElementById('fortunetellersGrid');

        if (!fortuneTellers.length) {
            tbody.innerHTML =
                '<tr><td colspan="9" style="text-align:center; color:#999;">å ã„å¸«ãŒã„ã¾ã›ã‚“</td></tr>';
            cardsGrid.innerHTML = '<div class="loading">å ã„å¸«ãŒã„ã¾ã›ã‚“</div>';
            return;
        }

        tbody.innerHTML = '';
        cardsGrid.innerHTML = '';

        fortuneTellers.forEach(ft => {
            const isNew = !!ft.isNew;

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
            let statusText = 'ä¸æ˜';
            if (ft.status === 'available') statusText = 'âš¡ å¾…æ©Ÿä¸­';
            else if (ft.status === 'accepting') statusText = 'ğŸ“ å—ä»˜ä¸­';
            else if (ft.status === 'stopped') statusText = 'â¸ï¸ åœæ­¢ä¸­';

            const totalReviews = ft.totalReviews || 0;
            const baseReviewCount = ft.baseReviewCount || 0;

            const ratingDisplay = ft.ratingFixed
                ? `<span class="star-display">â­ ${ft.averageRating || 0}</span><span class="fixed-badge">ğŸ”’ å›ºå®š</span><br>
                   <span style="font-size:12px; color:#666;">é‘‘å®š ${totalReviews}ä»¶${baseReviewCount > 0 ? ' (åŸºæº–:' + baseReviewCount + ')' : ''}</span>`
                : `<span class="star-display">â­ ${ft.averageRating || 0}</span><br>
                   <span style="font-size:12px; color:#666;">é‘‘å®š ${totalReviews}ä»¶${baseReviewCount > 0 ? ' (åŸºæº–:' + baseReviewCount + ')' : ''}</span>`;

            // å ±é…¬ç‡ï¼ˆè¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã¯ loadData ã¨åˆã‚ã›ã¦ã‚ã‚‹ï¼‰
            let commissionRate;
            if (ft.fixedCommissionRate) {
                commissionRate = ft.fixedCommissionRate;
            } else {
                const previousRevenue = ft.previousMonthRevenue || 0;
                if (previousRevenue >= 270000) commissionRate = 40;
                else if (previousRevenue >= 210000) commissionRate = 38;
                else if (previousRevenue >= 150000) commissionRate = 36;
                else if (previousRevenue >= 90000) commissionRate = 34;
                else if (previousRevenue >= 30000) commissionRate = 32;
                else commissionRate = 30;
            }
            const commissionDisplay = ft.fixedCommissionRate
                ? `<strong>${commissionRate}%</strong><span class="fixed-badge">ğŸ”’ å›ºå®š</span>`
                : `${commissionRate}%`;

            // --- ãƒ†ãƒ¼ãƒ–ãƒ«å´ ---
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    ${isNew ? '<span style="background:#ff4444; color:#fff; padding:2px 6px; border-radius:3px; font-size:10px; margin-right:5px;">NEW</span>' : ''}
                    <strong>${ft.name || '-'}</strong>
                </td>
                <td style="font-size:13px; color:#666;">${ft.email || '-'}</td>
                <td style="font-size:13px;">${ft.specialty || '-'}</td>
                <td><strong>${ft.price || 10}pt</strong>/æ–‡å­—</td>
                <td>${ratingDisplay}</td>
                <td>${commissionDisplay}</td>
                <td>${statusText}</td>
                <td>${ft.dummyActiveClients || 0}äºº</td>
                <td style="font-size:12px; color:#999;">â€» è©³ç´°ãƒœã‚¿ãƒ³é¡ã¯ã¾ã ç§»æ¤ã—ã¦ã„ã¾ã›ã‚“</td>
            `;
            tbody.appendChild(tr);

            // --- ã‚«ãƒ¼ãƒ‰å´ï¼ˆã‚¹ãƒãƒ›ç”¨ï¼‰ ---
            let statusTextCard = 'ä¸æ˜';
            let statusClass = 'inactive';
            if (ft.status === 'available') {
                statusTextCard = 'âš¡ å¾…æ©Ÿä¸­';
                statusClass = 'active';
            } else if (ft.status === 'accepting') {
                statusTextCard = 'ğŸ“ å—ä»˜ä¸­';
                statusClass = 'active';
            } else if (ft.status === 'stopped') {
                statusTextCard = 'â¸ï¸ åœæ­¢ä¸­';
                statusClass = 'inactive';
            }

            const card = document.createElement('div');
            card.className = 'ft-card';
            card.innerHTML = `
                <div class="ft-card-header">
                    <div>
                        <div class="ft-card-name">${ft.name || '-'}</div>
                        <div class="ft-card-email">${ft.email || '-'}</div>
                    </div>
                    <span class="ft-card-status ${statusClass}">${statusTextCard}</span>
                </div>
                <div class="ft-card-info">
                    <div class="ft-card-info-row">
                        <span class="ft-card-info-label">å°‚é–€åˆ†é‡</span>
                        <span class="ft-card-info-value">${ft.specialty || '-'}</span>
                    </div>
                    <div class="ft-card-info-row">
                        <span class="ft-card-info-label">æ–™é‡‘</span>
                        <span class="ft-card-info-value"><strong>${ft.price || 10}pt</strong>/æ–‡å­—</span>
                    </div>
                    <div class="ft-card-info-row">
                        <span class="ft-card-info-label">è©•ä¾¡</span>
                        <span class="ft-card-info-value">
                            <span class="star-display">â­ ${ft.averageRating || 0}</span>
                            ${ft.ratingFixed ? '<span class="fixed-badge">ğŸ”’ å›ºå®š</span>' : ''}
                        </span>
                    </div>
                    <div class="ft-card-info-row">
                        <span class="ft-card-info-label">å ±é…¬ç‡</span>
                        <span class="ft-card-info-value">
                            ${commissionRate}%
                            ${ft.fixedCommissionRate ? '<span class="fixed-badge">ğŸ”’ å›ºå®š</span>' : ''}
                        </span>
                    </div>
                </div>
            `;
            cardsGrid.appendChild(card);
        });
    }

    // ==== ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸€è¦§ï¼ˆ5ä»¶ã¶ã‚“é«˜ã•ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰ ====
    async function loadReviews() {
        const tbody = document.getElementById('reviewsList');
        if (!tbody) return;

        try {
            const reviewsRef = window.firebaseCollection(window.firebaseDB, 'reviews');
            const snapshot = await window.firebaseGetDocs(reviewsRef);

            if (snapshot.empty) {
                tbody.innerHTML =
                    '<tr><td colspan="6" style="text-align:center; color:#999;">ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                return;
            }

            const reviews = [];
            snapshot.forEach(doc => {
                reviews.push({ id: doc.id, ...doc.data() });
            });

            // æ–°ã—ã„é †ã«ã‚½ãƒ¼ãƒˆ
            reviews.sort((a, b) => {
                const aTime = a.createdAt ? new Date(a.createdAt).getTime() : 0;
                const bTime = b.createdAt ? new Date(b.createdAt).getTime() : 0;
                return bTime - aTime;
            });

            tbody.innerHTML = '';

            reviews.forEach(r => {
                const ft = cachedFortuneTellers.find(f => f.id === r.fortuneTellerId) || {};
                const user = cachedUsers.find(u => u.id === r.clientId) || {};

                const rating = r.rating || 0;
                const stars = 'â­'.repeat(rating);
                const dateText = r.createdAt
                    ? new Date(r.createdAt).toLocaleString('ja-JP')
                    : '-';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${ft.name || r.fortuneTellerId || '-'}</td>
                    <td>${user.name || r.clientId || '-'}</td>
                    <td>${stars}</td>
                    <td style="white-space:pre-wrap;">${r.comment || ''}</td>
                    <td>${dateText}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteReview('${r.id}')">
                            ğŸ—‘ï¸ å‰Šé™¤
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

        } catch (e) {
            console.error('ãƒ¬ãƒ“ãƒ¥ãƒ¼èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
            tbody.innerHTML =
                '<tr><td colspan="6" style="text-align:center; color:#f43f5e;">ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</td></tr>';
        }
    }

    // ==== ä»Šæœˆã®å£²ä¸Šãƒ©ãƒ³ã‚­ãƒ³ã‚° ====
    function displayRanking(fortuneTellers) {
        const wrapper = document.getElementById('rankingList');
        if (!wrapper) return;

        if (!fortuneTellers || !fortuneTellers.length) {
            wrapper.innerHTML =
                '<div class="loading">å ã„å¸«ãŒã„ã¾ã›ã‚“</div>';
            return;
        }

        const sorted = [...fortuneTellers]
            .filter(ft => (ft.currentMonthRevenue || 0) > 0)
            .sort((a, b) => (b.currentMonthRevenue || 0) - (a.currentMonthRevenue || 0));

        if (!sorted.length) {
            wrapper.innerHTML =
                '<div class="loading">ä»Šæœˆã®å£²ä¸Šãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
            return;
        }

        wrapper.innerHTML = '';

        sorted.forEach((ft, index) => {
            const rank = index + 1;
            const revenue = ft.currentMonthRevenue || 0;

            let medal = '';
            if (rank === 1) medal = 'ğŸ¥‡';
            else if (rank === 2) medal = 'ğŸ¥ˆ';
            else if (rank === 3) medal = 'ğŸ¥‰';

            // å ±é…¬ç‡ï¼ˆä»–ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
            let commissionRate;
            if (ft.fixedCommissionRate) {
                commissionRate = ft.fixedCommissionRate;
            } else {
                const previousRevenue = ft.previousMonthRevenue || 0;
                if (previousRevenue >= 270000) commissionRate = 40;
                else if (previousRevenue >= 210000) commissionRate = 38;
                else if (previousRevenue >= 150000) commissionRate = 36;
                else if (previousRevenue >= 90000) commissionRate = 34;
                else if (previousRevenue >= 30000) commissionRate = 32;
                else commissionRate = 30;
            }

            const commission = Math.floor(revenue * (commissionRate / 100));

            const item = document.createElement('div');
            item.className = 'ranking-item';
            item.innerHTML = `
                <div class="ranking-medal">${medal || rank + 'ä½'}</div>
                <div class="ranking-info">
                    <div class="ranking-name">${ft.name || '-'}</div>
                    <div class="ranking-email">${ft.email || '-'}</div>
                </div>
                <div class="ranking-sales">
                    <div class="ranking-amount">Â¥${Math.floor(revenue).toLocaleString()}</div>
                    <div class="ranking-commission">å ±é…¬: Â¥${commission.toLocaleString()}ï¼ˆ${commissionRate}%ï¼‰</div>
                </div>
            `;
            wrapper.appendChild(item);
        });
    }

    // ==== ãƒã‚¤ãƒ³ãƒˆè¿½åŠ  ====
    window.addPointsToUser = async function (userId, userName) {
        const value = prompt(
            `${userName || 'ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼'} ã«è¿½åŠ ã™ã‚‹ãƒã‚¤ãƒ³ãƒˆæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆãƒã‚¤ãƒŠã‚¹ã§æ¸›ç®—ã‚‚å¯ï¼‰`,
            '0'
        );
        if (value === null) return;

        const diff = Number(value);
        if (Number.isNaN(diff)) {
            alert('æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }

        try {
            const userRef = window.firebaseDoc(window.firebaseDB, 'users', userId);
            const snap = await window.firebaseGetDoc(userRef);
            if (!snap.exists()) {
                alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            const data = snap.data() || {};
            const current = typeof data.points === 'number' ? data.points : 0;
            const newPoints = current + diff;
            await window.firebaseUpdateDoc(userRef, { points: newPoints });
            alert(`ãƒã‚¤ãƒ³ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚ç¾åœ¨ã®æ®‹é«˜: ${newPoints}pt`);
            loadData(); // ç”»é¢æ›´æ–°
        } catch (e) {
            console.error('ãƒã‚¤ãƒ³ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:', e);
            alert('ãƒã‚¤ãƒ³ãƒˆã‚’æ›´æ–°ã§ãã¾ã›ã‚“ã§ã—ãŸ');
        }
    };

    // ==== ãƒ¬ãƒ“ãƒ¥ãƒ¼å‰Šé™¤ ====
    window.deleteReview = async function (reviewId) {
        if (!confirm('ã“ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

        try {
            const ref = window.firebaseDoc(window.firebaseDB, 'reviews', reviewId);
            await window.firebaseDeleteDoc(ref);
            alert('ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            await loadReviews();
        } catch (e) {
            console.error('ãƒ¬ãƒ“ãƒ¥ãƒ¼å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', e);
            alert('ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å‰Šé™¤ã§ãã¾ã›ã‚“ã§ã—ãŸ');
        }
    };

    // ==== ãƒ¬ãƒ“ãƒ¥ãƒ¼è¿½åŠ ãƒœã‚¿ãƒ³ï¼ˆã¨ã‚Šã‚ãˆãšç°¡æ˜“ã‚¢ãƒ©ãƒ¼ãƒˆï¼‰ ====
    window.showAddReviewModal = function () {
        alert('ã”ã‚ã‚“ã­ã€ãƒ¬ãƒ“ãƒ¥ãƒ¼è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ ã¯ã¾ã ç§»æ¤ã—ã¦ãªã„ã‹ã‚‰ã€\nä»Šã¯ Firestore ã®ã€Œreviewsã€ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ç›´æ¥è¿½åŠ ã—ã¦ã­ğŸ™');
    };

    // ==== ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ ====
    window.logout = function () {
        localStorage.removeItem('currentUser');
        window.location.href = 'cupids-top.html';
    };
</script>

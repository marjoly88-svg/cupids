<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚«ãƒ«ãƒ† - ã‚­ãƒ¥ãƒ¼ãƒ”ãƒƒã‚º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', sans-serif;
            background: linear-gradient(135deg, #FCE7F3 0%, #DBEAFE 100%);
            min-height: 100vh;
            padding-bottom: 20px;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            background: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .back-button {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .save-button {
            background: linear-gradient(135deg, #FF69B4, #9370DB);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .save-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(255,105,180,0.3);
        }

        .block-button {
            background: #ef4444;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 10px;
        }

        .block-button:hover {
            background: #dc2626;
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(239, 68, 68, 0.3);
        }

        .header-buttons {
            display: flex;
            gap: 10px;
        }

        /* ä¿å­˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .save-message {
            max-width: 800px;
            margin: 16px auto;
            padding: 12px 16px;
            background: #10b981;
            color: white;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ãƒ–ãƒ­ãƒƒã‚¯ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« */
        .block-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .block-modal.active {
            display: flex;
        }

        .block-modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .block-modal-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }

        .block-modal-text {
            font-size: 14px;
            color: #666;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .block-modal-buttons {
            display: flex;
            gap: 10px;
        }

        .block-modal-button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .block-modal-button.cancel {
            background: #f0f0f0;
            color: #666;
        }

        .block-modal-button.cancel:hover {
            background: #e0e0e0;
        }

        .block-modal-button.confirm {
            background: #ef4444;
            color: white;
        }

        .block-modal-button.confirm:hover {
            background: #dc2626;
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(239, 68, 68, 0.3);
        }

        /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .section-title.memo {
            color: #EC4899;
        }

        .section-title.person {
            color: #333;
        }

        /* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´  */
        .form-group {
            margin-bottom: 12px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #9370DB;
        }

        .form-input:disabled, .form-select:disabled {
            background: #f9fafb;
            color: #6b7280;
        }

        .form-textarea {
            width: 100%;
            min-height: 200px;
            max-height: 200px;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            resize: none;
            overflow-y: auto;
            background: #f3f4f6;
            font-family: inherit;
        }

        .form-textarea:focus {
            outline: none;
            border-color: #9370DB;
        }

        .placeholder-text {
            color: #9ca3af;
        }

        /* èª¬æ˜ãƒ†ã‚­ã‚¹ãƒˆ */
        .info-text {
            font-size: 12px;
            color: #999;
            margin-top: 8px;
        }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }
    </style>
</head>
<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="header">
        <div class="header-left">
            <button class="back-button" onclick="goBack()">â†</button>
            <div class="header-title">ç›¸è«‡è€…ã‚«ãƒ«ãƒ†</div>
        </div>
        <div class="header-buttons" id="headerButtons">
            <!-- å ã„å¸«ã®ã¿ãƒ–ãƒ­ãƒƒã‚¯ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º -->
        </div>
    </div>

    <!-- ä¿å­˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
    <div id="saveMessage" style="display: none;"></div>

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
    <div id="loadingIndicator" class="loading">
        <div>èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

    <div class="container" id="karteContainer" style="display: none;">
        <!-- ãƒ¡ãƒ¢ï¼ˆå ã„å¸«ã®ã¿ï¼‰ -->
        <div class="section" id="memoSection" style="display: none;">
            <div class="section-title memo">ğŸ“ ãƒ¡ãƒ¢ï¼ˆå ã„å¸«ã®ã¿é–²è¦§å¯èƒ½ï¼‰</div>
            <textarea 
                id="memoField" 
                class="form-textarea" 
                placeholder="ã“ã®ãƒ¡ãƒ¢ã¯ç›¸è«‡è€…ã«ã¯è¦‹ã‚‰ã‚Œã¾ã›ã‚“ã€‚è‡ªç”±ã«ãƒ¡ãƒ¢ã‚’æ®‹ã—ã¦ãã ã•ã„ã€‚">
            </textarea>
            <div class="info-text">â€»ã“ã®ãƒ¡ãƒ¢ã¯ã‚ãªãŸä»¥å¤–ã«è¦‹ã‚‰ã‚Œã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“</div>
        </div>

        <!-- æœ¬äººæƒ…å ± -->
        <div class="section">
            <div class="section-title person">ğŸ‘¤ æœ¬äººæƒ…å ±</div>
            <div class="form-group">
                <input type="text" id="name" class="form-input" placeholder="ãŠåå‰" maxlength="10">
            </div>
            <div class="form-group">
                <input type="text" id="furigana" class="form-input" placeholder="ãµã‚ŠãŒãª" maxlength="10">
            </div>
            <div class="form-group">
                <select id="gender" class="form-select">
                    <option value="">æ€§åˆ¥</option>
                    <option value="male">ç”·æ€§</option>
                    <option value="female">å¥³æ€§</option>
                    <option value="other">ãã®ä»–</option>
                </select>
            </div>
            <div class="form-group">
                <input type="date" id="birthDate" class="form-input" placeholder="ç”Ÿå¹´æœˆæ—¥">
            </div>
            <div class="form-group">
                <input type="text" id="birthTime" class="form-input" placeholder="å‡ºç”Ÿæ™‚é–“ï¼ˆã‚ã‹ã‚‹æ–¹ï¼‰" maxlength="10">
            </div>
            <div class="form-group">
                <input type="text" id="birthPlace" class="form-input" placeholder="å‡ºç”Ÿåœ°ï¼ˆå¸‚ç”ºæ‘ã¾ã§ï¼‰" maxlength="10">
            </div>
            <div class="form-group">
                <select id="bloodType" class="form-select">
                    <option value="">è¡€æ¶²å‹</option>
                    <option value="A">Aå‹</option>
                    <option value="B">Bå‹</option>
                    <option value="O">Oå‹</option>
                    <option value="AB">ABå‹</option>
                </select>
            </div>
            <div class="form-group">
                <select id="maritalStatus" class="form-select">
                    <option value="">å©šå§»çŠ¶æ…‹</option>
                    <option value="single">ç‹¬èº«</option>
                    <option value="married">æ—¢å©š</option>
                    <option value="divorced">é›¢å©š</option>
                    <option value="widowed">æ­»åˆ¥</option>
                </select>
            </div>
        </div>

        <!-- ç›¸æ‰‹æƒ…å ±1 -->
        <div class="section">
            <div class="section-title person">ğŸ’‘ ç›¸æ‰‹æƒ…å ±1</div>
            <div class="form-group">
                <input type="text" id="partner1Name" class="form-input" placeholder="ãŠåå‰" maxlength="10">
            </div>
            <div class="form-group">
                <input type="text" id="partner1Furigana" class="form-input" placeholder="ãµã‚ŠãŒãª" maxlength="10">
            </div>
            <div class="form-group">
                <select id="partner1Gender" class="form-select">
                    <option value="">æ€§åˆ¥</option>
                    <option value="male">ç”·æ€§</option>
                    <option value="female">å¥³æ€§</option>
                    <option value="other">ãã®ä»–</option>
                </select>
            </div>
            <div class="form-group">
                <input type="date" id="partner1BirthDate" class="form-input" placeholder="ç”Ÿå¹´æœˆæ—¥">
            </div>
            <div class="form-group">
                <input type="text" id="partner1BirthTime" class="form-input" placeholder="å‡ºç”Ÿæ™‚é–“" maxlength="10">
            </div>
            <div class="form-group">
                <input type="text" id="partner1BirthPlace" class="form-input" placeholder="å‡ºç”Ÿåœ°" maxlength="10">
            </div>
            <div class="form-group">
                <select id="partner1BloodType" class="form-select">
                    <option value="">è¡€æ¶²å‹</option>
                    <option value="A">Aå‹</option>
                    <option value="B">Bå‹</option>
                    <option value="O">Oå‹</option>
                    <option value="AB">ABå‹</option>
                </select>
            </div>
            <div class="form-group">
                <select id="partner1MaritalStatus" class="form-select">
                    <option value="">å©šå§»çŠ¶æ…‹</option>
                    <option value="single">ç‹¬èº«</option>
                    <option value="married">æ—¢å©š</option>
                    <option value="divorced">é›¢å©š</option>
                    <option value="widowed">æ­»åˆ¥</option>
                </select>
            </div>
            <div class="form-group">
                <input type="text" id="partner1Relationship" class="form-input" placeholder="é–¢ä¿‚æ€§ï¼ˆæ‹äººã€é…å¶è€…ãªã©ï¼‰" maxlength="20">
            </div>
        </div>

        <!-- ç›¸æ‰‹æƒ…å ±2 -->
        <div class="section">
            <div class="section-title person">ğŸ’‘ ç›¸æ‰‹æƒ…å ±2</div>
            <div class="form-group">
                <input type="text" id="partner2Name" class="form-input" placeholder="ãŠåå‰" maxlength="10">
            </div>
            <div class="form-group">
                <input type="text" id="partner2Furigana" class="form-input" placeholder="ãµã‚ŠãŒãª" maxlength="10">
            </div>
            <div class="form-group">
                <select id="partner2Gender" class="form-select">
                    <option value="">æ€§åˆ¥</option>
                    <option value="male">ç”·æ€§</option>
                    <option value="female">å¥³æ€§</option>
                    <option value="other">ãã®ä»–</option>
                </select>
            </div>
            <div class="form-group">
                <input type="date" id="partner2BirthDate" class="form-input" placeholder="ç”Ÿå¹´æœˆæ—¥">
            </div>
            <div class="form-group">
                <input type="text" id="partner2BirthTime" class="form-input" placeholder="å‡ºç”Ÿæ™‚é–“" maxlength="10">
            </div>
            <div class="form-group">
                <input type="text" id="partner2BirthPlace" class="form-input" placeholder="å‡ºç”Ÿåœ°" maxlength="10">
            </div>
            <div class="form-group">
                <select id="partner2BloodType" class="form-select">
                    <option value="">è¡€æ¶²å‹</option>
                    <option value="A">Aå‹</option>
                    <option value="B">Bå‹</option>
                    <option value="O">Oå‹</option>
                    <option value="AB">ABå‹</option>
                </select>
            </div>
            <div class="form-group">
                <select id="partner2MaritalStatus" class="form-select">
                    <option value="">å©šå§»çŠ¶æ…‹</option>
                    <option value="single">ç‹¬èº«</option>
                    <option value="married">æ—¢å©š</option>
                    <option value="divorced">é›¢å©š</option>
                    <option value="widowed">æ­»åˆ¥</option>
                </select>
            </div>
            <div class="form-group">
                <input type="text" id="partner2Relationship" class="form-input" placeholder="é–¢ä¿‚æ€§ï¼ˆæ‹äººã€é…å¶è€…ãªã©ï¼‰" maxlength="20">
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyA52uJ31HzLkbz32lA-3WWSmhM10xYjjCg",
            authDomain: "cupids-chat.firebaseapp.com",
            projectId: "cupids-chat",
            storageBucket: "cupids-chat.firebasestorage.app",
            messagingSenderId: "44532110483",
            appId: "1:44532110483:web:d6266e8abba8582b8b6966"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.firebaseAuth = auth;
        window.firebaseDB = db;
        window.firebaseDoc = doc;
        window.firebaseGetDoc = getDoc;
        window.firebaseSetDoc = setDoc;

        // FirebaseåˆæœŸåŒ–å®Œäº†ã‚’é€šçŸ¥
        window.firebaseReady = true;
        window.dispatchEvent(new Event('firebaseReady'));
        console.log('âœ… FirebaseåˆæœŸåŒ–å®Œäº†!');
    </script>

    <script>
        // ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
        const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
        if (!currentUser) {
            alert('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
            window.location.href = 'client-login.html';
        }

        const isClient = currentUser.type === 'client';
        const isFortuneTeller = currentUser.type === 'fortune-teller';

        // ã‚«ãƒ«ãƒ†ã®IDã‚’æ±ºå®š
        let karteId = null;
        let clientIdForKarte = null; // ãŠå®¢æ§˜ã®UID
        const karteMode = localStorage.getItem('karteMode');

        if (karteMode === 'myKarte') {
            // ãƒã‚¤ãƒšãƒ¼ã‚¸ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹: è‡ªåˆ†ã®ã‚«ãƒ«ãƒ†
            karteId = currentUser.uid;
            clientIdForKarte = currentUser.uid;
            localStorage.removeItem('karteMode'); // ä½¿ç”¨å¾Œã¯å‰Šé™¤
        } else {
            // ãƒãƒ£ãƒƒãƒˆç”»é¢ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹
            const conversationId = localStorage.getItem('selectedConversationId');
            if (isClient) {
                // ãŠå®¢æ§˜ã®å ´åˆ: å¸¸ã«è‡ªåˆ†ã®ã‚«ãƒ«ãƒ†
                karteId = currentUser.uid;
                clientIdForKarte = currentUser.uid;
            } else if (conversationId) {
                // å ã„å¸«ã®å ´åˆ: ä¼šè©±æƒ…å ±ã‹ã‚‰clientIdã‚’å–å¾—
                karteId = 'temp-' + conversationId; // ä¸€æ—¦ä»®ã®å€¤ã€å¾Œã§loadKarteã§å–å¾—
                clientIdForKarte = null; // loadKarteã§å–å¾—
            } else {
                // å ã„å¸«ã§ä¼šè©±IDãŒãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
                alert('ä¼šè©±ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
                window.location.href = 'fortune-lobby.html';
            }
        }

        if (!karteId) {
            alert('ã‚«ãƒ«ãƒ†IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            window.location.href = 'index.html';
        }

        let karteData = {}; // ãŠå®¢æ§˜æƒ…å ±
        let fortuneTellerMemo = ''; // å ã„å¸«ã®ãƒ¡ãƒ¢(å ã„å¸«ã”ã¨ã«åˆ¥ç®¡ç†)

        // ã‚«ãƒ«ãƒ†ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        window.loadKarte = async function() {
            try {
                // å ã„å¸«ã®å ´åˆã€ã¾ãšä¼šè©±ã‹ã‚‰clientIdã‚’å–å¾—
                if (isFortuneTeller && !clientIdForKarte) {
                    const conversationId = localStorage.getItem('selectedConversationId');
                    if (conversationId) {
                        const convRef = window.firebaseDoc(window.firebaseDB, 'conversations', conversationId);
                        const convDoc = await window.firebaseGetDoc(convRef);
                        if (convDoc.exists()) {
                            clientIdForKarte = convDoc.data().clientId;
                            karteId = clientIdForKarte;
                        } else {
                            alert('ä¼šè©±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                            window.location.href = 'index.html';
                            return;
                        }
                    }
                }

                // clientIdForKarteãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
                if (!clientIdForKarte) {
                    throw new Error('ãŠå®¢æ§˜ã®IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚clientIdForKarte is null/undefined.');
                }

                // clientIdForKarteã‚’ä½¿ã£ã¦ã‚«ãƒ«ãƒ†(ãŠå®¢æ§˜æƒ…å ±)ã‚’èª­ã¿è¾¼ã¿
                const karteRef = window.firebaseDoc(window.firebaseDB, 'kartes', clientIdForKarte);
                const karteDoc = await window.firebaseGetDoc(karteRef);

                if (karteDoc.exists()) {
                    karteData = karteDoc.data();
                } else {
                    // ã‚«ãƒ«ãƒ†ãŒã¾ã å­˜åœ¨ã—ãªã„å ´åˆã¯ç©ºã®ãƒ‡ãƒ¼ã‚¿
                    karteData = {
                        clientId: clientIdForKarte,
                        name: '',
                        furigana: '',
                        gender: '',
                        birthDate: '',
                        birthTime: '',
                        birthPlace: '',
                        bloodType: '',
                        maritalStatus: '',
                        partner1: {
                            name: '',
                            furigana: '',
                            gender: '',
                            birthDate: '',
                            birthTime: '',
                            birthPlace: '',
                            bloodType: '',
                            maritalStatus: '',
                            relationship: ''
                        },
                        partner2: {
                            name: '',
                            furigana: '',
                            gender: '',
                            birthDate: '',
                            birthTime: '',
                            birthPlace: '',
                            bloodType: '',
                            maritalStatus: '',
                            relationship: ''
                        }
                    };
                }

                // å ã„å¸«ã®å ´åˆã¯ã€è‡ªåˆ†å°‚ç”¨ã®ãƒ¡ãƒ¢ã‚’èª­ã¿è¾¼ã¿
                if (isFortuneTeller) {
                    const memoId = `${clientIdForKarte}_${currentUser.uid}`;
                    const memoRef = window.firebaseDoc(window.firebaseDB, 'memos', memoId);
                    const memoDoc = await window.firebaseGetDoc(memoRef);
                    
                    if (memoDoc.exists()) {
                        fortuneTellerMemo = memoDoc.data().memo || '';
                    } else {
                        fortuneTellerMemo = '';
                    }
                }

                displayKarte();
            } catch (error) {
                console.error('ã‚«ãƒ«ãƒ†èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                
                // ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã‚‚ãƒ¡ãƒ¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯éè¡¨ç¤ºã«ã™ã‚‹
                const memoSection = document.getElementById('memoSection');
                if (isClient) {
                    memoSection.style.display = 'none';
                }
                
                // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã¦ç”»é¢ã¯è¡¨ç¤ºã™ã‚‹
                alert('ã‚«ãƒ«ãƒ†ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                
                // ç©ºã®ãƒ‡ãƒ¼ã‚¿ã§è¡¨ç¤º
                karteData = {
                    clientId: clientIdForKarte,
                    name: '',
                    furigana: '',
                    gender: '',
                    birthDate: '',
                    birthTime: '',
                    birthPlace: '',
                    bloodType: '',
                    maritalStatus: '',
                    partner1: {
                        name: '',
                        furigana: '',
                        gender: '',
                        birthDate: '',
                        birthTime: '',
                        birthPlace: '',
                        bloodType: '',
                        maritalStatus: '',
                        relationship: ''
                    },
                    partner2: {
                        name: '',
                        furigana: '',
                        gender: '',
                        birthDate: '',
                        birthTime: '',
                        birthPlace: '',
                        bloodType: '',
                        maritalStatus: '',
                        relationship: ''
                    }
                };
                displayKarte();
            }
        }

        // ã‚«ãƒ«ãƒ†ã‚’è¡¨ç¤º
        function displayKarte() {
            // ãƒ¡ãƒ¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå ã„å¸«ã®ã¿è¡¨ç¤ºï¼‰
            const memoSection = document.getElementById('memoSection');
            if (isClient) {
                memoSection.style.display = 'none';
            } else {
                memoSection.style.display = 'block';
                document.getElementById('memoField').value = fortuneTellerMemo || '';
            }

            // æœ¬äººæƒ…å ±
            document.getElementById('name').value = karteData.name || '';
            document.getElementById('furigana').value = karteData.furigana || '';
            document.getElementById('gender').value = karteData.gender || '';
            document.getElementById('birthDate').value = karteData.birthDate || '';
            document.getElementById('birthTime').value = karteData.birthTime || '';
            document.getElementById('birthPlace').value = karteData.birthPlace || '';
            document.getElementById('bloodType').value = karteData.bloodType || '';
            document.getElementById('maritalStatus').value = karteData.maritalStatus || '';

            // ç›¸æ‰‹1
            const p1 = karteData.partner1 || {};
            document.getElementById('partner1Name').value = p1.name || '';
            document.getElementById('partner1Furigana').value = p1.furigana || '';
            document.getElementById('partner1Gender').value = p1.gender || '';
            document.getElementById('partner1BirthDate').value = p1.birthDate || '';
            document.getElementById('partner1BirthTime').value = p1.birthTime || '';
            document.getElementById('partner1BirthPlace').value = p1.birthPlace || '';
            document.getElementById('partner1BloodType').value = p1.bloodType || '';
            document.getElementById('partner1MaritalStatus').value = p1.maritalStatus || '';
            document.getElementById('partner1Relationship').value = p1.relationship || '';

            // ç›¸æ‰‹2
            const p2 = karteData.partner2 || {};
            document.getElementById('partner2Name').value = p2.name || '';
            document.getElementById('partner2Furigana').value = p2.furigana || '';
            document.getElementById('partner2Gender').value = p2.gender || '';
            document.getElementById('partner2BirthDate').value = p2.birthDate || '';
            document.getElementById('partner2BirthTime').value = p2.birthTime || '';
            document.getElementById('partner2BirthPlace').value = p2.birthPlace || '';
            document.getElementById('partner2BloodType').value = p2.bloodType || '';
            document.getElementById('partner2MaritalStatus').value = p2.maritalStatus || '';
            document.getElementById('partner2Relationship').value = p2.relationship || '';

            // ç·¨é›†å¯å¦ã‚’è¨­å®š
            setEditableFields();
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éè¡¨ç¤ºã«ã—ã¦ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('karteContainer').style.display = 'block';
        }

        // ç·¨é›†å¯å¦ã‚’è¨­å®š
        function setEditableFields() {
            const personalFields = [
                'name', 'furigana', 'gender', 'birthDate', 'birthTime', 'birthPlace', 'bloodType', 'maritalStatus',
                'partner1Name', 'partner1Furigana', 'partner1Gender', 'partner1BirthDate', 'partner1BirthTime', 'partner1BirthPlace', 'partner1BloodType', 'partner1MaritalStatus', 'partner1Relationship',
                'partner2Name', 'partner2Furigana', 'partner2Gender', 'partner2BirthDate', 'partner2BirthTime', 'partner2BirthPlace', 'partner2BloodType', 'partner2MaritalStatus', 'partner2Relationship'
            ];

            if (isClient) {
                // ãŠå®¢æ§˜: æœ¬äººæƒ…å ±ãƒ»ç›¸æ‰‹æƒ…å ±ã‚’ç·¨é›†å¯èƒ½
                personalFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.removeAttribute('readonly');
                        field.removeAttribute('disabled');
                        field.style.background = 'white';
                        field.style.cursor = 'text';
                    }
                });
            } else {
                // å ã„å¸«: æœ¬äººæƒ…å ±ãƒ»ç›¸æ‰‹æƒ…å ±ã¯èª­ã¿å–ã‚Šå°‚ç”¨
                personalFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.setAttribute('readonly', 'readonly');
                        if (field.tagName === 'SELECT') {
                            field.setAttribute('disabled', 'disabled');
                        }
                    }
                });
            }
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒœã‚¿ãƒ³ã‚’è¨­å®š
            setupHeaderButtons();
        }

        // ã‚«ãƒ«ãƒ†ã‚’ä¿å­˜
        async function saveKarte() {
            try {
                // clientIdForKarteãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
                if (!clientIdForKarte) {
                    alert('ãŠå®¢æ§˜ã®IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ä¿å­˜ã§ãã¾ã›ã‚“ã€‚');
                    return;
                }

                if (isClient) {
                    // ãŠå®¢æ§˜: æœ¬äººæƒ…å ±ãƒ»ç›¸æ‰‹æƒ…å ±ã‚’æ›´æ–°
                    karteData.name = document.getElementById('name').value;
                    karteData.furigana = document.getElementById('furigana').value;
                    karteData.gender = document.getElementById('gender').value;
                    karteData.birthDate = document.getElementById('birthDate').value;
                    karteData.birthTime = document.getElementById('birthTime').value;
                    karteData.birthPlace = document.getElementById('birthPlace').value;
                    karteData.bloodType = document.getElementById('bloodType').value;
                    karteData.maritalStatus = document.getElementById('maritalStatus').value;

                    // ç›¸æ‰‹1
                    karteData.partner1 = {
                        name: document.getElementById('partner1Name').value,
                        furigana: document.getElementById('partner1Furigana').value,
                        gender: document.getElementById('partner1Gender').value,
                        birthDate: document.getElementById('partner1BirthDate').value,
                        birthTime: document.getElementById('partner1BirthTime').value,
                        birthPlace: document.getElementById('partner1BirthPlace').value,
                        bloodType: document.getElementById('partner1BloodType').value,
                        maritalStatus: document.getElementById('partner1MaritalStatus').value,
                        relationship: document.getElementById('partner1Relationship').value
                    };

                    // ç›¸æ‰‹2
                    karteData.partner2 = {
                        name: document.getElementById('partner2Name').value,
                        furigana: document.getElementById('partner2Furigana').value,
                        gender: document.getElementById('partner2Gender').value,
                        birthDate: document.getElementById('partner2BirthDate').value,
                        birthTime: document.getElementById('partner2BirthTime').value,
                        birthPlace: document.getElementById('partner2BirthPlace').value,
                        bloodType: document.getElementById('partner2BloodType').value,
                        maritalStatus: document.getElementById('partner2MaritalStatus').value,
                        relationship: document.getElementById('partner2Relationship').value
                    };

                    // ãŠå®¢æ§˜æƒ…å ±ã‚’kartesã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ä¿å­˜
                    const karteRef = window.firebaseDoc(window.firebaseDB, 'kartes', clientIdForKarte);
                    await window.firebaseSetDoc(karteRef, karteData, { merge: true });

                } else {
                    // å ã„å¸«: ãƒ¡ãƒ¢ã®ã¿æ›´æ–°(memosã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«åˆ¥é€”ä¿å­˜)
                    fortuneTellerMemo = document.getElementById('memoField').value;
                    
                    const memoId = `${clientIdForKarte}_${currentUser.uid}`;
                    const memoRef = window.firebaseDoc(window.firebaseDB, 'memos', memoId);
                    await window.firebaseSetDoc(memoRef, {
                        clientId: clientIdForKarte,
                        fortuneTellerId: currentUser.uid,
                        memo: fortuneTellerMemo,
                        updatedAt: new Date().toISOString()
                    }, { merge: true });
                }

                // ä¿å­˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                const saveMessage = document.getElementById('saveMessage');
                saveMessage.textContent = 'âœ… ä¿å­˜ã—ã¾ã—ãŸ';
                saveMessage.className = 'save-message';
                saveMessage.style.display = 'block';

                setTimeout(() => {
                    saveMessage.style.display = 'none';
                }, 3000);

            } catch (error) {
                console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒœã‚¿ãƒ³ã‚’è¨­å®š
        function setupHeaderButtons() {
            const headerButtons = document.getElementById('headerButtons');
            headerButtons.innerHTML = '';
            
            if (isFortuneTeller) {
                // å ã„å¸«ã®å ´åˆã€ãƒ–ãƒ­ãƒƒã‚¯ãƒœã‚¿ãƒ³ã¨ä¿å­˜ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                headerButtons.innerHTML = `
                    <button class="block-button" onclick="showBlockModal()">ğŸš« ãƒ–ãƒ­ãƒƒã‚¯</button>
                    <button class="save-button" onclick="saveKarte()">ğŸ’¾ ä¿å­˜</button>
                `;
            } else {
                // ãŠå®¢æ§˜ã®å ´åˆã€ä¿å­˜ãƒœã‚¿ãƒ³ã®ã¿
                headerButtons.innerHTML = `
                    <button class="save-button" onclick="saveKarte()">ğŸ’¾ ä¿å­˜</button>
                `;
            }
        }

        // ãƒ–ãƒ­ãƒƒã‚¯ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        function showBlockModal() {
            const modal = document.getElementById('blockModal');
            modal.classList.add('active');
        }

        // ãƒ–ãƒ­ãƒƒã‚¯ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeBlockModal() {
            const modal = document.getElementById('blockModal');
            modal.classList.remove('active');
        }

        // ãƒ–ãƒ­ãƒƒã‚¯å®Ÿè¡Œ
        async function confirmBlock() {
            if (!clientIdForKarte) {
                alert('ãŠå®¢æ§˜ã®IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            try {
                // Firebaseã« blocked ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ 
                const conversationId = localStorage.getItem('selectedConversationId');
                if (conversationId) {
                    const convRef = window.firebaseDoc(window.firebaseDB, 'conversations', conversationId);
                    await window.firebaseSetDoc(convRef, {
                        blocked: true,
                        blockedBy: currentUser.uid,
                        blockedAt: new Date().toISOString()
                    }, { merge: true });
                    
                    console.log('âœ… ãŠå®¢æ§˜ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¾ã—ãŸ');
                    alert('ãŠå®¢æ§˜ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¾ã—ãŸã€‚ã“ã®ä¼šè©±ã‹ã‚‰ã®æ–°è¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯å—ã‘å–ã‚Šã¾ã›ã‚“ã€‚');
                    
                    closeBlockModal();
                    
                    // ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚‹
                    setTimeout(() => {
                        window.location.href = 'fortune-lobby.html';
                    }, 1000);
                } else {
                    alert('ä¼šè©±IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
            } catch (error) {
                console.error('ãƒ–ãƒ­ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ–ãƒ­ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        function goBack() {
            // ãŠå®¢æ§˜ã¨å ã„å¸«ã§æˆ»ã‚‹å…ˆã‚’å¤‰ãˆã‚‹
            if (isClient) {
                // ãŠå®¢æ§˜ã®å ´åˆã¯ãƒãƒ£ãƒƒãƒˆç”»é¢ã«æˆ»ã‚‹
                const conversationId = localStorage.getItem('selectedConversationId');
                if (conversationId) {
                    window.location.href = `mail-chat.html?conversationId=${conversationId}`;
                } else {
                    window.location.href = 'index.html';
                }
            } else {
                // å ã„å¸«ã®å ´åˆã¯ãƒãƒ£ãƒƒãƒˆç”»é¢ã«æˆ»ã‚‹
                const conversationId = localStorage.getItem('selectedConversationId');
                if (conversationId) {
                    window.location.href = `fortune-chat.html?conversationId=${conversationId}`;
                } else {
                    window.location.href = 'fortune-lobby.html';
                }
            }
        }

        // FirebaseåˆæœŸåŒ–ã‚’å¾…ã£ã¦ã‹ã‚‰å®Ÿè¡Œ
        function initializePage() {
            if (!window.firebaseReady) {
                // FirebaseãŒã¾ã æº–å‚™ã§ãã¦ã„ãªã„å ´åˆã¯ã€ã‚¤ãƒ™ãƒ³ãƒˆã‚’å¾…ã¤
                window.addEventListener('firebaseReady', initializePage, { once: true });
                return;
            }
            
            console.log('ğŸš€ ã‚«ãƒ«ãƒ†åˆæœŸåŒ–é–‹å§‹...');
            window.loadKarte();
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«åˆæœŸåŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializePage);
        } else {
            initializePage();
        }
    </script>

    <!-- ãƒ–ãƒ­ãƒƒã‚¯ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="block-modal" id="blockModal">
        <div class="block-modal-content">
            <div class="block-modal-title">âš ï¸ ãƒ–ãƒ­ãƒƒã‚¯ç¢ºèª</div>
            <div class="block-modal-text">
                æœ¬å½“ã«ã“ã®ãŠå®¢æ§˜ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¾ã™ã‹ï¼Ÿ<br>
                ãƒ–ãƒ­ãƒƒã‚¯å¾Œã¯ã€ã“ã®ãŠå®¢æ§˜ã‹ã‚‰ã®æ–°è¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ã‘å–ã‚Œãªããªã‚Šã¾ã™ã€‚
            </div>
            <div class="block-modal-buttons">
                <button class="block-modal-button cancel" onclick="closeBlockModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="block-modal-button confirm" onclick="confirmBlock()">ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹</button>
            </div>
        </div>
    </div>
</body>
</html>

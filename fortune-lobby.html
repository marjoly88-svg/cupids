<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å ã„å¸«ãƒ­ãƒ“ãƒ¼ - ã‚­ãƒ¥ãƒ¼ãƒ”ãƒƒã‚º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', sans-serif;
            background: linear-gradient(135deg, #FFE5F0 0%, #E5E5FF 100%);
            min-height: 100vh;
            padding-bottom: 80px;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            background: linear-gradient(90deg, #E967A5 0%, #B565D8 100%);
            padding: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .fortune-teller-name {
            color: white;
            font-size: 18px;
            font-weight: bold;
        }

        .header-buttons {
            display: flex;
            gap: 8px;
        }

        .header-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .header-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* å ±é…¬ç¢ºèªã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .revenue-section {
            background: linear-gradient(135deg, #E967A5 0%, #B565D8 100%);
            margin: 16px;
            padding: 24px;
            border-radius: 20px;
            color: white;
            box-shadow: 0 4px 15px rgba(233, 103, 165, 0.3);
        }

        .revenue-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .revenue-current {
            margin-bottom: 12px;
        }

        .revenue-amount {
            font-size: 28px;
            font-weight: bold;
            margin: 8px 0;
        }

        .revenue-count {
            font-size: 14px;
            opacity: 0.9;
        }

        .revenue-last-month {
            font-size: 14px;
            opacity: 0.8;
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.3);
        }

        /* å¾…æ©ŸçŠ¶æ…‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .status-section {
            background: white;
            margin: 16px;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .status-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-buttons {
            display: flex;
            gap: 12px;
        }

        .status-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #E0E0E0;
            border-radius: 12px;
            background: white;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .status-btn.active {
            background: linear-gradient(135deg, #7FD959 0%, #4CAF50 100%);
            color: white;
            border-color: #4CAF50;
        }

        .status-btn.accepting {
            background: linear-gradient(135deg, #FFC107 0%, #FF9800 100%);
            color: white;
            border-color: #FF9800;
        }

        .status-description {
            margin-top: 12px;
            font-size: 13px;
            color: #666;
        }

        /* ãŠå®¢æ§˜ä¸€è¦§ */
        .clients-section {
            background: white;
            margin: 16px;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .clients-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .client-card {
            background: #FAFAFA;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .client-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: #E967A5;
        }

        .client-card.new {
            border-color: #FFD700;
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.2);
        }

        .client-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .client-name {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .new-badge {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }

        .client-points {
            color: #E967A5;
            font-weight: bold;
            font-size: 14px;
        }

        .client-preview {
            font-size: 13px;
            color: #666;
            margin-top: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .no-clients {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }
    </style>
</head>
<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="header">
        <div class="header-content">
            <div class="fortune-teller-name" id="fortuneTellerName">å ã„å¸«ã®ã¿ãªã¿ã•ã‚“</div>
            <div class="header-buttons">
                <button class="header-btn" onclick="goToProfile()">ãƒ—ãƒ­ãƒ•ç·¨é›†</button>
                <button class="header-btn" onclick="goToBlock()">ãƒ–ãƒ­ãƒƒã‚¯</button>
                <button class="header-btn" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
        </div>
    </div>

    <!-- å ±é…¬ç¢ºèª -->
    <div class="revenue-section">
        <div class="revenue-title">ğŸ’° å ±é…¬ç¢ºèª</div>
        <div class="revenue-current">
            <div>ä»Šæœˆã®å ±é…¬: <span class="revenue-amount" id="currentMonthRevenue">Â¥0</span></div>
            <div class="revenue-count" id="currentMonthCount">(é‘‘å®šæ•° 0ä»¶)</div>
        </div>
        <div class="revenue-last-month" id="lastMonthRevenue">
            å…ˆæœˆã®å ±é…¬: Â¥0
        </div>
    </div>

    <!-- å¾…æ©ŸçŠ¶æ…‹ -->
    <div class="status-section">
        <div class="status-title">â° å¾…æ©ŸçŠ¶æ…‹</div>
        <div class="status-buttons">
            <button class="status-btn" id="statusAvailable" onclick="setStatus('available')">
                é‘‘å®šå—ä»˜ä¸­
            </button>
            <button class="status-btn" id="statusOffline" onclick="setStatus('offline')">
                é‘‘å®šå—ä»˜ä¸­æ­¢
            </button>
        </div>
        <div class="status-description" id="statusDescription">
            ç¾åœ¨ã®çŠ¶æ…‹: é‘‘å®šå—ä»˜ä¸­(24æ™‚é–“ä»¥å†…ã«è¿”ä¿¡)
        </div>
    </div>

    <!-- ãŠå®¢æ§˜ä¸€è¦§ -->
    <div class="clients-section">
        <div class="clients-title">ğŸ’¬ ãŠå®¢æ§˜ä¸€è¦§</div>
        <div id="clientsList">
            <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, updateDoc, collection, query, where, getDocs, orderBy, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyA52uJ31HzLkbz32lA-3WWSmhM10xYjjCg",
            authDomain: "cupids-chat.firebaseapp.com",
            projectId: "cupids-chat",
            storageBucket: "cupids-chat.firebasestorage.app",
            messagingSenderId: "44532110483",
            appId: "1:44532110483:web:d6266e8abba8582b8b6966"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.firebaseAuth = auth;
        window.firebaseDB = db;
        window.firebaseDoc = doc;
        window.firebaseGetDoc = getDoc;
        window.firebaseUpdateDoc = updateDoc;
        window.firebaseCollection = collection;
        window.firebaseQuery = query;
        window.firebaseWhere = where;
        window.firebaseGetDocs = getDocs;
        window.firebaseOrderBy = orderBy;
        window.firebaseOnSnapshot = onSnapshot;
        window.firebaseSignOut = signOut;

        window.firebaseReady = true;
        window.dispatchEvent(new Event('firebaseReady'));
    </script>

    <script>
        let currentFortuneTeller = null;
        let conversations = [];

        // åˆæœŸåŒ–
        function init() {
            if (!window.firebaseAuth) {
                setTimeout(init, 100);
                return;
            }

            window.firebaseAuth.onAuthStateChanged(async (user) => {
                if (!user) {
                    window.location.href = 'fortune-login.html';
                    return;
                }

                const storedFT = JSON.parse(localStorage.getItem('currentUser') || 'null');
                if (!storedFT || storedFT.type !== 'fortuneTeller' || storedFT.uid !== user.uid) {
                    window.location.href = 'fortune-login.html';
                    return;
                }

                currentFortuneTeller = storedFT;
                document.getElementById('fortuneTellerName').textContent = currentFortuneTeller.name + 'ã•ã‚“';

                await loadFortuneTellerData();
                await loadConversations();
                await calculateRevenue();
            });
        }

        // å ã„å¸«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadFortuneTellerData() {
            try {
                const ftRef = window.firebaseDoc(window.firebaseDB, 'fortuneTellers', currentFortuneTeller.uid);
                const ftDoc = await window.firebaseGetDoc(ftRef);
                
                if (ftDoc.exists()) {
                    const ftData = ftDoc.data();
                    currentFortuneTeller.status = ftData.status || 'available';
                    currentFortuneTeller.initialPrice = ftData.initialPrice || 500;
                    currentFortuneTeller.regularPrice = ftData.regularPrice || 800;
                    
                    updateStatusUI(currentFortuneTeller.status);
                }
            } catch (error) {
                console.error('å ã„å¸«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ä¼šè©±ä¸€è¦§èª­ã¿è¾¼ã¿
        async function loadConversations() {
            try {
                const convsRef = window.firebaseCollection(window.firebaseDB, 'conversations');
                const q = window.firebaseQuery(
                    convsRef,
                    window.firebaseWhere('fortuneTellerId', '==', currentFortuneTeller.uid),
                    window.firebaseOrderBy('updatedAt', 'desc')
                );

                // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼
                window.firebaseOnSnapshot(q, async (snapshot) => {
                    conversations = [];
                    
                    for (const docSnapshot of snapshot.docs) {
                        const conv = { id: docSnapshot.id, ...docSnapshot.data() };
                        
                        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°ã‚’å–å¾—
                        const messagesRef = window.firebaseCollection(window.firebaseDB, 'messages');
                        const messagesQuery = window.firebaseQuery(
                            messagesRef,
                            window.firebaseWhere('conversationId', '==', conv.id)
                        );
                        const messagesSnapshot = await window.firebaseGetDocs(messagesQuery);
                        conv.messageCount = messagesSnapshot.size;
                        
                        // æœ€æ–°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
                        if (messagesSnapshot.size > 0) {
                            const messages = [];
                            messagesSnapshot.forEach(msgDoc => {
                                messages.push({ id: msgDoc.id, ...msgDoc.data() });
                            });
                            messages.sort((a, b) => {
                                const timeA = a.createdAt?.toMillis?.() || 0;
                                const timeB = b.createdAt?.toMillis?.() || 0;
                                return timeB - timeA;
                            });
                            conv.lastMessage = messages[0];
                        }
                        
                        conversations.push(conv);
                    }
                    
                    displayConversations();
                });
            } catch (error) {
                console.error('ä¼šè©±èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('clientsList').innerHTML = 
                    '<div class="no-clients">ä¼šè©±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            }
        }

        // ä¼šè©±ä¸€è¦§è¡¨ç¤º
        function displayConversations() {
            const clientsList = document.getElementById('clientsList');
            
            if (conversations.length === 0) {
                clientsList.innerHTML = '<div class="no-clients">ã¾ã ãŠå®¢æ§˜ãŒã„ã¾ã›ã‚“</div>';
                return;
            }

            let html = '';
            conversations.forEach(conv => {
                const clientName = conv.clientName || 'åŒ¿å';
                const points = conv.totalPoints || 0;
                const lastMessageText = conv.lastMessage?.text || '(ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã—)';
                
                // æ–°ç€ãƒãƒƒã‚¸: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚‹ ã‹ã¤ æœªèª­
                const hasNewMessage = conv.messageCount > 0 && !conv.fortuneTellerHasRead;
                const newClass = hasNewMessage ? 'new' : '';
                const newBadge = hasNewMessage ? '<span class="new-badge">æ–°ç€</span>' : '';
                
                html += `
                    <div class="client-card ${newClass}" onclick="openChat('${conv.id}', '${clientName}', ${points})">
                        <div class="client-header">
                            <div class="client-name">
                                ${newBadge}
                                ${clientName}
                            </div>
                            <div class="client-points">æ®‹ãƒã‚¤ãƒ³ãƒˆ: ${points}pt</div>
                        </div>
                        <div class="client-preview">${lastMessageText}</div>
                    </div>
                `;
            });
            
            clientsList.innerHTML = html;
        }

        // å ±é…¬è¨ˆç®—
        async function calculateRevenue() {
            try {
                const convsRef = window.firebaseCollection(window.firebaseDB, 'conversations');
                const q = window.firebaseQuery(
                    convsRef,
                    window.firebaseWhere('fortuneTellerId', '==', currentFortuneTeller.uid)
                );
                const convsSnapshot = await window.firebaseGetDocs(q);

                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth(); // 0-11
                
                let currentMonthRevenue = 0;
                let currentMonthCount = 0;
                let lastMonthRevenue = 0;

                convsSnapshot.forEach(doc => {
                    const conv = doc.data();
                    const createdAt = conv.createdAt?.toDate?.();
                    
                    if (!createdAt) return;
                    
                    const convYear = createdAt.getFullYear();
                    const convMonth = createdAt.getMonth();
                    const revenue = conv.fortuneTellerRevenue || 0;
                    
                    // ä»Šæœˆ
                    if (convYear === currentYear && convMonth === currentMonth) {
                        currentMonthRevenue += revenue;
                        if (revenue > 0) currentMonthCount++;
                    }
                    
                    // å…ˆæœˆ
                    const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
                    const lastMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;
                    if (convYear === lastMonthYear && convMonth === lastMonth) {
                        lastMonthRevenue += revenue;
                    }
                });

                document.getElementById('currentMonthRevenue').textContent = 
                    'Â¥' + currentMonthRevenue.toLocaleString();
                document.getElementById('currentMonthCount').textContent = 
                    `(é‘‘å®šæ•° ${currentMonthCount}ä»¶)`;
                document.getElementById('lastMonthRevenue').textContent = 
                    'å…ˆæœˆã®å ±é…¬: Â¥' + lastMonthRevenue.toLocaleString();

            } catch (error) {
                console.error('å ±é…¬è¨ˆç®—ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´
        async function setStatus(status) {
            try {
                const ftRef = window.firebaseDoc(window.firebaseDB, 'fortuneTellers', currentFortuneTeller.uid);
                await window.firebaseUpdateDoc(ftRef, { status: status });
                
                currentFortuneTeller.status = status;
                updateStatusUI(status);
                
                alert('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
            } catch (error) {
                console.error('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹UIæ›´æ–°
        function updateStatusUI(status) {
            const availableBtn = document.getElementById('statusAvailable');
            const offlineBtn = document.getElementById('statusOffline');
            const description = document.getElementById('statusDescription');
            
            availableBtn.classList.remove('active', 'accepting');
            offlineBtn.classList.remove('active');
            
            if (status === 'available' || status === 'accepting') {
                availableBtn.classList.add(status === 'available' ? 'active' : 'accepting');
                description.textContent = 'ç¾åœ¨ã®çŠ¶æ…‹: é‘‘å®šå—ä»˜ä¸­(24æ™‚é–“ä»¥å†…ã«è¿”ä¿¡)';
            } else {
                offlineBtn.classList.add('active');
                description.textContent = 'ç¾åœ¨ã®çŠ¶æ…‹: é‘‘å®šå—ä»˜ä¸­æ­¢';
            }
        }

        // ãƒãƒ£ãƒƒãƒˆã‚’é–‹ã
        function openChat(conversationId, clientName, points) {
            window.location.href = `fortune-chat.html?conversationId=${conversationId}`;
        }

        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†
        function goToProfile() {
            window.location.href = 'fortune-profile-edit.html';
        }

        // ãƒ–ãƒ­ãƒƒã‚¯ãƒªã‚¹ãƒˆ
        function goToBlock() {
            window.location.href = 'fortune-block.html';
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        async function logout() {
            if (!confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹?')) return;
            
            try {
                await window.firebaseSignOut(window.firebaseAuth);
                localStorage.removeItem('currentUser');
                window.location.href = 'fortune-login.html';
            } catch (error) {
                console.error('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // åˆæœŸåŒ–å®Ÿè¡Œ
        if (window.firebaseReady) {
            init();
        } else {
            window.addEventListener('firebaseReady', init);
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - ã‚­ãƒ¥ãƒ¼ãƒ”ãƒƒã‚ºå ã„å¸«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', sans-serif;
            background: #F5F5F5;
            min-height: 100vh;
            padding-bottom: 20px;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            background: linear-gradient(to right, #EC4899, #A855F7);
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1024px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-logo {
            height: 40px;
            width: auto;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-name {
            color: white;
            font-size: 14px;
            font-weight: 600;
        }

        .header-button {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .header-button:hover {
            background: rgba(255,255,255,0.3);
        }

        /* ã‚³ãƒ³ãƒ†ãƒŠ */
        .container {
            max-width: 1024px;
            margin: 0 auto;
            padding: 20px;
        }

        /* å¾…æ©ŸçŠ¶æ…‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .status-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .status-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 12px;
        }

        .status-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .status-button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .status-button.active.available {
            background: linear-gradient(to right, #10b981, #059669);
            color: white;
        }

        .status-button.active.accepting {
            background: linear-gradient(to right, #3b82f6, #2563eb);
            color: white;
        }

        .status-button.active.stopped {
            background: linear-gradient(to right, #6b7280, #4b5563);
            color: white;
        }

        .status-button.inactive {
            background: #e5e7eb;
            color: #6b7280;
        }

        .status-info {
            font-size: 13px;
            color: #6b7280;
        }

        .status-info strong {
            color: #333;
        }

        /* ãŠå®¢æ§˜ä¸€è¦§ */
        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }

        .client-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .client-item {
            background: white;
            padding: 16px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s;
        }

        .client-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .client-header {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .client-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            font-weight: bold;
            flex-shrink: 0;
            position: relative;
        }

        /* æœªèª­ãƒãƒƒã‚¸ */
        .unread-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: #EF4444;
            color: white;
            font-size: 11px;
            font-weight: bold;
            min-width: 20px;
            height: 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 6px;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .client-info {
            flex: 1;
        }

        .client-name {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
        }

        .client-points {
            font-size: 12px;
            color: #EC4899;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .client-message {
            font-size: 14px;
            color: #6b7280;
        }

        .no-clients {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 14px;
        }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }
    </style>
</head>
<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="header">
        <div class="header-content">
            <div>
                <span class="header-name" id="fortuneTellerName">èª­ã¿è¾¼ã¿ä¸­...</span>
            </div>
            <div class="header-actions">
                <button class="header-button" onclick="goToBlockList()">ğŸš« ãƒ–ãƒ­ãƒƒã‚¯ãƒªã‚¹ãƒˆ</button>
                <button class="header-button" onclick="goToProfileEdit()">ğŸ“ ãƒ—ãƒ­ãƒ•ç·¨é›†</button>
                <button class="header-button" onclick="goToRevenue()">ğŸ’° å ±é…¬ç¢ºèª</button>
                <button class="header-button" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- å¾…æ©ŸçŠ¶æ…‹ -->
        <div class="status-section">
            <div class="status-title">â° å¾…æ©ŸçŠ¶æ…‹</div>
            <div class="status-buttons">
                <button class="status-button inactive" id="statusAvailable" onclick="changeStatus('available')">
                    ä»Šã™ãå ã†
                </button>
                <button class="status-button inactive" id="statusAccepting" onclick="changeStatus('accepting')">
                    é‘‘å®šå—ä»˜ä¸­
                </button>
                <button class="status-button inactive" id="statusStopped" onclick="changeStatus('stopped')">
                    é‘‘å®šåœæ­¢
                </button>
            </div>
            <div class="status-info">
                ç¾åœ¨ã®çŠ¶æ…‹: <strong id="statusText">-</strong>
            </div>
        </div>

        <!-- ãŠå®¢æ§˜ä¸€è¦§ -->
        <div class="section-title">ğŸ’¬ ãŠå®¢æ§˜ä¸€è¦§</div>
        <div class="client-list" id="clientList">
            <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyA52uJ31HzLkbz32lA-3WWSmhM10xYjjCg",
            authDomain: "cupids-chat.firebaseapp.com",
            projectId: "cupids-chat",
            storageBucket: "cupids-chat.firebasestorage.app",
            messagingSenderId: "44532110483",
            appId: "1:44532110483:web:d6266e8abba8582b8b6966"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.firebaseAuth = auth;
        window.firebaseDB = db;
        window.firebaseDoc = doc;
        window.firebaseGetDoc = getDoc;
        window.firebaseSetDoc = setDoc;
        window.firebaseUpdateDoc = updateDoc;
        window.firebaseCollection = collection;
        window.firebaseQuery = query;
        window.firebaseWhere = where;
        window.firebaseGetDocs = getDocs;

        // FirebaseåˆæœŸåŒ–å®Œäº†ã‚’é€šçŸ¥
        window.firebaseReady = true;
        window.dispatchEvent(new Event('firebaseReady'));
        console.log('âœ… FirebaseåˆæœŸåŒ–å®Œäº†!');
    </script>

    <script>
        // ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
        const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
        if (!currentUser || currentUser.type !== 'fortune-teller') {
            alert('å ã„å¸«ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
            window.location.href = 'cupids-login.html';
        }

        let fortuneTellerData = {};

        // æœˆæ¬¡å£²ä¸Šã‚’ãƒªã‚»ãƒƒãƒˆ
        async function checkAndResetMonthly() {
            try {
                const now = new Date();
                const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                
                const ftRef = window.firebaseDoc(window.firebaseDB, 'fortuneTellers', currentUser.uid);
                const ftDoc = await window.firebaseGetDoc(ftRef);

                if (ftDoc.exists()) {
                    const data = ftDoc.data();
                    const lastResetMonth = data.lastResetMonth || '';

                    // æœˆãŒå¤‰ã‚ã£ã¦ã„ãŸã‚‰å£²ä¸Šã‚’ãƒªã‚»ãƒƒãƒˆ
                    if (lastResetMonth !== currentMonth) {
                        // å‰æœˆã®å£²ä¸Šã¨å ±é…¬ç‡ã‹ã‚‰æ‰‹å–ã‚Šã‚’è¨ˆç®—
                        const previousSales = data.currentMonthSales || 0;
                        const previousRevenue = data.previousMonthRevenue || 0;
                        
                        // å›ºå®šå ±é…¬ç‡ãŒãªã„å ´åˆã€å‰æœˆã®æ‰‹å–ã‚Šã‹ã‚‰ä»Šæœˆã®å ±é…¬ç‡ã‚’æ±ºå®š
                        let newCommissionRate = 30; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ30%
                        if (!data.fixedCommissionRate) {
                            if (previousRevenue >= 270000) {
                                newCommissionRate = 40;
                            } else if (previousRevenue >= 210000) {
                                newCommissionRate = 38;
                            } else if (previousRevenue >= 150000) {
                                newCommissionRate = 36;
                            } else if (previousRevenue >= 90000) {
                                newCommissionRate = 34;
                            } else if (previousRevenue >= 30000) {
                                newCommissionRate = 32;
                            }
                        }
                        
                        await window.firebaseUpdateDoc(ftRef, {
                            currentMonthSales: 0,
                            lastResetMonth: currentMonth,
                            previousMonthSales: previousSales,
                            previousMonthRevenue: previousRevenue,
                            currentCommissionRate: data.fixedCommissionRate || newCommissionRate
                        });
                        
                        console.log('æœˆæ¬¡å£²ä¸Šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ:', currentMonth, 'æ–°å ±é…¬ç‡:', newCommissionRate + '%');
                    }
                }
            } catch (error) {
                console.error('æœˆæ¬¡ãƒªã‚»ãƒƒãƒˆã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // å ã„å¸«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        async function loadFortuneTellerData() {
            try {
                // ã¾ãšæœˆæ¬¡ãƒªã‚»ãƒƒãƒˆã‚’ãƒã‚§ãƒƒã‚¯
                await checkAndResetMonthly();
                
                const ftRef = window.firebaseDoc(window.firebaseDB, 'fortuneTellers', currentUser.uid);
                const ftDoc = await window.firebaseGetDoc(ftRef);

                if (ftDoc.exists()) {
                    fortuneTellerData = ftDoc.data();
                    document.getElementById('fortuneTellerName').textContent = fortuneTellerData.name + 'ã•ã‚“';
                    
                    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
                    updateStatusButtons();
                    
                    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’æ¶ˆã™
                    document.body.style.opacity = '1';
                } else {
                    // Firebaseã«ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆ
                    console.log('å ã„å¸«ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    document.body.style.opacity = '1';
                    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã§ç”»é¢ã‚’è¡¨ç¤º
                    fortuneTellerData = {
                        name: currentUser.name || 'å ã„å¸«',
                        status: 'stopped'
                    };
                    document.getElementById('fortuneTellerName').textContent = fortuneTellerData.name + 'ã•ã‚“';
                    updateStatusButtons();
                }
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                // ã‚¨ãƒ©ãƒ¼ã§ã‚‚ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’æ¶ˆã™
                document.body.style.opacity = '1';
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã§ç”»é¢ã‚’è¡¨ç¤ºï¼ˆã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯å‡ºã•ãªã„ï¼‰
                fortuneTellerData = {
                    name: currentUser.name || 'å ã„å¸«',
                    status: 'stopped'
                };
                document.getElementById('fortuneTellerName').textContent = fortuneTellerData.name + 'ã•ã‚“';
                updateStatusButtons();
            }
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
        function updateStatusButtons() {
            const status = fortuneTellerData.status || 'stopped';
            
            // ã™ã¹ã¦ã®ãƒœã‚¿ãƒ³ã‚’inactiveã«
            document.querySelectorAll('.status-button').forEach(btn => {
                btn.className = 'status-button inactive';
            });

            // ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’activeã«
            if (status === 'available') {
                document.getElementById('statusAvailable').className = 'status-button active available';
                document.getElementById('statusText').textContent = 'ä»Šã™ãå ã†ï¼ˆã™ãè¿”ä¿¡ã§ãã‚‹æ–¹ã®ã¿ï¼‰';
            } else if (status === 'accepting') {
                document.getElementById('statusAccepting').className = 'status-button active accepting';
                document.getElementById('statusText').textContent = 'é‘‘å®šå—ä»˜ä¸­ï¼ˆ24æ™‚é–“ä»¥å†…ã«è¿”ä¿¡ï¼‰';
            } else if (status === 'stopped') {
                document.getElementById('statusStopped').className = 'status-button active stopped';
                document.getElementById('statusText').textContent = 'é‘‘å®šåœæ­¢ä¸­';
            }
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å¤‰æ›´
        async function changeStatus(newStatus) {
            try {
                const ftRef = window.firebaseDoc(window.firebaseDB, 'fortuneTellers', currentUser.uid);
                
                // setDocã®mergeã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ï¼ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒãªã„å ´åˆã¯ä½œæˆã€ã‚ã‚‹å ´åˆã¯æ›´æ–°ï¼‰
                await window.firebaseSetDoc(ftRef, {
                    status: newStatus
                }, { merge: true });

                fortuneTellerData.status = newStatus;
                updateStatusButtons();

                let message = '';
                if (newStatus === 'available') {
                    message = 'âœ¨ å¾…æ©Ÿã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚ã™ãè¿”ä¿¡ã§ãã‚‹æ–¹ã®ã¿å¾…æ©ŸãŠé¡˜ã„ã—ã¾ã™';
                } else if (newStatus === 'accepting') {
                    message = 'âœ… é‘‘å®šã‚’å—ã‘ä»˜ã‘ã¾ã™ã€‚24æ™‚é–“ä»¥å†…ã«è¿”ä¿¡å¯èƒ½ã®æ–¹ã®ã¿å—ä»˜ä¸­ã«ã—ã¦ãã ã•ã„';
                } else if (newStatus === 'stopped') {
                    message = 'â¸ï¸ ã—ã°ã‚‰ãé‘‘å®šã‚’å—ã‘ã‚‰ã‚Œãªã„å ´åˆã«æŠ¼ã—ã¦ãã ã•ã„';
                }
                
                if (message) {
                    alert(message);
                }

            } catch (error) {
                console.error('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ãŠå®¢æ§˜ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
        async function loadClientList() {
            try {
                const clientList = document.getElementById('clientList');
                
                // Firestoreã‹ã‚‰è‡ªåˆ†ãŒå‚åŠ ã—ã¦ã„ã‚‹ä¼šè©±ã‚’å–å¾—
                const conversationsRef = window.firebaseCollection(window.firebaseDB, 'conversations');
                const q = window.firebaseQuery(
                    conversationsRef,
                    window.firebaseWhere('fortuneTellerId', '==', currentUser.uid)
                );
                
                const querySnapshot = await window.firebaseGetDocs(q);
                
                if (querySnapshot.empty) {
                    clientList.innerHTML = `
                        <div class="no-clients">
                            <p style="margin-bottom: 15px;">ã¾ã ãŠå®¢æ§˜ã¨ã®ãƒãƒ£ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>
                            <button onclick="showDemoChat()" style="
                                background: linear-gradient(to right, #EC4899, #A855F7);
                                color: white;
                                border: none;
                                padding: 12px 24px;
                                border-radius: 10px;
                                font-size: 14px;
                                font-weight: 600;
                                cursor: pointer;
                                transition: all 0.2s;
                                box-shadow: 0 2px 10px rgba(236, 72, 153, 0.3);
                            " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                ğŸ“± ãƒ‡ãƒ¢ãƒãƒ£ãƒƒãƒˆã‚’è¡¨ç¤º
                            </button>
                            <p style="margin-top: 10px; font-size: 12px; color: #999;">ãƒ‡ãƒ¢ãƒãƒ£ãƒƒãƒˆã§ç”»é¢ã‚’ç¢ºèªã§ãã¾ã™</p>
                        </div>
                    `;
                    return;
                }

                clientList.innerHTML = '';
                
                for (const docSnapshot of querySnapshot.docs) {
                    const conv = docSnapshot.data();
                    
                    // ãŠå®¢æ§˜æƒ…å ±ã‚’å–å¾—
                    const clientDoc = await window.firebaseGetDoc(
                        window.firebaseDoc(window.firebaseDB, 'users', conv.clientId)
                    );
                    
                    if (clientDoc.exists()) {
                        const client = clientDoc.data();
                        
                        // æœªèª­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°ã‚’å–å¾—
                        const unreadCount = await getUnreadCount(docSnapshot.id);
                        
                        const item = document.createElement('div');
                        item.className = 'client-item';
                        item.onclick = () => goToChat(docSnapshot.id, conv.clientId);
                        
                        const lastMessage = conv.lastMessage || 'ã¾ã ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“';
                        
                        // æœªèª­ãƒãƒƒã‚¸ã®HTMLï¼ˆæœªèª­ãŒã‚ã‚‹å ´åˆã®ã¿è¡¨ç¤ºï¼‰
                        const unreadBadge = unreadCount > 0 ? `<div class="unread-badge">${unreadCount}</div>` : '';
                        
                        item.innerHTML = `
                            <div class="client-header">
                                <div class="client-avatar">
                                    ${client.name ? client.name[0] : '?'}
                                    ${unreadBadge}
                                </div>
                                <div class="client-info">
                                    <div class="client-name">${client.name || 'åå‰æœªè¨­å®š'}</div>
                                    <div class="client-points">æ‰€æŒãƒã‚¤ãƒ³ãƒˆ: ${client.points || 0}pt</div>
                                    <div class="client-message">${lastMessage.substring(0, 50)}${lastMessage.length > 50 ? '...' : ''}</div>
                                </div>
                            </div>
                        `;
                        
                        clientList.appendChild(item);
                    }
                }
                
            } catch (error) {
                console.error('ãŠå®¢æ§˜ä¸€è¦§èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('clientList').innerHTML = '<div class="no-clients">ãŠå®¢æ§˜ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            }
        }

        // æœªèª­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°ã‚’å–å¾—
        async function getUnreadCount(conversationId) {
            try {
                const messagesRef = window.firebaseCollection(window.firebaseDB, 'messages');
                // ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¯ã‚¨ãƒªã«å¤‰æ›´ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚¨ãƒ©ãƒ¼å›é¿ï¼‰
                const q = window.firebaseQuery(
                    messagesRef,
                    window.firebaseWhere('conversationId', '==', conversationId)
                );
                
                const snapshot = await window.firebaseGetDocs(q);
                
                // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                let unreadCount = 0;
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    if (msg.senderId !== currentUser.uid && msg.isRead === false) {
                        unreadCount++;
                    }
                });
                
                return unreadCount;
            } catch (error) {
                console.error('æœªèª­æ•°å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                return 0;
            }
        }

        function goToProfileEdit() {
            window.location.href = 'cupids-profile-edit.html';
        }

        function goToRevenue() {
            window.location.href = 'cupids-revenue.html';
        }

        function goToChat(conversationId, clientId) {
            localStorage.setItem('selectedConversationId', conversationId);
            if (clientId) {
                localStorage.setItem('selectedClientId', clientId);
            }
            window.location.href = 'cupids-chat-v2.html';
        }

        // ãƒ‡ãƒ¢ãƒãƒ£ãƒƒãƒˆã‚’è¡¨ç¤º
        function showDemoChat() {
            const clientList = document.getElementById('clientList');
            clientList.innerHTML = '';
            
            // ãƒ‡ãƒ¢ãƒãƒ£ãƒƒãƒˆ1: ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªä¼šè©±
            const demoItem1 = document.createElement('div');
            demoItem1.className = 'client-item';
            demoItem1.style.opacity = '0.7';
            demoItem1.style.pointerEvents = 'none';
            demoItem1.innerHTML = `
                <div class="client-header">
                    <div class="client-avatar">
                        ä½
                        <div class="unread-badge">3</div>
                    </div>
                    <div class="client-info">
                        <div class="client-name">ä½è—¤ èŠ±å­</div>
                        <div class="client-points">æ‰€æŒãƒã‚¤ãƒ³ãƒˆ: 500pt</div>
                        <div class="client-message">ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™!ã¾ãŸã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™âœ¨</div>
                    </div>
                </div>
            `;
            clientList.appendChild(demoItem1);
            
            // ãƒ‡ãƒ¢ãƒãƒ£ãƒƒãƒˆ2: é€²è¡Œä¸­ã®ä¼šè©±
            const demoItem2 = document.createElement('div');
            demoItem2.className = 'client-item';
            demoItem2.style.opacity = '0.7';
            demoItem2.style.pointerEvents = 'none';
            demoItem2.innerHTML = `
                <div class="client-header">
                    <div class="client-avatar">
                        ç”°
                        <div class="unread-badge">1</div>
                    </div>
                    <div class="client-info">
                        <div class="client-name">ç”°ä¸­ å¤ªéƒ</div>
                        <div class="client-points">æ‰€æŒãƒã‚¤ãƒ³ãƒˆ: 1200pt</div>
                        <div class="client-message">ä»•äº‹ã«ã¤ã„ã¦ç›¸è«‡ã—ãŸã„ã®ã§ã™ãŒ...</div>
                    </div>
                </div>
            `;
            clientList.appendChild(demoItem2);
            
            // ãƒ‡ãƒ¢ãƒãƒ£ãƒƒãƒˆ3: éå»ã®ä¼šè©±
            const demoItem3 = document.createElement('div');
            demoItem3.className = 'client-item';
            demoItem3.style.opacity = '0.7';
            demoItem3.style.pointerEvents = 'none';
            demoItem3.innerHTML = `
                <div class="client-header">
                    <div class="client-avatar">å±±</div>
                    <div class="client-info">
                        <div class="client-name">å±±ç”° ç¾å’²</div>
                        <div class="client-points">æ‰€æŒãƒã‚¤ãƒ³ãƒˆ: 300pt</div>
                        <div class="client-message">å ã£ã¦ã„ãŸã ã„ã¦ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸ!</div>
                    </div>
                </div>
            `;
            clientList.appendChild(demoItem3);
            
            // æ³¨æ„æ›¸ãã‚’è¿½åŠ 
            const notice = document.createElement('div');
            notice.style.cssText = `
                background: #FFF3CD;
                border: 1px solid #FFE69C;
                border-radius: 10px;
                padding: 12px;
                margin-top: 15px;
                font-size: 13px;
                color: #856404;
                text-align: center;
            `;
            notice.innerHTML = 'âš ï¸ ã“ã‚Œã¯ãƒ‡ãƒ¢è¡¨ç¤ºã§ã™ã€‚å®Ÿéš›ã®ãŠå®¢æ§˜ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
            clientList.appendChild(notice);
            
            // æˆ»ã‚‹ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
            const backButton = document.createElement('button');
            backButton.textContent = 'ğŸ”„ å®Ÿéš›ã®ä¸€è¦§ã«æˆ»ã‚‹';
            backButton.style.cssText = `
                background: white;
                color: #EC4899;
                border: 2px solid #EC4899;
                padding: 10px 20px;
                border-radius: 10px;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                margin-top: 10px;
                width: 100%;
                transition: all 0.2s;
            `;
            backButton.onmouseover = function() { this.style.background = '#FDF2F8'; };
            backButton.onmouseout = function() { this.style.background = 'white'; };
            backButton.onclick = loadClientList;
            clientList.appendChild(backButton);
        }

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'cupids-fortune-login.html';
        }
        
        function goToBlockList() {
            window.location.href = 'cupids-block-list.html';
        }

        // FirebaseåˆæœŸåŒ–ã‚’å¾…ã£ã¦ã‹ã‚‰å®Ÿè¡Œ
        async function initializePage() {
            if (!window.firebaseReady) {
                // FirebaseãŒã¾ã æº–å‚™ã§ãã¦ã„ãªã„å ´åˆã¯ã€ã‚¤ãƒ™ãƒ³ãƒˆã‚’å¾…ã¤
                window.addEventListener('firebaseReady', initializePage, { once: true });
                return;
            }
            
            console.log('ğŸš€ å ã„å¸«ãƒ­ãƒ“ãƒ¼åˆæœŸåŒ–é–‹å§‹...');
            
            // å ã„å¸«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
            await loadFortuneTellerData();
            
            // ãŠå®¢æ§˜ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
            loadClientList();
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«åˆæœŸåŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializePage);
        } else {
            initializePage();
        }
    </script>
</body>
</html>

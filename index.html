<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Cupids - ãƒãƒ£ãƒƒãƒˆå ã„</title>
  
  <!-- Google Fontsï¼ˆãƒãƒ¡ãƒ­ãƒ³é¢¨ã®ä¸¸ã‚´ã‚·ãƒƒã‚¯ï¼‰ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700&family=Kosugi+Maru&display=swap" rel="stylesheet">
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  
  <!-- React -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  
  <style>
    body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    * { box-sizing: border-box; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    // Firebaseè¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyA52uJ31HzLkbz32lA-3WWSmhM10xYjjCg",
      authDomain: "cupids-chat.firebaseapp.com",
      projectId: "cupids-chat",
      storageBucket: "cupids-chat.firebasestorage.app",
      messagingSenderId: "44532110483",
      appId: "1:44532110483:web:d6266e8abba8582b8b6966"
    };
    
    let auth = null;
    let db = null;
    let firebaseEnabled = false;
    
    try {
      firebase.initializeApp(firebaseConfig);
      auth = firebase.auth();
      db = firebase.firestore();
      firebaseEnabled = true;
      console.log("âœ… Firebaseæ¥ç¶šæˆåŠŸ");
    } catch(error) {
      console.log("Firebaseæœªè¨­å®šï¼ˆãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ï¼‰");
    }
    
import React, { useState, useEffect, useRef } from 'react';
import { Send, User, LogOut, Menu, Mail, Moon, Star, FileText, ArrowLeft, Edit2, Plus, X, DollarSign, TrendingUp } from 'lucide-react';

export default function FortuneServiceApp() {
  const [currentUser, setCurrentUser] = useState(null);
  const [screen, setScreen] = useState('login');
  const [conversations, setConversations] = useState({});
  const [currentChat, setCurrentChat] = useState(null);
  const [selectedFortuneTellerId, setSelectedFortuneTellerId] = useState(null); // é¸æŠã•ã‚ŒãŸå ã„å¸«ID
  const [karteDataByConversation, setKarteDataByConversation] = useState({});
  const [saveMessage, setSaveMessage] = useState('');
  const [conversationStatus, setConversationStatus] = useState({}); // ä¼šè©±ã®çŠ¶æ…‹ (active, ended)
  const [conversationPoints, setConversationPoints] = useState({}); // ä¼šè©±ã”ã¨ã®æ¶ˆè²»ãƒã‚¤ãƒ³ãƒˆ
  const [sessionStartPoints, setSessionStartPoints] = useState({}); // ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹æ™‚ã®ãƒã‚¤ãƒ³ãƒˆè¨˜éŒ²
  const [showReviewForm, setShowReviewForm] = useState(false); // ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º
  const [reviewFormShownFor, setReviewFormShownFor] = useState({}); // ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤ºæ¸ˆã¿ã®ä¼šè©±ID
  const [registrationType, setRegistrationType] = useState('client'); // 'client' or 'fortune-teller'
  const [lastResetMonth, setLastResetMonth] = useState(new Date().toISOString().slice(0, 7)); // æœ€å¾Œã«ãƒªã‚»ãƒƒãƒˆã—ãŸæœˆ (YYYY-MMå½¢å¼)
  const maxChars = 500;
  const messagesEndRef = useRef(null);

  // å ã„å¸«ã®å®šå‹æ–‡ç®¡ç†ï¼ˆå…¨ã¦ç„¡æ–™ï¼‰
  const [fortuneTellerTemplates, setFortuneTellerTemplates] = useState([
    'ã”ç›¸è«‡ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚è©³ã—ããŠè©±ã‚’ä¼ºã‚ã›ã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ',
    'é‘‘å®šã•ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚å°‘ã€…ãŠå¾…ã¡ãã ã•ã„ã€‚',
    'ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚ã¾ãŸã„ã¤ã§ã‚‚ã”ç›¸è«‡ãã ã•ã„ã€‚'
  ]);
  const [editingTemplates, setEditingTemplates] = useState(false);
  const [tempTemplates, setTempTemplates] = useState([]);

  const [users, setUsers] = useState({
    'demo-client-001': {
      id: 'demo-client-001',
      name: 'ãƒ‡ãƒ¢å¤ªéƒ',
      email: 'demo@client.com',
      password: 'demo',
      type: 'client',
      points: 1500
    },
    'admin-001': {
      id: 'admin-001',
      name: 'ç®¡ç†è€…',
      email: 'memetan@cupids.com',
      password: 'admin123',
      type: 'admin'
    }
  });

  // å ±é…¬è¨ˆç®—é–¢æ•°
  const calculateCommissionRate = (lastMonthRevenue) => {
    if (lastMonthRevenue < 30000) {
      return 0.30; // 30%
    } else if (lastMonthRevenue < 90000) {
      return 0.32; // 32%
    } else if (lastMonthRevenue < 150000) {
      return 0.34; // 34%
    } else if (lastMonthRevenue < 210000) {
      return 0.36; // 36%
    } else if (lastMonthRevenue < 270000) {
      return 0.38; // 38%
    } else {
      return 0.40; // 40% (æœ€å¤§)
    }
  };

  // æ¬¡ã®å ±é…¬ç‡æ®µéšã¾ã§ã®å¿…è¦é‡‘é¡ã‚’è¨ˆç®—
  const calculateNextTierAmount = (currentRevenue) => {
    if (currentRevenue < 30000) return 30000 - currentRevenue;
    if (currentRevenue < 90000) return 90000 - currentRevenue;
    if (currentRevenue < 150000) return 150000 - currentRevenue;
    if (currentRevenue < 210000) return 210000 - currentRevenue;
    if (currentRevenue < 270000) return 270000 - currentRevenue;
    return 0; // æœ€å¤§æ®µéšã«åˆ°é”
  };

  // æœˆæ¬¡ãƒªã‚»ãƒƒãƒˆå‡¦ç†
  const performMonthlyReset = () => {
    const currentMonth = new Date().toISOString().slice(0, 7);
    
    setFortuneTellers(prev => {
      const updated = {};
      Object.keys(prev).forEach(ftId => {
        const ft = prev[ftId];
        const newLastMonthRevenue = ft.currentMonthRevenue;
        
        // å ±é…¬ç‡å›ºå®šã§ãªã„å ´åˆã®ã¿ã€å ±é…¬ç‡ã‚’å†è¨ˆç®—
        let newCommissionRate = ft.currentCommissionRate;
        if (!ft.commissionRateFixed) {
          newCommissionRate = calculateCommissionRate(newLastMonthRevenue);
        }
        
        updated[ftId] = {
          ...ft,
          lastMonthRevenue: newLastMonthRevenue,
          currentMonthRevenue: 0,
          currentCommissionRate: newCommissionRate,
          nextMonthCommissionRate: calculateCommissionRate(0), // æ¥æœˆã®äºˆæ¸¬ã¯0ã‚¹ã‚¿ãƒ¼ãƒˆ
          revenueHistory: [
            ...(ft.revenueHistory || []),
            {
              month: lastResetMonth,
              revenue: newLastMonthRevenue,
              commissionRate: ft.currentCommissionRate
            }
          ]
        };
      });
      return updated;
    });
    
    setLastResetMonth(currentMonth);
    console.log(`æœˆæ¬¡ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œ: ${currentMonth}`);
  };

  // è‡ªå‹•æœˆæ¬¡ãƒªã‚»ãƒƒãƒˆ
  useEffect(() => {
    const currentMonth = new Date().toISOString().slice(0, 7);
    
    // æœˆãŒå¤‰ã‚ã£ã¦ã„ãŸã‚‰è‡ªå‹•ãƒªã‚»ãƒƒãƒˆ
    if (currentMonth !== lastResetMonth) {
      performMonthlyReset();
    }
  }, [currentUser]); // ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã‚„ãƒ¦ãƒ¼ã‚¶ãƒ¼å¤‰æ›´æ™‚ã«ãƒã‚§ãƒƒã‚¯

  const [fortuneTellers, setFortuneTellers] = useState({
    'test-bot-001': {
      id: 'test-bot-001',
      name: 'ã‚­ãƒ¥ãƒ¼ãƒ”ãƒƒã‚º',
      email: 'test@system.com',
      password: 'test',
      type: 'fortune-teller',
      specialty: 'ç„¡æ–™ãƒãƒ£ãƒƒãƒˆãƒ†ã‚¹ãƒˆ',
      description: 'ãƒ†ã‚¹ãƒˆç”¨ãƒœãƒƒãƒˆã§ã™',
      isTestBot: true,
      rating: 5.0,
      reviewCount: 0,
      baseReviewCount: 0, // ç®¡ç†ç”»é¢ã§è¨­å®šã—ãŸåŸºæº–é‘‘å®šæ•°
      ratingFixed: false, // è©•ä¾¡ã‚’å›ºå®šã™ã‚‹ã‹ã©ã†ã‹
      tags: ['ãƒ†ã‚¹ãƒˆ', 'ç·´ç¿’ç”¨'],
      status: 'available',
      profileMessage: '',
      pointsPerChar: 1,
      showReviews: true,
      reviews: [],
      // å ±é…¬é–¢é€£ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
      currentMonthRevenue: 0,
      lastMonthRevenue: 0,
      currentCommissionRate: 0.30,
      nextMonthCommissionRate: 0.30,
      commissionRateFixed: false, // å ±é…¬ç‡ã‚’å›ºå®šã™ã‚‹ã‹ã©ã†ã‹
      revenueHistory: [],
      // é€šçŸ¥é–¢é€£ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
      unreadNotifications: 0, // æœªèª­é€šçŸ¥æ•°
      lineUserId: '' // LINEé€šçŸ¥ç”¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆä»»æ„ï¼‰
    },
    'demo-ft-001': {
      id: 'demo-ft-001',
      name: 'ä¸ƒæ°´å—',
      email: 'demo@fortune.com',
      password: 'demo',
      type: 'fortune-teller',
      specialty: 'ã‚¿ãƒ­ãƒƒãƒˆãƒ»éœŠè¦–',
      description: 'æœˆæ˜ã‹ã‚Šã®å°ãã§ã‚ãªãŸã®æœªæ¥ã‚’ç…§ã‚‰ã—ã¾ã™',
      rating: 4.9,
      reviewCount: 3704,
      baseReviewCount: 3704, // ç®¡ç†ç”»é¢ã§è¨­å®šã—ãŸåŸºæº–é‘‘å®šæ•°
      ratingFixed: false, // è©•ä¾¡ã‚’å›ºå®šã™ã‚‹ã‹ã©ã†ã‹
      tags: ['éœŠè¦–', 'ã‚·ãƒ³ãƒ—ãƒ«', 'å¯„ã‚Šæ·»ã„'],
      status: 'available',
      profileMessage: 'â¤ï¸ ãƒ¡ãƒ¼ãƒ«é‘‘å®šè¶…ãŠå‹§ã‚ â¤ï¸ ãœã²ã”åˆ©ç”¨ãã ã•ã„ â¤ï¸\n\nãƒ¡ãƒ¼ãƒ«é‘‘å®šãªã‚‰ã€Œæ‰‹ç›¸é‘‘å®šã€ã‚‚å‡ºæ¥ã¾ã™ã—ã€ã‚ãªãŸã®ã€Œãƒãƒ¤ãƒ³ãƒãƒ¼ã‚¹ãƒ‡ãƒ¼ã€ã‹ã‚‰ã€ã‚ãªãŸã®æ€§æ ¼ã‚„æ‰èƒ½ã€é‹å‹¢å‚¾å‘ã‚’ãŠèª¿ã¹ã™ã‚‹äº‹ã‚‚å‡ºæ¥ã¾ã™ã€‚ã‚¿ãƒ­ãƒƒãƒˆä»–ã®å è¡“ã¨ã‚‚çµ„ã¿åˆã‚ã›ã¦ã€ã˜ã£ãã‚Šã¨é‘‘å®šã‚’ã•ã›ã¦ã„ãŸã ã‘ã¾ã™ã€‚\næ‹æ„›é‹ã€çµå©šé‹ã€ä»•äº‹é‹ã€é‡‘é‹ã€å¥åº·é‹ã€etc ã‚’ç·åˆçš„ã«é‘‘å®šã—ã¦ã€ã‚ãªãŸã®é‹å‹¢ã®å……å®Ÿã—ãŸé–‹é‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãŠå±Šã‘ã™ã‚‹äº‹ãŒå‡ºæ¥ã¾ã™ã€‚',
      pointsPerChar: 1,
      showReviews: true,
      reviews: [
        {
          id: 'review1',
          clientName: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼1',
          rating: 5,
          comment: 'ã¨ã¦ã‚‚è¦ªèº«ã«ãªã£ã¦ç›¸è«‡ã«ä¹—ã£ã¦ãã ã•ã„ã¾ã—ãŸã€‚ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼',
          date: '2025-10-15',
          visible: true
        },
        {
          id: 'review2',
          clientName: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼2',
          rating: 5,
          comment: 'çš„ç¢ºãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ã„ãŸã ã‘ã¾ã—ãŸã€‚ã¾ãŸç›¸è«‡ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚',
          date: '2025-10-20',
          visible: true
        },
        {
          id: 'review3',
          clientName: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼3',
          rating: 5,
          comment: 'ã„ã¤ã‚‚å„ªã—ãå¯„ã‚Šæ·»ã£ã¦ãã ã•ã£ã¦ã€å¿ƒãŒè»½ããªã‚Šã¾ã™ã€‚',
          date: '2025-10-25',
          visible: true
        }
      ],
      // å ±é…¬é–¢é€£ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
      currentMonthRevenue: 0,
      lastMonthRevenue: 0,
      currentCommissionRate: 0.30,
      nextMonthCommissionRate: 0.30,
      commissionRateFixed: false, // å ±é…¬ç‡ã‚’å›ºå®šã™ã‚‹ã‹ã©ã†ã‹
      revenueHistory: [],
      // é€šçŸ¥é–¢é€£ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
      unreadNotifications: 0, // æœªèª­é€šçŸ¥æ•°
      lineUserId: '' // LINEé€šçŸ¥ç”¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆä»»æ„ï¼‰
    }
  });

  // é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®çŠ¶æ…‹
  const [notification, setNotification] = useState(null);

  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ã®é–¢æ•°
  const handleStatusChange = (status) => {
    setFortuneTellers(prev => ({
      ...prev,
      [currentUser.id]: {
        ...prev[currentUser.id],
        status: status
      }
    }));

    // é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    let message = '';
    if (status === 'available') {
      message = 'å¾…æ©Ÿã‚’é–‹å§‹ã—ã¾ã—ãŸâœ¨ã™ãè¿”ä¿¡ã§ãã‚‹æ–¹ã®ã¿å¾…æ©ŸãŠé¡˜ã„ã—ã¾ã™';
    } else if (status === 'accepting') {
      message = 'é‘‘å®šã‚’å—ã‘ä»˜ã‘ã¾ã™ã€‚24æ™‚é–“ä»¥å†…ã«è¿”ä¿¡å¯èƒ½ã®æ–¹ã®ã¿å—ä»˜ä¸­ã«ã—ã¦ãã ã•ã„';
    } else if (status === 'stopped') {
      message = 'ã—ã°ã‚‰ãé‘‘å®šã‚’å—ã‘ã‚Œãªã„å ´åˆã«æŠ¼ã—ã¦ãã ã•ã„';
    }
    
    setNotification(message);
    setTimeout(() => setNotification(null), 6000);
  };

  // å ã„å¸«ã¸ã®é€šçŸ¥ã‚’é€ã‚‹é–¢æ•°
  const notifyFortuneTeller = (fortuneTellerId, notificationType, clientName = '') => {
    const fortuneTeller = fortuneTellers[fortuneTellerId];
    if (!fortuneTeller) return;

    // ã‚¢ãƒ—ãƒªå†…é€šçŸ¥ï¼šæœªèª­ã‚«ã‚¦ãƒ³ãƒˆã‚’å¢—ã‚„ã™
    setFortuneTellers(prev => ({
      ...prev,
      [fortuneTellerId]: {
        ...prev[fortuneTellerId],
        unreadNotifications: prev[fortuneTellerId].unreadNotifications + 1
      }
    }));

    // é€šçŸ¥éŸ³ã‚’é³´ã‚‰ã™ï¼ˆå ã„å¸«ãŒãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®å ´åˆï¼‰
    if (currentUser && currentUser.id === fortuneTellerId) {
      playNotificationSound();
    }

    // LINEé€šçŸ¥ï¼šå…¥å®¤æ™‚ã®ã¿é€ã‚‹ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯é€ã‚‰ãªã„ï¼‰
    if (notificationType === 'new_customer') {
      // å®Ÿè£…ã™ã‚‹å ´åˆã¯ä¸‹ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’è§£é™¤
      // sendLineNotification(fortuneTeller, notificationType, clientName);
    }
  };

  // é€šçŸ¥éŸ³ã‚’é³´ã‚‰ã™é–¢æ•°
  const playNotificationSound = () => {
    try {
      // Web Audio APIã§é€šçŸ¥éŸ³ã‚’ç”Ÿæˆ
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.value = 800; // å‘¨æ³¢æ•°
      gainNode.gain.value = 0.3; // éŸ³é‡
      
      oscillator.start();
      setTimeout(() => oscillator.stop(), 200); // 0.2ç§’é³´ã‚‰ã™
    } catch (error) {
      console.log('é€šçŸ¥éŸ³ã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
    }
  };

  // LINEé€šçŸ¥ã‚’é€ã‚‹é–¢æ•°ï¼ˆå°†æ¥çš„ã«å®Ÿè£…ã™ã‚‹å ´åˆã¯ã“ã“ã‚’ç·¨é›†ï¼‰
  const sendLineNotification = async (fortuneTeller, notificationType, clientName) => {
    // LINE Messaging APIã®è¨­å®š
    const LINE_CHANNEL_ACCESS_TOKEN = 'YOUR_CHANNEL_ACCESS_TOKEN_HERE'; // â† ã“ã“ã«LINEã®ãƒãƒ£ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥ã‚Œã‚‹
    
    if (!fortuneTeller.lineUserId || LINE_CHANNEL_ACCESS_TOKEN === 'YOUR_CHANNEL_ACCESS_TOKEN_HERE') {
      console.log('LINEé€šçŸ¥: æœªè¨­å®šï¼ˆlineUserIdã¾ãŸã¯ãƒˆãƒ¼ã‚¯ãƒ³ãŒæœªè¨­å®šï¼‰');
      return;
    }

    let message = '';
    if (notificationType === 'new_customer') {
      message = `ã€æ–°è¦ãŠå®¢æ§˜ã€‘\n${clientName}æ§˜ãŒãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã«å…¥å®¤ã—ã¾ã—ãŸï¼`;
    } else if (notificationType === 'new_message') {
      message = `ã€æ–°ç€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€‘\n${clientName}æ§˜ã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå±Šãã¾ã—ãŸï¼`;
    }

    try {
      // LINE Messaging APIã§ãƒ—ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
      const response = await fetch('https://api.line.me/v2/bot/message/push', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${LINE_CHANNEL_ACCESS_TOKEN}`
        },
        body: JSON.stringify({
          to: fortuneTeller.lineUserId,
          messages: [
            {
              type: 'text',
              text: message
            }
          ]
        })
      });

      if (response.ok) {
        console.log('LINEé€šçŸ¥é€ä¿¡æˆåŠŸ');
      } else {
        console.error('LINEé€šçŸ¥é€ä¿¡å¤±æ•—:', await response.text());
      }
    } catch (error) {
      console.error('LINEé€šçŸ¥ã‚¨ãƒ©ãƒ¼:', error);
    }
  };

  // å ã„å¸«ãŒé€šçŸ¥ã‚’æ—¢èª­ã«ã™ã‚‹é–¢æ•°
  const markNotificationsAsRead = (fortuneTellerId) => {
    setFortuneTellers(prev => ({
      ...prev,
      [fortuneTellerId]: {
        ...prev[fortuneTellerId],
        unreadNotifications: 0
      }
    }));
  };

  const [salesData] = useState({
    'demo-ft-001': {
      '2025-11-01': [{ clientName: 'ãƒ‡ãƒ¢å¤ªéƒ', amount: 8580 }],
      '2025-11-02': [{ clientName: 'ç”°ä¸­èŠ±å­', amount: 6500 }],
      '2025-11-03': [
        { clientName: 'ä½è—¤æ¬¡éƒ', amount: 7378 },
        { clientName: 'éˆ´æœ¨ç¾å’²', amount: 5720 }
      ],
      '2025-11-15': [{ clientName: 'é«˜æ©‹å¥å¤ª', amount: 12400 }],
      '2025-11-16': [{ clientName: 'ä¼Šè—¤æ„›', amount: 9850 }],
      '2025-11-20': [
        { clientName: 'æ¸¡è¾ºç¿”å¤ª', amount: 5000 },
        { clientName: 'ä¸­æ‘å½©', amount: 3490 }
      ],
      '2025-11-25': [{ clientName: 'ãƒ‡ãƒ¢å¤ªéƒ', amount: 15200 }],
      '2025-10-15': [{ clientName: 'æ¸¡è¾ºç¿”å¤ª', amount: 6854 }],
      '2025-10-16': [{ clientName: 'ä¸­æ‘å½©', amount: 25179 }],
      '2025-10-17': [{ clientName: 'ãƒ‡ãƒ¢å¤ªéƒ', amount: 5505 }],
      '2025-10-18': [{ clientName: 'ç”°ä¸­èŠ±å­', amount: 29261 }]
    }
  });

  const templates = {
    client: [
      'ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™',
      'ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸ',
      'ã¾ãŸç›¸è«‡ã•ã›ã¦ãã ã•ã„'
    ]
  };

  const handleLogin = (email, password) => {
    const user = Object.values(users).find(u => u.email === email && u.password === password);
    const ft = Object.values(fortuneTellers).find(f => f.email === email && f.password === password);
    
    if (user || ft) {
      setCurrentUser(user || ft);
      // ç®¡ç†è€…ã®å ´åˆã¯ç®¡ç†ç”»é¢ã¸
      if ((user || ft).type === 'admin') {
        setScreen('admin');
      } else {
        setScreen('lobby');
      }
    } else {
      alert('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
    }
  };

  const handleStartChat = (fortuneTellerId) => {
    const conversationId = `${currentUser.id}-${fortuneTellerId}`;
    
    if (!conversations[conversationId]) {
      setConversations({
        ...conversations,
        [conversationId]: {
          id: conversationId,
          participants: [currentUser.id, fortuneTellerId],
          messages: [],
          createdAt: new Date().toISOString()
        }
      });
      // æ–°ã—ã„ä¼šè©±ã¯æœªå…¥å®¤çŠ¶æ…‹
      setConversationStatus(prev => ({
        ...prev,
        [conversationId]: 'not-started'
      }));
    }
    
    setCurrentChat(conversationId);
    setScreen('chat');
  };

  // å…¥å®¤å‡¦ç†
  const handleEnterChat = (conversationId) => {
    // ãŠå®¢æ§˜ã®å ´åˆã€ãƒã‚¤ãƒ³ãƒˆãŒ1ä»¥ä¸Šã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    if (currentUser.type === 'client') {
      const conversation = conversations[conversationId];
      const partnerId = conversation.participants.find(id => id !== currentUser.id);
      const partner = fortuneTellers[partnerId];
      
      // ãƒ†ã‚¹ãƒˆãƒœãƒƒãƒˆä»¥å¤–ã§ã€ãƒã‚¤ãƒ³ãƒˆãŒ1æœªæº€ã®å ´åˆã¯å…¥å®¤ä¸å¯
      if (!partner.isTestBot && currentUser.points < 1) {
        alert('ãƒã‚¤ãƒ³ãƒˆãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ãƒã‚¤ãƒ³ãƒˆã‚’è³¼å…¥ã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      // å ã„å¸«ã«é€šçŸ¥ã‚’é€ã‚‹
      notifyFortuneTeller(partnerId, 'new_customer', currentUser.name);
    }
    
    setConversationStatus(prev => ({
      ...prev,
      [conversationId]: 'active'
    }));
    
    // ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹æ™‚ã®æ¶ˆè²»ãƒã‚¤ãƒ³ãƒˆã‚’è¨˜éŒ²
    setSessionStartPoints(prev => ({
      ...prev,
      [conversationId]: conversationPoints[conversationId] || 0
    }));
    
    // ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
    const systemMessage = {
      id: Date.now().toString(),
      senderId: 'system',
      text: 'ãƒãƒ£ãƒƒãƒˆãŒé–‹å§‹ã—ã¾ã—ãŸ',
      timestamp: new Date().toISOString(),
      isSystem: true
    };
    
    setConversations(prev => ({
      ...prev,
      [conversationId]: {
        ...prev[conversationId],
        messages: [...prev[conversationId].messages, systemMessage]
      }
    }));
  };

  // é€€å®¤å‡¦ç†
  const handleExitChat = (conversationId) => {
    setConversationStatus(prev => ({
      ...prev,
      [conversationId]: 'ended'
    }));
    
    // ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
    const systemMessage = {
      id: Date.now().toString(),
      senderId: 'system',
      text: 'ãƒãƒ£ãƒƒãƒˆãŒçµ‚äº†ã—ã¾ã—ãŸ',
      timestamp: new Date().toISOString(),
      isSystem: true
    };
    
    setConversations(prev => ({
      ...prev,
      [conversationId]: {
        ...prev[conversationId],
        messages: [...prev[conversationId].messages, systemMessage]
      }
    }));

    // ãŠå®¢æ§˜ãŒã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§100ptä»¥ä¸Šæ¶ˆè²»ã—ã¦ã„ãŸã‚‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
    if (currentUser.type === 'client') {
      const currentPoints = conversationPoints[conversationId] || 0;
      const startPoints = sessionStartPoints[conversationId] || 0;
      const sessionPoints = currentPoints - startPoints;
      
      if (sessionPoints >= 100) {
        setShowReviewForm(true);
      }
    }
  };

  const LoginScreen = () => {
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');

    // ãƒ†ã‚¹ãƒˆãƒœãƒƒãƒˆä»¥å¤–ã‹ã¤ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒstoppedã§ãªã„å ã„å¸«ã‚’å–å¾—
    const availableFortuneTellers = Object.values(fortuneTellers).filter(
      ft => !ft.isTestBot && ft.status !== 'stopped'
    );

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
    const getStatusText = (status) => {
      if (status === 'available') return 'ã„ã¾ã™ãå ãˆã¾ã™';
      if (status === 'accepting') return 'é‘‘å®šå—ä»˜ä¸­';
      return '';
    };

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ã‚µãƒ–ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
    const getStatusSubText = (status) => {
      if (status === 'accepting') return '(24æ™‚é–“ä»¥å†…ã«è¿”ä¿¡)';
      return '';
    };

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®èƒŒæ™¯è‰²ã‚’å–å¾—
    const getStatusColor = (status) => {
      if (status === 'available') return '#16a34a';
      if (status === 'accepting') return '#2563eb';
      return '#6b7280';
    };

    return (
      <div style={{
        minHeight: '100vh',
        background: 'white',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        padding: '16px'
      }}>
        {/* ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ  */}
        <div style={{
          maxWidth: '400px',
          width: '100%',
          background: 'white',
          borderRadius: '24px',
          padding: '32px',
          boxShadow: '0 20px 60px rgba(0,0,0,0.1)'
        }}>
          <div style={{ textAlign: 'center', marginBottom: '24px' }}>
            <svg width="340" height="130" viewBox="0 0 500 180" xmlns="http://www.w3.org/2000/svg" style="display: block; margin: 0 auto;">
            <defs>
              <linearGradient id="textGrad2" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" style="stop-color:#ec4899;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#a855f7;stop-opacity:1" />
              </linearGradient>
              <filter id="softShadow2">
                <feDropShadow dx="0" dy="3" stdDeviation="3" flood-color="#000000" flood-opacity="0.25"/>
              </filter>
            </defs>
            
            <!-- å¯æ„›ã„æœˆï¼ˆãƒãƒ¡ãƒ­ãƒ³é¢¨ï¼‰ -->
            <g transform="translate(70, 60)" filter="url(#softShadow2)">
              <path d="M 0,0 A 38,38 0 1,0 22,-22 A 28,28 0 1,1 0,0 Z" fill="#fef3c7"/>
              <circle cx="13" cy="-13" r="3" fill="#fbbf24"/>
              <path d="M 13,-16 L 13.5,-13.5 L 16,-13 L 13.5,-12.5 L 13,-10 L 12.5,-12.5 L 10,-13 L 12.5,-13.5 Z" fill="#fbbf24"/>
              <circle cx="-10" cy="-10" r="2" fill="#fbbf24" opacity="0.8"/>
            </g>
            
            <!-- Cupidsã®æ–‡å­— -->
            <g filter="url(#softShadow2)">
              <text x="145" y="105" font-family="'Comic Sans MS', 'Arial Rounded MT Bold', sans-serif" font-size="70" font-weight="900" fill="#ffffff" stroke="#ffffff" stroke-width="6">
                Cupids
              </text>
              <text x="145" y="105" font-family="'Comic Sans MS', 'Arial Rounded MT Bold', sans-serif" font-size="70" font-weight="900" fill="url(#textGrad2)">
                Cupids
              </text>
            </g>
            
            <!-- ã‚µãƒ–ãƒ†ã‚­ã‚¹ãƒˆ -->
            <text x="147" y="135" font-family="'Comic Sans MS', sans-serif" font-size="18" fill="#a855f7" font-weight="bold" letter-spacing="2">
              ãƒãƒ£ãƒƒãƒˆå ã„
            </text>
            
            <!-- å°ã•ãªãƒãƒ¼ãƒˆ -->
            <path d="M 460,50 L 465,45 Q 470,40 473,45 Q 476,40 481,45 L 473,60 Z" fill="#ec4899" opacity="0.7">
              <animateTransform attributeName="transform" type="translate" values="0,0; 0,-5; 0,0" dur="2s" repeatCount="indefinite"/>
            </path>
            
            <!-- ã‚­ãƒ©ã‚­ãƒ© -->
            <g opacity="0.8">
              <circle cx="430" cy="100" r="3" fill="#fbbf24">
                <animate attributeName="opacity" values="1;0.4;1" dur="1.5s" repeatCount="indefinite"/>
              </circle>
              <path d="M 430,96 L 431,99 L 434,100 L 431,101 L 430,104 L 429,101 L 426,100 L 429,99 Z" fill="#ffffff">
                <animate attributeName="opacity" values="1;0.5;1" dur="1.5s" repeatCount="indefinite"/>
              </path>
            </g>
          </svg>
            <p style={{ color: '#ec4899', marginBottom: '24px', fontSize: '13px', fontWeight: 'bold', fontFamily: "'Comic Sans MS', 'Mamelon', sans-serif" }}>æœˆã«ä»£ã‚ã£ã¦ã‚ãªãŸã®æ‹ã‚’å¿œæ´ã—ã¾ã™â™¡</p>
          </div>

          {/* å ã„å¸«ä¸€è¦§ */}
          <div style={{ marginBottom: '24px' }}>
            <h2 style={{ fontSize: '16px', fontWeight: 'bold', color: '#1f2937', marginBottom: '12px' }}>
              ä»Šã™ãå ãˆã‚‹å ã„å¸«
            </h2>
            <div style={{ display: 'flex', flexDirection: 'column', gap: '8px', maxHeight: '200px', overflowY: 'auto' }}>
              {availableFortuneTellers.map((ft) => (
                <div key={ft.id} style={{
                  background: '#f9fafb',
                  borderRadius: '8px',
                  padding: '12px',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '12px',
                  border: '1px solid #e5e7eb'
                }}>
                  <div style={{
                    width: '40px',
                    height: '40px',
                    borderRadius: '50%',
                    background: 'linear-gradient(135deg, #ec4899, #a855f7)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    flexShrink: 0
                  }}>
                    <span style={{ color: 'white', fontSize: '16px', fontWeight: 'bold' }}>
                      {ft.name[0]}
                    </span>
                  </div>
                  <div style={{ flex: 1 }}>
                    <h3 style={{ fontSize: '14px', fontWeight: 'bold', color: '#1f2937', marginBottom: '2px' }}>
                      {ft.name}
                    </h3>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                      <Star size={12} fill="#fbbf24" color="#fbbf24" />
                      <span style={{ fontSize: '12px', color: '#6b7280' }}>
                        {ft.rating.toFixed(1)}
                      </span>
                      <span style={{ fontSize: '12px', color: '#fbbf24' }}>
                        é‘‘å®šæ•° {ft.reviewCount}ä»¶
                      </span>
                    </div>
                  </div>
                  <div style={{
                    background: getStatusColor(ft.status),
                    color: 'white',
                    padding: '4px 8px',
                    borderRadius: '4px',
                    fontSize: '10px',
                    fontWeight: 'bold',
                    textAlign: 'center',
                    lineHeight: '1.3'
                  }}>
                    <div>{getStatusText(ft.status)}</div>
                    {getStatusSubText(ft.status) && (
                      <div style={{ fontSize: '9px' }}>{getStatusSubText(ft.status)}</div>
                    )}
                  </div>
                </div>
              ))}
            </div>
          </div>

          <div style={{ marginBottom: '16px' }}>
            <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: '#374151', marginBottom: '8px' }}>
              ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
            </label>
            <input
              type="email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              style={{
                width: '100%',
                padding: '12px 16px',
                border: '1px solid #d1d5db',
                borderRadius: '8px',
                fontSize: '14px'
              }}
              placeholder="your@email.com"
            />
          </div>

          <div style={{ marginBottom: '16px' }}>
            <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: '#374151', marginBottom: '8px' }}>
              ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
            </label>
            <input
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              onKeyPress={(e) => e.key === 'Enter' && handleLogin(email, password)}
              style={{
                width: '100%',
                padding: '12px 16px',
                border: '1px solid #d1d5db',
                borderRadius: '8px',
                fontSize: '14px'
              }}
              placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
            />
          </div>

          <button
            onClick={() => handleLogin(email, password)}
            style={{
              width: '100%',
              background: 'linear-gradient(to right, #ec4899, #a855f7)',
              color: 'white',
              fontWeight: 'bold',
              padding: '12px',
              borderRadius: '8px',
              border: 'none',
              cursor: 'pointer',
              fontSize: '16px'
            }}
          >
            ãƒ­ã‚°ã‚¤ãƒ³
          </button>

          <button
            onClick={() => setScreen('register')}
            style={{
              width: '100%',
              background: 'white',
              color: '#a855f7',
              fontWeight: 'bold',
              padding: '12px',
              borderRadius: '8px',
              border: '2px solid #a855f7',
              cursor: 'pointer',
              fontSize: '16px',
              marginTop: '12px'
            }}
          >
            æ–°è¦ç™»éŒ²
          </button>
        </div>
      </div>
    );
  };

  const RegisterScreen = () => {
    // ãŠå®¢æ§˜ç”¨ã®ãƒ•ã‚©ãƒ¼ãƒ 
    const [clientName, setClientName] = useState('');
    const [clientEmail, setClientEmail] = useState('');
    const [clientPassword, setClientPassword] = useState('');

    const handleClientSubmit = () => {
      if (!clientName || !clientEmail || !clientPassword) {
        alert('å…¨ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      // æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ç”Ÿæˆ
      const newUserId = 'user-' + Date.now();
      
      // æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ 
      const newUser = {
        id: newUserId,
        name: clientName,
        email: clientEmail,
        password: clientPassword,
        type: 'client',
        points: 0 // åˆæœŸãƒã‚¤ãƒ³ãƒˆ0
      };

      setUsers(prev => ({
        ...prev,
        [newUserId]: newUser
      }));

      // è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³
      setCurrentUser(newUser);
      setScreen('lobby');
    };

    const handleFortuneTellerSubmit = () => {
      // Googleãƒ•ã‚©ãƒ¼ãƒ ã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
      window.open('https://docs.google.com/forms/d/e/1FAIpQLSd47fyl7SSNBOcgdRyuKMx9N0rQVb9nZnlMfSlHlN4IEGbDpw/viewform', '_blank');
      
      // ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
      alert('Googleãƒ•ã‚©ãƒ¼ãƒ ãŒé–‹ãã¾ã—ãŸã€‚\nãƒ•ã‚©ãƒ¼ãƒ ã«å…¥åŠ›ã—ã¦é€ä¿¡ã—ã¦ãã ã•ã„ã€‚\nå¯©æŸ»çµæœã¯ãƒ¡ãƒ¼ãƒ«ã§ãŠçŸ¥ã‚‰ã›ã—ã¾ã™ã€‚');
      
      // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹
      setScreen('login');
    };

    return (
      <div style={{
        minHeight: '100vh',
        background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        padding: '32px 16px'
      }}>
        <div style={{
          maxWidth: '600px',
          width: '100%',
          background: 'white',
          borderRadius: '24px',
          padding: '32px',
          boxShadow: '0 20px 60px rgba(0,0,0,0.3)'
        }}>
          <div style={{ textAlign: 'center', marginBottom: '24px' }}>
            <Moon style={{ margin: '0 auto 16px', color: '#667eea' }} size={48} />
            <h1 style={{ fontSize: '28px', fontWeight: 'bold', color: '#667eea', marginBottom: '8px' }}>
              æ–°è¦ç™»éŒ²
            </h1>
          </div>

          {/* ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ */}
          <div style={{ 
            display: 'flex', 
            gap: '8px', 
            marginBottom: '24px',
            borderBottom: '2px solid #e5e7eb'
          }}>
            <button
              onClick={() => setRegistrationType('client')}
              style={{
                flex: 1,
                padding: '12px',
                background: registrationType === 'client' ? 'linear-gradient(to right, #ec4899, #a855f7)' : 'transparent',
                color: registrationType === 'client' ? 'white' : '#6b7280',
                border: 'none',
                borderBottom: registrationType === 'client' ? '3px solid #ec4899' : 'none',
                cursor: 'pointer',
                fontSize: '16px',
                fontWeight: 'bold',
                borderRadius: '8px 8px 0 0'
              }}
            >
              ãŠå®¢æ§˜
            </button>
            <button
              onClick={() => setRegistrationType('fortune-teller')}
              style={{
                flex: 1,
                padding: '12px',
                background: registrationType === 'fortune-teller' ? 'linear-gradient(to right, #ec4899, #a855f7)' : 'transparent',
                color: registrationType === 'fortune-teller' ? 'white' : '#6b7280',
                border: 'none',
                borderBottom: registrationType === 'fortune-teller' ? '3px solid #ec4899' : 'none',
                cursor: 'pointer',
                fontSize: '16px',
                fontWeight: 'bold',
                borderRadius: '8px 8px 0 0'
              }}
            >
              å ã„å¸«
            </button>
          </div>

          {/* ãŠå®¢æ§˜ç”¨ãƒ•ã‚©ãƒ¼ãƒ  */}
          {registrationType === 'client' && (
            <div style={{ maxHeight: '60vh', overflowY: 'auto', paddingRight: '8px' }}>
              <div style={{ marginBottom: '16px' }}>
                <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: '#374151', marginBottom: '8px' }}>
                  ãŠåå‰ <span style={{ color: '#ef4444' }}>*</span>
                </label>
                <input
                  type="text"
                  value={clientName}
                  onChange={(e) => setClientName(e.target.value)}
                  style={{
                    width: '100%',
                    padding: '12px 16px',
                    border: '1px solid #d1d5db',
                    borderRadius: '8px',
                    fontSize: '14px'
                  }}
                  placeholder="å±±ç”°å¤ªéƒ"
                />
              </div>

              <div style={{ marginBottom: '16px' }}>
                <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: '#374151', marginBottom: '8px' }}>
                  ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ <span style={{ color: '#ef4444' }}>*</span>
                </label>
                <input
                  type="email"
                  value={clientEmail}
                  onChange={(e) => setClientEmail(e.target.value)}
                  style={{
                    width: '100%',
                    padding: '12px 16px',
                    border: '1px solid #d1d5db',
                    borderRadius: '8px',
                    fontSize: '14px'
                  }}
                  placeholder="your@email.com"
                />
              </div>

              <div style={{ marginBottom: '24px' }}>
                <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: '#374151', marginBottom: '8px' }}>
                  ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ <span style={{ color: '#ef4444' }}>*</span>
                </label>
                <input
                  type="password"
                  value={clientPassword}
                  onChange={(e) => setClientPassword(e.target.value)}
                  style={{
                    width: '100%',
                    padding: '12px 16px',
                    border: '1px solid #d1d5db',
                    borderRadius: '8px',
                    fontSize: '14px'
                  }}
                  placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                />
              </div>

              <button
                onClick={handleClientSubmit}
                style={{
                  width: '100%',
                  background: 'linear-gradient(to right, #ec4899, #a855f7)',
                  color: 'white',
                  fontWeight: 'bold',
                  padding: '14px',
                  borderRadius: '8px',
                  border: 'none',
                  cursor: 'pointer',
                  fontSize: '16px',
                  marginBottom: '12px'
                }}
              >
                ç™»éŒ²ç”³è«‹ã‚’é€ä¿¡
              </button>
            </div>
          )}

          {/* å ã„å¸«ç”¨ãƒ•ã‚©ãƒ¼ãƒ  */}
          {registrationType === 'fortune-teller' && (
            <div style={{ maxHeight: '60vh', overflowY: 'auto', paddingRight: '8px' }}>
              <div style={{
                background: '#f9fafb',
                border: '2px solid #a855f7',
                borderRadius: '12px',
                padding: '24px',
                marginBottom: '24px',
                textAlign: 'center'
              }}>
                <div style={{
                  width: '60px',
                  height: '60px',
                  margin: '0 auto 16px',
                  background: 'linear-gradient(135deg, #ec4899, #a855f7)',
                  borderRadius: '50%',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center'
                }}>
                  <FileText size={30} color="white" />
                </div>
                <h3 style={{
                  fontSize: '18px',
                  fontWeight: 'bold',
                  color: '#1f2937',
                  marginBottom: '12px'
                }}>
                  å ã„å¸«ç™»éŒ²ç”³è«‹
                </h3>
                <p style={{
                  fontSize: '14px',
                  color: '#6b7280',
                  lineHeight: '1.6',
                  marginBottom: '20px'
                }}>
                  å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã«é€²ã¿ã¾ã™ã€‚<br/>
                  ç™»éŒ²ç”³è«‹ã‚’é€ä¿¡ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„
                </p>
              </div>

              <button
                onClick={handleFortuneTellerSubmit}
                style={{
                  width: '100%',
                  background: 'linear-gradient(to right, #ec4899, #a855f7)',
                  color: 'white',
                  fontWeight: 'bold',
                  padding: '14px',
                  borderRadius: '8px',
                  border: 'none',
                  cursor: 'pointer',
                  fontSize: '16px',
                  marginBottom: '12px'
                }}
              >
                ç™»éŒ²ç”³è«‹ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã
              </button>
            </div>
          )}

          <button
            onClick={() => setScreen('login')}
            style={{
              width: '100%',
              background: 'white',
              color: '#6b7280',
              fontWeight: '600',
              padding: '12px',
              borderRadius: '8px',
              border: '1px solid #d1d5db',
              cursor: 'pointer',
              fontSize: '14px'
            }}
          >
            ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹
          </button>
        </div>
      </div>
    );
  };

  const LobbyScreen = () => {
    // ãŠå®¢æ§˜ã®ãƒ­ãƒ“ãƒ¼
    if (currentUser.type === 'client') {
      return (
        <div style={{ minHeight: '100vh', background: '#f9fafb' }}>
          <div style={{
            background: 'linear-gradient(to right, #ec4899, #a855f7)',
            padding: '16px',
            boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
          }}>
            <div style={{
              maxWidth: '1024px',
              margin: '0 auto',
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center'
            }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                <svg width="340" height="130" viewBox="0 0 500 180" xmlns="http://www.w3.org/2000/svg" style="display: block; margin: 0 auto;">
            <defs>
              <linearGradient id="textGrad2" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" style="stop-color:#ec4899;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#a855f7;stop-opacity:1" />
              </linearGradient>
              <filter id="softShadow2">
                <feDropShadow dx="0" dy="3" stdDeviation="3" flood-color="#000000" flood-opacity="0.25"/>
              </filter>
            </defs>
            
            <!-- å¯æ„›ã„æœˆï¼ˆãƒãƒ¡ãƒ­ãƒ³é¢¨ï¼‰ -->
            <g transform="translate(70, 60)" filter="url(#softShadow2)">
              <path d="M 0,0 A 38,38 0 1,0 22,-22 A 28,28 0 1,1 0,0 Z" fill="#fef3c7"/>
              <circle cx="13" cy="-13" r="3" fill="#fbbf24"/>
              <path d="M 13,-16 L 13.5,-13.5 L 16,-13 L 13.5,-12.5 L 13,-10 L 12.5,-12.5 L 10,-13 L 12.5,-13.5 Z" fill="#fbbf24"/>
              <circle cx="-10" cy="-10" r="2" fill="#fbbf24" opacity="0.8"/>
            </g>
            
            <!-- Cupidsã®æ–‡å­— -->
            <g filter="url(#softShadow2)">
              <text x="145" y="105" font-family="'Comic Sans MS', 'Arial Rounded MT Bold', sans-serif" font-size="70" font-weight="900" fill="#ffffff" stroke="#ffffff" stroke-width="6">
                Cupids
              </text>
              <text x="145" y="105" font-family="'Comic Sans MS', 'Arial Rounded MT Bold', sans-serif" font-size="70" font-weight="900" fill="url(#textGrad2)">
                Cupids
              </text>
            </g>
            
            <!-- ã‚µãƒ–ãƒ†ã‚­ã‚¹ãƒˆ -->
            <text x="147" y="135" font-family="'Comic Sans MS', sans-serif" font-size="18" fill="#a855f7" font-weight="bold" letter-spacing="2">
              ãƒãƒ£ãƒƒãƒˆå ã„
            </text>
            
            <!-- å°ã•ãªãƒãƒ¼ãƒˆ -->
            <path d="M 460,50 L 465,45 Q 470,40 473,45 Q 476,40 481,45 L 473,60 Z" fill="#ec4899" opacity="0.7">
              <animateTransform attributeName="transform" type="translate" values="0,0; 0,-5; 0,0" dur="2s" repeatCount="indefinite"/>
            </path>
            
            <!-- ã‚­ãƒ©ã‚­ãƒ© -->
            <g opacity="0.8">
              <circle cx="430" cy="100" r="3" fill="#fbbf24">
                <animate attributeName="opacity" values="1;0.4;1" dur="1.5s" repeatCount="indefinite"/>
              </circle>
              <path d="M 430,96 L 431,99 L 434,100 L 431,101 L 430,104 L 429,101 L 426,100 L 429,99 Z" fill="#ffffff">
                <animate attributeName="opacity" values="1;0.5;1" dur="1.5s" repeatCount="indefinite"/>
              </path>
            </g>
          </svg>
              </div>
              <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                <div style={{
                  background: 'rgba(255,255,255,0.2)',
                  padding: '8px 16px',
                  borderRadius: '8px',
                  border: '1px solid rgba(255,255,255,0.3)'
                }}>
                  <span style={{ color: 'white', fontSize: '14px', fontWeight: '600' }}>
                    ğŸ’° {currentUser.points}pt
                  </span>
                </div>
                <button
                  onClick={() => setScreen('purchase')}
                  style={{
                    background: '#fbbf24',
                    color: '#78350f',
                    padding: '8px 16px',
                    borderRadius: '8px',
                    border: 'none',
                    cursor: 'pointer',
                    fontSize: '14px',
                    fontWeight: '700',
                    boxShadow: '0 2px 8px rgba(251, 191, 36, 0.4)'
                  }}
                >
                  ãƒã‚¤ãƒ³ãƒˆè³¼å…¥
                </button>
                <span style={{ color: 'white', fontSize: '14px', fontWeight: '600' }}>
                  {currentUser.name}ã•ã‚“
                </span>
                <button
                  onClick={() => {
                    setCurrentUser(null);
                    setScreen('login');
                  }}
                  style={{
                    background: 'rgba(255,255,255,0.2)',
                    color: 'white',
                    padding: '8px 16px',
                    borderRadius: '8px',
                    border: '1px solid rgba(255,255,255,0.3)',
                    cursor: 'pointer',
                    fontSize: '14px',
                    fontWeight: '600',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '6px'
                  }}
                >
                  <LogOut size={16} />
                  ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                </button>
              </div>
            </div>
          </div>

          <div style={{ maxWidth: '1024px', margin: '0 auto', padding: '24px 16px' }}>
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(280px, 1fr))', gap: '16px' }}>
              {Object.values(fortuneTellers).map((ft) => {
                // ã“ã®å ã„å¸«ã¨å…¥å®¤ä¸­ã®ä¼šè©±æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
                const activeChatsCount = Object.values(conversationStatus).filter((status, idx) => {
                  const convId = Object.keys(conversationStatus)[idx];
                  const conv = conversations[convId];
                  return conv && conv.participants.includes(ft.id) && status === 'active';
                }).length;

                return (
                <div 
                  key={ft.id} 
                  onClick={() => {
                    setSelectedFortuneTellerId(ft.id);
                    setScreen('fortune-profile');
                  }}
                  style={{
                    background: 'white',
                    borderRadius: '12px',
                    overflow: 'hidden',
                    boxShadow: '0 2px 8px rgba(0,0,0,0.1)',
                    border: '1px solid #e5e7eb',
                    transition: 'all 0.2s',
                    cursor: 'pointer'
                  }}
                  onMouseOver={(e) => {
                    e.currentTarget.style.transform = 'translateY(-2px)';
                    e.currentTarget.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
                  }}
                  onMouseOut={(e) => {
                    e.currentTarget.style.transform = 'translateY(0)';
                    e.currentTarget.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
                  }}
                >
                  <div style={{ padding: '16px', display: 'flex', gap: '12px' }}>
                    {/* ã‚¢ã‚¤ã‚³ãƒ³ */}
                    <div style={{
                      width: '60px',
                      height: '60px',
                      borderRadius: '50%',
                      background: 'linear-gradient(135deg, #a855f7, #ec4899)',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      flexShrink: 0
                    }}>
                      <span style={{ color: 'white', fontSize: '20px', fontWeight: 'bold' }}>
                        {ft.name[0]}
                      </span>
                    </div>

                    {/* æƒ…å ±ã‚¨ãƒªã‚¢ */}
                    <div style={{ flex: 1, minWidth: 0 }}>
                      {/* åå‰ã¨è©•ä¾¡ */}
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '4px' }}>
                        <h3 style={{ fontSize: '16px', fontWeight: 'bold', color: '#1f2937' }}>
                          {ft.name}
                        </h3>
                        <div style={{
                          display: 'flex',
                          alignItems: 'center',
                          gap: '2px',
                          flexShrink: 0
                        }}>
                          <Star size={14} fill="#fbbf24" color="#fbbf24" />
                          <span style={{ fontSize: '13px', fontWeight: 'bold', color: '#92400e' }}>
                            {ft.rating}
                          </span>
                        </div>
                      </div>

                      {/* å°‚é–€åˆ†é‡ */}
                      <p style={{ fontSize: '12px', color: '#6b7280', marginBottom: '8px' }}>
                        {ft.specialty}
                      </p>

                      {/* é‘‘å®šæ•°ã¨ãƒã‚¤ãƒ³ãƒˆ */}
                      <div style={{ display: 'flex', gap: '8px', alignItems: 'center', marginBottom: '8px' }}>
                        <span style={{ fontSize: '11px', color: '#9ca3af' }}>
                          é‘‘å®šæ•° {ft.reviewCount}ä»¶
                        </span>
                        <span style={{ 
                          fontSize: '12px', 
                          color: '#ec4899',
                          fontWeight: 'bold'
                        }}>
                          {ft.pointsPerChar}pt/1æ–‡å­—
                        </span>
                      </div>

                      {/* é‘‘å®šä¸­ã®äººæ•° */}
                      <div style={{
                        display: 'inline-block',
                        background: activeChatsCount === 0 ? '#10b981' : '#fbbf24',
                        color: 'white',
                        padding: '4px 12px',
                        borderRadius: '12px',
                        fontSize: '12px',
                        fontWeight: 'bold'
                      }}>
                        {activeChatsCount === 0 ? 'ã™ãå ãˆã¾ã™' : `${activeChatsCount}äººé‘‘å®šä¸­`}
                      </div>
                    </div>
                  </div>
                </div>
              );
              })}
            </div>
          </div>
        </div>
      );
    }

    // å ã„å¸«ã®ãƒ­ãƒ“ãƒ¼
    return (
      <div style={{ minHeight: '100vh', background: '#f9fafb' }}>
        <div style={{
          background: 'linear-gradient(to right, #ec4899, #a855f7)',
          padding: '16px',
          boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
        }}>
          <div style={{
            maxWidth: '1024px',
            margin: '0 auto',
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center'
          }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
              <svg width="340" height="130" viewBox="0 0 500 180" xmlns="http://www.w3.org/2000/svg" style="display: block; margin: 0 auto;">
            <defs>
              <linearGradient id="textGrad2" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" style="stop-color:#ec4899;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#a855f7;stop-opacity:1" />
              </linearGradient>
              <filter id="softShadow2">
                <feDropShadow dx="0" dy="3" stdDeviation="3" flood-color="#000000" flood-opacity="0.25"/>
              </filter>
            </defs>
            
            <!-- å¯æ„›ã„æœˆï¼ˆãƒãƒ¡ãƒ­ãƒ³é¢¨ï¼‰ -->
            <g transform="translate(70, 60)" filter="url(#softShadow2)">
              <path d="M 0,0 A 38,38 0 1,0 22,-22 A 28,28 0 1,1 0,0 Z" fill="#fef3c7"/>
              <circle cx="13" cy="-13" r="3" fill="#fbbf24"/>
              <path d="M 13,-16 L 13.5,-13.5 L 16,-13 L 13.5,-12.5 L 13,-10 L 12.5,-12.5 L 10,-13 L 12.5,-13.5 Z" fill="#fbbf24"/>
              <circle cx="-10" cy="-10" r="2" fill="#fbbf24" opacity="0.8"/>
            </g>
            
            <!-- Cupidsã®æ–‡å­— -->
            <g filter="url(#softShadow2)">
              <text x="145" y="105" font-family="'Comic Sans MS', 'Arial Rounded MT Bold', sans-serif" font-size="70" font-weight="900" fill="#ffffff" stroke="#ffffff" stroke-width="6">
                Cupids
              </text>
              <text x="145" y="105" font-family="'Comic Sans MS', 'Arial Rounded MT Bold', sans-serif" font-size="70" font-weight="900" fill="url(#textGrad2)">
                Cupids
              </text>
            </g>
            
            <!-- ã‚µãƒ–ãƒ†ã‚­ã‚¹ãƒˆ -->
            <text x="147" y="135" font-family="'Comic Sans MS', sans-serif" font-size="18" fill="#a855f7" font-weight="bold" letter-spacing="2">
              ãƒãƒ£ãƒƒãƒˆå ã„
            </text>
            
            <!-- å°ã•ãªãƒãƒ¼ãƒˆ -->
            <path d="M 460,50 L 465,45 Q 470,40 473,45 Q 476,40 481,45 L 473,60 Z" fill="#ec4899" opacity="0.7">
              <animateTransform attributeName="transform" type="translate" values="0,0; 0,-5; 0,0" dur="2s" repeatCount="indefinite"/>
            </path>
            
            <!-- ã‚­ãƒ©ã‚­ãƒ© -->
            <g opacity="0.8">
              <circle cx="430" cy="100" r="3" fill="#fbbf24">
                <animate attributeName="opacity" values="1;0.4;1" dur="1.5s" repeatCount="indefinite"/>
              </circle>
              <path d="M 430,96 L 431,99 L 434,100 L 431,101 L 430,104 L 429,101 L 426,100 L 429,99 Z" fill="#ffffff">
                <animate attributeName="opacity" values="1;0.5;1" dur="1.5s" repeatCount="indefinite"/>
              </path>
            </g>
          </svg>
            </div>
            <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
              <span style={{ color: 'white', fontSize: '14px', fontWeight: '600' }}>
                {currentUser.name}ã•ã‚“
              </span>
              <button
                onClick={() => setScreen('profile-edit')}
                style={{
                  background: 'rgba(255,255,255,0.2)',
                  color: 'white',
                  padding: '8px 16px',
                  borderRadius: '8px',
                  border: '1px solid rgba(255,255,255,0.3)',
                  cursor: 'pointer',
                  fontSize: '14px',
                  fontWeight: '600',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '6px'
                }}
              >
                <Edit2 size={16} />
                ãƒ—ãƒ­ãƒ•ç·¨é›†
              </button>
              <button
                onClick={() => setScreen('revenue')}
                style={{
                  background: 'rgba(255,255,255,0.2)',
                  color: 'white',
                  padding: '8px 16px',
                  borderRadius: '8px',
                  border: '1px solid rgba(255,255,255,0.3)',
                  cursor: 'pointer',
                  fontSize: '14px',
                  fontWeight: '600'
                }}
              >
                å ±é…¬ç¢ºèª
              </button>
              <button
                onClick={() => {
                  setCurrentUser(null);
                  setScreen('login');
                }}
                style={{
                  background: 'rgba(255,255,255,0.2)',
                  color: 'white',
                  padding: '8px 16px',
                  borderRadius: '8px',
                  border: '1px solid rgba(255,255,255,0.3)',
                  cursor: 'pointer',
                  fontSize: '14px',
                  fontWeight: '600',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '6px'
                }}
              >
                <LogOut size={16} />
                ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
              </button>
            </div>
          </div>
        </div>

        {/* é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */}
        {notification && (
          <div style={{
            maxWidth: '1024px',
            margin: '16px auto',
            padding: '12px 16px',
            background: '#10b981',
            color: 'white',
            borderRadius: '8px',
            textAlign: 'center',
            fontWeight: 'bold',
            boxShadow: '0 4px 12px rgba(16, 185, 129, 0.3)'
          }}>
            {notification}
          </div>
        )}

        {/* å¾…æ©ŸçŠ¶æ…‹ãƒœã‚¿ãƒ³ */}
        <div style={{ maxWidth: '1024px', margin: '0 auto', padding: '24px 16px 0' }}>
          <div style={{ 
            background: 'white',
            borderRadius: '12px',
            padding: '20px',
            marginBottom: '20px',
            boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
          }}>
            <h3 style={{ fontSize: '16px', fontWeight: 'bold', color: '#1f2937', marginBottom: '12px' }}>
              å¾…æ©ŸçŠ¶æ…‹
            </h3>
            <div style={{ display: 'flex', gap: '12px', flexWrap: 'wrap' }}>
              <button
                onClick={() => handleStatusChange('available')}
                style={{
                  padding: '10px 20px',
                  background: fortuneTellers[currentUser.id]?.status === 'available' 
                    ? 'linear-gradient(to right, #10b981, #059669)' 
                    : '#e5e7eb',
                  color: fortuneTellers[currentUser.id]?.status === 'available' ? 'white' : '#6b7280',
                  borderRadius: '8px',
                  border: 'none',
                  cursor: 'pointer',
                  fontSize: '14px',
                  fontWeight: '600',
                  transition: 'all 0.2s'
                }}
              >
                å¾…æ©Ÿé–‹å§‹
              </button>
              <button
                onClick={() => handleStatusChange('accepting')}
                style={{
                  padding: '10px 20px',
                  background: fortuneTellers[currentUser.id]?.status === 'accepting' 
                    ? 'linear-gradient(to right, #3b82f6, #2563eb)' 
                    : '#e5e7eb',
                  color: fortuneTellers[currentUser.id]?.status === 'accepting' ? 'white' : '#6b7280',
                  borderRadius: '8px',
                  border: 'none',
                  cursor: 'pointer',
                  fontSize: '14px',
                  fontWeight: '600',
                  transition: 'all 0.2s'
                }}
              >
                é‘‘å®šå—ä»˜ä¸­
              </button>
              <button
                onClick={() => handleStatusChange('stopped')}
                style={{
                  padding: '10px 20px',
                  background: fortuneTellers[currentUser.id]?.status === 'stopped' 
                    ? 'linear-gradient(to right, #6b7280, #4b5563)' 
                    : '#e5e7eb',
                  color: fortuneTellers[currentUser.id]?.status === 'stopped' ? 'white' : '#6b7280',
                  borderRadius: '8px',
                  border: 'none',
                  cursor: 'pointer',
                  fontSize: '14px',
                  fontWeight: '600',
                  transition: 'all 0.2s'
                }}
              >
                é‘‘å®šåœæ­¢
              </button>
            </div>
            <p style={{ fontSize: '13px', color: '#6b7280', marginTop: '12px' }}>
              ç¾åœ¨ã®çŠ¶æ…‹: <span style={{ fontWeight: 'bold', color: '#1f2937' }}>
                {fortuneTellers[currentUser.id]?.status === 'available' && 'å¾…æ©Ÿä¸­ï¼ˆã™ãè¿”ä¿¡ã§ãã‚‹æ–¹ã®ã¿ï¼‰'}
                {fortuneTellers[currentUser.id]?.status === 'accepting' && 'é‘‘å®šå—ä»˜ä¸­ï¼ˆ24æ™‚é–“ä»¥å†…ã«è¿”ä¿¡ï¼‰'}
                {fortuneTellers[currentUser.id]?.status === 'stopped' && 'é‘‘å®šåœæ­¢ä¸­'}
              </span>
            </p>
          </div>
        </div>

        <div style={{ maxWidth: '1024px', margin: '0 auto', padding: '0 16px 24px' }}>
          {Object.values(conversations)
            .filter(conv => conv.participants.includes(currentUser.id))
            .map(conv => {
              const otherParticipantId = conv.participants.find(id => id !== currentUser.id);
              const otherParticipant = users[otherParticipantId];
              const lastMessage = conv.messages[conv.messages.length - 1];

              return (
                <div
                  key={conv.id}
                  onClick={() => {
                    setCurrentChat(conv.id);
                    setScreen('chat');
                  }}
                  style={{
                    background: 'white',
                    padding: '16px',
                    borderRadius: '12px',
                    marginBottom: '12px',
                    cursor: 'pointer',
                    border: '1px solid #e5e7eb',
                    transition: 'all 0.2s'
                  }}
                >
                  <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                    <div style={{
                      width: '48px',
                      height: '48px',
                      borderRadius: '50%',
                      background: 'linear-gradient(135deg, #fbbf24, #f59e0b)',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center'
                    }}>
                      <span style={{ color: 'white', fontSize: '18px', fontWeight: 'bold' }}>
                        {otherParticipant?.name[0]}
                      </span>
                    </div>
                    <div style={{ flex: 1 }}>
                      <h3 style={{ fontSize: '16px', fontWeight: 'bold', color: '#1f2937', marginBottom: '4px' }}>
                        {otherParticipant?.name}
                      </h3>
                      {otherParticipant?.points !== undefined && (
                        <p style={{ fontSize: '12px', color: '#ec4899', fontWeight: 'bold', marginBottom: '4px' }}>
                          æ‰€æŒãƒã‚¤ãƒ³ãƒˆ: {otherParticipant.points}pt
                        </p>
                      )}
                      {lastMessage && (
                        <p style={{ fontSize: '14px', color: '#6b7280' }}>
                          {lastMessage.text.substring(0, 50)}{lastMessage.text.length > 50 ? '...' : ''}
                        </p>
                      )}
                    </div>
                    <div style={{ textAlign: 'right' }}>
                      {lastMessage && (
                        <p style={{ fontSize: '12px', color: '#6b7280' }}>
                          {new Date(lastMessage.timestamp).toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' })}
                        </p>
                      )}
                    </div>
                  </div>
                </div>
              );
            })}

          {Object.values(conversations).filter(conv => conv.participants.includes(currentUser.id)).length === 0 && (
            <div style={{
              textAlign: 'center',
              padding: '48px 16px',
              color: '#6b7280'
            }}>
              <Mail size={48} style={{ margin: '0 auto 16px', opacity: 0.3 }} />
              <p>ã¾ã ãƒãƒ£ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>
            </div>
          )}
        </div>
      </div>
    );
  };

  const SalesScreen = () => {
    const [selectedMonth, setSelectedMonth] = useState('2025-11');
    const [selectedDate, setSelectedDate] = useState(null);

    const data = salesData[currentUser.id] || {};
    const months = ['2025-11', '2025-10'];

    // é¸æŠã•ã‚ŒãŸæœˆã®æ—¥æ•°ã‚’å–å¾—
    const [year, month] = selectedMonth.split('-').map(Number);
    const daysInMonth = new Date(year, month, 0).getDate();
    // æœˆæ›œæ—¥å§‹ã¾ã‚Šã«ã™ã‚‹ãŸã‚èª¿æ•´ (0=æ—¥æ›œæ—¥ãªã®ã§ã€æœˆæ›œå§‹ã¾ã‚Šã¯6ã€ç«æ›œã¯0ã€...ã€æ—¥æ›œã¯5)
    const firstDayOfMonth = new Date(year, month - 1, 1).getDay();
    const adjustedFirstDay = firstDayOfMonth === 0 ? 6 : firstDayOfMonth - 1;

    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”¨ã®æ—¥ä»˜é…åˆ—ã‚’ä½œæˆ
    const calendarDays = [];
    for (let i = 0; i < adjustedFirstDay; i++) {
      calendarDays.push(null);
    }
    for (let day = 1; day <= daysInMonth; day++) {
      calendarDays.push(day);
    }

    // ãã®æ—¥ã®å£²ä¸Šåˆè¨ˆã‚’è¨ˆç®—
    const getDaySales = (day) => {
      const dateKey = `${selectedMonth}-${String(day).padStart(2, '0')}`;
      const sales = data[dateKey];
      if (!sales) return 0;
      return sales.reduce((sum, sale) => sum + sale.amount, 0);
    };

    // é¸æŠã•ã‚ŒãŸæ—¥ä»˜ã®è©³ç´°ãƒ‡ãƒ¼ã‚¿
    const getSelectedDayData = () => {
      if (!selectedDate) return null;
      const dateKey = `${selectedMonth}-${String(selectedDate).padStart(2, '0')}`;
      return data[dateKey] || [];
    };

    // æœˆã®åˆè¨ˆå£²ä¸Š
    const monthlyTotal = Object.entries(data)
      .filter(([date]) => date.startsWith(selectedMonth))
      .reduce((sum, [, sales]) => sum + sales.reduce((s, sale) => s + sale.amount, 0), 0);

    const selectedDayData = getSelectedDayData();

    return (
      <div style={{ minHeight: '100vh', background: '#f9fafb' }}>
        <div style={{
          background: 'linear-gradient(to right, #ec4899, #a855f7)',
          padding: '16px',
          boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
        }}>
          <div style={{
            maxWidth: '1024px',
            margin: '0 auto',
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center'
          }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
              <button
                onClick={() => setScreen('lobby')}
                style={{
                  background: 'rgba(255,255,255,0.2)',
                  color: 'white',
                  padding: '8px',
                  borderRadius: '8px',
                  border: '1px solid rgba(255,255,255,0.3)',
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center'
                }}
              >
                <ArrowLeft size={20} />
              </button>
              <h1 style={{ fontSize: '20px', fontWeight: 'bold', color: 'white' }}>
                å ±é…¬ç¢ºèª
              </h1>
            </div>
          </div>
        </div>

        <div style={{ maxWidth: '1024px', margin: '0 auto', padding: '24px 16px' }}>
          <div style={{
            background: 'white',
            borderRadius: '12px',
            padding: '24px',
            marginBottom: '24px',
            boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
          }}>
            {/* æœˆé¸æŠã¨åˆè¨ˆ */}
            <div style={{ marginBottom: '24px', textAlign: 'center' }}>
              <select
                value={selectedMonth}
                onChange={(e) => {
                  setSelectedMonth(e.target.value);
                  setSelectedDate(null);
                }}
                style={{
                  padding: '12px 24px',
                  borderRadius: '8px',
                  border: '2px solid #ec4899',
                  fontSize: '18px',
                  fontWeight: 'bold',
                  marginBottom: '16px',
                  cursor: 'pointer'
                }}
              >
                {months.map(m => (
                  <option key={m} value={m}>{m.replace('-', 'å¹´')}æœˆ</option>
                ))}
              </select>
              <div style={{
                background: 'linear-gradient(135deg, #ec4899, #a855f7)',
                padding: '16px',
                borderRadius: '12px',
                color: 'white'
              }}>
                <p style={{ fontSize: '14px', marginBottom: '4px', opacity: 0.9 }}>å£²ä¸Šåˆè¨ˆ</p>
                <p style={{ fontSize: '32px', fontWeight: 'bold' }}>{monthlyTotal.toLocaleString()}å††</p>
              </div>
            </div>

            {/* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */}
            <div style={{ marginBottom: '24px' }}>
              <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(7, 1fr)',
                gap: '4px',
                marginBottom: '8px'
              }}>
                {['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'].map(day => (
                  <div key={day} style={{
                    textAlign: 'center',
                    padding: '8px',
                    fontWeight: 'bold',
                    color: '#6b7280',
                    fontSize: '14px'
                  }}>
                    {day}
                  </div>
                ))}
              </div>
              <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(7, 1fr)',
                gap: '4px'
              }}>
                {calendarDays.map((day, index) => {
                  if (day === null) {
                    return <div key={`empty-${index}`} />;
                  }
                  const sales = getDaySales(day);
                  const isSelected = selectedDate === day;
                  return (
                    <button
                      key={day}
                      onClick={() => setSelectedDate(day)}
                      style={{
                        padding: '12px 4px',
                        border: isSelected ? '2px solid #ec4899' : '1px solid #e5e7eb',
                        borderRadius: '8px',
                        background: isSelected ? '#fce7f3' : sales > 0 ? '#fef3f6' : 'white',
                        cursor: 'pointer',
                        textAlign: 'center',
                        transition: 'all 0.2s'
                      }}
                    >
                      <div style={{ fontSize: '16px', fontWeight: 'bold', color: '#1f2937', marginBottom: '4px' }}>
                        {day}
                      </div>
                      {sales > 0 && (
                        <div style={{ fontSize: '11px', color: '#3b82f6', fontWeight: '600' }}>
                          {sales.toLocaleString()}å††
                        </div>
                      )}
                    </button>
                  );
                })}
              </div>
            </div>

            {/* é¸æŠã•ã‚ŒãŸæ—¥ã®è©³ç´° */}
            {selectedDate && selectedDayData && selectedDayData.length > 0 && (
              <div style={{
                background: '#f9fafb',
                padding: '16px',
                borderRadius: '8px',
                border: '1px solid #e5e7eb'
              }}>
                <p style={{ fontSize: '16px', fontWeight: 'bold', color: '#1f2937', marginBottom: '12px' }}>
                  {selectedMonth.replace('-', 'å¹´')}æœˆ{selectedDate}æ—¥(é‡‘)
                </p>
                {selectedDayData.map((sale, idx) => (
                  <div key={idx} style={{
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    padding: '12px 0',
                    borderBottom: idx < selectedDayData.length - 1 ? '1px solid #e5e7eb' : 'none'
                  }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                      <div style={{
                        width: '32px',
                        height: '32px',
                        borderRadius: '50%',
                        background: 'linear-gradient(135deg, #fbbf24, #f59e0b)',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center'
                      }}>
                        <span style={{ color: 'white', fontSize: '14px', fontWeight: 'bold' }}>
                          {sale.clientName[0]}
                        </span>
                      </div>
                      <span style={{ fontSize: '14px', color: '#1f2937' }}>{sale.clientName}</span>
                    </div>
                    <span style={{ fontSize: '16px', fontWeight: 'bold', color: '#1f2937' }}>
                      {sale.amount.toLocaleString()}å††
                    </span>
                  </div>
                ))}
              </div>
            )}

            {selectedDate && (!selectedDayData || selectedDayData.length === 0) && (
              <div style={{
                background: '#f9fafb',
                padding: '24px',
                borderRadius: '8px',
                textAlign: 'center',
                color: '#6b7280'
              }}>
                ã“ã®æ—¥ã¯å£²ä¸ŠãŒã‚ã‚Šã¾ã›ã‚“
              </div>
            )}
          </div>
        </div>
      </div>
    );
  };

  const KarteScreen = () => {
    const conversation = conversations[currentChat];
    if (!conversation) return null;

    const otherParticipantId = conversation.participants.find(id => id !== currentUser.id);
    const otherParticipant = currentUser.type === 'client' 
      ? fortuneTellers[otherParticipantId]
      : users[otherParticipantId];

    const isClient = currentUser.type === 'client';

    // ãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹ã§ç®¡ç†
    const [localKarteData, setLocalKarteData] = useState(() => {
      return karteDataByConversation[currentChat] || {
        memo: '',
        name: '',
        furigana: '',
        gender: '',
        birthDate: '',
        birthTime: '',
        birthPlace: '',
        bloodType: '',
        maritalStatus: '',
        partner1: {
          name: '',
          furigana: '',
          gender: '',
          birthDate: '',
          birthTime: '',
          birthPlace: '',
          bloodType: '',
          maritalStatus: '',
          relationship: ''
        },
        partner2: {
          name: '',
          furigana: '',
          gender: '',
          birthDate: '',
          birthTime: '',
          birthPlace: '',
          bloodType: '',
          maritalStatus: '',
          relationship: ''
        }
      };
    });

    const handleSave = () => {
      // ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ã‚’æ›´æ–°
      setKarteDataByConversation(prev => ({
        ...prev,
        [currentChat]: localKarteData
      }));
      setSaveMessage('ä¿å­˜ã—ã¾ã—ãŸ');
      setTimeout(() => setSaveMessage(''), 3000);
    };

    const updateKarteField = (field, value) => {
      setLocalKarteData(prev => ({
        ...prev,
        [field]: value
      }));
    };

    const updatePartnerField = (partnerNum, field, value) => {
      setLocalKarteData(prev => ({
        ...prev,
        [`partner${partnerNum}`]: {
          ...prev[`partner${partnerNum}`],
          [field]: value
        }
      }));
    };

    return (
      <div style={{ minHeight: '100vh', background: '#fce7f3' }}>
        <div style={{
          background: 'linear-gradient(to right, #ec4899, #a855f7)',
          padding: '16px',
          boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
        }}>
          <div style={{
            maxWidth: '800px',
            margin: '0 auto',
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center'
          }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
              <button
                onClick={() => setScreen('chat')}
                style={{
                  background: 'rgba(255,255,255,0.2)',
                  color: 'white',
                  padding: '8px',
                  borderRadius: '8px',
                  border: '1px solid rgba(255,255,255,0.3)',
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center'
                }}
              >
                <ArrowLeft size={20} />
              </button>
              <h1 style={{ fontSize: '20px', fontWeight: 'bold', color: 'white' }}>
                ç›¸è«‡è€…ã‚«ãƒ«ãƒ†
              </h1>
            </div>
            <button
              onClick={handleSave}
              style={{
                background: 'white',
                color: '#ec4899',
                padding: '8px 16px',
                borderRadius: '8px',
                border: 'none',
                cursor: 'pointer',
                fontSize: '14px',
                fontWeight: 'bold'
              }}
            >
              ä¿å­˜
            </button>
          </div>
        </div>

        {saveMessage && (
          <div style={{
            maxWidth: '800px',
            margin: '16px auto 0',
            padding: '12px 16px',
            background: '#10b981',
            color: 'white',
            borderRadius: '8px',
            textAlign: 'center',
            fontWeight: 'bold',
            boxShadow: '0 4px 12px rgba(16, 185, 129, 0.3)'
          }}>
            {saveMessage}
          </div>
        )}

        <div style={{ maxWidth: '800px', margin: '0 auto', padding: '24px 16px' }}>
          {/* ãƒ¡ãƒ¢ï¼ˆå ã„å¸«ã®ã¿è¡¨ç¤ºãƒ»ç·¨é›†å¯ï¼‰ */}
          {!isClient && (
            <div style={{
              background: 'white',
              borderRadius: '12px',
              padding: '20px',
              marginBottom: '20px',
              boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
            }}>
              <h2 style={{ fontSize: '16px', fontWeight: 'bold', color: '#ec4899', marginBottom: '16px' }}>
                ãƒ¡ãƒ¢ï¼ˆå ã„å¸«ã®ã¿é–²è¦§å¯èƒ½ï¼‰
              </h2>
              <textarea
                value={localKarteData.memo}
                onChange={(e) => updateKarteField('memo', e.target.value)}
                placeholder="ãƒ¡ãƒ¢ã¯ã‚ãªãŸä»¥å¤–ã«è¦‹ã‚‰ã‚Œã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚"
                style={{
                  width: '100%',
                  minHeight: '240px',
                  maxHeight: '240px',
                  padding: '12px',
                  border: '1px solid #e5e7eb',
                  borderRadius: '8px',
                  fontSize: '14px',
                  resize: 'none',
                  overflowY: 'auto',
                  background: '#f3f4f6',
                  fontFamily: 'inherit'
                }}
                rows={10}
              />
            </div>
          )}

          {/* æœ¬äººæƒ…å ± */}
          <div style={{
            background: 'white',
            borderRadius: '12px',
            padding: '20px',
            marginBottom: '20px',
            boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
          }}>
            <h2 style={{ fontSize: '16px', fontWeight: 'bold', color: '#1f2937', marginBottom: '16px' }}>
              æœ¬äººæƒ…å ±
            </h2>

            <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
              <div>
                <input
                  type="text"
                  value={localKarteData.name}
                  onChange={(e) => updateKarteField('name', e.target.value)}
                  placeholder="ãŠåå‰"
                  disabled={!isClient}
                  style={{
                    width: '100%',
                    padding: '12px',
                    border: '1px solid #e5e7eb',
                    borderRadius: '8px',
                    fontSize: '14px',
                    background: isClient ? 'white' : '#f9fafb'
                  }}
                />
              </div>

              <div>
                <input
                  type="text"
                  value={localKarteData.furigana}
                  onChange={(e) => updateKarteField('furigana', e.target.value)}
                  placeholder="ãµã‚ŠãŒãª"
                  disabled={!isClient}
                  style={{
                    width: '100%',
                    padding: '12px',
                    border: '1px solid #e5e7eb',
                    borderRadius: '8px',
                    fontSize: '14px',
                    background: isClient ? 'white' : '#f9fafb'
                  }}
                />
              </div>

              <div>
                <select
                  value={localKarteData.gender}
                  onChange={(e) => updateKarteField('gender', e.target.value)}
                  disabled={!isClient}
                  style={{
                    width: '100%',
                    padding: '12px',
                    border: '1px solid #e5e7eb',
                    borderRadius: '8px',
                    fontSize: '14px',
                    background: isClient ? 'white' : '#f9fafb',
                    color: localKarteData.gender ? '#1f2937' : '#9ca3af'
                  }}
                >
                  <option value="">æ€§åˆ¥</option>
                  <option value="male">ç”·æ€§</option>
                  <option value="female">å¥³æ€§</option>
                  <option value="other">ãã®ä»–</option>
                </select>
              </div>

              <div>
                <input
                  type="date"
                  value={localKarteData.birthDate}
                  onChange={(e) => updateKarteField('birthDate', e.target.value)}
                  placeholder="ç”Ÿå¹´æœˆæ—¥"
                  disabled={!isClient}
                  style={{
                    width: '100%',
                    padding: '12px',
                    border: '1px solid #e5e7eb',
                    borderRadius: '8px',
                    fontSize: '14px',
                    background: isClient ? 'white' : '#f9fafb'
                  }}
                />
              </div>

              <div>
                <input
                  type="text"
                  value={localKarteData.birthTime}
                  onChange={(e) => updateKarteField('birthTime', e.target.value)}
                  placeholder="å‡ºç”Ÿæ™‚é–“ï¼ˆã‚ã‹ã‚‹æ–¹ï¼‰"
                  disabled={!isClient}
                  style={{
                    width: '100%',
                    padding: '12px',
                    border: '1px solid #e5e7eb',
                    borderRadius: '8px',
                    fontSize: '14px',
                    background: isClient ? 'white' : '#f9fafb'
                  }}
                />
              </div>

              <div>
                <input
                  type="text"
                  value={localKarteData.birthPlace}
                  onChange={(e) => updateKarteField('birthPlace', e.target.value)}
                  placeholder="å‡ºç”Ÿåœ°ï¼ˆå¸‚ç”ºæ‘ã¾ã§ï¼‰"
                  disabled={!isClient}
                  style={{
                    width: '100%',
                    padding: '12px',
                    border: '1px solid #e5e7eb',
                    borderRadius: '8px',
                    fontSize: '14px',
                    background: isClient ? 'white' : '#f9fafb'
                  }}
                />
              </div>

              <div>
                <select
                  value={localKarteData.bloodType}
                  onChange={(e) => updateKarteField('bloodType', e.target.value)}
                  disabled={!isClient}
                  style={{
                    width: '100%',
                    padding: '12px',
                    border: '1px solid #e5e7eb',
                    borderRadius: '8px',
                    fontSize: '14px',
                    background: isClient ? 'white' : '#f9fafb',
                    color: localKarteData.bloodType ? '#1f2937' : '#9ca3af'
                  }}
                >
                  <option value="">è¡€æ¶²å‹</option>
                  <option value="A">Aå‹</option>
                  <option value="B">Bå‹</option>
                  <option value="O">Oå‹</option>
                  <option value="AB">ABå‹</option>
                </select>
              </div>

              <div>
                <select
                  value={localKarteData.maritalStatus}
                  onChange={(e) => updateKarteField('maritalStatus', e.target.value)}
                  disabled={!isClient}
                  style={{
                    width: '100%',
                    padding: '12px',
                    border: '1px solid #e5e7eb',
                    borderRadius: '8px',
                    fontSize: '14px',
                    background: isClient ? 'white' : '#f9fafb',
                    color: localKarteData.maritalStatus ? '#1f2937' : '#9ca3af'
                  }}
                >
                  <option value="">å©šå§»çŠ¶æ…‹</option>
                  <option value="single">ç‹¬èº«</option>
                  <option value="married">æ—¢å©š</option>
                  <option value="divorced">é›¢å©š</option>
                  <option value="widowed">æ­»åˆ¥</option>
                </select>
              </div>
            </div>
          </div>

          {/* ç›¸æ‰‹æƒ…å ±1 */}
          <div style={{
            background: 'white',
            borderRadius: '12px',
            padding: '20px',
            marginBottom: '20px',
            boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
          }}>
            <h2 style={{ fontSize: '16px', fontWeight: 'bold', color: '#1f2937', marginBottom: '16px' }}>
              ç›¸æ‰‹æƒ…å ±1
            </h2>

            <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
              <input
                type="text"
                value={localKarteData.partner1.name}
                onChange={(e) => updatePartnerField(1, 'name', e.target.value)}
                placeholder="1ãŠåå‰"
                disabled={!isClient}
                style={{
                  width: '100%',
                  padding: '12px',
                  border: '1px solid #e5e7eb',
                  borderRadius: '8px',
                  fontSize: '14px',
                  background: isClient ? 'white' : '#f9fafb'
                }}
              />

              <input
                type="text"
                value={localKarteData.partner1.furigana}
                onChange={(e) => updatePartnerField(1, 'furigana', e.target.value)}
                placeholder="1ãµã‚ŠãŒãª"
                disabled={!isClient}
                style={{
                  width: '100%',
                  padding: '12px',
                  border: '1px solid #e5e7eb',
                  borderRadius: '8px',
                  fontSize: '14px',
                  background: isClient ? 'white' : '#f9fafb'
                }}
              />

              <select
                value={localKarteData.partner1.gender}
                onChange={(e) => updatePartnerField(1, 'gender', e.target.value)}
                disabled={!isClient}
                style={{
                  width: '100%',
                  padding: '12px',
                  border: '1px solid #e5e7eb',
                  borderRadius: '8px',
                  fontSize: '14px',
                  background: isClient ? 'white' : '#f9fafb',
                  color: localKarteData.partner1.gender ? '#1f2937' : '#9ca3af'
                }}
              >
                <option value="">1æ€§åˆ¥</option>
                <option value="male">ç”·æ€§</option>
                <option value="female">å¥³æ€§</option>
                <option value="other">ãã®ä»–</option>
              </select>

              <input
                type="date"
                value={localKarteData.partner1.birthDate}
                onChange={(e) => updatePartnerField(1, 'birthDate', e.target.value)}
                disabled={!isClient}
                style={{
                  width: '100%',
                  padding: '12px',
                  border: '1px solid #e5e7eb',
                  borderRadius: '8px',
                  fontSize: '14px',
                  background: isClient ? 'white' : '#f9fafb'
                }}
              />

              <input
                type="text"
                value={localKarteData.partner1.birthTime}
                onChange={(e) => updatePartnerField(1, 'birthTime', e.target.value)}
                placeholder="1å‡ºç”Ÿæ™‚é–“ï¼ˆã‚ã‹ã‚‹æ–¹ï¼‰"
                disabled={!isClient}
                style={{
                  width: '100%',
                  padding: '12px',
                  border: '1px solid #e5e7eb',
                  borderRadius: '8px',
                  fontSize: '14px',
                  background: isClient ? 'white' : '#f9fafb'
                }}
              />

              <input
                type="text"
                value={localKarteData.partner1.birthPlace}
                onChange={(e) => updatePartnerField(1, 'birthPlace', e.target.value)}
                placeholder="1å‡ºç”Ÿåœ°ï¼ˆå¸‚ç”ºæ‘ã¾ã§ï¼‰"
                disabled={!isClient}
                style={{
                  width: '100%',
                  padding: '12px',
                  border: '1px solid #e5e7eb',
                  borderRadius: '8px',
                  fontSize: '14px',
                  background: isClient ? 'white' : '#f9fafb'
                }}
              />

              <select
                value={localKarteData.partner1.bloodType}
                onChange={(e) => updatePartnerField(1, 'bloodType', e.target.value)}
                disabled={!isClient}
                style={{
                  width: '100%',
                  padding: '12px',
                  border: '1px solid #e5e7eb',
                  borderRadius: '8px',
                  fontSize: '14px',
                  background: isClient ? 'white' : '#f9fafb',
                  color: localKarteData.partner1.bloodType ? '#1f2937' : '#9ca3af'
                }}
              >
                <option value="">1è¡€æ¶²å‹</option>
                <option value="A">Aå‹</option>
                <option value="B">Bå‹</option>
                <option value="O">Oå‹</option>
                <option value="AB">ABå‹</option>
              </select>

              <select
                value={localKarteData.partner1.maritalStatus}
                onChange={(e) => updatePartnerField(1, 'maritalStatus', e.target.value)}
                disabled={!isClient}
                style={{
                  width: '100%',
                  padding: '12px',
                  border: '1px solid #e5e7eb',
                  borderRadius: '8px',
                  fontSize: '14px',
                  background: isClient ? 'white' : '#f9fafb',
                  color: localKarteData.partner1.maritalStatus ? '#1f2937' : '#9ca3af'
                }}
              >
                <option value="">1å©šå§»çŠ¶æ…‹</option>
                <option value="single">ç‹¬èº«</option>
                <option value="married">æ—¢å©š</option>
                <option value="divorced">é›¢å©š</option>
                <option value="widowed">æ­»åˆ¥</option>
              </select>

              <input
                type="text"
                value={localKarteData.partner1.relationship}
                onChange={(e) => updatePartnerField(1, 'relationship', e.target.value)}
                placeholder="1é–¢ä¿‚"
                maxLength={30}
                disabled={!isClient}
                style={{
                  width: '100%',
                  padding: '12px',
                  border: '1px solid #e5e7eb',
                  borderRadius: '8px',
                  fontSize: '14px',
                  background: isClient ? 'white' : '#f9fafb'
                }}
              />
            </div>
          </div>

          {/* ç›¸æ‰‹æƒ…å ±2 */}
          <div style={{
            background: 'white',
            borderRadius: '12px',
            padding: '20px',
            marginBottom: '20px',
            boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
          }}>
            <h2 style={{ fontSize: '16px', fontWeight: 'bold', color: '#1f2937', marginBottom: '16px' }}>
              ç›¸æ‰‹æƒ…å ±2
            </h2>

            <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
              <input
                type="text"
                value={localKarteData.partner2.name}
                onChange={(e) => updatePartnerField(2, 'name', e.target.value)}
                placeholder="2ãŠåå‰"
                disabled={!isClient}
                style={{
                  width: '100%',
                  padding: '12px',
                  border: '1px solid #e5e7eb',
                  borderRadius: '8px',
                  fontSize: '14px',
                  background: isClient ? 'white' : '#f9fafb'
                }}
              />

              <input
                type="text"
                value={localKarteData.partner2.furigana}
                onChange={(e) => updatePartnerField(2, 'furigana', e.target.value)}
                placeholder="2ãµã‚ŠãŒãª"
                disabled={!isClient}
                style={{
                  width: '100%',
                  padding: '12px',
                  border: '1px solid #e5e7eb',
                  borderRadius: '8px',
                  fontSize: '14px',
                  background: isClient ? 'white' : '#f9fafb'
                }}
              />

              <select
                value={localKarteData.partner2.gender}
                onChange={(e) => updatePartnerField(2, 'gender', e.target.value)}
                disabled={!isClient}
                style={{
                  width: '100%',
                  padding: '12px',
                  border: '1px solid #e5e7eb',
                  borderRadius: '8px',
                  fontSize: '14px',
                  background: isClient ? 'white' : '#f9fafb',
                  color: localKarteData.partner2.gender ? '#1f2937' : '#9ca3af'
                }}
              >
                <option value="">2æ€§åˆ¥</option>
                <option value="male">ç”·æ€§</option>
                <option value="female">å¥³æ€§</option>
                <option value="other">ãã®ä»–</option>
              </select>

              <input
                type="date"
                value={localKarteData.partner2.birthDate}
                onChange={(e) => updatePartnerField(2, 'birthDate', e.target.value)}
                disabled={!isClient}
                style={{
                  width: '100%',
                  padding: '12px',
                  border: '1px solid #e5e7eb',
                  borderRadius: '8px',
                  fontSize: '14px',
                  background: isClient ? 'white' : '#f9fafb'
                }}
              />

              <input
                type="text"
                value={localKarteData.partner2.birthTime}
                onChange={(e) => updatePartnerField(2, 'birthTime', e.target.value)}
                placeholder="2å‡ºç”Ÿæ™‚é–“ï¼ˆã‚ã‹ã‚‹æ–¹ï¼‰"
                disabled={!isClient}
                style={{
                  width: '100%',
                  padding: '12px',
                  border: '1px solid #e5e7eb',
                  borderRadius: '8px',
                  fontSize: '14px',
                  background: isClient ? 'white' : '#f9fafb'
                }}
              />

              <input
                type="text"
                value={localKarteData.partner2.birthPlace}
                onChange={(e) => updatePartnerField(2, 'birthPlace', e.target.value)}
                placeholder="2å‡ºç”Ÿåœ°ï¼ˆå¸‚ç”ºæ‘ã¾ã§ï¼‰"
                disabled={!isClient}
                style={{
                  width: '100%',
                  padding: '12px',
                  border: '1px solid #e5e7eb',
                  borderRadius: '8px',
                  fontSize: '14px',
                  background: isClient ? 'white' : '#f9fafb'
                }}
              />

              <select
                value={localKarteData.partner2.bloodType}
                onChange={(e) => updatePartnerField(2, 'bloodType', e.target.value)}
                disabled={!isClient}
                style={{
                  width: '100%',
                  padding: '12px',
                  border: '1px solid #e5e7eb',
                  borderRadius: '8px',
                  fontSize: '14px',
                  background: isClient ? 'white' : '#f9fafb',
                  color: localKarteData.partner2.bloodType ? '#1f2937' : '#9ca3af'
                }}
              >
                <option value="">2è¡€æ¶²å‹</option>
                <option value="A">Aå‹</option>
                <option value="B">Bå‹</option>
                <option value="O">Oå‹</option>
                <option value="AB">ABå‹</option>
              </select>

              <select
                value={localKarteData.partner2.maritalStatus}
                onChange={(e) => updatePartnerField(2, 'maritalStatus', e.target.value)}
                disabled={!isClient}
                style={{
                  width: '100%',
                  padding: '12px',
                  border: '1px solid #e5e7eb',
                  borderRadius: '8px',
                  fontSize: '14px',
                  background: isClient ? 'white' : '#f9fafb',
                  color: localKarteData.partner2.maritalStatus ? '#1f2937' : '#9ca3af'
                }}
              >
                <option value="">2å©šå§»çŠ¶æ…‹</option>
                <option value="single">ç‹¬èº«</option>
                <option value="married">æ—¢å©š</option>
                <option value="divorced">é›¢å©š</option>
                <option value="widowed">æ­»åˆ¥</option>
              </select>

              <input
                type="text"
                value={localKarteData.partner2.relationship}
                onChange={(e) => updatePartnerField(2, 'relationship', e.target.value)}
                placeholder="2é–¢ä¿‚"
                maxLength={30}
                disabled={!isClient}
                style={{
                  width: '100%',
                  padding: '12px',
                  border: '1px solid #e5e7eb',
                  borderRadius: '8px',
                  fontSize: '14px',
                  background: isClient ? 'white' : '#f9fafb'
                }}
              />
            </div>
          </div>
        </div>
      </div>
    );
  };

  const ChatScreen = () => {
    const [input, setInput] = useState('');
    const [charCount, setCharCount] = useState(0);
    const [showTemplates, setShowTemplates] = useState(false);
    const [isFreeMode, setIsFreeMode] = useState(true); // å ã„å¸«ã®ç„¡æ–™/æœ‰æ–™ãƒ¢ãƒ¼ãƒ‰
    const [reviewRating, setReviewRating] = useState(0); // ãƒ¬ãƒ“ãƒ¥ãƒ¼è©•ä¾¡
    const [reviewComment, setReviewComment] = useState(''); // ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆ

    const conversation = conversations[currentChat];
    if (!conversation) return null;

    const status = conversationStatus[currentChat] || 'not-started'; // ä¼šè©±ã®çŠ¶æ…‹ã‚’å–å¾—

    const otherParticipantId = conversation.participants.find(id => id !== currentUser.id);
    const partner = currentUser.type === 'client' 
      ? fortuneTellers[otherParticipantId]
      : users[otherParticipantId];

    useEffect(() => {
      messagesEndRef.current?.scrollIntoView({ behavior: 'auto' });
    }, [conversation.messages]);

    const handleInputChange = (e) => {
      const text = e.target.value;
      
      // ãƒã‚¤ãƒ³ãƒˆã«åŸºã¥ãæœ€å¤§æ–‡å­—æ•°ã‚’è¨ˆç®—
      let maxAllowedChars = maxChars; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯500æ–‡å­—
      
      const isTestBot = partner.isTestBot;
      
      if (!isTestBot) {
        if (currentUser.type === 'client') {
          // ãŠå®¢æ§˜ã®å ´åˆï¼šæ®‹ã‚Šãƒã‚¤ãƒ³ãƒˆ Ã· å ã„å¸«ã®å˜ä¾¡ = æœ€å¤§æ–‡å­—æ•°
          const fortuneTeller = partner; // partnerãŒå ã„å¸«
          const pointsPerChar = fortuneTeller.pointsPerChar;
          maxAllowedChars = Math.min(Math.floor(currentUser.points / pointsPerChar), maxChars);
        } else if (currentUser.type === 'fortune-teller' && !isFreeMode) {
          // å ã„å¸«ï¼ˆæœ‰æ–™ãƒ¢ãƒ¼ãƒ‰ï¼‰ã®å ´åˆï¼šãŠå®¢æ§˜ã®æ®‹ã‚Šãƒã‚¤ãƒ³ãƒˆ Ã· å˜ä¾¡ = æœ€å¤§æ–‡å­—æ•°
          const clientId = partner.id;
          const client = users[clientId];
          const pointsPerChar = fortuneTellers[currentUser.id].pointsPerChar;
          maxAllowedChars = Math.min(Math.floor(client.points / pointsPerChar), maxChars);
        }
      }
      
      // æœ€å¤§æ–‡å­—æ•°ã‚’è¶…ãˆãªã„ã‚ˆã†ã«åˆ¶é™
      if (text.length <= maxAllowedChars) {
        setInput(text);
        setCharCount(text.length);
      }
    };

    const handleSend = () => {
      // å…¥å®¤ã—ã¦ã„ãªã„ã€ã¾ãŸã¯é€€å®¤æ¸ˆã¿ã®å ´åˆã¯é€ä¿¡ä¸å¯
      if (status !== 'active') {
        alert('ãƒãƒ£ãƒƒãƒˆã«å…¥å®¤ã—ã¦ã‹ã‚‰é€ä¿¡ã—ã¦ãã ã•ã„');
        return;
      }
      
      if (!input.trim() || input.length > maxChars) return;

      const isTestBot = partner.isTestBot;
      
      // ãƒã‚¤ãƒ³ãƒˆè¨ˆç®—
      let pointCost = 0;
      if (!isTestBot) {
        if (currentUser.type === 'client') {
          // ãŠå®¢æ§˜ã®å ´åˆï¼šå ã„å¸«ã®pointsPerCharã§è¨ˆç®—
          const fortuneTeller = partner; // partnerãŒå ã„å¸«
          pointCost = input.length * fortuneTeller.pointsPerChar;
        } else if (currentUser.type === 'fortune-teller' && !isFreeMode) {
          // å ã„å¸«ã®å ´åˆï¼šæœ‰æ–™ãƒ¢ãƒ¼ãƒ‰ãªã‚‰ãŠå®¢æ§˜ã®ãƒã‚¤ãƒ³ãƒˆã‚’æ¶ˆè²»
          pointCost = input.length * fortuneTellers[currentUser.id].pointsPerChar;
        }
      }

      // ãŠå®¢æ§˜ã®å ´åˆã€ãƒã‚¤ãƒ³ãƒˆã‚’æ¶ˆè²»
      if (currentUser.type === 'client' && pointCost > 0) {
        if (currentUser.points < pointCost) {
          alert('ãƒã‚¤ãƒ³ãƒˆãŒä¸è¶³ã—ã¦ã„ã¾ã™');
          return;
        }

        // ãƒã‚¤ãƒ³ãƒˆã‚’æ¸›ç®—
        setUsers(prevUsers => ({
          ...prevUsers,
          [currentUser.id]: {
            ...prevUsers[currentUser.id],
            points: prevUsers[currentUser.id].points - pointCost
          }
        }));

        // currentUserã‚‚æ›´æ–°
        setCurrentUser(prev => ({
          ...prev,
          points: prev.points - pointCost
        }));

        // ä¼šè©±ã”ã¨ã®æ¶ˆè²»ãƒã‚¤ãƒ³ãƒˆã‚’è¨˜éŒ²
        setConversationPoints(prev => ({
          ...prev,
          [currentChat]: (prev[currentChat] || 0) + pointCost
        }));

        // å ã„å¸«ã®å ±é…¬ã‚’è¨˜éŒ²
        const fortuneTellerId = otherParticipantId; // å ã„å¸«ã®ID
        const fortuneTeller = partner; // partnerãŒå ã„å¸«
        const revenue = pointCost * fortuneTeller.currentCommissionRate;
        setFortuneTellers(prev => ({
          ...prev,
          [fortuneTellerId]: {
            ...prev[fortuneTellerId],
            currentMonthRevenue: prev[fortuneTellerId].currentMonthRevenue + revenue
          }
        }));
      }

      // å ã„å¸«ãŒæœ‰æ–™ãƒãƒ£ãƒƒãƒˆã‚’é€ä¿¡ã—ãŸå ´åˆã€ãŠå®¢æ§˜ã®ãƒã‚¤ãƒ³ãƒˆã‚’æ¸›ã‚‰ã™
      if (currentUser.type === 'fortune-teller' && !isFreeMode && pointCost > 0) {
        const clientId = partner.id;
        const client = users[clientId];
        
        if (client.points < pointCost) {
          alert(`ãŠå®¢æ§˜ã®ãƒã‚¤ãƒ³ãƒˆãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼ˆæ®‹ã‚Š${client.points}ptï¼‰`);
          return;
        }

        // ãŠå®¢æ§˜ã®ãƒã‚¤ãƒ³ãƒˆã‚’æ¸›ç®—
        setUsers(prevUsers => ({
          ...prevUsers,
          [clientId]: {
            ...prevUsers[clientId],
            points: prevUsers[clientId].points - pointCost
          }
        }));

        // ä¼šè©±ã”ã¨ã®æ¶ˆè²»ãƒã‚¤ãƒ³ãƒˆã‚’è¨˜éŒ²
        setConversationPoints(prev => ({
          ...prev,
          [currentChat]: (prev[currentChat] || 0) + pointCost
        }));

        // å ã„å¸«ã®å ±é…¬ã‚’è¨˜éŒ²
        const fortuneTellerId = currentUser.id;
        const fortuneTeller = fortuneTellers[fortuneTellerId];
        const revenue = pointCost * fortuneTeller.currentCommissionRate;
        setFortuneTellers(prev => ({
          ...prev,
          [fortuneTellerId]: {
            ...prev[fortuneTellerId],
            currentMonthRevenue: prev[fortuneTellerId].currentMonthRevenue + revenue
          }
        }));
      }

      const newMessage = {
        id: Date.now().toString(),
        senderId: currentUser.id,
        text: input.trim(),
        timestamp: new Date().toISOString(),
        pointCost: pointCost,
        isFree: currentUser.type === 'fortune-teller' ? isFreeMode : false // å ã„å¸«ã®å ´åˆã¯ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰
      };

      setConversations(prev => ({
        ...prev,
        [currentChat]: {
          ...prev[currentChat],
          messages: [...prev[currentChat].messages, newMessage]
        }
      }));

      // ãŠå®¢æ§˜ãŒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã£ãŸå ´åˆã€å ã„å¸«ã«é€šçŸ¥
      if (currentUser.type === 'client' && !isTestBot) {
        notifyFortuneTeller(partner.id, 'new_message', currentUser.name);
      }

      setInput('');
      setCharCount(0);
      setShowTemplates(false);

      if (isTestBot && currentUser.type === 'client') {
        setTimeout(() => {
          const botResponse = {
            id: (Date.now() + 1).toString(),
            senderId: partner.id,
            text: 'ãƒ†ã‚¹ãƒˆãƒœãƒƒãƒˆã®è‡ªå‹•è¿”ä¿¡ã§ã™ã€‚å®Ÿéš›ã®å ã„å¸«ã¨ã®ãƒãƒ£ãƒƒãƒˆã§ã¯ã€å ã„å¸«ã‹ã‚‰ã®è¿”ä¿¡ã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚',
            timestamp: new Date().toISOString()
          };

          setConversations(prev => ({
            ...prev,
            [currentChat]: {
              ...prev[currentChat],
              messages: [...prev[currentChat].messages, botResponse]
            }
          }));
        }, 1000);
      }
    };

    const handleTemplateSelect = (template) => {
      // å…¥å®¤ã—ã¦ã„ãªã„ã€ã¾ãŸã¯é€€å®¤æ¸ˆã¿ã®å ´åˆã¯é€ä¿¡ä¸å¯
      if (status !== 'active') {
        alert('ãƒãƒ£ãƒƒãƒˆã«å…¥å®¤ã—ã¦ã‹ã‚‰é€ä¿¡ã—ã¦ãã ã•ã„');
        return;
      }
      
      const newMessage = {
        id: Date.now().toString(),
        senderId: currentUser.id,
        text: template,
        timestamp: new Date().toISOString(),
        pointCost: 0,
        isFree: true // å®šå‹æ–‡ã¯å¸¸ã«ç„¡æ–™
      };

      setConversations({
        ...conversations,
        [currentChat]: {
          ...conversation,
          messages: [...conversation.messages, newMessage]
        }
      });

      setShowTemplates(false);
    };

    return (
      <div style={{
        height: '100vh',
        display: 'flex',
        flexDirection: 'column',
        background: '#f9fafb'
      }}>
        <div style={{
          background: 'linear-gradient(to right, #ec4899, #a855f7)',
          padding: '16px',
          boxShadow: '0 2px 8px rgba(0,0,0,0.1)',
          zIndex: 10
        }}>
          <div style={{
            maxWidth: '1024px',
            margin: '0 auto',
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center'
          }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
              <button
                onClick={() => setScreen('lobby')}
                style={{
                  background: 'rgba(255,255,255,0.2)',
                  color: 'white',
                  padding: '8px',
                  borderRadius: '8px',
                  border: '1px solid rgba(255,255,255,0.3)',
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center'
                }}
              >
                <ArrowLeft size={20} />
              </button>
              <div style={{
                width: '40px',
                height: '40px',
                borderRadius: '50%',
                background: currentUser.type === 'client' 
                  ? 'linear-gradient(135deg, #ec4899, #a855f7)' 
                  : 'linear-gradient(135deg, #fbbf24, #f59e0b)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center'
              }}>
                <span style={{ color: 'white', fontSize: '16px', fontWeight: 'bold' }}>
                  {partner.name[0]}
                </span>
              </div>
              <div>
                <h2 style={{ fontSize: '16px', fontWeight: 'bold', color: 'white' }}>
                  {partner.name}
                </h2>
                {currentUser.type === 'client' && partner.specialty && (
                  <p style={{ fontSize: '12px', color: 'rgba(255,255,255,0.9)' }}>
                    {partner.specialty}
                  </p>
                )}
                {currentUser.type === 'fortune-teller' && partner.points !== undefined && (
                  <p style={{ fontSize: '12px', color: 'rgba(255,255,255,0.9)' }}>
                    æ‰€æŒãƒã‚¤ãƒ³ãƒˆ: {users[partner.id]?.points || 0}pt
                  </p>
                )}
              </div>
            </div>
            <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
              {/* å…¥å®¤ãƒ»é€€å®¤ãƒœã‚¿ãƒ³ */}
              {/* ãŠå®¢æ§˜ã®å ´åˆã®ã¿å…¥å®¤ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º */}
              {currentUser.type === 'client' && (status === 'not-started' || status === 'ended') && (
                <button
                  onClick={() => handleEnterChat(currentChat)}
                  style={{
                    background: '#16a34a',
                    color: 'white',
                    padding: '8px 16px',
                    borderRadius: '8px',
                    border: 'none',
                    cursor: 'pointer',
                    fontSize: '14px',
                    fontWeight: '600'
                  }}
                >
                  å…¥å®¤ã™ã‚‹
                </button>
              )}
              {status === 'active' && (
                <button
                  onClick={() => handleExitChat(currentChat)}
                  style={{
                    background: '#dc2626',
                    color: 'white',
                    padding: '8px 16px',
                    borderRadius: '8px',
                    border: 'none',
                    cursor: 'pointer',
                    fontSize: '14px',
                    fontWeight: '600'
                  }}
                >
                  é€€å®¤ã™ã‚‹
                </button>
              )}
              <button
                onClick={() => setScreen('karte')}
                style={{
                  background: 'rgba(255,255,255,0.2)',
                  color: 'white',
                  padding: '8px 16px',
                  borderRadius: '8px',
                  border: '1px solid rgba(255,255,255,0.3)',
                  cursor: 'pointer',
                  fontSize: '14px',
                  fontWeight: '600',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '6px'
                }}
              >
                <FileText size={16} />
                ã‚«ãƒ«ãƒ†
              </button>
            </div>
          </div>
        </div>

        <div style={{
          flex: 1,
          overflowY: 'auto',
          padding: '16px',
          background: '#f9fafb',
          pointerEvents: 'auto'
        }}>
          {conversation.messages.map((msg) => {
            // ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆã¯ä¸­å¤®ã«è¡¨ç¤º
            if (msg.isSystem) {
              return (
                <div key={msg.id} style={{
                  display: 'flex',
                  justifyContent: 'center',
                  marginBottom: '16px'
                }}>
                  <div style={{
                    background: '#f3f4f6',
                    color: '#6b7280',
                    padding: '8px 16px',
                    borderRadius: '16px',
                    fontSize: '12px',
                    fontWeight: '500'
                  }}>
                    {msg.text}
                  </div>
                </div>
              );
            }
            
            const isMe = msg.senderId === currentUser.id;
            const isFreeMessage = msg.isFree; // ç„¡æ–™ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã©ã†ã‹
            
            // èƒŒæ™¯è‰²ã¨æ–‡å­—è‰²ã®æ±ºå®š
            let bgColor, textColor, border;
            if (isMe) {
              // è‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆãŠå®¢æ§˜ or å ã„å¸«ï¼‰
              if (isFreeMessage) {
                bgColor = 'white';
                textColor = '#1f2937';
                border = '1px solid #e5e7eb';
              } else {
                bgColor = '#ec4899';
                textColor = 'white';
                border = 'none';
              }
            } else {
              // ç›¸æ‰‹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
              if (isFreeMessage) {
                bgColor = 'white';
                textColor = '#1f2937';
                border = '1px solid #e5e7eb';
              } else {
                bgColor = '#ec4899';
                textColor = 'white';
                border = 'none';
              }
            }
            
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ†ã‚­ã‚¹ãƒˆï¼ˆç„¡æ–™ã®å ´åˆã¯ã€ç„¡æ–™ã€‘ã‚’è¿½åŠ ï¼‰
            const displayText = isFreeMessage ? `ã€ç„¡æ–™ã€‘${msg.text}` : msg.text;
            
            return (
              <div key={msg.id} style={{
                display: 'flex',
                justifyContent: isMe ? 'flex-end' : 'flex-start',
                marginBottom: '12px'
              }}>
                <div style={{
                  display: 'flex',
                  alignItems: 'start',
                  gap: '8px',
                  maxWidth: '70%'
                }}>
                  {!isMe && (
                    <div style={{
                      width: '40px',
                      height: '40px',
                      borderRadius: '50%',
                      background: 'linear-gradient(135deg, #ec4899, #a855f7)',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      flexShrink: 0
                    }}>
                      <span style={{ color: 'white', fontSize: '14px', fontWeight: 'bold' }}>
                        {partner.name[0]}
                      </span>
                    </div>
                  )}
                  <div>
                    <div style={{
                      padding: '12px 16px',
                      borderRadius: '16px',
                      background: bgColor,
                      color: textColor,
                      border: border,
                      borderBottomRightRadius: isMe ? '4px' : '16px',
                      borderBottomLeftRadius: isMe ? '16px' : '4px'
                    }}>
                      <p style={{ whiteSpace: 'pre-line', wordBreak: 'break-word' }}>{displayText}</p>
                    </div>
                    <div style={{
                      display: 'flex',
                      alignItems: 'center',
                      gap: '8px',
                      marginTop: '4px',
                      justifyContent: isMe ? 'flex-end' : 'flex-start'
                    }}>
                      <p style={{ fontSize: '12px', color: '#6b7280' }}>
                        {new Date(msg.timestamp).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' })}
                      </p>
                    </div>
                  </div>
                  {isMe && (
                    <div style={{
                      width: '40px',
                      height: '40px',
                      borderRadius: '50%',
                      background: 'linear-gradient(135deg, #fbbf24, #f59e0b)',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      flexShrink: 0
                    }}>
                      <span style={{ color: 'white', fontSize: '14px', fontWeight: 'bold' }}>
                        {currentUser.name[0]}
                      </span>
                    </div>
                  )}
                </div>
              </div>
            );
          })}
          <div ref={messagesEndRef} />
        </div>

        <div style={{
          padding: '16px',
          background: 'white',
          borderTop: '1px solid #e5e7eb',
          pointerEvents: 'auto'
        }}>
          <div style={{ maxWidth: '1024px', margin: '0 auto' }}>
            <div style={{ marginBottom: '12px', display: 'flex', gap: '8px', alignItems: 'center' }}>
              {currentUser.type === 'client' && (
                <>
                  <button
                    onClick={() => {
                      if (status === 'active') {
                        console.log('å®šå‹æ–‡ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯');
                        setShowTemplates(!showTemplates);
                      }
                    }}
                    disabled={status !== 'active'}
                    style={{
                      padding: '8px 16px',
                      background: status === 'active' ? '#16a34a' : '#d1d5db',
                      color: 'white',
                      borderRadius: '8px',
                      border: 'none',
                      fontWeight: '600',
                      cursor: status === 'active' ? 'pointer' : 'not-allowed',
                      pointerEvents: 'auto',
                      opacity: status === 'active' ? 1 : 0.5
                    }}
                  >
                    å®šå‹æ–‡ï¼ˆç„¡æ–™ï¼‰
                  </button>
                  <span style={{ fontSize: '14px', color: '#6b7280', fontWeight: '500' }}>
                    æ‰€æŒãƒã‚¤ãƒ³ãƒˆ: <span style={{ color: '#ec4899', fontWeight: 'bold' }}>{users[currentUser.id].points}pt</span>
                  </span>
                </>
              )}
              {currentUser.type === 'fortune-teller' && (
                <>
                  <button
                    onClick={() => status === 'active' && setIsFreeMode(true)}
                    disabled={status !== 'active'}
                    style={{
                      padding: '8px 16px',
                      background: status !== 'active' ? '#d1d5db' : (isFreeMode ? 'white' : '#6b7280'),
                      color: status !== 'active' ? '#9ca3af' : (isFreeMode ? '#1f2937' : 'white'),
                      borderRadius: '8px',
                      border: isFreeMode && status === 'active' ? '2px solid #1f2937' : 'none',
                      fontWeight: '600',
                      cursor: status === 'active' ? 'pointer' : 'not-allowed',
                      pointerEvents: 'auto',
                      opacity: status === 'active' ? 1 : 0.5
                    }}
                  >
                    ç„¡æ–™ãƒãƒ£ãƒƒãƒˆ
                  </button>
                  <button
                    onClick={() => status === 'active' && setIsFreeMode(false)}
                    disabled={status !== 'active'}
                    style={{
                      padding: '8px 16px',
                      background: status !== 'active' ? '#d1d5db' : (!isFreeMode ? '#ec4899' : '#6b7280'),
                      color: 'white',
                      borderRadius: '8px',
                      border: !isFreeMode && status === 'active' ? '2px solid #ec4899' : 'none',
                      fontWeight: '600',
                      cursor: status === 'active' ? 'pointer' : 'not-allowed',
                      pointerEvents: 'auto',
                      opacity: status === 'active' ? 1 : 0.5
                    }}
                  >
                    æœ‰æ–™ãƒãƒ£ãƒƒãƒˆ
                  </button>
                  <button
                    onClick={() => status === 'active' && setShowTemplates(!showTemplates)}
                    disabled={status !== 'active'}
                    style={{
                      padding: '8px 16px',
                      background: status === 'active' ? '#6b7280' : '#d1d5db',
                      color: 'white',
                      borderRadius: '8px',
                      border: 'none',
                      fontWeight: '600',
                      cursor: status === 'active' ? 'pointer' : 'not-allowed',
                      pointerEvents: 'auto',
                      opacity: status === 'active' ? 1 : 0.5
                    }}
                  >
                    å®šå‹æ–‡
                  </button>
                </>
              )}
            </div>

            {showTemplates && currentUser.type === 'client' && (
              <div style={{
                marginBottom: '12px',
                background: 'white',
                border: '1px solid #e5e7eb',
                borderRadius: '8px',
                padding: '12px',
                pointerEvents: 'auto'
              }}>
                {templates.client.map((template, index) => (
                  <button
                    key={index}
                    onClick={() => {
                      console.log('å®šå‹æ–‡é¸æŠ:', template);
                      handleTemplateSelect(template);
                    }}
                    style={{
                      width: '100%',
                      textAlign: 'left',
                      padding: '12px',
                      background: '#f3f4f6',
                      border: '1px solid #e5e7eb',
                      borderRadius: '4px',
                      marginBottom: '8px',
                      cursor: 'pointer',
                      fontSize: '14px',
                      color: '#1f2937',
                      pointerEvents: 'auto'
                    }}
                  >
                    {template}
                  </button>
                ))}
              </div>
            )}

            {showTemplates && currentUser.type === 'fortune-teller' && (
              <div style={{
                marginBottom: '12px',
                background: '#1f2937',
                border: '1px solid #374151',
                borderRadius: '8px',
                padding: '16px',
                pointerEvents: 'auto'
              }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                  <h4 style={{ fontSize: '14px', fontWeight: 'bold', color: 'white' }}>å®šå‹æ–‡ç·¨é›†</h4>
                  <button
                    onClick={() => {
                      setTempTemplates([...fortuneTellerTemplates]);
                      setEditingTemplates(true);
                    }}
                    style={{
                      padding: '6px 12px',
                      background: '#374151',
                      color: 'white',
                      borderRadius: '6px',
                      border: 'none',
                      cursor: 'pointer',
                      fontSize: '12px',
                      fontWeight: '600',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '4px'
                    }}
                  >
                    <Edit2 size={12} />
                    ç·¨é›†
                  </button>
                </div>
                {fortuneTellerTemplates.map((template, index) => (
                  <button
                    key={index}
                    onClick={() => handleTemplateSelect(template)}
                    style={{
                      width: '100%',
                      textAlign: 'left',
                      padding: '12px',
                      background: '#374151',
                      border: 'none',
                      borderRadius: '4px',
                      marginBottom: '8px',
                      cursor: 'pointer',
                      fontSize: '14px',
                      color: 'white',
                      pointerEvents: 'auto'
                    }}
                  >
                    {template}
                  </button>
                ))}
              </div>
            )}

            {editingTemplates && currentUser.type === 'fortune-teller' && (
              <div style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'rgba(0,0,0,0.5)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                zIndex: 1000,
                pointerEvents: 'auto'
              }} onClick={() => setEditingTemplates(false)}>
                <div style={{
                  background: 'white',
                  borderRadius: '12px',
                  padding: '24px',
                  width: '90%',
                  maxWidth: '600px',
                  maxHeight: '80vh',
                  overflowY: 'auto'
                }} onClick={(e) => e.stopPropagation()}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                    <h3 style={{ fontSize: '18px', fontWeight: 'bold' }}>å®šå‹æ–‡ã‚’ç·¨é›†</h3>
                    <button
                      onClick={() => setEditingTemplates(false)}
                      style={{
                        background: 'transparent',
                        border: 'none',
                        cursor: 'pointer',
                        padding: '4px'
                      }}
                    >
                      <X size={24} color="#6b7280" />
                    </button>
                  </div>

                  <div style={{ marginBottom: '24px' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                      <h4 style={{ fontSize: '16px', fontWeight: 'bold', color: '#1f2937' }}>å®šå‹æ–‡</h4>
                      <button
                        onClick={() => {
                          setTempTemplates([...tempTemplates, '']);
                        }}
                        style={{
                          padding: '6px 12px',
                          background: '#a855f7',
                          color: 'white',
                          borderRadius: '6px',
                          border: 'none',
                          cursor: 'pointer',
                          fontSize: '14px',
                          display: 'flex',
                          alignItems: 'center',
                          gap: '4px'
                        }}
                      >
                        <Plus size={14} />
                        å®šå‹æ–‡ã‚’è¿½åŠ 
                      </button>
                    </div>
                    {tempTemplates.map((template, index) => (
                      <div key={index} style={{ display: 'flex', gap: '8px', marginBottom: '8px' }}>
                        <input
                          type="text"
                          value={template}
                          onChange={(e) => {
                            const newTemplates = [...tempTemplates];
                            newTemplates[index] = e.target.value;
                            setTempTemplates(newTemplates);
                          }}
                          style={{
                            flex: 1,
                            padding: '8px 12px',
                            border: '1px solid #e5e7eb',
                            borderRadius: '6px',
                            fontSize: '14px'
                          }}
                          placeholder="å®šå‹æ–‡ã‚’å…¥åŠ›"
                        />
                        <button
                          onClick={() => {
                            const newTemplates = tempTemplates.filter((_, i) => i !== index);
                            setTempTemplates(newTemplates);
                          }}
                          style={{
                            padding: '8px',
                            background: '#ef4444',
                            color: 'white',
                            border: 'none',
                            borderRadius: '6px',
                            cursor: 'pointer'
                          }}
                        >
                          <X size={16} />
                        </button>
                      </div>
                    ))}
                  </div>

                  <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                    <button
                      onClick={() => setEditingTemplates(false)}
                      style={{
                        padding: '10px 20px',
                        background: '#e5e7eb',
                        color: '#374151',
                        borderRadius: '8px',
                        border: 'none',
                        cursor: 'pointer',
                        fontWeight: '600'
                      }}
                    >
                      ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                    <button
                      onClick={() => {
                        setFortuneTellerTemplates([...tempTemplates]);
                        setEditingTemplates(false);
                      }}
                      style={{
                        padding: '10px 20px',
                        background: 'linear-gradient(to right, #ec4899, #a855f7)',
                        color: 'white',
                        borderRadius: '8px',
                        border: 'none',
                        cursor: 'pointer',
                        fontWeight: '600'
                      }}
                    >
                      ä¿å­˜
                    </button>
                  </div>
                </div>
              </div>
            )}

            <div style={{ display: 'flex', alignItems: 'end', gap: '8px', pointerEvents: 'auto' }}>
              <div style={{ flex: 1, background: '#f3f4f6', borderRadius: '16px', border: '1px solid #e5e7eb' }}>
                <textarea
                  value={input}
                  onChange={(e) => {
                    console.log('å…¥åŠ›ä¸­:', e.target.value);
                    handleInputChange(e);
                  }}
                  onFocus={() => console.log('ãƒ•ã‚©ãƒ¼ã‚«ã‚¹')}
                  onClick={() => console.log('ã‚¯ãƒªãƒƒã‚¯')}
                  placeholder={status === 'active' ? "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." : "å…¥å®¤ã—ã¦ã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã§ãã¾ã™"}
                  maxLength={maxChars}
                  disabled={status !== 'active'}
                  style={{
                    width: '100%',
                    padding: '12px',
                    background: 'transparent',
                    border: 'none',
                    resize: 'none',
                    outline: 'none',
                    fontSize: '14px',
                    color: '#1f2937',
                    fontFamily: 'inherit',
                    pointerEvents: 'auto',
                    cursor: status === 'active' ? 'text' : 'not-allowed',
                    opacity: status === 'active' ? 1 : 0.5
                  }}
                  rows={3}
                />
                <div style={{
                  padding: '0 16px 8px',
                  display: 'flex',
                  justifyContent: 'space-between',
                  alignItems: 'center'
                }}>
                  <span style={{
                    fontSize: '12px',
                    color: (() => {
                      const isTestBot = partner.isTestBot;
                      let maxAllowedChars = maxChars;
                      
                      if (!isTestBot) {
                        if (currentUser.type === 'client') {
                          maxAllowedChars = Math.min(currentUser.points, maxChars);
                        } else if (currentUser.type === 'fortune-teller' && !isFreeMode) {
                          const clientId = partner.id;
                          const client = users[clientId];
                          const pointsPerChar = fortuneTellers[currentUser.id].pointsPerChar;
                          maxAllowedChars = Math.min(Math.floor(client.points / pointsPerChar), maxChars);
                        }
                      }
                      
                      return charCount > maxAllowedChars * 0.9 ? '#ef4444' : '#6b7280';
                    })()
                  }}>
                    {charCount} / {(() => {
                      const isTestBot = partner.isTestBot;
                      let maxAllowedChars = maxChars;
                      
                      if (!isTestBot) {
                        if (currentUser.type === 'client') {
                          maxAllowedChars = Math.min(currentUser.points, maxChars);
                        } else if (currentUser.type === 'fortune-teller' && !isFreeMode) {
                          const clientId = partner.id;
                          const client = users[clientId];
                          const pointsPerChar = fortuneTellers[currentUser.id].pointsPerChar;
                          maxAllowedChars = Math.min(Math.floor(client.points / pointsPerChar), maxChars);
                        }
                      }
                      
                      return maxAllowedChars;
                    })()}
                  </span>
                </div>
              </div>
              <button
                onClick={() => {
                  console.log('é€ä¿¡ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯');
                  handleSend();
                }}
                disabled={status !== 'active' || input.trim() === '' || input.length > maxChars}
                style={{
                  background: status !== 'active' || input.trim() === '' || input.length > maxChars
                    ? '#d1d5db'
                    : 'linear-gradient(to right, #ec4899, #a855f7)',
                  color: 'white',
                  padding: '16px',
                  borderRadius: '50%',
                  border: 'none',
                  boxShadow: '0 4px 12px rgba(236, 72, 153, 0.3)',
                  cursor: status !== 'active' || input.trim() === '' || input.length > maxChars ? 'not-allowed' : 'pointer',
                  pointerEvents: 'auto',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  opacity: status !== 'active' ? 0.5 : 1
                }}
              >
                <Send size={20} />
              </button>
            </div>
          </div>
        </div>

        {/* ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ•ã‚©ãƒ¼ãƒ  */}
        {showReviewForm && currentUser.type === 'client' && (
          <div 
            style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              background: 'rgba(0,0,0,0.7)',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              zIndex: 1000
            }}
            onClick={() => {
              // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
              setShowReviewForm(false);
              setReviewRating(0);
              setReviewComment('');
            }}
          >
            <div 
              style={{
                background: 'white',
                borderRadius: '16px',
                padding: '32px',
                width: '90%',
                maxWidth: '500px',
                maxHeight: '80vh',
                overflowY: 'auto'
              }}
              onClick={(e) => e.stopPropagation()}
            >
              <h2 style={{ fontSize: '20px', fontWeight: 'bold', color: '#1f2937', marginBottom: '8px' }}>
                ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›¸ã
              </h2>
              <p style={{ fontSize: '14px', color: '#6b7280', marginBottom: '24px' }}>
                {partner.name}å…ˆç”Ÿã®é‘‘å®šã¯ã„ã‹ãŒã§ã—ãŸã‹ï¼Ÿ
              </p>

              {/* æ˜Ÿè©•ä¾¡ */}
              <div style={{ marginBottom: '24px' }}>
                <label style={{ display: 'block', fontSize: '14px', fontWeight: 'bold', color: '#1f2937', marginBottom: '12px' }}>
                  è©•ä¾¡ {reviewRating > 0 && `(${reviewRating}ã¤æ˜Ÿ)`}
                </label>
                <div style={{ display: 'flex', gap: '8px', justifyContent: 'center' }}>
                  {[1, 2, 3, 4, 5].map((star) => (
                    <button
                      key={star}
                      onClick={() => setReviewRating(star)}
                      style={{
                        padding: '16px',
                        background: reviewRating >= star ? '#fef3c7' : 'white',
                        border: `2px solid ${reviewRating >= star ? '#fbbf24' : '#e5e7eb'}`,
                        borderRadius: '12px',
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        transition: 'all 0.2s',
                        flexDirection: 'column',
                        gap: '4px'
                      }}
                      onMouseOver={(e) => {
                        if (reviewRating < star) {
                          e.currentTarget.style.borderColor = '#fbbf24';
                          e.currentTarget.style.background = '#fffbeb';
                        }
                      }}
                      onMouseOut={(e) => {
                        if (reviewRating < star) {
                          e.currentTarget.style.borderColor = '#e5e7eb';
                          e.currentTarget.style.background = 'white';
                        }
                      }}
                    >
                      <Star size={28} fill={reviewRating >= star ? '#fbbf24' : 'none'} color="#fbbf24" />
                      <span style={{ fontSize: '12px', fontWeight: 'bold', color: '#1f2937' }}>
                        {star}
                      </span>
                    </button>
                  ))}
                </div>
              </div>

              {/* ã‚³ãƒ¡ãƒ³ãƒˆ */}
              <div style={{ marginBottom: '24px' }}>
                <label style={{ display: 'block', fontSize: '14px', fontWeight: 'bold', color: '#1f2937', marginBottom: '12px' }}>
                  ã‚³ãƒ¡ãƒ³ãƒˆ
                </label>
                <textarea
                  value={reviewComment}
                  onChange={(e) => setReviewComment(e.target.value)}
                  placeholder="é‘‘å®šã®æ„Ÿæƒ³ã‚’ãŠèã‹ã›ãã ã•ã„"
                  style={{
                    width: '100%',
                    minHeight: '120px',
                    padding: '12px',
                    border: '1px solid #e5e7eb',
                    borderRadius: '8px',
                    fontSize: '14px',
                    resize: 'vertical',
                    fontFamily: 'inherit'
                  }}
                />
              </div>

              {/* ãƒœã‚¿ãƒ³ */}
              <div style={{ display: 'flex', gap: '12px' }}>
                <button
                  onClick={() => {
                    setShowReviewForm(false);
                    setReviewRating(0);
                    setReviewComment('');
                  }}
                  style={{
                    flex: 1,
                    padding: '14px',
                    background: '#f3f4f6',
                    color: '#6b7280',
                    borderRadius: '8px',
                    border: 'none',
                    cursor: 'pointer',
                    fontWeight: '600',
                    fontSize: '14px'
                  }}
                >
                  ã‚¹ã‚­ãƒƒãƒ—
                </button>
                <button
                  onClick={() => {
                    if (reviewRating === 0) {
                      alert('è©•ä¾¡ã‚’é¸æŠã—ã¦ãã ã•ã„');
                      return;
                    }

                    // ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä¿å­˜
                    const newReview = {
                      id: Date.now().toString(),
                      clientName: currentUser.name,
                      rating: reviewRating,
                      comment: reviewComment.trim() || '', // ã‚³ãƒ¡ãƒ³ãƒˆã¯ç©ºã§ã‚‚OK
                      date: new Date().toISOString().split('T')[0],
                      visible: true
                    };

                    setFortuneTellers(prev => {
                      const ft = prev[partner.id];
                      const allReviews = [...(ft.reviews || []), newReview];
                      
                      // è©•ä¾¡ã®è¨ˆç®—
                      let newRating = ft.rating;
                      if (!ft.ratingFixed) {
                        // å›ºå®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€å…¨ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å¹³å‡ã‚’è¨ˆç®—
                        const visibleReviews = allReviews.filter(r => r.visible !== false);
                        if (visibleReviews.length > 0) {
                          const totalRating = visibleReviews.reduce((sum, r) => sum + r.rating, 0);
                          newRating = Math.round((totalRating / visibleReviews.length) * 10) / 10;
                        }
                      }
                      
                      // é‘‘å®šæ•°ã®è¨ˆç®—ï¼ˆbaseReviewCount + å®Ÿéš›ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°ï¼‰
                      const newReviewCount = (ft.baseReviewCount || 0) + allReviews.length;
                      
                      return {
                        ...prev,
                        [partner.id]: {
                          ...ft,
                          reviews: allReviews,
                          rating: newRating,
                          reviewCount: newReviewCount
                        }
                      };
                    });

                    // ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‰ã˜ã‚‹
                    setShowReviewForm(false);
                    setReviewRating(0);
                    setReviewComment('');
                    
                    alert('ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æŠ•ç¨¿ã—ã¾ã—ãŸï¼ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚');
                  }}
                  disabled={reviewRating === 0}
                  style={{
                    flex: 2,
                    padding: '14px',
                    background: reviewRating === 0
                      ? '#d1d5db' 
                      : 'linear-gradient(to right, #ec4899, #a855f7)',
                    color: 'white',
                    borderRadius: '8px',
                    border: 'none',
                    cursor: reviewRating === 0 ? 'not-allowed' : 'pointer',
                    fontWeight: 'bold',
                    fontSize: '14px'
                  }}
                >
                  ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æŠ•ç¨¿
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    );
  };

  const ProfileEditScreen = () => {
    const [profileMessage, setProfileMessage] = useState(fortuneTellers[currentUser.id]?.profileMessage || '');
    const currentReviews = fortuneTellers[currentUser.id]?.reviews || [];
    const [reviewVisibility, setReviewVisibility] = useState(() => {
      const visibility = {};
      currentReviews.forEach(review => {
        visibility[review.id] = review.visible !== false;
      });
      return visibility;
    });

    const handleSave = () => {
      // ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«å¯è¦–æ€§ã‚’åæ˜ 
      const updatedReviews = currentReviews.map(review => ({
        ...review,
        visible: reviewVisibility[review.id] !== false
      }));

      setFortuneTellers(prev => ({
        ...prev,
        [currentUser.id]: {
          ...prev[currentUser.id],
          profileMessage,
          reviews: updatedReviews
        }
      }));
      alert('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
      setScreen('lobby');
    };

    return (
      <div style={{ minHeight: '100vh', background: '#f9fafb' }}>
        <div style={{
          background: 'linear-gradient(to right, #ec4899, #a855f7)',
          padding: '16px',
          boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
        }}>
          <div style={{
            maxWidth: '800px',
            margin: '0 auto',
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center'
          }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
              <button
                onClick={() => setScreen('lobby')}
                style={{
                  background: 'rgba(255,255,255,0.2)',
                  color: 'white',
                  padding: '8px',
                  borderRadius: '8px',
                  border: '1px solid rgba(255,255,255,0.3)',
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center'
                }}
              >
                <ArrowLeft size={20} />
              </button>
              <h1 style={{ fontSize: '20px', fontWeight: 'bold', color: 'white' }}>
                ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†
              </h1>
            </div>
            <button
              onClick={handleSave}
              style={{
                background: 'white',
                color: '#ec4899',
                padding: '8px 16px',
                borderRadius: '8px',
                border: 'none',
                cursor: 'pointer',
                fontSize: '14px',
                fontWeight: 'bold'
              }}
            >
              ä¿å­˜
            </button>
          </div>
        </div>

        <div style={{ maxWidth: '800px', margin: '0 auto', padding: '24px 16px' }}>
          {/* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */}
          <div style={{
            background: 'white',
            borderRadius: '12px',
            padding: '20px',
            marginBottom: '20px',
            boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
          }}>
            <h2 style={{ fontSize: '16px', fontWeight: 'bold', color: '#1f2937', marginBottom: '16px' }}>
              ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            </h2>
            <textarea
              value={profileMessage}
              onChange={(e) => setProfileMessage(e.target.value)}
              maxLength={1000}
              placeholder="ãŠå®¢æ§˜ã«è¡¨ç¤ºã•ã‚Œã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
              style={{
                width: '100%',
                minHeight: '200px',
                padding: '12px',
                border: '1px solid #e5e7eb',
                borderRadius: '8px',
                fontSize: '14px',
                resize: 'vertical',
                fontFamily: 'inherit'
              }}
            />
            <div style={{ textAlign: 'right', fontSize: '12px', color: '#6b7280', marginTop: '4px' }}>
              {profileMessage.length} / 1000
            </div>
          </div>

          {/* ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºè¨­å®š */}
          <div style={{
            background: 'white',
            borderRadius: '12px',
            padding: '20px',
            marginBottom: '20px',
            boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
          }}>
            <h2 style={{ fontSize: '16px', fontWeight: 'bold', color: '#1f2937', marginBottom: '16px' }}>
              ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºè¨­å®š
            </h2>
            {currentReviews.length === 0 ? (
              <p style={{ fontSize: '14px', color: '#6b7280' }}>ã¾ã ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“</p>
            ) : (
              <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                {currentReviews.map((review) => (
                  <div key={review.id} style={{
                    padding: '16px',
                    background: '#f9fafb',
                    borderRadius: '8px',
                    border: '1px solid #e5e7eb'
                  }}>
                    <div style={{ display: 'flex', alignItems: 'start', gap: '12px' }}>
                      <input
                        type="checkbox"
                        checked={reviewVisibility[review.id] !== false}
                        onChange={(e) => setReviewVisibility(prev => ({
                          ...prev,
                          [review.id]: e.target.checked
                        }))}
                        style={{
                          width: '18px',
                          height: '18px',
                          cursor: 'pointer',
                          marginTop: '2px',
                          flexShrink: 0
                        }}
                      />
                      <div style={{ flex: 1 }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}>
                          <span style={{ fontSize: '14px', fontWeight: 'bold', color: '#1f2937' }}>
                            {review.clientName}
                          </span>
                          <div style={{ display: 'flex', alignItems: 'center' }}>
                            {[...Array(5)].map((_, i) => (
                              <Star 
                                key={i} 
                                size={14} 
                                fill={i < review.rating ? '#fbbf24' : 'none'} 
                                color="#fbbf24" 
                              />
                            ))}
                          </div>
                          <span style={{ fontSize: '12px', color: '#6b7280' }}>
                            {review.date}
                          </span>
                        </div>
                        <p style={{ fontSize: '14px', color: '#6b7280', lineHeight: '1.5' }}>
                          {review.comment}
                        </p>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
            <p style={{ fontSize: '12px', color: '#6b7280', marginTop: '12px' }}>
              â€»ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã—ãŸãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã«è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ï¼ˆæ˜Ÿè©•ä¾¡ã«ã¯åæ˜ ã•ã‚Œã¾ã™ï¼‰
            </p>
          </div>
        </div>
      </div>
    );
  };

  const FortuneProfileScreen = () => {
    if (!selectedFortuneTellerId) {
      // selectedFortuneTellerIdãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚‹
      setScreen('lobby');
      return null;
    }

    const fortuneTellerId = selectedFortuneTellerId;
    const fortuneTeller = fortuneTellers[fortuneTellerId];

    if (!fortuneTeller) {
      // å ã„å¸«ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã‚‚ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚‹
      setScreen('lobby');
      return null;
    }

    // è¡¨ç¤ºå¯èƒ½ãªãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    const visibleReviews = (fortuneTeller.reviews || []).filter(review => review.visible !== false);

    const handleStartChat = () => {
      const conversationId = `${currentUser.id}-${fortuneTellerId}`;
      const conversation = conversations[conversationId];
      
      if (!conversation) {
        setConversations({
          ...conversations,
          [conversationId]: {
            id: conversationId,
            participants: [currentUser.id, fortuneTellerId],
            messages: [],
            createdAt: new Date().toISOString()
          }
        });
        setConversationStatus(prev => ({
          ...prev,
          [conversationId]: 'not-started'
        }));
      }
      setCurrentChat(conversationId);
      setScreen('chat');
    };

    return (
      <div style={{ minHeight: '100vh', background: '#f9fafb' }}>
        {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
        <div style={{
          background: 'linear-gradient(to right, #ec4899, #a855f7)',
          padding: '16px',
          boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
        }}>
          <div style={{
            maxWidth: '800px',
            margin: '0 auto',
            display: 'flex',
            alignItems: 'center',
            gap: '12px'
          }}>
            <button
              onClick={() => setScreen('lobby')}
              style={{
                background: 'rgba(255,255,255,0.2)',
                color: 'white',
                padding: '8px',
                borderRadius: '8px',
                border: '1px solid rgba(255,255,255,0.3)',
                cursor: 'pointer',
                display: 'flex',
                alignItems: 'center'
              }}
            >
              <ArrowLeft size={20} />
            </button>
            <h1 style={{ fontSize: '20px', fontWeight: 'bold', color: 'white' }}>
              å ã„å¸«ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
            </h1>
          </div>
        </div>

        <div style={{ maxWidth: '800px', margin: '0 auto', padding: '24px 16px' }}>
          {/* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚«ãƒ¼ãƒ‰ */}
          <div style={{
            background: 'white',
            borderRadius: '16px',
            overflow: 'hidden',
            boxShadow: '0 2px 8px rgba(0,0,0,0.1)',
            marginBottom: '20px'
          }}>
            {/* ãƒ˜ãƒƒãƒ€ãƒ¼ç”»åƒ */}
            <div style={{
              height: '160px',
              background: 'linear-gradient(135deg, #ec4899, #a855f7)',
              position: 'relative'
            }}>
              <div style={{
                position: 'absolute',
                bottom: '-50px',
                left: '24px',
                width: '100px',
                height: '100px',
                borderRadius: '50%',
                background: 'linear-gradient(135deg, #a855f7, #ec4899)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                border: '5px solid white',
                boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
              }}>
                <span style={{ color: 'white', fontSize: '36px', fontWeight: 'bold' }}>
                  {fortuneTeller.name[0]}
                </span>
              </div>
            </div>

            <div style={{ padding: '24px', paddingTop: '64px' }}>
              {/* åå‰ã¨è©•ä¾¡ */}
              <div style={{ marginBottom: '16px' }}>
                <h2 style={{ fontSize: '24px', fontWeight: 'bold', color: '#1f2937', marginBottom: '8px' }}>
                  {fortuneTeller.name}
                </h2>
                <p style={{ fontSize: '14px', color: '#6b7280', marginBottom: '12px' }}>
                  {fortuneTeller.specialty}
                </p>
                <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                    <Star size={20} fill="#fbbf24" color="#fbbf24" />
                    <span style={{ fontSize: '18px', fontWeight: 'bold', color: '#1f2937' }}>
                      {fortuneTeller.rating.toFixed(1)}
                    </span>
                  </div>
                  <span style={{ fontSize: '14px', color: '#6b7280' }}>
                    é‘‘å®šæ•° {fortuneTeller.reviewCount}ä»¶
                  </span>
                  <span style={{ 
                    fontSize: '14px', 
                    color: '#ec4899',
                    fontWeight: 'bold',
                    background: '#fce7f3',
                    padding: '4px 12px',
                    borderRadius: '12px'
                  }}>
                    {fortuneTeller.pointsPerChar}pt / 1æ–‡å­—
                  </span>
                </div>
              </div>

              {/* ã‚¿ã‚° */}
              {fortuneTeller.tags && fortuneTeller.tags.length > 0 && (
                <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap', marginBottom: '16px' }}>
                  {fortuneTeller.tags.map((tag, index) => (
                    <span key={index} style={{
                      background: '#f3f4f6',
                      color: '#6b7280',
                      padding: '4px 12px',
                      borderRadius: '12px',
                      fontSize: '12px',
                      fontWeight: '500'
                    }}>
                      {tag}
                    </span>
                  ))}
                </div>
              )}

              {/* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */}
              {fortuneTeller.profileMessage && (
                <div style={{
                  background: '#f9fafb',
                  padding: '16px',
                  borderRadius: '8px',
                  marginBottom: '20px'
                }}>
                  <h3 style={{ fontSize: '14px', fontWeight: 'bold', color: '#1f2937', marginBottom: '12px' }}>
                    ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                  </h3>
                  <p style={{ 
                    fontSize: '14px', 
                    color: '#374151', 
                    lineHeight: '1.8',
                    whiteSpace: 'pre-wrap'
                  }}>
                    {fortuneTeller.profileMessage}
                  </p>
                </div>
              )}

              {/* ãƒãƒ£ãƒƒãƒˆé–‹å§‹ãƒœã‚¿ãƒ³ */}
              <button
                onClick={handleStartChat}
                style={{
                  width: '100%',
                  background: 'linear-gradient(to right, #ec4899, #a855f7)',
                  color: 'white',
                  padding: '16px',
                  borderRadius: '8px',
                  border: 'none',
                  cursor: 'pointer',
                  fontSize: '16px',
                  fontWeight: 'bold',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  gap: '8px'
                }}
              >
                <Mail size={20} />
                ãƒãƒ£ãƒƒãƒˆã‚’å§‹ã‚ã‚‹
              </button>
            </div>
          </div>

          {/* ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸€è¦§ */}
          {visibleReviews.length > 0 && (
            <div style={{
              background: 'white',
              borderRadius: '16px',
              padding: '24px',
              boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
            }}>
              <h3 style={{ fontSize: '18px', fontWeight: 'bold', color: '#1f2937', marginBottom: '20px' }}>
                æ„Ÿè¬ã®å£°
              </h3>
              <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                {visibleReviews.map((review) => (
                  <div key={review.id} style={{
                    padding: '16px',
                    background: '#f9fafb',
                    borderRadius: '8px',
                    border: '1px solid #e5e7eb'
                  }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '8px' }}>
                      <span style={{ fontSize: '14px', fontWeight: 'bold', color: '#1f2937' }}>
                        {review.clientName}
                      </span>
                      <div style={{ display: 'flex', alignItems: 'center' }}>
                        {[...Array(5)].map((_, i) => (
                          <Star 
                            key={i} 
                            size={14} 
                            fill={i < review.rating ? '#fbbf24' : 'none'} 
                            color="#fbbf24" 
                          />
                        ))}
                      </div>
                      <span style={{ fontSize: '12px', color: '#6b7280' }}>
                        {review.date}
                      </span>
                    </div>
                    <p style={{ fontSize: '14px', color: '#6b7280', lineHeight: '1.6' }}>
                      {review.comment}
                    </p>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      </div>
    );
  };

  if (!currentUser && screen === 'login') return <LoginScreen />;
  if (screen === 'register') return <RegisterScreen />;
  if (screen === 'purchase') return <PurchaseScreen />;
  if (screen === 'admin') return <AdminScreen />;
  if (screen === 'lobby') return <LobbyScreen />;
  if (screen === 'fortune-profile') return <FortuneProfileScreen />;
  if (screen === 'profile-edit') return <ProfileEditScreen />;
  if (screen === 'revenue') return <RevenueScreen />;
  if (screen === 'karte') return <KarteScreen />;
  if (screen === 'chat') return <ChatScreen />;


  // å ±é…¬ç¢ºèªç”»é¢
  function RevenueScreen() {
    const [selectedMonth, setSelectedMonth] = useState('2025-11');
    const [selectedDate, setSelectedDate] = useState(null);
    
    const ft = fortuneTellers[currentUser.id];
    const currentRate = ft.currentCommissionRate;
    const nextRate = calculateCommissionRate(ft.currentMonthRevenue);
    const nextTierAmount = calculateNextTierAmount(ft.currentMonthRevenue);
    const isMaxTier = nextTierAmount === 0;

    const data = salesData[currentUser.id] || {};
    const months = ['2025-11', '2025-10'];

    // é¸æŠã•ã‚ŒãŸæœˆã®æ—¥æ•°ã‚’å–å¾—
    const [year, month] = selectedMonth.split('-').map(Number);
    const daysInMonth = new Date(year, month, 0).getDate();
    const firstDayOfMonth = new Date(year, month - 1, 1).getDay();
    const adjustedFirstDay = firstDayOfMonth === 0 ? 6 : firstDayOfMonth - 1;

    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”¨ã®æ—¥ä»˜é…åˆ—ã‚’ä½œæˆ
    const calendarDays = [];
    for (let i = 0; i < adjustedFirstDay; i++) {
      calendarDays.push(null);
    }
    for (let day = 1; day <= daysInMonth; day++) {
      calendarDays.push(day);
    }

    // ãã®æ—¥ã®å£²ä¸Šåˆè¨ˆã‚’è¨ˆç®—
    const getDaySales = (day) => {
      const dateKey = `${selectedMonth}-${String(day).padStart(2, '0')}`;
      const sales = data[dateKey];
      if (!sales) return 0;
      return sales.reduce((sum, sale) => sum + sale.amount, 0);
    };

    // é¸æŠã•ã‚ŒãŸæ—¥ä»˜ã®è©³ç´°ãƒ‡ãƒ¼ã‚¿
    const getSelectedDayData = () => {
      if (!selectedDate) return null;
      const dateKey = `${selectedMonth}-${String(selectedDate).padStart(2, '0')}`;
      return data[dateKey] || [];
    };

    const selectedDayData = getSelectedDayData();

    return (
      <div style={{ minHeight: '100vh', background: '#f9fafb' }}>
        {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
        <div style={{
          background: 'linear-gradient(to right, #ec4899, #a855f7)',
          padding: '16px',
          boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
        }}>
          <div style={{
            maxWidth: '1024px',
            margin: '0 auto',
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center'
          }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
              <button
                onClick={() => setScreen('lobby')}
                style={{
                  background: 'rgba(255,255,255,0.2)',
                  color: 'white',
                  padding: '8px',
                  borderRadius: '8px',
                  border: '1px solid rgba(255,255,255,0.3)',
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center'
                }}
              >
                <ArrowLeft size={20} />
              </button>
              <h1 style={{ fontSize: '20px', fontWeight: 'bold', color: 'white' }}>
                å ±é…¬ç¢ºèª
              </h1>
            </div>
          </div>
        </div>

        <div style={{ maxWidth: '1024px', margin: '0 auto', padding: '24px 16px' }}>
          {/* æœˆé¸æŠã¨ä»Šæœˆã®å ±é…¬ */}
          <div style={{
            background: 'white',
            borderRadius: '12px',
            padding: '24px',
            marginBottom: '24px',
            boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
          }}>
            <div style={{ marginBottom: '24px', textAlign: 'center' }}>
              <select
                value={selectedMonth}
                onChange={(e) => {
                  setSelectedMonth(e.target.value);
                  setSelectedDate(null);
                }}
                style={{
                  padding: '12px 24px',
                  borderRadius: '8px',
                  border: '2px solid #ec4899',
                  fontSize: '18px',
                  fontWeight: 'bold',
                  marginBottom: '16px',
                  cursor: 'pointer'
                }}
              >
                {months.map(m => (
                  <option key={m} value={m}>{m.replace('-', 'å¹´')}æœˆ</option>
                ))}
              </select>
              <div style={{
                background: 'linear-gradient(135deg, #ec4899, #a855f7)',
                padding: '16px',
                borderRadius: '12px',
                color: 'white',
                marginBottom: '16px'
              }}>
                <p style={{ fontSize: '14px', marginBottom: '4px', opacity: 0.9 }}>ä»Šæœˆã®å ±é…¬</p>
                <p style={{ fontSize: '32px', fontWeight: 'bold', marginBottom: '8px' }}>Â¥{Math.floor(ft.currentMonthRevenue).toLocaleString()}</p>
                <div style={{ 
                  display: 'flex', 
                  justifyContent: 'center', 
                  alignItems: 'center', 
                  gap: '8px',
                  padding: '8px',
                  background: 'rgba(255,255,255,0.2)',
                  borderRadius: '8px'
                }}>
                  <span style={{ fontSize: '14px', opacity: 0.9 }}>ç¾åœ¨ã®å ±é…¬ç‡</span>
                  <span style={{ fontSize: '18px', fontWeight: 'bold' }}>
                    {(currentRate * 100).toFixed(0)}%
                  </span>
                </div>
              </div>
            </div>

            {/* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */}
            <div style={{ marginBottom: '24px' }}>
              <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(7, 1fr)',
                gap: '4px',
                marginBottom: '8px'
              }}>
                {['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'].map(day => (
                  <div key={day} style={{
                    textAlign: 'center',
                    padding: '8px',
                    fontWeight: 'bold',
                    color: '#6b7280',
                    fontSize: '14px'
                  }}>
                    {day}
                  </div>
                ))}
              </div>
              <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(7, 1fr)',
                gap: '4px'
              }}>
                {calendarDays.map((day, index) => {
                  if (day === null) {
                    return <div key={`empty-${index}`} />;
                  }
                  const sales = getDaySales(day);
                  const isSelected = selectedDate === day;
                  return (
                    <button
                      key={day}
                      onClick={() => setSelectedDate(day)}
                      style={{
                        padding: '12px 4px',
                        border: isSelected ? '2px solid #ec4899' : '1px solid #e5e7eb',
                        borderRadius: '8px',
                        background: isSelected ? '#fce7f3' : sales > 0 ? '#fef3f6' : 'white',
                        cursor: 'pointer',
                        textAlign: 'center',
                        transition: 'all 0.2s'
                      }}
                    >
                      <div style={{ fontSize: '16px', fontWeight: 'bold', color: '#1f2937', marginBottom: '4px' }}>
                        {day}
                      </div>
                      {sales > 0 && (
                        <div style={{ fontSize: '11px', color: '#ec4899', fontWeight: '600' }}>
                          {sales.toLocaleString()}å††
                        </div>
                      )}
                    </button>
                  );
                })}
              </div>
            </div>

            {/* é¸æŠã•ã‚ŒãŸæ—¥ã®è©³ç´° */}
            {selectedDate && selectedDayData && selectedDayData.length > 0 && (
              <div style={{
                background: '#f9fafb',
                padding: '16px',
                borderRadius: '8px',
                border: '1px solid #e5e7eb'
              }}>
                <p style={{ fontSize: '16px', fontWeight: 'bold', color: '#1f2937', marginBottom: '12px' }}>
                  {selectedMonth.replace('-', 'å¹´')}æœˆ{selectedDate}æ—¥
                </p>
                {selectedDayData.map((sale, idx) => (
                  <div key={idx} style={{
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                    padding: '12px 0',
                    borderBottom: idx < selectedDayData.length - 1 ? '1px solid #e5e7eb' : 'none'
                  }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                      <div style={{
                        width: '32px',
                        height: '32px',
                        borderRadius: '50%',
                        background: 'linear-gradient(135deg, #ec4899, #a855f7)',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center'
                      }}>
                        <span style={{ color: 'white', fontSize: '14px', fontWeight: 'bold' }}>
                          {sale.clientName[0]}
                        </span>
                      </div>
                      <span style={{ fontSize: '14px', color: '#1f2937' }}>{sale.clientName}</span>
                    </div>
                    <span style={{ fontSize: '16px', fontWeight: 'bold', color: '#1f2937' }}>
                      {sale.amount.toLocaleString()}å††
                    </span>
                  </div>
                ))}
              </div>
            )}

            {selectedDate && (!selectedDayData || selectedDayData.length === 0) && (
              <div style={{
                background: '#f9fafb',
                padding: '24px',
                borderRadius: '8px',
                textAlign: 'center',
                color: '#6b7280'
              }}>
                ã“ã®æ—¥ã¯å£²ä¸ŠãŒã‚ã‚Šã¾ã›ã‚“
              </div>
            )}
          </div>

          {/* æ¥æœˆã®å ±é…¬ç‡ã‚«ãƒ¼ãƒ‰ */}
          <div style={{
            background: 'white',
            borderRadius: '12px',
            padding: '24px',
            marginBottom: '16px',
            boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
          }}>
            <h2 style={{ fontSize: '16px', fontWeight: 'bold', color: '#6b7280', marginBottom: '12px' }}>
              æ¥æœˆã®å ±é…¬ç‡
            </h2>
            <div style={{
              padding: '16px',
              background: nextRate > currentRate ? '#d1fae5' : nextRate < currentRate ? '#fee2e2' : '#f3f4f6',
              borderRadius: '8px',
              marginBottom: '12px'
            }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '8px' }}>
                {nextRate > currentRate ? (
                  <TrendingUp size={24} color="#10b981" />
                ) : nextRate < currentRate ? (
                  <TrendingUp size={24} color="#ef4444" style={{ transform: 'rotate(180deg)' }} />
                ) : (
                  <span style={{ fontSize: '24px' }}>â†’</span>
                )}
                <span style={{ fontSize: '28px', fontWeight: 'bold', color: '#1f2937' }}>
                  {(nextRate * 100).toFixed(0)}%
                </span>
              </div>
              {(nextRate !== currentRate) && (
                <p style={{
                  fontSize: '14px',
                  color: nextRate > currentRate ? '#059669' : '#dc2626',
                  fontWeight: '600'
                }}>
                  {nextRate > currentRate ? 'ğŸ‰ æ¥æœˆã®å ±é…¬ç‡ãŒã‚¢ãƒƒãƒ—ã—ã¾ã™ï¼' : 'âš ï¸ æ¥æœˆã®å ±é…¬ç‡ãŒä¸‹ãŒã‚Šã¾ã™'}
                </p>
              )}
            </div>

            {!isMaxTier && (
              <div style={{
                padding: '12px',
                background: '#fef3c7',
                borderRadius: '8px',
                border: '1px solid #fbbf24'
              }}>
                <p style={{ fontSize: '13px', color: '#92400e', marginBottom: '4px' }}>
                  æ¬¡ã®å ±é…¬ç‡ã‚¢ãƒƒãƒ—ã¾ã§
                </p>
                <p style={{ fontSize: '18px', fontWeight: 'bold', color: '#92400e' }}>
                  ã‚ã¨ Â¥{nextTierAmount.toLocaleString()}
                </p>
              </div>
            )}
            {isMaxTier && (
              <div style={{
                padding: '12px',
                background: '#d1fae5',
                borderRadius: '8px',
                border: '1px solid #10b981'
              }}>
                <p style={{ fontSize: '14px', color: '#059669', fontWeight: '600' }}>
                  ğŸ‰ æœ€å¤§å ±é…¬ç‡ã«åˆ°é”ã—ã¾ã—ãŸï¼
                </p>
              </div>
            )}
          </div>

          {/* å ±é…¬ç‡ã®èª¬æ˜ */}
          <div style={{
            background: 'white',
            borderRadius: '12px',
            padding: '24px',
            marginBottom: '16px',
            boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
          }}>
            <h2 style={{ fontSize: '16px', fontWeight: 'bold', color: '#1f2937', marginBottom: '16px' }}>
              å ±é…¬ã‚·ã‚¹ãƒ†ãƒ ã«ã¤ã„ã¦
            </h2>
            <div style={{
              padding: '16px',
              background: '#f9fafb',
              borderRadius: '8px',
              marginBottom: '12px'
            }}>
              <p style={{ fontSize: '13px', color: '#6b7280', lineHeight: '1.8', marginBottom: '12px' }}>
                å ±é…¬ç‡ã¯æ¯æœˆã€å‰æœˆã®å ±é…¬é¡ã«ã‚ˆã£ã¦æ±ºã¾ã‚Šã¾ã™ã€‚
              </p>
              <div style={{ fontSize: '13px', color: '#6b7280', lineHeight: '1.8' }}>
                <p>â€¢ å ±é…¬ Â¥0ã€œÂ¥29,999 â†’ ç¿Œæœˆ <strong style={{ color: '#1f2937' }}>30%</strong></p>
                <p>â€¢ å ±é…¬ Â¥30,000ã€œÂ¥89,999 â†’ ç¿Œæœˆ <strong style={{ color: '#1f2937' }}>32%</strong></p>
                <p>â€¢ å ±é…¬ Â¥90,000ã€œÂ¥149,999 â†’ ç¿Œæœˆ <strong style={{ color: '#1f2937' }}>34%</strong></p>
                <p>â€¢ å ±é…¬ Â¥150,000ã€œÂ¥209,999 â†’ ç¿Œæœˆ <strong style={{ color: '#1f2937' }}>36%</strong></p>
                <p>â€¢ å ±é…¬ Â¥210,000ã€œÂ¥269,999 â†’ ç¿Œæœˆ <strong style={{ color: '#1f2937' }}>38%</strong></p>
                <p>â€¢ å ±é…¬ Â¥270,000ä»¥ä¸Š â†’ ç¿Œæœˆ <strong style={{ color: '#1f2937' }}>40%</strong> (æœ€å¤§)</p>
              </div>
            </div>
            <div style={{
              padding: '12px',
              background: '#fef3c7',
              borderRadius: '8px',
              border: '1px solid #fbbf24'
            }}>
              <p style={{ fontSize: '12px', color: '#92400e', lineHeight: '1.6' }}>
                <strong>é‡è¦:</strong> å ±é…¬ç‡ã¯æ¯æœˆãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚
              </p>
            </div>
          </div>

          {/* å…ˆæœˆã®å®Ÿç¸¾ */}
          {ft.lastMonthRevenue > 0 && (
            <div style={{
              background: 'white',
              borderRadius: '12px',
              padding: '24px',
              boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
            }}>
              <h2 style={{ fontSize: '16px', fontWeight: 'bold', color: '#6b7280', marginBottom: '12px' }}>
                å…ˆæœˆã®å®Ÿç¸¾
              </h2>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <span style={{ fontSize: '14px', color: '#6b7280' }}>å…ˆæœˆã®å ±é…¬</span>
                <span style={{ fontSize: '20px', fontWeight: 'bold', color: '#1f2937' }}>
                  Â¥{Math.floor(ft.lastMonthRevenue).toLocaleString()}
                </span>
              </div>
            </div>
          )}
        </div>
      </div>
    );
  }

  // ãƒã‚¤ãƒ³ãƒˆè³¼å…¥ç”»é¢
  function PurchaseScreen() {
    const [chargeCode, setChargeCode] = useState('');

    const pointPackages = [
      { id: 1, points: 500, basePoints: 500, bonusPoints: 0, price: 500, popular: false, url: 'https://minamisan.square.site/product/-cupids-500-/1?cs=true&cst=popular' },
      { id: 2, points: 1500, basePoints: 1500, bonusPoints: 0, price: 1500, popular: false, url: 'https://minamisan.square.site/product/-cupids-1500-/2?si=true' },
      { id: 3, points: 3100, basePoints: 3000, bonusPoints: 100, price: 3000, popular: true, url: 'https://minamisan.square.site/product/-cupids-3100-100pt-/3?si=true' },
      { id: 4, points: 6250, basePoints: 6000, bonusPoints: 250, price: 6000, popular: false, url: 'https://minamisan.square.site/product/-cupids-6250-250pt-/4?si=true' }
    ];

    const handlePurchase = (packageData) => {
      // Squareã‚µã‚¤ãƒˆã®å•†å“ãƒšãƒ¼ã‚¸ã‚’é–‹ã
      window.open(packageData.url, '_blank');
      alert('è³¼å…¥å®Œäº†å¾Œã€ãƒ¡ãƒ¼ãƒ«ã«è¨˜è¼‰ã•ã‚ŒãŸãƒãƒ£ãƒ¼ã‚¸ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
    };

    const handleChargeCode = () => {
      if (!chargeCode.trim()) {
        alert('ãƒãƒ£ãƒ¼ã‚¸ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      // ç°¡æ˜“çš„ãªãƒãƒ£ãƒ¼ã‚¸ã‚³ãƒ¼ãƒ‰æ¤œè¨¼ï¼ˆå®Ÿéš›ã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§æ¤œè¨¼ï¼‰
      // ãƒ‡ãƒ¢ç”¨: "DEMO100" ã§100ptè¿½åŠ 
      if (chargeCode === 'DEMO100') {
        setUsers(prev => ({
          ...prev,
          [currentUser.id]: {
            ...prev[currentUser.id],
            points: prev[currentUser.id].points + 100
          }
        }));
        setCurrentUser(prev => ({
          ...prev,
          points: prev.points + 100
        }));
        alert('100ãƒã‚¤ãƒ³ãƒˆã‚’ãƒãƒ£ãƒ¼ã‚¸ã—ã¾ã—ãŸï¼');
        setChargeCode('');
      } else if (chargeCode === 'DEMO500') {
        setUsers(prev => ({
          ...prev,
          [currentUser.id]: {
            ...prev[currentUser.id],
            points: prev[currentUser.id].points + 500
          }
        }));
        setCurrentUser(prev => ({
          ...prev,
          points: prev.points + 500
        }));
        alert('500ãƒã‚¤ãƒ³ãƒˆã‚’ãƒãƒ£ãƒ¼ã‚¸ã—ã¾ã—ãŸï¼');
        setChargeCode('');
      } else {
        alert('ç„¡åŠ¹ãªãƒãƒ£ãƒ¼ã‚¸ã‚³ãƒ¼ãƒ‰ã§ã™');
      }
    };

    return (
      <div style={{ minHeight: '100vh', background: '#f9fafb' }}>
        {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
        <div style={{
          background: 'linear-gradient(to right, #ec4899, #a855f7)',
          padding: '16px',
          boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
        }}>
          <div style={{
            maxWidth: '800px',
            margin: '0 auto',
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center'
          }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
              <button
                onClick={() => setScreen('lobby')}
                style={{
                  background: 'rgba(255,255,255,0.2)',
                  color: 'white',
                  padding: '8px',
                  borderRadius: '8px',
                  border: '1px solid rgba(255,255,255,0.3)',
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center'
                }}
              >
                <ArrowLeft size={20} />
              </button>
              <h1 style={{ fontSize: '20px', fontWeight: 'bold', color: 'white' }}>
                ãƒã‚¤ãƒ³ãƒˆè³¼å…¥
              </h1>
            </div>
            <div style={{
              background: 'rgba(255,255,255,0.2)',
              padding: '8px 16px',
              borderRadius: '8px',
              border: '1px solid rgba(255,255,255,0.3)'
            }}>
              <span style={{ color: 'white', fontSize: '14px', fontWeight: '600' }}>
                ç¾åœ¨: {currentUser.points}pt
              </span>
            </div>
          </div>
        </div>

        <div style={{ maxWidth: '800px', margin: '0 auto', padding: '24px 16px' }}>
          {/* ã”è³¼å…¥ã®æµã‚Œ */}
          <div style={{
            background: '#f9fafb',
            borderRadius: '12px',
            padding: '20px',
            marginBottom: '24px',
            border: '1px solid #e5e7eb'
          }}>
            <h3 style={{ fontSize: '14px', fontWeight: 'bold', color: '#1f2937', marginBottom: '12px' }}>
              ã”è³¼å…¥ã®æµã‚Œ
            </h3>
            <ol style={{ fontSize: '14px', color: '#6b7280', lineHeight: '1.8', paddingLeft: '20px', marginBottom: '12px' }}>
              <li>ãŠå¥½ããªãƒã‚¤ãƒ³ãƒˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã€Œè³¼å…¥ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
              <li>æ±ºæ¸ˆãƒšãƒ¼ã‚¸ãŒé–‹ãã¾ã™ã®ã§ã€ãŠæ”¯æ‰•ã„æƒ…å ±ã‚’å…¥åŠ›</li>
              <li>è³¼å…¥å®Œäº†å¾Œã€ãƒ¡ãƒ¼ãƒ«ã§ãƒãƒ£ãƒ¼ã‚¸ã‚³ãƒ¼ãƒ‰ãŒé€ã‚‰ã‚Œã¾ã™</li>
              <li>ãƒãƒ£ãƒ¼ã‚¸ã‚³ãƒ¼ãƒ‰ã‚’ä¸Šã®å…¥åŠ›æ¬„ã«å…¥åŠ›ã—ã¦ãƒã‚¤ãƒ³ãƒˆã‚’ãƒãƒ£ãƒ¼ã‚¸</li>
            </ol>
            <p style={{ fontSize: '12px', color: '#6b7280', marginTop: '8px' }}>
              â€»1å††ã§1ãƒã‚¤ãƒ³ãƒˆã«ãªã‚Šã¾ã™
            </p>
          </div>

          {/* ãƒãƒ£ãƒ¼ã‚¸ã‚³ãƒ¼ãƒ‰å…¥åŠ› */}
          <div style={{
            background: 'white',
            borderRadius: '12px',
            padding: '24px',
            marginBottom: '24px',
            boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
          }}>
            <h2 style={{ fontSize: '18px', fontWeight: 'bold', color: '#1f2937', marginBottom: '16px' }}>
              ãƒãƒ£ãƒ¼ã‚¸ã‚³ãƒ¼ãƒ‰ã‚’ãŠæŒã¡ã®æ–¹
            </h2>
            <div style={{ display: 'flex', gap: '12px' }}>
              <input
                type="text"
                value={chargeCode}
                onChange={(e) => setChargeCode(e.target.value)}
                placeholder="ãƒãƒ£ãƒ¼ã‚¸ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›"
                style={{
                  flex: 1,
                  padding: '12px',
                  border: '1px solid #e5e7eb',
                  borderRadius: '8px',
                  fontSize: '14px'
                }}
              />
              <button
                onClick={handleChargeCode}
                style={{
                  padding: '12px 24px',
                  background: 'linear-gradient(to right, #ec4899, #a855f7)',
                  color: 'white',
                  borderRadius: '8px',
                  border: 'none',
                  cursor: 'pointer',
                  fontSize: '14px',
                  fontWeight: '600'
                }}
              >
                ãƒãƒ£ãƒ¼ã‚¸
              </button>
            </div>
          </div>

          {/* ãƒã‚¤ãƒ³ãƒˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ */}
          <h2 style={{ fontSize: '18px', fontWeight: 'bold', color: '#1f2937', marginBottom: '16px' }}>
            ãƒã‚¤ãƒ³ãƒˆã‚’è³¼å…¥
          </h2>
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '16px' }}>
            {pointPackages.map(pkg => (
              <div
                key={pkg.id}
                style={{
                  background: 'white',
                  borderRadius: '12px',
                  padding: '24px',
                  boxShadow: '0 2px 8px rgba(0,0,0,0.1)',
                  border: pkg.popular ? '2px solid #fbbf24' : '1px solid #e5e7eb',
                  position: 'relative'
                }}
              >
                {pkg.popular && (
                  <div style={{
                    position: 'absolute',
                    top: '-12px',
                    left: '50%',
                    transform: 'translateX(-50%)',
                    background: '#fbbf24',
                    color: '#78350f',
                    padding: '4px 16px',
                    borderRadius: '12px',
                    fontSize: '12px',
                    fontWeight: 'bold'
                  }}>
                    ğŸ‘‘äººæ°—
                  </div>
                )}
                {pkg.bonusPoints > 0 && (
                  <div style={{
                    position: 'absolute',
                    top: '16px',
                    right: '16px',
                    background: '#ec4899',
                    color: 'white',
                    padding: '4px 12px',
                    borderRadius: '6px',
                    fontSize: '11px',
                    fontWeight: 'bold'
                  }}>
                    {pkg.bonusPoints}ptãŠå¾—
                  </div>
                )}
                <div style={{ textAlign: 'center', marginBottom: '8px', marginTop: pkg.bonusPoints > 0 ? '20px' : '0' }}>
                  <p style={{ fontSize: '36px', fontWeight: 'bold', color: '#ec4899', marginBottom: '4px' }}>
                    {pkg.points.toLocaleString()}
                  </p>
                  <p style={{ fontSize: '12px', color: '#6b7280' }}>ãƒã‚¤ãƒ³ãƒˆ</p>
                  {pkg.bonusPoints > 0 && (
                    <p style={{ fontSize: '11px', color: '#ec4899', marginTop: '4px' }}>
                      {pkg.bonusPoints}ptãƒœãƒ¼ãƒŠã‚¹è¾¼ã¿
                    </p>
                  )}
                </div>
                <p style={{ fontSize: '24px', fontWeight: 'bold', color: '#1f2937', textAlign: 'center', marginBottom: '16px' }}>
                  Â¥{pkg.price.toLocaleString()}
                </p>
                <button
                  onClick={() => handlePurchase(pkg)}
                  style={{
                    width: '100%',
                    padding: '12px',
                    background: 'linear-gradient(to right, #ec4899, #a855f7)',
                    color: 'white',
                    borderRadius: '8px',
                    border: 'none',
                    cursor: 'pointer',
                    fontSize: '14px',
                    fontWeight: '600'
                  }}
                >
                  è³¼å…¥ã™ã‚‹
                </button>
              </div>
            ))}
          </div>
        </div>
      </div>
    );
  }

  // ç®¡ç†ç”»é¢
  function AdminScreen() {
    const [activeTab, setActiveTab] = useState('dashboard');

    return (
      <div style={{ minHeight: '100vh', background: '#f9fafb' }}>
        {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
        <div style={{
          background: 'linear-gradient(to right, #ec4899, #a855f7)',
          padding: '16px',
          boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
        }}>
          <div style={{
            maxWidth: '1200px',
            margin: '0 auto',
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center'
          }}>
            <h1 style={{ fontSize: '24px', fontWeight: 'bold', color: 'white' }}>
              ç®¡ç†ç”»é¢
            </h1>
            <button
              onClick={() => {
                setCurrentUser(null);
                setScreen('login');
              }}
              style={{
                background: 'rgba(255,255,255,0.2)',
                color: 'white',
                padding: '8px 16px',
                borderRadius: '8px',
                border: '1px solid rgba(255,255,255,0.3)',
                cursor: 'pointer',
                fontSize: '14px',
                fontWeight: '600'
              }}
            >
              ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
            </button>
          </div>
        </div>

        <div style={{ maxWidth: '1200px', margin: '0 auto', padding: '24px 16px' }}>
          {/* ã‚¿ãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */}
          <div style={{ 
            display: 'flex', 
            gap: '8px', 
            marginBottom: '24px',
            overflowX: 'auto',
            padding: '8px 0'
          }}>
            {[
              { id: 'dashboard', label: 'ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰' },
              { id: 'sales', label: 'å£²ä¸Šç®¡ç†' },
              { id: 'last-month-rewards', label: 'å…ˆæœˆã®å ±é…¬' },
              { id: 'users', label: 'ãŠå®¢æ§˜ç®¡ç†' },
              { id: 'fortune-tellers', label: 'å ã„å¸«ç®¡ç†' },
              { id: 'chats', label: 'ãƒãƒ£ãƒƒãƒˆå±¥æ­´' },
              { id: 'reviews', label: 'ãƒ¬ãƒ“ãƒ¥ãƒ¼ç®¡ç†' }
            ].map(tab => (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id)}
                style={{
                  padding: '12px 24px',
                  background: activeTab === tab.id 
                    ? 'linear-gradient(to right, #ec4899, #a855f7)' 
                    : 'white',
                  color: activeTab === tab.id ? 'white' : '#6b7280',
                  borderRadius: '8px',
                  border: 'none',
                  cursor: 'pointer',
                  fontSize: '14px',
                  fontWeight: '600',
                  whiteSpace: 'nowrap',
                  boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
                }}
              >
                {tab.label}
              </button>
            ))}
          </div>

          {/* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ */}
          {activeTab === 'dashboard' && <DashboardTab />}
          {activeTab === 'sales' && <SalesManagementTab />}
          {activeTab === 'last-month-rewards' && <LastMonthRewardsTab />}
          {activeTab === 'users' && <UsersManagementTab />}
          {activeTab === 'fortune-tellers' && <FortuneTellersManagementTab />}
          {activeTab === 'chats' && <ChatsHistoryTab />}
          {activeTab === 'reviews' && <ReviewsManagementTab />}
        </div>
      </div>
    );

    // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚¿ãƒ–
    function DashboardTab() {
      const totalUsers = Object.values(users).filter(u => u.type === 'client').length;
      const totalFortuneTellers = Object.values(fortuneTellers).length;
      const activeChats = Object.values(conversationStatus).filter(s => s === 'active').length;

      // äººæ°—å ã„å¸«ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°é †ï¼‰
      const popularFortuneTellers = Object.values(fortuneTellers)
        .sort((a, b) => b.reviewCount - a.reviewCount)
        .slice(0, 5);

      return (
        <div>
          <h2 style={{ fontSize: '20px', fontWeight: 'bold', color: '#1f2937', marginBottom: '20px' }}>
            çµ±è¨ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
          </h2>

          {/* çµ±è¨ˆã‚«ãƒ¼ãƒ‰ */}
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '16px', marginBottom: '32px' }}>
            <div style={{
              background: 'white',
              borderRadius: '12px',
              padding: '20px',
              boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
            }}>
              <p style={{ fontSize: '14px', color: '#6b7280', marginBottom: '8px' }}>ç·ãŠå®¢æ§˜æ•°</p>
              <p style={{ fontSize: '32px', fontWeight: 'bold', color: '#ec4899' }}>{totalUsers}</p>
            </div>
            <div style={{
              background: 'white',
              borderRadius: '12px',
              padding: '20px',
              boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
            }}>
              <p style={{ fontSize: '14px', color: '#6b7280', marginBottom: '8px' }}>ç·å ã„å¸«æ•°</p>
              <p style={{ fontSize: '32px', fontWeight: 'bold', color: '#a855f7' }}>{totalFortuneTellers}</p>
            </div>
            <div style={{
              background: 'white',
              borderRadius: '12px',
              padding: '20px',
              boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
            }}>
              <p style={{ fontSize: '14px', color: '#6b7280', marginBottom: '8px' }}>ç¾åœ¨å…¥å®¤ä¸­</p>
              <p style={{ fontSize: '32px', fontWeight: 'bold', color: '#10b981' }}>{activeChats}</p>
            </div>
          </div>

          {/* äººæ°—å ã„å¸«ãƒ©ãƒ³ã‚­ãƒ³ã‚° */}
          <div style={{
            background: 'white',
            borderRadius: '12px',
            padding: '24px',
            boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
          }}>
            <h3 style={{ fontSize: '18px', fontWeight: 'bold', color: '#1f2937', marginBottom: '16px' }}>
              äººæ°—å ã„å¸«ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆé‘‘å®šæ•°é †ï¼‰
            </h3>
            <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
              {popularFortuneTellers.map((ft, index) => (
                <div key={ft.id} style={{
                  display: 'flex',
                  alignItems: 'center',
                  gap: '16px',
                  padding: '12px',
                  background: '#f9fafb',
                  borderRadius: '8px'
                }}>
                  <div style={{
                    width: '32px',
                    height: '32px',
                    borderRadius: '50%',
                    background: index === 0 ? '#fbbf24' : index === 1 ? '#d1d5db' : '#cd7f32',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    color: 'white',
                    fontWeight: 'bold',
                    fontSize: '14px'
                  }}>
                    {index + 1}
                  </div>
                  <div style={{ flex: 1 }}>
                    <p style={{ fontSize: '16px', fontWeight: 'bold', color: '#1f2937' }}>{ft.name}</p>
                    <p style={{ fontSize: '12px', color: '#6b7280' }}>{ft.specialty}</p>
                  </div>
                  <div style={{ textAlign: 'right' }}>
                    <p style={{ fontSize: '14px', fontWeight: 'bold', color: '#ec4899' }}>â­ {ft.rating.toFixed(1)}</p>
                    <p style={{ fontSize: '12px', color: '#6b7280' }}>{ft.reviewCount}ä»¶</p>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    }

    // å£²ä¸Šç®¡ç†ã‚¿ãƒ–
    function SalesManagementTab() {
      const [selectedMonth, setSelectedMonth] = useState('2025-11');

      // å…¨å ã„å¸«ã®å£²ä¸Šã‚’é›†è¨ˆ
      const calculateMonthlySales = (fortuneTellerId, month) => {
        const ftSales = salesData[fortuneTellerId] || {};
        let total = 0;
        
        Object.keys(ftSales).forEach(date => {
          if (date.startsWith(month)) {
            ftSales[date].forEach(sale => {
              total += sale.amount;
            });
          }
        });
        
        return total;
      };

      // å ã„å¸«ã”ã¨ã®æœˆåˆ¥å£²ä¸Šã‚’è¨ˆç®—
      const fortuneTellerSales = Object.values(fortuneTellers).map(ft => {
        const monthlySales = calculateMonthlySales(ft.id, selectedMonth);
        return {
          id: ft.id,
          name: ft.name,
          specialty: ft.specialty,
          sales: monthlySales
        };
      }).sort((a, b) => b.sales - a.sales);

      // ç·å£²ä¸Šã‚’è¨ˆç®—
      const totalSales = fortuneTellerSales.reduce((sum, ft) => sum + ft.sales, 0);

      // åˆ©ç”¨å¯èƒ½ãªæœˆã‚’å–å¾—
      const availableMonths = new Set();
      Object.values(salesData).forEach(ftData => {
        Object.keys(ftData).forEach(date => {
          const month = date.substring(0, 7);
          availableMonths.add(month);
        });
      });
      const sortedMonths = Array.from(availableMonths).sort().reverse();

      return (
        <div>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
            <h2 style={{ fontSize: '20px', fontWeight: 'bold', color: '#1f2937' }}>
              å£²ä¸Šç®¡ç†
            </h2>
            <select
              value={selectedMonth}
              onChange={(e) => setSelectedMonth(e.target.value)}
              style={{
                padding: '8px 16px',
                borderRadius: '8px',
                border: '1px solid #e5e7eb',
                fontSize: '14px',
                fontWeight: '500',
                cursor: 'pointer'
              }}
            >
              {sortedMonths.map(month => (
                <option key={month} value={month}>
                  {month.replace('-', 'å¹´')}æœˆ
                </option>
              ))}
            </select>
          </div>

          {/* ç·å£²ä¸Šã‚«ãƒ¼ãƒ‰ */}
          <div style={{
            background: 'linear-gradient(to right, #ec4899, #a855f7)',
            borderRadius: '12px',
            padding: '24px',
            marginBottom: '20px',
            boxShadow: '0 4px 12px rgba(236, 72, 153, 0.3)'
          }}>
            <p style={{ fontSize: '14px', color: 'rgba(255,255,255,0.9)', marginBottom: '8px' }}>
              {selectedMonth.replace('-', 'å¹´')}æœˆã®ç·å£²ä¸Š
            </p>
            <p style={{ fontSize: '36px', fontWeight: 'bold', color: 'white' }}>
              Â¥{totalSales.toLocaleString()}
            </p>
          </div>

          {/* å ã„å¸«åˆ¥å£²ä¸Šä¸€è¦§ */}
          <div style={{
            background: 'white',
            borderRadius: '12px',
            padding: '24px',
            boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
          }}>
            <h3 style={{ fontSize: '16px', fontWeight: 'bold', color: '#1f2937', marginBottom: '16px' }}>
              å ã„å¸«åˆ¥å£²ä¸Š
            </h3>
            <div style={{ overflowX: 'auto' }}>
              <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                <thead>
                  <tr style={{ borderBottom: '2px solid #e5e7eb' }}>
                    <th style={{ padding: '12px', textAlign: 'left', fontSize: '14px', fontWeight: 'bold', color: '#6b7280' }}>é †ä½</th>
                    <th style={{ padding: '12px', textAlign: 'left', fontSize: '14px', fontWeight: 'bold', color: '#6b7280' }}>å ã„å¸«å</th>
                    <th style={{ padding: '12px', textAlign: 'left', fontSize: '14px', fontWeight: 'bold', color: '#6b7280' }}>å°‚é–€åˆ†é‡</th>
                    <th style={{ padding: '12px', textAlign: 'right', fontSize: '14px', fontWeight: 'bold', color: '#6b7280' }}>å£²ä¸Šé‡‘é¡</th>
                    <th style={{ padding: '12px', textAlign: 'right', fontSize: '14px', fontWeight: 'bold', color: '#6b7280' }}>æ§‹æˆæ¯”</th>
                  </tr>
                </thead>
                <tbody>
                  {fortuneTellerSales.map((ft, index) => {
                    const percentage = totalSales > 0 ? ((ft.sales / totalSales) * 100).toFixed(1) : 0;
                    return (
                      <tr key={ft.id} style={{ borderBottom: '1px solid #e5e7eb' }}>
                        <td style={{ padding: '12px', fontSize: '14px', fontWeight: 'bold', color: '#6b7280' }}>
                          {index + 1}
                        </td>
                        <td style={{ padding: '12px', fontSize: '14px', color: '#1f2937', fontWeight: '600' }}>
                          {ft.name}
                        </td>
                        <td style={{ padding: '12px', fontSize: '14px', color: '#6b7280' }}>
                          {ft.specialty}
                        </td>
                        <td style={{ padding: '12px', fontSize: '16px', color: '#ec4899', fontWeight: 'bold', textAlign: 'right' }}>
                          Â¥{ft.sales.toLocaleString()}
                        </td>
                        <td style={{ padding: '12px', fontSize: '14px', color: '#6b7280', textAlign: 'right' }}>
                          {percentage}%
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
                <tfoot>
                  <tr style={{ borderTop: '2px solid #e5e7eb', background: '#f9fafb' }}>
                    <td colSpan="3" style={{ padding: '12px', fontSize: '14px', fontWeight: 'bold', color: '#1f2937' }}>
                      åˆè¨ˆ
                    </td>
                    <td style={{ padding: '12px', fontSize: '18px', fontWeight: 'bold', color: '#ec4899', textAlign: 'right' }}>
                      Â¥{totalSales.toLocaleString()}
                    </td>
                    <td style={{ padding: '12px', fontSize: '14px', fontWeight: 'bold', color: '#1f2937', textAlign: 'right' }}>
                      100%
                    </td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>

          {/* æœˆæ¬¡ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ */}
          <div style={{
            background: 'white',
            borderRadius: '12px',
            padding: '24px',
            marginTop: '20px',
            boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
          }}>
            <h3 style={{ fontSize: '16px', fontWeight: 'bold', color: '#1f2937', marginBottom: '12px' }}>
              æœˆæ¬¡ãƒªã‚»ãƒƒãƒˆ
            </h3>
            <p style={{ fontSize: '14px', color: '#6b7280', marginBottom: '16px' }}>
              æœˆãŒå¤‰ã‚ã£ãŸã‚‰ã€ã“ã®ãƒœã‚¿ãƒ³ã§å£²ä¸Šã¨å ±é…¬ç‡ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚<br />
              â€»å ±é…¬ç‡å›ºå®šã®å ã„å¸«ã¯ã€å ±é…¬ç‡ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã›ã‚“ã€‚
            </p>
            <button
              onClick={() => {
                if (window.confirm('æœˆæ¬¡ãƒªã‚»ãƒƒãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ\n\nãƒ»ä»Šæœˆã®å£²ä¸ŠãŒå…ˆæœˆã®å£²ä¸Šã«ç§»å‹•ã—ã¾ã™\nãƒ»ä»Šæœˆã®å£²ä¸ŠãŒ0ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™\nãƒ»å ±é…¬ç‡å›ºå®šã§ãªã„å ã„å¸«ã®å ±é…¬ç‡ãŒã€å…ˆæœˆã®å£²ä¸Šã«å¿œã˜ã¦å†è¨ˆç®—ã•ã‚Œã¾ã™')) {
                  performMonthlyReset();
                  alert('æœˆæ¬¡ãƒªã‚»ãƒƒãƒˆãŒå®Œäº†ã—ã¾ã—ãŸï¼');
                }
              }}
              style={{
                padding: '12px 24px',
                background: 'linear-gradient(to right, #ec4899, #a855f7)',
                color: 'white',
                borderRadius: '8px',
                border: 'none',
                cursor: 'pointer',
                fontSize: '14px',
                fontWeight: '600',
                boxShadow: '0 2px 4px rgba(236, 72, 153, 0.3)'
              }}
            >
              æœˆæ¬¡ãƒªã‚»ãƒƒãƒˆã‚’å®Ÿè¡Œ
            </button>
          </div>
        </div>
      );
    }

    // å…ˆæœˆã®å ±é…¬ã‚¿ãƒ–
    function LastMonthRewardsTab() {
      const fortuneTellersList = Object.values(fortuneTellers)
        .filter(ft => !ft.isTestBot)
        .sort((a, b) => b.lastMonthRevenue - a.lastMonthRevenue);

      const totalLastMonthRevenue = fortuneTellersList.reduce((sum, ft) => sum + ft.lastMonthRevenue, 0);

      return (
        <div>
          <h2 style={{ fontSize: '20px', fontWeight: 'bold', color: '#1f2937', marginBottom: '20px' }}>
            å…ˆæœˆã®å ±é…¬ãƒ¬ãƒãƒ¼ãƒˆ
          </h2>

          {/* ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ */}
          <div style={{
            background: 'linear-gradient(to right, #ec4899, #a855f7)',
            borderRadius: '12px',
            padding: '24px',
            marginBottom: '20px',
            boxShadow: '0 4px 12px rgba(236, 72, 153, 0.3)'
          }}>
            <p style={{ fontSize: '14px', color: 'rgba(255,255,255,0.9)', marginBottom: '8px' }}>
              å…ˆæœˆã®ç·å£²ä¸Š
            </p>
            <p style={{ fontSize: '36px', fontWeight: 'bold', color: 'white' }}>
              Â¥{totalLastMonthRevenue.toLocaleString()}
            </p>
          </div>

          {/* å ã„å¸«åˆ¥å ±é…¬ä¸€è¦§ */}
          <div style={{
            background: 'white',
            borderRadius: '12px',
            padding: '24px',
            boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
          }}>
            <h3 style={{ fontSize: '16px', fontWeight: 'bold', color: '#1f2937', marginBottom: '16px' }}>
              å ã„å¸«åˆ¥å ±é…¬
            </h3>
            <div style={{ overflowX: 'auto' }}>
              <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                <thead>
                  <tr style={{ borderBottom: '2px solid #e5e7eb' }}>
                    <th style={{ padding: '12px', textAlign: 'left', fontSize: '14px', fontWeight: 'bold', color: '#6b7280' }}>é †ä½</th>
                    <th style={{ padding: '12px', textAlign: 'left', fontSize: '14px', fontWeight: 'bold', color: '#6b7280' }}>å ã„å¸«å</th>
                    <th style={{ padding: '12px', textAlign: 'left', fontSize: '14px', fontWeight: 'bold', color: '#6b7280' }}>å°‚é–€åˆ†é‡</th>
                    <th style={{ padding: '12px', textAlign: 'right', fontSize: '14px', fontWeight: 'bold', color: '#6b7280' }}>å£²ä¸Šé‡‘é¡</th>
                    <th style={{ padding: '12px', textAlign: 'right', fontSize: '14px', fontWeight: 'bold', color: '#6b7280' }}>å ±é…¬ç‡</th>
                    <th style={{ padding: '12px', textAlign: 'right', fontSize: '14px', fontWeight: 'bold', color: '#6b7280' }}>å ±é…¬é‡‘é¡</th>
                  </tr>
                </thead>
                <tbody>
                  {fortuneTellersList.map((ft, index) => {
                    const reward = ft.lastMonthRevenue * ft.currentCommissionRate;
                    return (
                      <tr key={ft.id} style={{ borderBottom: '1px solid #e5e7eb' }}>
                        <td style={{ padding: '12px', fontSize: '14px', fontWeight: 'bold', color: '#6b7280' }}>
                          {index + 1}
                        </td>
                        <td style={{ padding: '12px', fontSize: '14px', color: '#1f2937', fontWeight: '600' }}>
                          {ft.name}
                          {ft.commissionRateFixed && (
                            <span style={{ 
                              marginLeft: '8px', 
                              fontSize: '11px', 
                              background: '#fef3c7', 
                              color: '#92400e',
                              padding: '2px 6px',
                              borderRadius: '4px',
                              fontWeight: '600'
                            }}>
                              å›ºå®š
                            </span>
                          )}
                        </td>
                        <td style={{ padding: '12px', fontSize: '14px', color: '#6b7280' }}>
                          {ft.specialty}
                        </td>
                        <td style={{ padding: '12px', fontSize: '16px', color: '#1f2937', fontWeight: 'bold', textAlign: 'right' }}>
                          Â¥{ft.lastMonthRevenue.toLocaleString()}
                        </td>
                        <td style={{ padding: '12px', fontSize: '14px', color: '#6b7280', textAlign: 'right' }}>
                          {(ft.currentCommissionRate * 100).toFixed(0)}%
                        </td>
                        <td style={{ padding: '12px', fontSize: '16px', color: '#ec4899', fontWeight: 'bold', textAlign: 'right' }}>
                          Â¥{reward.toLocaleString()}
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
                <tfoot>
                  <tr style={{ borderTop: '2px solid #e5e7eb', background: '#f9fafb' }}>
                    <td colSpan="5" style={{ padding: '12px', fontSize: '14px', fontWeight: 'bold', color: '#1f2937' }}>
                      åˆè¨ˆ
                    </td>
                    <td style={{ padding: '12px', fontSize: '18px', fontWeight: 'bold', color: '#ec4899', textAlign: 'right' }}>
                      Â¥{fortuneTellersList.reduce((sum, ft) => sum + (ft.lastMonthRevenue * ft.currentCommissionRate), 0).toLocaleString()}
                    </td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>

          {/* å ±é…¬å±¥æ­´ */}
          {fortuneTellersList.some(ft => ft.revenueHistory && ft.revenueHistory.length > 0) && (
            <div style={{
              background: 'white',
              borderRadius: '12px',
              padding: '24px',
              marginTop: '20px',
              boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
            }}>
              <h3 style={{ fontSize: '16px', fontWeight: 'bold', color: '#1f2937', marginBottom: '16px' }}>
                éå»ã®å ±é…¬å±¥æ­´
              </h3>
              <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                {fortuneTellersList.map(ft => {
                  if (!ft.revenueHistory || ft.revenueHistory.length === 0) return null;
                  return (
                    <div key={ft.id} style={{
                      padding: '16px',
                      background: '#f9fafb',
                      borderRadius: '8px',
                      border: '1px solid #e5e7eb'
                    }}>
                      <p style={{ fontSize: '14px', fontWeight: 'bold', color: '#1f2937', marginBottom: '12px' }}>
                        {ft.name}
                      </p>
                      <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                        {ft.revenueHistory.slice(-6).reverse().map((history, idx) => (
                          <div key={idx} style={{
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center',
                            padding: '8px',
                            background: 'white',
                            borderRadius: '4px'
                          }}>
                            <span style={{ fontSize: '13px', color: '#6b7280' }}>
                              {history.month.replace('-', 'å¹´')}æœˆ
                            </span>
                            <div style={{ display: 'flex', gap: '16px', alignItems: 'center' }}>
                              <span style={{ fontSize: '13px', color: '#6b7280' }}>
                                å ±é…¬ç‡: {(history.commissionRate * 100).toFixed(0)}%
                              </span>
                              <span style={{ fontSize: '14px', fontWeight: 'bold', color: '#ec4899' }}>
                                Â¥{(history.revenue * history.commissionRate).toLocaleString()}
                              </span>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          )}
        </div>
      );
    }

    // ãŠå®¢æ§˜ç®¡ç†ã‚¿ãƒ–
    function UsersManagementTab() {
      const clients = Object.values(users).filter(u => u.type === 'client');
      const [giftingClient, setGiftingClient] = useState(null);
      const [giftPoints, setGiftPoints] = useState('');
      const [giftReason, setGiftReason] = useState('');

      const handleGiftPoints = () => {
        const points = parseInt(giftPoints);
        if (!points || points <= 0) {
          alert('æœ‰åŠ¹ãªãƒã‚¤ãƒ³ãƒˆæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }
        if (!giftReason.trim()) {
          alert('ä»˜ä¸ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }

        setUsers(prev => ({
          ...prev,
          [giftingClient.id]: {
            ...prev[giftingClient.id],
            points: prev[giftingClient.id].points + points
          }
        }));

        alert(`${giftingClient.name}æ§˜ã«${points}ãƒã‚¤ãƒ³ãƒˆã‚’ä»˜ä¸ã—ã¾ã—ãŸ\nç†ç”±: ${giftReason}`);
        setGiftingClient(null);
        setGiftPoints('');
        setGiftReason('');
      };

      return (
        <div>
          <h2 style={{ fontSize: '20px', fontWeight: 'bold', color: '#1f2937', marginBottom: '20px' }}>
            ãŠå®¢æ§˜ç®¡ç†
          </h2>
          <div style={{
            background: 'white',
            borderRadius: '12px',
            padding: '24px',
            boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
          }}>
            <table style={{ width: '100%', borderCollapse: 'collapse' }}>
              <thead>
                <tr style={{ borderBottom: '2px solid #e5e7eb' }}>
                  <th style={{ padding: '12px', textAlign: 'left', fontSize: '14px', fontWeight: 'bold', color: '#6b7280' }}>ID</th>
                  <th style={{ padding: '12px', textAlign: 'left', fontSize: '14px', fontWeight: 'bold', color: '#6b7280' }}>åå‰</th>
                  <th style={{ padding: '12px', textAlign: 'left', fontSize: '14px', fontWeight: 'bold', color: '#6b7280' }}>ãƒ¡ãƒ¼ãƒ«</th>
                  <th style={{ padding: '12px', textAlign: 'right', fontSize: '14px', fontWeight: 'bold', color: '#6b7280' }}>ãƒã‚¤ãƒ³ãƒˆ</th>
                  <th style={{ padding: '12px', textAlign: 'center', fontSize: '14px', fontWeight: 'bold', color: '#6b7280' }}>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody>
                {clients.map(client => (
                  <tr key={client.id} style={{ borderBottom: '1px solid #e5e7eb' }}>
                    <td style={{ padding: '12px', fontSize: '14px', color: '#6b7280' }}>{client.id}</td>
                    <td style={{ padding: '12px', fontSize: '14px', color: '#1f2937', fontWeight: '500' }}>{client.name}</td>
                    <td style={{ padding: '12px', fontSize: '14px', color: '#6b7280' }}>{client.email}</td>
                    <td style={{ padding: '12px', fontSize: '14px', color: '#ec4899', fontWeight: 'bold', textAlign: 'right' }}>{client.points}pt</td>
                    <td style={{ padding: '12px', textAlign: 'center' }}>
                      <button
                        onClick={() => setGiftingClient(client)}
                        style={{
                          padding: '6px 12px',
                          background: 'linear-gradient(to right, #ec4899, #a855f7)',
                          color: 'white',
                          borderRadius: '6px',
                          border: 'none',
                          cursor: 'pointer',
                          fontSize: '13px',
                          fontWeight: '600'
                        }}
                      >
                        ãƒã‚¤ãƒ³ãƒˆä»˜ä¸
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          {/* ãƒã‚¤ãƒ³ãƒˆä»˜ä¸ãƒ¢ãƒ¼ãƒ€ãƒ« */}
          {giftingClient && (
            <div style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              background: 'rgba(0,0,0,0.5)',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              zIndex: 1000
            }}>
              <div style={{
                background: 'white',
                borderRadius: '12px',
                padding: '24px',
                width: '90%',
                maxWidth: '500px',
                boxShadow: '0 4px 20px rgba(0,0,0,0.2)'
              }}>
                <h3 style={{ fontSize: '18px', fontWeight: 'bold', color: '#1f2937', marginBottom: '16px' }}>
                  ãƒã‚¤ãƒ³ãƒˆä»˜ä¸
                </h3>
                
                <div style={{ marginBottom: '16px' }}>
                  <p style={{ fontSize: '14px', color: '#6b7280', marginBottom: '4px' }}>ãŠå®¢æ§˜</p>
                  <p style={{ fontSize: '16px', fontWeight: 'bold', color: '#1f2937' }}>
                    {giftingClient.name} ({giftingClient.email})
                  </p>
                  <p style={{ fontSize: '14px', color: '#6b7280', marginTop: '4px' }}>
                    ç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒˆ: <span style={{ color: '#ec4899', fontWeight: 'bold' }}>{giftingClient.points}pt</span>
                  </p>
                </div>

                <div style={{ marginBottom: '16px' }}>
                  <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: '#374151', marginBottom: '8px' }}>
                    ä»˜ä¸ãƒã‚¤ãƒ³ãƒˆæ•° <span style={{ color: '#ef4444' }}>*</span>
                  </label>
                  <input
                    type="number"
                    min="1"
                    value={giftPoints}
                    onChange={(e) => setGiftPoints(e.target.value)}
                    placeholder="ä¾‹: 100"
                    style={{
                      width: '100%',
                      padding: '12px',
                      border: '1px solid #e5e7eb',
                      borderRadius: '8px',
                      fontSize: '14px'
                    }}
                  />
                </div>

                <div style={{ marginBottom: '24px' }}>
                  <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: '#374151', marginBottom: '8px' }}>
                    ä»˜ä¸ç†ç”± <span style={{ color: '#ef4444' }}>*</span>
                  </label>
                  <textarea
                    value={giftReason}
                    onChange={(e) => setGiftReason(e.target.value)}
                    placeholder="ä¾‹: ã‚·ã‚¹ãƒ†ãƒ éšœå®³ã®ãŠè©«ã³"
                    rows="3"
                    style={{
                      width: '100%',
                      padding: '12px',
                      border: '1px solid #e5e7eb',
                      borderRadius: '8px',
                      fontSize: '14px',
                      resize: 'vertical'
                    }}
                  />
                </div>

                <div style={{ display: 'flex', gap: '12px' }}>
                  <button
                    onClick={() => {
                      setGiftingClient(null);
                      setGiftPoints('');
                      setGiftReason('');
                    }}
                    style={{
                      flex: 1,
                      padding: '12px',
                      background: '#f9fafb',
                      color: '#6b7280',
                      borderRadius: '8px',
                      border: '1px solid #e5e7eb',
                      cursor: 'pointer',
                      fontSize: '14px',
                      fontWeight: '600'
                    }}
                  >
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                  </button>
                  <button
                    onClick={handleGiftPoints}
                    style={{
                      flex: 1,
                      padding: '12px',
                      background: 'linear-gradient(to right, #ec4899, #a855f7)',
                      color: 'white',
                      borderRadius: '8px',
                      border: 'none',
                      cursor: 'pointer',
                      fontSize: '14px',
                      fontWeight: '600'
                    }}
                  >
                    ä»˜ä¸ã™ã‚‹
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // å ã„å¸«ç®¡ç†ã‚¿ãƒ–
    function FortuneTellersManagementTab() {
      const [editingFT, setEditingFT] = useState(null);
      const [addingReviewFor, setAddingReviewFor] = useState(null);
      const [newReview, setNewReview] = useState({
        clientName: '',
        rating: 5,
        comment: '',
        date: new Date().toISOString().slice(0, 10)
      });

      const handleAddReview = () => {
        if (!newReview.clientName.trim() || !newReview.comment.trim()) {
          alert('ãŠå®¢æ§˜åã¨ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }

        const review = {
          id: 'review-' + Date.now(),
          clientName: newReview.clientName,
          rating: newReview.rating,
          comment: newReview.comment,
          date: newReview.date,
          visible: true
        };

        setFortuneTellers(prev => ({
          ...prev,
          [addingReviewFor.id]: {
            ...prev[addingReviewFor.id],
            reviews: [...prev[addingReviewFor.id].reviews, review],
            reviewCount: prev[addingReviewFor.id].reviewCount + 1,
            // è©•ä¾¡ã‚’å†è¨ˆç®—ï¼ˆå›ºå®šã§ãªã„å ´åˆï¼‰
            rating: prev[addingReviewFor.id].ratingFixed 
              ? prev[addingReviewFor.id].rating
              : ((prev[addingReviewFor.id].rating * prev[addingReviewFor.id].reviews.length + newReview.rating) / 
                 (prev[addingReviewFor.id].reviews.length + 1))
          }
        }));

        alert('ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼');
        setAddingReviewFor(null);
        setNewReview({
          clientName: '',
          rating: 5,
          comment: '',
          date: new Date().toISOString().slice(0, 10)
        });
      };

      return (
        <div>
          <h2 style={{ fontSize: '20px', fontWeight: 'bold', color: '#1f2937', marginBottom: '20px' }}>
            å ã„å¸«ç®¡ç†
          </h2>
          
          {/* æ–°è¦å ã„å¸«è¿½åŠ ãƒœã‚¿ãƒ³ */}
          <button
            onClick={() => {
              const newId = 'ft-' + Date.now();
              setEditingFT({
                id: newId,
                name: '',
                email: '',
                password: '',
                specialty: '',
                description: '',
                rating: 5.0,
                reviewCount: 0,
                baseReviewCount: 0,
                ratingFixed: false,
                tags: [],
                status: 'available',
                profileMessage: '',
                pointsPerChar: 1,
                showReviews: true,
                reviews: [],
                currentMonthRevenue: 0,
                lastMonthRevenue: 0,
                currentCommissionRate: 0.30,
                nextMonthCommissionRate: 0.30,
                commissionRateFixed: false,
                revenueHistory: [],
                isNew: true
              });
            }}
            style={{
              padding: '12px 24px',
              background: 'linear-gradient(to right, #ec4899, #a855f7)',
              color: 'white',
              borderRadius: '8px',
              border: 'none',
              cursor: 'pointer',
              fontSize: '14px',
              fontWeight: '600',
              marginBottom: '16px'
            }}
          >
            + æ–°è¦å ã„å¸«ã‚’è¿½åŠ 
          </button>

          <div style={{
            background: 'white',
            borderRadius: '12px',
            padding: '24px',
            boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
          }}>
            <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
              {Object.values(fortuneTellers).map(ft => (
                <div key={ft.id} style={{
                  padding: '16px',
                  background: '#f9fafb',
                  borderRadius: '8px',
                  border: '1px solid #e5e7eb'
                }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '12px' }}>
                    <div>
                      <h3 style={{ fontSize: '16px', fontWeight: 'bold', color: '#1f2937', marginBottom: '4px' }}>
                        {ft.name}
                      </h3>
                      <p style={{ fontSize: '14px', color: '#6b7280' }}>{ft.specialty}</p>
                    </div>
                    <div style={{ display: 'flex', gap: '8px' }}>
                      <button
                        onClick={() => setAddingReviewFor(ft)}
                        style={{
                          padding: '8px 16px',
                          background: 'linear-gradient(to right, #ec4899, #a855f7)',
                          color: 'white',
                          borderRadius: '6px',
                          border: 'none',
                          cursor: 'pointer',
                          fontSize: '12px',
                          fontWeight: '600'
                        }}
                      >
                        ãƒ¬ãƒ“ãƒ¥ãƒ¼è¿½åŠ 
                      </button>
                      <button
                        onClick={() => setEditingFT({...ft})}
                        style={{
                          padding: '8px 16px',
                          background: '#3b82f6',
                          color: 'white',
                          borderRadius: '6px',
                          border: 'none',
                          cursor: 'pointer',
                          fontSize: '12px',
                          fontWeight: '600'
                        }}
                      >
                        ç·¨é›†
                      </button>
                    </div>
                  </div>
                  <div style={{ display: 'flex', gap: '16px', fontSize: '14px' }}>
                    <span>â­ {ft.rating.toFixed(1)}</span>
                    <span>é‘‘å®šæ•°: {ft.reviewCount}ä»¶</span>
                    <span style={{ color: '#ec4899', fontWeight: 'bold' }}>{ft.pointsPerChar}pt/æ–‡å­—</span>
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« */}
          {editingFT && (
            <div style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              background: 'rgba(0,0,0,0.5)',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              zIndex: 1000,
              padding: '16px'
            }}>
              <div style={{
                background: 'white',
                borderRadius: '16px',
                padding: '32px',
                width: '100%',
                maxWidth: '600px',
                maxHeight: '90vh',
                overflowY: 'auto'
              }}>
                <h3 style={{ fontSize: '20px', fontWeight: 'bold', color: '#1f2937', marginBottom: '20px' }}>
                  {editingFT.isNew ? 'æ–°è¦å ã„å¸«è¿½åŠ ' : 'å ã„å¸«æƒ…å ±ç·¨é›†'}
                </h3>
                
                <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                  <div>
                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: '#374151', marginBottom: '8px' }}>
                      åå‰
                    </label>
                    <input
                      type="text"
                      value={editingFT.name}
                      onChange={(e) => setEditingFT({...editingFT, name: e.target.value})}
                      style={{
                        width: '100%',
                        padding: '12px',
                        border: '1px solid #e5e7eb',
                        borderRadius: '8px',
                        fontSize: '14px'
                      }}
                    />
                  </div>

                  <div>
                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: '#374151', marginBottom: '8px' }}>
                      ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
                    </label>
                    <input
                      type="email"
                      value={editingFT.email}
                      onChange={(e) => setEditingFT({...editingFT, email: e.target.value})}
                      style={{
                        width: '100%',
                        padding: '12px',
                        border: '1px solid #e5e7eb',
                        borderRadius: '8px',
                        fontSize: '14px'
                      }}
                    />
                  </div>

                  {editingFT.isNew && (
                    <div>
                      <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: '#374151', marginBottom: '8px' }}>
                        ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
                      </label>
                      <input
                        type="password"
                        value={editingFT.password}
                        onChange={(e) => setEditingFT({...editingFT, password: e.target.value})}
                        style={{
                          width: '100%',
                          padding: '12px',
                          border: '1px solid #e5e7eb',
                          borderRadius: '8px',
                          fontSize: '14px'
                        }}
                      />
                    </div>
                  )}

                  <div>
                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: '#374151', marginBottom: '8px' }}>
                      å°‚é–€åˆ†é‡
                    </label>
                    <input
                      type="text"
                      value={editingFT.specialty}
                      onChange={(e) => setEditingFT({...editingFT, specialty: e.target.value})}
                      style={{
                        width: '100%',
                        padding: '12px',
                        border: '1px solid #e5e7eb',
                        borderRadius: '8px',
                        fontSize: '14px'
                      }}
                    />
                  </div>

                  <div>
                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: '#374151', marginBottom: '8px' }}>
                      è©•ä¾¡ï¼ˆæ˜Ÿï¼‰
                    </label>
                    <input
                      type="number"
                      step="0.1"
                      min="0"
                      max="5"
                      value={editingFT.rating}
                      onChange={(e) => setEditingFT({...editingFT, rating: parseFloat(e.target.value)})}
                      style={{
                        width: '100%',
                        padding: '12px',
                        border: '1px solid #e5e7eb',
                        borderRadius: '8px',
                        fontSize: '14px'
                      }}
                    />
                    <label style={{ display: 'flex', alignItems: 'center', gap: '8px', marginTop: '8px', cursor: 'pointer' }}>
                      <input
                        type="checkbox"
                        checked={editingFT.ratingFixed || false}
                        onChange={(e) => setEditingFT({...editingFT, ratingFixed: e.target.checked})}
                        style={{ cursor: 'pointer' }}
                      />
                      <span style={{ fontSize: '13px', color: '#6b7280' }}>è©•ä¾¡ã‚’å›ºå®šã™ã‚‹ï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼ã§å¤‰å‹•ã—ãªã„ï¼‰</span>
                    </label>
                  </div>

                  <div>
                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: '#374151', marginBottom: '8px' }}>
                      é‘‘å®šæ•°
                    </label>
                    <input
                      type="number"
                      value={editingFT.reviewCount}
                      onChange={(e) => {
                        const newCount = parseInt(e.target.value);
                        setEditingFT({
                          ...editingFT, 
                          reviewCount: newCount,
                          baseReviewCount: newCount // åŸºæº–é‘‘å®šæ•°ã‚‚åŒæ™‚ã«æ›´æ–°
                        });
                      }}
                      style={{
                        width: '100%',
                        padding: '12px',
                        border: '1px solid #e5e7eb',
                        borderRadius: '8px',
                        fontSize: '14px'
                      }}
                    />
                    <p style={{ fontSize: '12px', color: '#6b7280', marginTop: '4px' }}>
                      â€»ã“ã®æ•°ã‚’èµ·ç‚¹ã«ã€ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå¢—ãˆã‚‹ãŸã³ã«+1ã•ã‚Œã¾ã™
                    </p>
                  </div>

                  <div>
                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: '#374151', marginBottom: '8px' }}>
                      1æ–‡å­—ã‚ãŸã‚Šãƒã‚¤ãƒ³ãƒˆ
                    </label>
                    <input
                      type="number"
                      min="1"
                      max="100"
                      value={editingFT.pointsPerChar}
                      onChange={(e) => setEditingFT({...editingFT, pointsPerChar: parseInt(e.target.value)})}
                      style={{
                        width: '100%',
                        padding: '12px',
                        border: '1px solid #e5e7eb',
                        borderRadius: '8px',
                        fontSize: '14px'
                      }}
                    />
                  </div>

                  <div>
                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: '#374151', marginBottom: '8px' }}>
                      å ±é…¬ç‡ï¼ˆ%ï¼‰
                    </label>
                    <input
                      type="number"
                      min="1"
                      max="100"
                      value={Math.round(editingFT.currentCommissionRate * 100)}
                      onChange={(e) => {
                        const value = parseInt(e.target.value) || 30;
                        setEditingFT({...editingFT, currentCommissionRate: value / 100});
                      }}
                      style={{
                        width: '100%',
                        padding: '12px',
                        border: '1px solid #e5e7eb',
                        borderRadius: '8px',
                        fontSize: '14px'
                      }}
                    />
                    <p style={{ fontSize: '12px', color: '#6b7280', marginTop: '4px' }}>
                      â€»å ã„å¸«ãŒå—ã‘å–ã‚‹å ±é…¬ã®å‰²åˆï¼ˆ1ã€œ100%ï¼‰
                    </p>
                  </div>

                  <div>
                    <label style={{
                      display: 'flex',
                      alignItems: 'center',
                      gap: '8px',
                      cursor: 'pointer',
                      padding: '12px',
                      background: '#f9fafb',
                      borderRadius: '8px',
                      border: '1px solid #e5e7eb'
                    }}>
                      <input
                        type="checkbox"
                        checked={editingFT.commissionRateFixed || false}
                        onChange={(e) => setEditingFT({...editingFT, commissionRateFixed: e.target.checked})}
                        style={{
                          width: '18px',
                          height: '18px',
                          cursor: 'pointer'
                        }}
                      />
                      <div>
                        <span style={{ fontSize: '14px', fontWeight: '500', color: '#374151', display: 'block' }}>
                          å ±é…¬ç‡ã‚’å›ºå®š
                        </span>
                        <span style={{ fontSize: '12px', color: '#6b7280' }}>
                          ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã¨ã€æ¯æœˆãƒªã‚»ãƒƒãƒˆã•ã‚Œãšå›ºå®šã®å ±é…¬ç‡ã«ãªã‚Šã¾ã™
                        </span>
                      </div>
                    </label>
                  </div>
                </div>

                <div style={{ display: 'flex', gap: '12px', marginTop: '24px' }}>
                  <button
                    onClick={() => setEditingFT(null)}
                    style={{
                      flex: 1,
                      padding: '12px',
                      background: '#f3f4f6',
                      color: '#6b7280',
                      borderRadius: '8px',
                      border: 'none',
                      cursor: 'pointer',
                      fontSize: '14px',
                      fontWeight: '600'
                    }}
                  >
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                  </button>
                  <button
                    onClick={() => {
                      if (editingFT.isNew) {
                        const {isNew, ...ftData} = editingFT;
                        setFortuneTellers(prev => ({
                          ...prev,
                          [ftData.id]: {
                            ...ftData,
                            type: 'fortune-teller'
                          }
                        }));
                      } else {
                        setFortuneTellers(prev => ({
                          ...prev,
                          [editingFT.id]: editingFT
                        }));
                      }
                      setEditingFT(null);
                      alert('ä¿å­˜ã—ã¾ã—ãŸ');
                    }}
                    style={{
                      flex: 1,
                      padding: '12px',
                      background: 'linear-gradient(to right, #ec4899, #a855f7)',
                      color: 'white',
                      borderRadius: '8px',
                      border: 'none',
                      cursor: 'pointer',
                      fontSize: '14px',
                      fontWeight: '600'
                    }}
                  >
                    ä¿å­˜
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* ãƒ¬ãƒ“ãƒ¥ãƒ¼è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« */}
          {addingReviewFor && (
            <div style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              background: 'rgba(0,0,0,0.5)',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              zIndex: 1000,
              padding: '16px'
            }}>
              <div style={{
                background: 'white',
                borderRadius: '16px',
                padding: '32px',
                width: '100%',
                maxWidth: '500px',
                maxHeight: '90vh',
                overflowY: 'auto'
              }}>
                <h3 style={{ fontSize: '20px', fontWeight: 'bold', color: '#1f2937', marginBottom: '16px' }}>
                  ãƒ¬ãƒ“ãƒ¥ãƒ¼è¿½åŠ ï¼š{addingReviewFor.name}
                </h3>
                
                <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                  <div>
                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: '#374151', marginBottom: '8px' }}>
                      ãŠå®¢æ§˜å <span style={{ color: '#ef4444' }}>*</span>
                    </label>
                    <input
                      type="text"
                      value={newReview.clientName}
                      onChange={(e) => setNewReview({...newReview, clientName: e.target.value})}
                      placeholder="ä¾‹: ç”°ä¸­èŠ±å­"
                      style={{
                        width: '100%',
                        padding: '12px',
                        border: '1px solid #e5e7eb',
                        borderRadius: '8px',
                        fontSize: '14px'
                      }}
                    />
                  </div>

                  <div>
                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: '#374151', marginBottom: '8px' }}>
                      è©•ä¾¡ <span style={{ color: '#ef4444' }}>*</span>
                    </label>
                    <div style={{ display: 'flex', gap: '8px' }}>
                      {[1, 2, 3, 4, 5].map(star => (
                        <button
                          key={star}
                          onClick={() => setNewReview({...newReview, rating: star})}
                          style={{
                            fontSize: '32px',
                            background: 'none',
                            border: 'none',
                            cursor: 'pointer',
                            color: star <= newReview.rating ? '#fbbf24' : '#e5e7eb'
                          }}
                        >
                          â˜…
                        </button>
                      ))}
                    </div>
                  </div>

                  <div>
                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: '#374151', marginBottom: '8px' }}>
                      ã‚³ãƒ¡ãƒ³ãƒˆ <span style={{ color: '#ef4444' }}>*</span>
                    </label>
                    <textarea
                      value={newReview.comment}
                      onChange={(e) => setNewReview({...newReview, comment: e.target.value})}
                      placeholder="ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
                      rows="4"
                      style={{
                        width: '100%',
                        padding: '12px',
                        border: '1px solid #e5e7eb',
                        borderRadius: '8px',
                        fontSize: '14px',
                        resize: 'vertical'
                      }}
                    />
                  </div>

                  <div>
                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: '#374151', marginBottom: '8px' }}>
                      æ—¥ä»˜
                    </label>
                    <input
                      type="date"
                      value={newReview.date}
                      onChange={(e) => setNewReview({...newReview, date: e.target.value})}
                      style={{
                        width: '100%',
                        padding: '12px',
                        border: '1px solid #e5e7eb',
                        borderRadius: '8px',
                        fontSize: '14px'
                      }}
                    />
                  </div>
                </div>

                <div style={{ display: 'flex', gap: '12px', marginTop: '24px' }}>
                  <button
                    onClick={() => {
                      setAddingReviewFor(null);
                      setNewReview({
                        clientName: '',
                        rating: 5,
                        comment: '',
                        date: new Date().toISOString().slice(0, 10)
                      });
                    }}
                    style={{
                      flex: 1,
                      padding: '12px',
                      background: '#f9fafb',
                      color: '#6b7280',
                      borderRadius: '8px',
                      border: '1px solid #e5e7eb',
                      cursor: 'pointer',
                      fontSize: '14px',
                      fontWeight: '600'
                    }}
                  >
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                  </button>
                  <button
                    onClick={handleAddReview}
                    style={{
                      flex: 1,
                      padding: '12px',
                      background: 'linear-gradient(to right, #ec4899, #a855f7)',
                      color: 'white',
                      borderRadius: '8px',
                      border: 'none',
                      cursor: 'pointer',
                      fontSize: '14px',
                      fontWeight: '600'
                    }}
                  >
                    è¿½åŠ 
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚¿ãƒ–
    function ChatsHistoryTab() {
      return (
        <div>
          <h2 style={{ fontSize: '20px', fontWeight: 'bold', color: '#1f2937', marginBottom: '20px' }}>
            ãƒãƒ£ãƒƒãƒˆå±¥æ­´
          </h2>
          <div style={{
            background: 'white',
            borderRadius: '12px',
            padding: '24px',
            boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
          }}>
            {Object.values(conversations).length === 0 ? (
              <p style={{ color: '#6b7280', textAlign: 'center' }}>ã¾ã ãƒãƒ£ãƒƒãƒˆå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>
            ) : (
              <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                {Object.values(conversations).map(conv => {
                  const client = users[conv.participants.find(id => users[id])];
                  const ft = fortuneTellers[conv.participants.find(id => fortuneTellers[id])];
                  return (
                    <div key={conv.id} style={{
                      padding: '16px',
                      background: '#f9fafb',
                      borderRadius: '8px',
                      border: '1px solid #e5e7eb'
                    }}>
                      <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                        <div>
                          <p style={{ fontSize: '14px', fontWeight: 'bold', color: '#1f2937' }}>
                            {client?.name} â‡” {ft?.name}
                          </p>
                          <p style={{ fontSize: '12px', color: '#6b7280' }}>
                            ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°: {conv.messages.length}
                          </p>
                        </div>
                        <span style={{ 
                          fontSize: '12px', 
                          padding: '4px 12px',
                          borderRadius: '12px',
                          background: conversationStatus[conv.id] === 'active' ? '#10b981' : '#6b7280',
                          color: 'white',
                          fontWeight: 'bold'
                        }}>
                          {conversationStatus[conv.id] === 'active' ? 'å…¥å®¤ä¸­' : 'é€€å®¤æ¸ˆã¿'}
                        </span>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        </div>
      );
    }

    // ãƒ¬ãƒ“ãƒ¥ãƒ¼ç®¡ç†ã‚¿ãƒ–
    function ReviewsManagementTab() {
      const allReviews = [];
      Object.values(fortuneTellers).forEach(ft => {
        if (ft.reviews) {
          ft.reviews.forEach(review => {
            allReviews.push({
              ...review,
              fortuneTellerId: ft.id,
              fortuneTellerName: ft.name
            });
          });
        }
      });

      return (
        <div>
          <h2 style={{ fontSize: '20px', fontWeight: 'bold', color: '#1f2937', marginBottom: '20px' }}>
            ãƒ¬ãƒ“ãƒ¥ãƒ¼ç®¡ç†
          </h2>
          <div style={{
            background: 'white',
            borderRadius: '12px',
            padding: '24px',
            boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
          }}>
            {allReviews.length === 0 ? (
              <p style={{ color: '#6b7280', textAlign: 'center' }}>ã¾ã ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“</p>
            ) : (
              <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                {allReviews.map(review => (
                  <div key={review.id} style={{
                    padding: '16px',
                    background: '#f9fafb',
                    borderRadius: '8px',
                    border: '1px solid #e5e7eb'
                  }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '12px' }}>
                      <div>
                        <p style={{ fontSize: '14px', fontWeight: 'bold', color: '#1f2937' }}>
                          {review.clientName} â†’ {review.fortuneTellerName}
                        </p>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '4px', marginTop: '4px' }}>
                          {[...Array(5)].map((_, i) => (
                            <Star key={i} size={14} fill={i < review.rating ? '#fbbf24' : 'none'} color="#fbbf24" />
                          ))}
                          <span style={{ fontSize: '12px', color: '#6b7280', marginLeft: '4px' }}>
                            {review.date}
                          </span>
                        </div>
                      </div>
                      <button
                        onClick={() => {
                          setFortuneTellers(prev => ({
                            ...prev,
                            [review.fortuneTellerId]: {
                              ...prev[review.fortuneTellerId],
                              reviews: prev[review.fortuneTellerId].reviews.map(r => 
                                r.id === review.id ? {...r, visible: !r.visible} : r
                              )
                            }
                          }));
                        }}
                        style={{
                          padding: '6px 12px',
                          background: review.visible === false ? '#10b981' : '#ef4444',
                          color: 'white',
                          borderRadius: '6px',
                          border: 'none',
                          cursor: 'pointer',
                          fontSize: '12px',
                          fontWeight: '600'
                        }}
                      >
                        {review.visible === false ? 'è¡¨ç¤º' : 'éè¡¨ç¤º'}
                      </button>
                    </div>
                    <p style={{ fontSize: '14px', color: '#6b7280' }}>{review.comment}</p>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      );
    }
  }

  return <LoginScreen />;
}

  </script>
</body>
</html>
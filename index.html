<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cupids - ãƒãƒ£ãƒƒãƒˆå ã„</title>
  
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#ec4899">
  <link rel="apple-touch-icon" href="./cupids_icon_192.png">
  <link rel="icon" type="image/png" sizes="192x192" href="./cupids_icon_192.png">
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  
  <style>
    body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    * { box-sizing: border-box; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // FirebaseåˆæœŸåŒ–
    const firebaseConfig = {
      apiKey: "AIzaSyA52uJ31HzLkbz32lA-3WWSmhM10xYjjCg",
      authDomain: "cupids-chat.firebaseapp.com",
      projectId: "cupids-chat",
      storageBucket: "cupids-chat.firebasestorage.app",
      messagingSenderId: "44532110483",
      appId: "1:44532110483:web:d6266e8abba8582b8b6966"
    };
    
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    function FortuneServiceApp() {
      // Stateç®¡ç†
      const [currentUser, setCurrentUser] = useState(null);
      const [screen, setScreen] = useState('login');
      const [loading, setLoading] = useState(true);
      
      // ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ç”¨
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      
      // æ–°è¦ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ç”¨
      const [registrationType, setRegistrationType] = useState('client');
      const [clientName, setClientName] = useState('');
      const [clientEmail, setClientEmail] = useState('');
      const [clientPassword, setClientPassword] = useState('');
      
      // ãƒãƒ£ãƒƒãƒˆé–¢é€£
      const [fortuneTellers, setFortuneTellers] = useState([]);
      const [selectedFortuneTeller, setSelectedFortuneTeller] = useState(null);
      const [currentChat, setCurrentChat] = useState(null);
      const [messages, setMessages] = useState([]);
      const [messageText, setMessageText] = useState('');
      
      // ãƒã‚¤ãƒ³ãƒˆè³¼å…¥
      const [chargeCode, setChargeCode] = useState('');
      
      // å ã„å¸«ã®å®šå‹æ–‡ç®¡ç†
      const [fortuneTellerTemplates, setFortuneTellerTemplates] = useState([
        'ã”ç›¸è«‡ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚è©³ã—ããŠè©±ã‚’ä¼ºã‚ã›ã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ',
        'é‘‘å®šã•ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚å°‘ã€…ãŠå¾…ã¡ãã ã•ã„ã€‚',
        'ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚ã¾ãŸã„ã¤ã§ã‚‚ã”ç›¸è«‡ãã ã•ã„ã€‚'
      ]);
      const [editingTemplates, setEditingTemplates] = useState(false);
      const [tempTemplates, setTempTemplates] = useState([]);
      
      const maxChars = 500;
      const messagesEndRef = useRef(null);

      // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã®ã¿ï¼ˆç”»é¢é·ç§»ã¯ã—ãªã„ï¼‰
      useEffect(() => {
        let unsubscribeUser = null;
        
        const unsubscribe = auth.onAuthStateChanged(async (firebaseUser) => {
          if (firebaseUser) {
            try {
              // Firestoreã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å–å¾—
              unsubscribeUser = db.collection('users').doc(firebaseUser.uid).onSnapshot((doc) => {
                if (doc.exists) {
                  const userData = doc.data();
                  const newUserData = {
                    id: firebaseUser.uid,
                    email: firebaseUser.email,
                    ...userData
                  };
                  
                  setCurrentUser(prevUser => {
                    // åˆå›ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®ã¿ç”»é¢é·ç§»
                    if (!prevUser) {
                      if (userData.type === 'admin') {
                        setScreen('admin');
                      } else {
                        setScreen('lobby');
                      }
                    }
                    return newUserData;
                  });
                } else {
                  console.error('User document does not exist');
                  auth.signOut();
                }
                setLoading(false);
              }, (error) => {
                console.error('Error listening to user data:', error);
                setLoading(false);
              });
            } catch (error) {
              console.error('Error setting up user listener:', error);
              setLoading(false);
            }
          } else {
            setCurrentUser(null);
            setScreen('login');
            setLoading(false);
          }
        });
        
        return () => {
          unsubscribe();
          if (unsubscribeUser) unsubscribeUser();
        };
      }, []);

      // å ã„å¸«ä¸€è¦§ã®å–å¾—ï¼ˆãŠå®¢æ§˜ã®å ´åˆï¼‰
      useEffect(() => {
        if (currentUser?.type === 'client') {
          const unsubscribe = db.collection('users')
            .where('type', '==', 'fortune-teller')
            .onSnapshot((snapshot) => {
              const fts = [];
              snapshot.forEach((doc) => {
                fts.push({ id: doc.id, ...doc.data() });
              });
              setFortuneTellers(fts);
            });
          return () => unsubscribe();
        }
      }, [currentUser]);

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å–å¾—
      useEffect(() => {
        if (currentChat && currentUser) {
          const unsubscribe = db.collection('chats')
            .doc(currentChat)
            .collection('messages')
            .orderBy('timestamp', 'asc')
            .onSnapshot((snapshot) => {
              const msgs = [];
              snapshot.forEach((doc) => {
                msgs.push({ id: doc.id, ...doc.data() });
              });
              setMessages(msgs);
              setTimeout(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
              }, 100);
            });
          return () => unsubscribe();
        }
      }, [currentChat, currentUser]);

      // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
      const handleLogin = async () => {
        if (!email || !password) {
          alert('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }
        
        try {
          setLoading(true);
          await auth.signInWithEmailAndPassword(email, password);
          // onAuthStateChangedã§è‡ªå‹•çš„ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒè¨­å®šã•ã‚Œã‚‹
        } catch (error) {
          console.error('Login error:', error);
          if (error.code === 'auth/user-not-found') {
            alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          } else if (error.code === 'auth/wrong-password') {
            alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
          } else {
            alert('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
          }
          setLoading(false);
        }
      };

      // æ–°è¦ç™»éŒ²å‡¦ç†ï¼ˆãŠå®¢æ§˜ï¼‰
      const handleClientRegister = async () => {
        if (!clientName || !clientEmail || !clientPassword) {
          alert('å…¨ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }
        
        if (clientPassword.length < 6) {
          alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }
        
        try {
          setLoading(true);
          
          // Firebase Authenticationã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
          const userCredential = await auth.createUserWithEmailAndPassword(clientEmail, clientPassword);
          
          // Firestoreã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ä¿å­˜
          await db.collection('users').doc(userCredential.user.uid).set({
            name: clientName,
            email: clientEmail,
            type: 'client',
            points: 0,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          // ç™»éŒ²æˆåŠŸå¾Œã¯è‡ªå‹•çš„ã«ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã«ãªã‚‹
        } catch (error) {
          console.error('Register error:', error);
          if (error.code === 'auth/email-already-in-use') {
            alert('ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™');
          } else if (error.code === 'auth/weak-password') {
            alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„');
          } else {
            alert('ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
          }
          setLoading(false);
        }
      };

      // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
      const handleLogout = async () => {
        try {
          await auth.signOut();
          setCurrentUser(null);
          setScreen('login');
          setEmail('');
          setPassword('');
          setSelectedFortuneTeller(null);
          setCurrentChat(null);
          setMessages([]);
        } catch (error) {
          alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        }
      };

      // ãƒãƒ£ãƒƒãƒˆé–‹å§‹
      const handleStartChat = (fortuneTeller) => {
        const chatId = [currentUser.id, fortuneTeller.id].sort().join('_');
        setCurrentChat(chatId);
        setSelectedFortuneTeller(fortuneTeller);
        setScreen('chat');
      };

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
      const handleSendMessage = async () => {
        if (!messageText.trim() || !currentChat || !selectedFortuneTeller) return;
        
        const pointsPerChar = selectedFortuneTeller.pointsPerChar || 1;
        const pointCost = messageText.length * pointsPerChar;
        
        // ãŠå®¢æ§˜ã®å ´åˆã€ãƒã‚¤ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯
        if (currentUser.type === 'client') {
          if (currentUser.points < pointCost) {
            alert(`ãƒã‚¤ãƒ³ãƒˆãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚${pointCost}ptå¿…è¦ã§ã™ã€‚`);
            return;
          }
        }
        
        const messageToSend = messageText;
        setMessageText(''); // ã™ãã«å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
        
        try {
          // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¿å­˜
          const messageData = {
            text: messageToSend,
            senderId: currentUser.id,
            senderName: currentUser.name,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            createdAt: new Date().toISOString()
          };
          
          await db.collection('chats').doc(currentChat).collection('messages').add(messageData);
          
          // ãƒã‚¤ãƒ³ãƒˆã‚’æ¶ˆè²»ï¼ˆãŠå®¢æ§˜ã®å ´åˆï¼‰
          if (currentUser.type === 'client') {
            await db.collection('users').doc(currentUser.id).update({
              points: firebase.firestore.FieldValue.increment(-pointCost)
            });
          }
        } catch (error) {
          console.error('Send message error:', error);
          alert('é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
          setMessageText(messageToSend); // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ†ã‚­ã‚¹ãƒˆã‚’å¾©å…ƒ
        }
      };

      // ãƒãƒ£ãƒ¼ã‚¸ã‚³ãƒ¼ãƒ‰å‡¦ç†
      const handleChargeCode = async () => {
        if (!chargeCode.trim()) {
          alert('ãƒãƒ£ãƒ¼ã‚¸ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }
        
        try {
          const code = chargeCode.trim().toUpperCase();
          
          // ãƒ‡ãƒ¢ã‚³ãƒ¼ãƒ‰
          if (code === 'DEMO100') {
            await db.collection('users').doc(currentUser.id).update({
              points: firebase.firestore.FieldValue.increment(100)
            });
            alert('100ãƒã‚¤ãƒ³ãƒˆã‚’ãƒãƒ£ãƒ¼ã‚¸ã—ã¾ã—ãŸï¼');
            setChargeCode('');
          } else if (code === 'DEMO500') {
            await db.collection('users').doc(currentUser.id).update({
              points: firebase.firestore.FieldValue.increment(500)
            });
            alert('500ãƒã‚¤ãƒ³ãƒˆã‚’ãƒãƒ£ãƒ¼ã‚¸ã—ã¾ã—ãŸï¼');
            setChargeCode('');
          } else {
            alert('ç„¡åŠ¹ãªãƒãƒ£ãƒ¼ã‚¸ã‚³ãƒ¼ãƒ‰ã§ã™');
          }
        } catch (error) {
          alert('ãƒãƒ£ãƒ¼ã‚¸ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        }
      };

      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢
      if (loading) {
        return (
          <div style={{
            minHeight: '100vh',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
          }}>
            <div style={{ color: 'white', fontSize: '20px' }}>èª­ã¿è¾¼ã¿ä¸­...</div>
          </div>
        );
      }

      // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢
      if (screen === 'login') {
        // åˆ©ç”¨å¯èƒ½ãªå ã„å¸«ï¼ˆãƒ‡ãƒ¢è¡¨ç¤ºç”¨ï¼‰
        const availableFortuneTellers = fortuneTellers.filter(ft => ft.status === 'available').slice(0, 3);
        
        return (
          <div style={{
            minHeight: '100vh',
            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            padding: '32px 16px'
          }}>
            <div style={{
              maxWidth: '440px',
              width: '100%',
              background: 'white',
              borderRadius: '24px',
              padding: '32px',
              boxShadow: '0 20px 60px rgba(0,0,0,0.1)'
            }}>
              <div style={{ textAlign: 'center', marginBottom: '24px' }}>
                <img 
                  src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDUwMCAxODAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiAgPGRlZnM+CiAgICA8bGluZWFyR3JhZGllbnQgaWQ9InRleHRHcmFkIiB4MT0iMCUiIHkxPSIwJSIgeDI9IjEwMCUiIHkyPSIwJSI+CiAgICAgIDxzdG9wIG9mZnNldD0iMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiNlYzQ4OTk7c3RvcC1vcGFjaXR5OjEiIC8+CiAgICAgIDxzdG9wIG9mZnNldD0iMTAwJSIgc3R5bGU9InN0b3AtY29sb3I6I2E4NTVmNztzdG9wLW9wYWNpdHk6MSIgLz4KICAgIDwvbGluZWFyR3JhZGllbnQ+CiAgICA8ZmlsdGVyIGlkPSJzb2Z0U2hhZG93Ij4KICAgICAgPGZlRHJvcFNoYWRvdyBkeD0iMCIgZHk9IjMiIHN0ZERldmlhdGlvbj0iMyIgZmxvb2QtY29sb3I9IiMwMDAwMDAiIGZsb29kLW9wYWNpdHk9IjAuMjUiLz4KICAgIDwvZmlsdGVyPgogIDwvZGVmcz4KICAKICA8IS0tIOWPr+aEm+OBhOaciO+8iOODnuODoeODreODs+miqO+8iSAtLT4KICA8ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSg3MCwgNjApIiBmaWx0ZXI9InVybCgjc29mdFNoYWRvdykiPgogICAgPCEtLSDmnIjmnKzkvZMgLS0+CiAgICA8cGF0aCBkPSJNIDAsMCBBIDM4LDM4IDAgMSwwIDIyLC0yMiBBIDI4LDI4IDAgMSwxIDAsMCBaIiBmaWxsPSIjZmVmM2M3Ii8+CiAgICA8IS0tIOaYn+OBrumjvuOCiiAtLT4KICAgIDxjaXJjbGUgY3g9IjEzIiBjeT0iLTEzIiByPSIzIiBmaWxsPSIjZmJiZjI0Ii8+CiAgICA8cGF0aCBkPSJNIDEzLC0xNiBMIDEzLjUsLTEzLjUgTCAxNiwtMTMgTCAxMy41LC0xMi41IEwgMTMsLTEwIEwgMTIuNSwtMTIuNSBMIDEwLC0xMyBMIDEyLjUsLTEzLjUgWiIgZmlsbD0iI2ZiYmYyNCIvPgogICAgPCEtLSDlsI/jgZXjgarmmJ8gLS0+CiAgICA8Y2lyY2xlIGN4PSItMTAiIGN5PSItMTAiIHI9IjIiIGZpbGw9IiNmYmJmMjQiIG9wYWNpdHk9IjAuOCIvPgogIDwvZz4KICAKICA8IS0tIEN1cGlkc+OBruaWh+WtlyAtLT4KICA8ZyBmaWx0ZXI9InVybCgjc29mdFNoYWRvdykiPgogICAgPHRleHQgeD0iMTQ1IiB5PSIxMDUiIGZvbnQtZmFtaWx5PSInQ29taWMgU2FucyBNUycsICdBcmlhbCBSb3VuZGVkIE1UIEJvbGQnLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjcwIiBmb250LXdlaWdodD0iOTAwIiBmaWxsPSIjZmZmZmZmIiBzdHJva2U9IiNmZmZmZmYiIHN0cm9rZS13aWR0aD0iNiI+CiAgICAgIEN1cGlkcwogICAgPC90ZXh0PgogICAgPHRleHQgeD0iMTQ1IiB5PSIxMDUiIGZvbnQtZmFtaWx5PSInQ29taWMgU2FucyBNUycsICdBcmlhbCBSb3VuZGVkIE1UIEJvbGQnLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjcwIiBmb250LXdlaWdodD0iOTAwIiBmaWxsPSJ1cmwoI3RleHRHcmFkKSI+CiAgICAgIEN1cGlkcwogICAgPC90ZXh0PgogIDwvZz4KICAKICA8IS0tIOOCteODluODhuOCreOCueODiCAtLT4KICA8dGV4dCB4PSIxNDciIHk9IjEzNSIgZm9udC1mYW1pbHk9IidDb21pYyBTYW5zIE1TJywgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxOCIgZmlsbD0iI2E4NTVmNyIgZm9udC13ZWlnaHQ9ImJvbGQiIGxldHRlci1zcGFjaW5nPSIyIj4KICAgIOODgeODo+ODg+ODiOWNoOOBhAogIDwvdGV4dD4KICAKICA8IS0tIOWwj+OBleOBquODj+ODvOODiCAtLT4KICA8cGF0aCBkPSJNIDQ2MCw1MCBMIDQ2NSw0NSBRIDQ3MCw0MCA0NzMsNDUgUSA0NzYsNDAgNDgxLDQ1IEwgNDczLDYwIFoiIGZpbGw9IiNlYzQ4OTkiIG9wYWNpdHk9IjAuNyI+CiAgICA8YW5pbWF0ZVRyYW5zZm9ybSBhdHRyaWJ1dGVOYW1lPSJ0cmFuc2Zvcm0iIHR5cGU9InRyYW5zbGF0ZSIgdmFsdWVzPSIwLDA7IDAsLTU7IDAsMCIgZHVyPSIycyIgcmVwZWF0Q291bnQ9ImluZGVmaW5pdGUiLz4KICA8L3BhdGg+CiAgCiAgPCEtLSDjgq3jg6njgq3jg6kgLS0+CiAgPGcgb3BhY2l0eT0iMC44Ij4KICAgIDxjaXJjbGUgY3g9IjQzMCIgY3k9IjEwMCIgcj0iMyIgZmlsbD0iI2ZiYmYyNCI+CiAgICAgIDxhbmltYXRlIGF0dHJpYnV0ZU5hbWU9Im9wYWNpdHkiIHZhbHVlcz0iMTswLjQ7MSIgZHVyPSIxLjVzIiByZXBlYXRDb3VudD0iaW5kZWZpbml0ZSIvPgogICAgPC9jaXJjbGU+CiAgICA8cGF0aCBkPSJNIDQzMCw5NiBMIDQzMSw5OSBMIDQzNCwxMDAgTCA0MzEsMTAxIEwgNDMwLDEwNCBMIDQyOSwxMDEgTCA0MjYsMTAwIEwgNDI5LDk5IFoiIGZpbGw9IiNmZmZmZmYiPgogICAgICA8YW5pbWF0ZSBhdHRyaWJ1dGVOYW1lPSJvcGFjaXR5IiB2YWx1ZXM9IjE7MC41OzEiIGR1cj0iMS41cyIgcmVwZWF0Q291bnQ9ImluZGVmaW5pdGUiLz4KICAgIDwvcGF0aD4KICA8L2c+Cjwvc3ZnPgo="
                  alt="Cupids"
                  style={{ width: '350px', height: 'auto', margin: '0 auto 16px' }}
                />
                <p style={{ 
                  color: '#ec4899', 
                  marginBottom: '24px', 
                  fontSize: '13px', 
                  fontWeight: 'bold', 
                  fontFamily: "'Comic Sans MS', 'Mamelon', sans-serif" 
                }}>
                  æœˆã«ä»£ã‚ã£ã¦ã‚ãªãŸã®æ‹ã‚’å¿œæ´ã—ã¾ã™â™¡
                </p>
              </div>

              {/* å ã„å¸«ä¸€è¦§ */}
              {availableFortuneTellers.length > 0 && (
                <div style={{ marginBottom: '24px' }}>
                  <h2 style={{ fontSize: '16px', fontWeight: 'bold', color: '#1f2937', marginBottom: '12px' }}>
                    ä»Šã™ãå ãˆã‚‹å ã„å¸«
                  </h2>
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '8px', maxHeight: '200px', overflowY: 'auto' }}>
                    {availableFortuneTellers.map((ft) => (
                      <div key={ft.id} style={{
                        background: '#f9fafb',
                        borderRadius: '8px',
                        padding: '12px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '12px',
                        border: '1px solid #e5e7eb'
                      }}>
                        <div style={{
                          width: '40px',
                          height: '40px',
                          borderRadius: '50%',
                          background: 'linear-gradient(135deg, #ec4899, #a855f7)',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          flexShrink: 0
                        }}>
                          <span style={{ color: 'white', fontSize: '16px', fontWeight: 'bold' }}>
                            {ft.name[0]}
                          </span>
                        </div>
                        <div style={{ flex: 1 }}>
                          <h3 style={{ fontSize: '14px', fontWeight: 'bold', color: '#1f2937', marginBottom: '2px' }}>
                            {ft.name}
                          </h3>
                          <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                            <span style={{ fontSize: '12px', color: '#6b7280' }}>
                              â­ {ft.rating?.toFixed(1) || '5.0'}
                            </span>
                            <span style={{ fontSize: '12px', color: '#fbbf24' }}>
                              é‘‘å®šæ•° {ft.reviewCount || 0}ä»¶
                            </span>
                          </div>
                        </div>
                        <div style={{
                          background: '#10b981',
                          color: 'white',
                          padding: '4px 8px',
                          borderRadius: '4px',
                          fontSize: '10px',
                          fontWeight: 'bold',
                          textAlign: 'center',
                          lineHeight: '1.3'
                        }}>
                          <div>ã„ã¾ã™ãå ãˆã‚‹</div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              <div style={{ marginBottom: '16px' }}>
                <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: '#374151', marginBottom: '8px' }}>
                  ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
                </label>
                <input
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  style={{
                    width: '100%',
                    padding: '12px 16px',
                    border: '1px solid #d1d5db',
                    borderRadius: '8px',
                    fontSize: '14px'
                  }}
                  placeholder="your@email.com"
                />
              </div>

              <div style={{ marginBottom: '16px' }}>
                <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: '#374151', marginBottom: '8px' }}>
                  ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
                </label>
                <input
                  type="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                  style={{
                    width: '100%',
                    padding: '12px 16px',
                    border: '1px solid #d1d5db',
                    borderRadius: '8px',
                    fontSize: '14px'
                  }}
                  placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                />
              </div>

              <button
                onClick={handleLogin}
                style={{
                  width: '100%',
                  background: 'linear-gradient(to right, #ec4899, #a855f7)',
                  color: 'white',
                  fontWeight: 'bold',
                  padding: '12px',
                  borderRadius: '8px',
                  border: 'none',
                  cursor: 'pointer',
                  fontSize: '16px'
                }}
              >
                ãƒ­ã‚°ã‚¤ãƒ³
              </button>

              <button
                onClick={() => setScreen('register')}
                style={{
                  width: '100%',
                  background: 'white',
                  color: '#a855f7',
                  fontWeight: 'bold',
                  padding: '12px',
                  borderRadius: '8px',
                  border: '2px solid #a855f7',
                  cursor: 'pointer',
                  fontSize: '16px',
                  marginTop: '12px'
                }}
              >
                æ–°è¦ç™»éŒ²
              </button>
            </div>
          </div>
        );
      }
      
      // æ–°è¦ç™»éŒ²ç”»é¢
      if (screen === 'register') {
        return (
          <div style={{
            minHeight: '100vh',
            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            padding: '32px 16px'
          }}>
            <div style={{
              maxWidth: '600px',
              width: '100%',
              background: 'white',
              borderRadius: '24px',
              padding: '32px',
              boxShadow: '0 20px 60px rgba(0,0,0,0.3)'
            }}>
              <div style={{ textAlign: 'center', marginBottom: '24px' }}>
                <div style={{ fontSize: '48px', marginBottom: '16px' }}>ğŸŒ™</div>
                <h1 style={{ fontSize: '28px', fontWeight: 'bold', color: '#667eea', marginBottom: '8px' }}>
                  æ–°è¦ç™»éŒ²
                </h1>
              </div>

              <div style={{ 
                display: 'flex', 
                gap: '8px', 
                marginBottom: '24px',
                borderBottom: '2px solid #e5e7eb'
              }}>
                <button
                  onClick={() => setRegistrationType('client')}
                  style={{
                    flex: 1,
                    padding: '12px',
                    background: registrationType === 'client' ? 'linear-gradient(to right, #ec4899, #a855f7)' : 'transparent',
                    color: registrationType === 'client' ? 'white' : '#6b7280',
                    border: 'none',
                    borderBottom: registrationType === 'client' ? '3px solid #ec4899' : 'none',
                    cursor: 'pointer',
                    fontSize: '16px',
                    fontWeight: 'bold',
                    borderRadius: '8px 8px 0 0'
                  }}
                >
                  ãŠå®¢æ§˜
                </button>
                <button
                  onClick={() => setRegistrationType('fortune-teller')}
                  style={{
                    flex: 1,
                    padding: '12px',
                    background: registrationType === 'fortune-teller' ? 'linear-gradient(to right, #ec4899, #a855f7)' : 'transparent',
                    color: registrationType === 'fortune-teller' ? 'white' : '#6b7280',
                    border: 'none',
                    borderBottom: registrationType === 'fortune-teller' ? '3px solid #ec4899' : 'none',
                    cursor: 'pointer',
                    fontSize: '16px',
                    fontWeight: 'bold',
                    borderRadius: '8px 8px 0 0'
                  }}
                >
                  å ã„å¸«
                </button>
              </div>

              {registrationType === 'client' ? (
                <div>
                  <div style={{ marginBottom: '16px' }}>
                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: '#374151', marginBottom: '8px' }}>
                      ãŠåå‰ <span style={{ color: '#ef4444' }}>*</span>
                    </label>
                    <input
                      type="text"
                      value={clientName}
                      onChange={(e) => setClientName(e.target.value)}
                      style={{
                        width: '100%',
                        padding: '12px 16px',
                        border: '1px solid #d1d5db',
                        borderRadius: '8px',
                        fontSize: '14px'
                      }}
                      placeholder="å±±ç”°å¤ªéƒ"
                    />
                  </div>
                  <div style={{ marginBottom: '16px' }}>
                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: '#374151', marginBottom: '8px' }}>
                      ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ <span style={{ color: '#ef4444' }}>*</span>
                    </label>
                    <input
                      type="email"
                      value={clientEmail}
                      onChange={(e) => setClientEmail(e.target.value)}
                      style={{
                        width: '100%',
                        padding: '12px 16px',
                        border: '1px solid #d1d5db',
                        borderRadius: '8px',
                        fontSize: '14px'
                      }}
                      placeholder="your@email.com"
                    />
                  </div>
                  <div style={{ marginBottom: '24px' }}>
                    <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', color: '#374151', marginBottom: '8px' }}>
                      ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ <span style={{ color: '#ef4444' }}>*</span>
                    </label>
                    <input
                      type="password"
                      value={clientPassword}
                      onChange={(e) => setClientPassword(e.target.value)}
                      style={{
                        width: '100%',
                        padding: '12px 16px',
                        border: '1px solid #d1d5db',
                        borderRadius: '8px',
                        fontSize: '14px'
                      }}
                      placeholder="6æ–‡å­—ä»¥ä¸Š"
                    />
                  </div>
                  <button
                    onClick={handleClientRegister}
                    style={{
                      width: '100%',
                      background: 'linear-gradient(to right, #ec4899, #a855f7)',
                      color: 'white',
                      fontWeight: 'bold',
                      padding: '14px',
                      borderRadius: '8px',
                      border: 'none',
                      cursor: 'pointer',
                      fontSize: '16px',
                      marginBottom: '12px'
                    }}
                  >
                    ç™»éŒ²ã™ã‚‹
                  </button>
                </div>
              ) : (
                <div style={{ textAlign: 'center', padding: '20px' }}>
                  <p style={{ fontSize: '14px', color: '#6b7280', marginBottom: '20px' }}>
                    å ã„å¸«ã¨ã—ã¦ç™»éŒ²ã™ã‚‹ã«ã¯ã€Googleãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰å¿œå‹Ÿã—ã¦ãã ã•ã„ã€‚
                  </p>
                  <button
                    onClick={() => {
                      window.open('https://docs.google.com/forms/d/e/1FAIpQLSd47fyl7SSNBOcgdRyuKMx9N0rQVb9nZnlMfSlHlN4IEGbDpw/viewform', '_blank');
                      alert('Googleãƒ•ã‚©ãƒ¼ãƒ ãŒé–‹ãã¾ã—ãŸã€‚\nãƒ•ã‚©ãƒ¼ãƒ ã«å…¥åŠ›ã—ã¦é€ä¿¡ã—ã¦ãã ã•ã„ã€‚\nå¯©æŸ»çµæœã¯ãƒ¡ãƒ¼ãƒ«ã§ãŠçŸ¥ã‚‰ã›ã—ã¾ã™ã€‚');
                      setScreen('login');
                    }}
                    style={{
                      background: 'linear-gradient(to right, #ec4899, #a855f7)',
                      color: 'white',
                      fontWeight: 'bold',
                      padding: '14px 32px',
                      borderRadius: '8px',
                      border: 'none',
                      cursor: 'pointer',
                      fontSize: '16px'
                    }}
                  >
                    Googleãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã
                  </button>
                </div>
              )}

              <button
                onClick={() => setScreen('login')}
                style={{
                  width: '100%',
                  background: 'white',
                  color: '#6b7280',
                  fontWeight: 'bold',
                  padding: '12px',
                  borderRadius: '8px',
                  border: '1px solid #d1d5db',
                  cursor: 'pointer',
                  fontSize: '14px'
                }}
              >
                ãƒ­ã‚°ã‚¤ãƒ³ã«æˆ»ã‚‹
              </button>
            </div>
          </div>
        );
      }
      
      // ãƒã‚¤ãƒ³ãƒˆè³¼å…¥ç”»é¢
      if (screen === 'purchase') {
        const pointPackages = [
          { id: 1, points: 500, basePoints: 500, bonusPoints: 0, price: 500, popular: false, url: 'https://minamisan.square.site/product/-cupids-500-/1?cs=true&cst=popular' },
          { id: 2, points: 1500, basePoints: 1500, bonusPoints: 0, price: 1500, popular: false, url: 'https://minamisan.square.site/product/-cupids-1500-/2?si=true' },
          { id: 3, points: 3100, basePoints: 3000, bonusPoints: 100, price: 3000, popular: true, url: 'https://minamisan.square.site/product/-cupids-3100-100pt-/3?si=true' },
          { id: 4, points: 6250, basePoints: 6000, bonusPoints: 250, price: 6000, popular: false, url: 'https://minamisan.square.site/product/-cupids-6250-250pt-/4?si=true' }
        ];

        return (
          <div style={{ minHeight: '100vh', background: '#f9fafb' }}>
            <div style={{
              background: 'linear-gradient(to right, #ec4899, #a855f7)',
              padding: '16px',
              boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
            }}>
              <div style={{
                maxWidth: '800px',
                margin: '0 auto',
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center'
              }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                  <button
                    onClick={() => setScreen('lobby')}
                    style={{
                      background: 'rgba(255,255,255,0.2)',
                      color: 'white',
                      padding: '8px',
                      borderRadius: '8px',
                      border: '1px solid rgba(255,255,255,0.3)',
                      cursor: 'pointer'
                    }}
                  >
                    â†
                  </button>
                  <h1 style={{ fontSize: '20px', fontWeight: 'bold', color: 'white' }}>
                    ãƒã‚¤ãƒ³ãƒˆè³¼å…¥
                  </h1>
                </div>
                <div style={{
                  background: 'rgba(255,255,255,0.2)',
                  padding: '8px 16px',
                  borderRadius: '8px',
                  border: '1px solid rgba(255,255,255,0.3)'
                }}>
                  <span style={{ color: 'white', fontSize: '14px', fontWeight: '600' }}>
                    ç¾åœ¨: {currentUser.points}pt
                  </span>
                </div>
              </div>
            </div>

            <div style={{ maxWidth: '800px', margin: '0 auto', padding: '24px 16px' }}>
              <div style={{
                background: '#f9fafb',
                borderRadius: '12px',
                padding: '20px',
                marginBottom: '24px',
                border: '1px solid #e5e7eb'
              }}>
                <h3 style={{ fontSize: '14px', fontWeight: 'bold', color: '#1f2937', marginBottom: '12px' }}>
                  ã”è³¼å…¥ã®æµã‚Œ
                </h3>
                <ol style={{ fontSize: '14px', color: '#6b7280', lineHeight: '1.8', paddingLeft: '20px', marginBottom: '12px' }}>
                  <li>ãŠå¥½ããªãƒã‚¤ãƒ³ãƒˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã€Œè³¼å…¥ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                  <li>æ±ºæ¸ˆãƒšãƒ¼ã‚¸ãŒé–‹ãã¾ã™ã®ã§ã€ãŠæ”¯æ‰•ã„æƒ…å ±ã‚’å…¥åŠ›</li>
                  <li>è³¼å…¥å®Œäº†å¾Œã€ãƒ¡ãƒ¼ãƒ«ã§ãƒãƒ£ãƒ¼ã‚¸ã‚³ãƒ¼ãƒ‰ãŒé€ã‚‰ã‚Œã¾ã™</li>
                  <li>ãƒãƒ£ãƒ¼ã‚¸ã‚³ãƒ¼ãƒ‰ã‚’ä¸‹ã®å…¥åŠ›æ¬„ã«å…¥åŠ›ã—ã¦ãƒã‚¤ãƒ³ãƒˆã‚’ãƒãƒ£ãƒ¼ã‚¸</li>
                </ol>
                <p style={{ fontSize: '12px', color: '#6b7280', marginTop: '8px' }}>
                  â€»1å††ã§1ãƒã‚¤ãƒ³ãƒˆã«ãªã‚Šã¾ã™
                </p>
              </div>

              <div style={{
                background: 'white',
                borderRadius: '12px',
                padding: '24px',
                marginBottom: '24px',
                boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
              }}>
                <h2 style={{ fontSize: '18px', fontWeight: 'bold', color: '#1f2937', marginBottom: '16px' }}>
                  ãƒãƒ£ãƒ¼ã‚¸ã‚³ãƒ¼ãƒ‰ã‚’ãŠæŒã¡ã®æ–¹
                </h2>
                <div style={{ display: 'flex', gap: '12px' }}>
                  <input
                    type="text"
                    value={chargeCode}
                    onChange={(e) => setChargeCode(e.target.value)}
                    placeholder="ãƒãƒ£ãƒ¼ã‚¸ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›"
                    style={{
                      flex: 1,
                      padding: '12px',
                      border: '1px solid #e5e7eb',
                      borderRadius: '8px',
                      fontSize: '14px'
                    }}
                  />
                  <button
                    onClick={handleChargeCode}
                    style={{
                      background: 'linear-gradient(to right, #ec4899, #a855f7)',
                      color: 'white',
                      padding: '12px 24px',
                      borderRadius: '8px',
                      border: 'none',
                      cursor: 'pointer',
                      fontWeight: 'bold',
                      fontSize: '14px'
                    }}
                  >
                    ãƒãƒ£ãƒ¼ã‚¸
                  </button>
                </div>
              </div>

              <h2 style={{ fontSize: '20px', fontWeight: 'bold', color: '#1f2937', marginBottom: '16px' }}>
                ãƒã‚¤ãƒ³ãƒˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
              </h2>
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(180px, 1fr))', gap: '16px' }}>
                {pointPackages.map(pkg => (
                  <div
                    key={pkg.id}
                    style={{
                      background: 'white',
                      borderRadius: '12px',
                      padding: '20px',
                      boxShadow: '0 2px 8px rgba(0,0,0,0.1)',
                      border: pkg.popular ? '2px solid #ec4899' : '1px solid #e5e7eb',
                      position: 'relative'
                    }}
                  >
                    {pkg.popular && (
                      <div style={{
                        position: 'absolute',
                        top: '-10px',
                        right: '10px',
                        background: '#ec4899',
                        color: 'white',
                        padding: '4px 12px',
                        borderRadius: '12px',
                        fontSize: '12px',
                        fontWeight: 'bold'
                      }}>
                        äººæ°—
                      </div>
                    )}
                    <div style={{ fontSize: '32px', fontWeight: 'bold', color: '#1f2937', marginBottom: '8px' }}>
                      {pkg.points}pt
                    </div>
                    {pkg.bonusPoints > 0 && (
                      <div style={{ fontSize: '12px', color: '#ec4899', marginBottom: '8px' }}>
                        +{pkg.bonusPoints}pt ãƒœãƒ¼ãƒŠã‚¹
                      </div>
                    )}
                    <div style={{ fontSize: '20px', fontWeight: 'bold', color: '#6b7280', marginBottom: '16px' }}>
                      Â¥{pkg.price.toLocaleString()}
                    </div>
                    <button
                      onClick={() => {
                        window.open(pkg.url, '_blank');
                        alert('è³¼å…¥å®Œäº†å¾Œã€ãƒ¡ãƒ¼ãƒ«ã«è¨˜è¼‰ã•ã‚ŒãŸãƒãƒ£ãƒ¼ã‚¸ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                      }}
                      style={{
                        width: '100%',
                        background: 'linear-gradient(to right, #ec4899, #a855f7)',
                        color: 'white',
                        padding: '10px',
                        borderRadius: '8px',
                        border: 'none',
                        cursor: 'pointer',
                        fontWeight: 'bold',
                        fontSize: '14px'
                      }}
                    >
                      è³¼å…¥ã™ã‚‹
                    </button>
                  </div>
                ))}
              </div>
            </div>
          </div>
        );
      }

      // ãƒ­ãƒ“ãƒ¼ç”»é¢
      if (screen === 'lobby') {
        return (
          <div style={{ minHeight: '100vh', background: '#f9fafb' }}>
            <div style={{
              background: 'linear-gradient(to right, #ec4899, #a855f7)',
              padding: '16px',
              boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
            }}>
              <div style={{
                maxWidth: '1200px',
                margin: '0 auto',
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center'
              }}>
                <div>
                  <h1 style={{ fontSize: '24px', fontWeight: 'bold', color: 'white', marginBottom: '4px' }}>
                    Cupids
                  </h1>
                  <p style={{ fontSize: '12px', color: 'rgba(255,255,255,0.9)' }}>
                    {currentUser?.name}ã•ã‚“
                  </p>
                </div>
                <div style={{ display: 'flex', gap: '12px', alignItems: 'center' }}>
                  {currentUser?.type === 'client' && (
                    <>
                      <div style={{
                        background: 'rgba(255,255,255,0.2)',
                        padding: '8px 16px',
                        borderRadius: '8px',
                        fontSize: '16px',
                        fontWeight: 'bold',
                        color: 'white'
                      }}>
                        {currentUser.points}pt
                      </div>
                      <button
                        onClick={() => setScreen('purchase')}
                        style={{
                          background: '#10b981',
                          color: 'white',
                          padding: '8px 16px',
                          borderRadius: '8px',
                          border: 'none',
                          cursor: 'pointer',
                          fontSize: '14px',
                          fontWeight: '600'
                        }}
                      >
                        ãƒã‚¤ãƒ³ãƒˆè³¼å…¥
                      </button>
                    </>
                  )}
                  <button
                    onClick={handleLogout}
                    style={{
                      background: 'rgba(255,255,255,0.2)',
                      color: 'white',
                      padding: '8px 16px',
                      borderRadius: '8px',
                      border: '1px solid rgba(255,255,255,0.3)',
                      cursor: 'pointer',
                      fontSize: '14px',
                      fontWeight: '600'
                    }}
                  >
                    ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                  </button>
                </div>
              </div>
            </div>

            <div style={{ maxWidth: '1200px', margin: '0 auto', padding: '32px 16px' }}>
              {currentUser?.type === 'client' ? (
                <div>
                  <h2 style={{ fontSize: '24px', fontWeight: 'bold', color: '#1f2937', marginBottom: '16px' }}>
                    å ã„å¸«ä¸€è¦§
                  </h2>
                  {fortuneTellers.length === 0 ? (
                    <p style={{ color: '#6b7280' }}>å ã„å¸«ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                  ) : (
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))', gap: '16px' }}>
                      {fortuneTellers.map((ft) => (
                        <div
                          key={ft.id}
                          style={{
                            background: 'white',
                            borderRadius: '12px',
                            padding: '20px',
                            boxShadow: '0 2px 8px rgba(0,0,0,0.1)',
                            cursor: 'pointer'
                          }}
                          onClick={() => handleStartChat(ft)}
                        >
                          <h3 style={{ fontSize: '18px', fontWeight: 'bold', color: '#1f2937', marginBottom: '8px' }}>
                            {ft.name}
                          </h3>
                          <p style={{ fontSize: '14px', color: '#6b7280', marginBottom: '8px' }}>
                            {ft.specialty || 'å ã„å¸«'}
                          </p>
                          <div style={{ fontSize: '14px', color: '#ec4899', fontWeight: 'bold', marginBottom: '12px' }}>
                            {ft.pointsPerChar || 1}pt/æ–‡å­—
                          </div>
                          {ft.rating && (
                            <div style={{ fontSize: '14px', color: '#6b7280' }}>
                              â­ {ft.rating} ({ft.reviewCount || 0}ä»¶)
                            </div>
                          )}
                          <button
                            style={{
                              width: '100%',
                              padding: '10px',
                              background: 'linear-gradient(to right, #ec4899, #a855f7)',
                              color: 'white',
                              borderRadius: '8px',
                              border: 'none',
                              cursor: 'pointer',
                              fontSize: '14px',
                              fontWeight: '600',
                              marginTop: '12px'
                            }}
                          >
                            ğŸ’¬ ãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹
                          </button>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              ) : (
                <div style={{ textAlign: 'center', padding: '48px' }}>
                  <div style={{ fontSize: '64px', marginBottom: '16px' }}>ğŸ”®</div>
                  <h2 style={{ fontSize: '24px', fontWeight: 'bold', color: '#1f2937', marginBottom: '8px' }}>
                    å ã„å¸«ãƒ¢ãƒ¼ãƒ‰
                  </h2>
                  <p style={{ fontSize: '16px', color: '#6b7280' }}>
                    ãŠå®¢æ§˜ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãŠå¾…ã¡ã—ã¦ã„ã¾ã™
                  </p>
                </div>
              )}
            </div>
          </div>
        );
      }
      
      // ãƒãƒ£ãƒƒãƒˆç”»é¢
      if (screen === 'chat' && selectedFortuneTeller && currentChat) {
        const [isFreeMode, setIsFreeMode] = useState(true);
        const [showTemplates, setShowTemplates] = useState(false);
        
        const pointsPerChar = selectedFortuneTeller?.pointsPerChar || 1;
        const isClient = currentUser.type === 'client';
        
        // æœ€å¤§æ–‡å­—æ•°è¨ˆç®—
        let maxAllowedChars = maxChars;
        if (isClient) {
          maxAllowedChars = Math.min(Math.floor(currentUser.points / pointsPerChar), maxChars);
        } else if (!isFreeMode) {
          // å ã„å¸«ãŒæœ‰æ–™ãƒ¢ãƒ¼ãƒ‰ã®æ™‚ã¯ç›¸æ‰‹ã®ãƒã‚¤ãƒ³ãƒˆã§è¨ˆç®—ï¼ˆç°¡æ˜“å®Ÿè£…ï¼‰
          maxAllowedChars = maxChars;
        }

        return (
          <div style={{ height: '100vh', background: '#f9fafb', display: 'flex', flexDirection: 'column' }}>
            {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
            <div style={{
              background: 'linear-gradient(to right, #ec4899, #a855f7)',
              padding: '16px',
              boxShadow: '0 2px 8px rgba(0,0,0,0.1)',
              flexShrink: 0
            }}>
              <div style={{ maxWidth: '1024px', margin: '0 auto', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                  <button
                    onClick={() => {
                      setScreen('lobby');
                      setSelectedFortuneTeller(null);
                      setCurrentChat(null);
                    }}
                    style={{
                      background: 'rgba(255,255,255,0.2)',
                      color: 'white',
                      padding: '8px',
                      borderRadius: '8px',
                      border: '1px solid rgba(255,255,255,0.3)',
                      cursor: 'pointer'
                    }}
                  >
                    â†
                  </button>
                  <div style={{
                    width: '40px',
                    height: '40px',
                    borderRadius: '50%',
                    background: 'linear-gradient(135deg, #ec4899, #a855f7)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center'
                  }}>
                    <span style={{ color: 'white', fontSize: '16px', fontWeight: 'bold' }}>
                      {selectedFortuneTeller.name[0]}
                    </span>
                  </div>
                  <div>
                    <h2 style={{ fontSize: '16px', fontWeight: 'bold', color: 'white' }}>
                      {selectedFortuneTeller.name}
                    </h2>
                    {selectedFortuneTeller.specialty && (
                      <p style={{ fontSize: '12px', color: 'rgba(255,255,255,0.9)' }}>
                        {selectedFortuneTeller.specialty}
                      </p>
                    )}
                  </div>
                </div>
                <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                  {isClient && (
                    <div style={{
                      background: 'rgba(255,255,255,0.2)',
                      padding: '8px 16px',
                      borderRadius: '8px',
                      fontSize: '14px',
                      fontWeight: '600',
                      color: 'white'
                    }}>
                      {currentUser.points}pt
                    </div>
                  )}
                </div>
              </div>
            </div>

            {/* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ */}
            <div style={{ flex: 1, overflowY: 'auto', padding: '16px', maxWidth: '1024px', width: '100%', margin: '0 auto' }}>
              {messages.length === 0 ? (
                <div style={{ textAlign: 'center', padding: '48px', color: '#6b7280' }}>
                  ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¦ä¼šè©±ã‚’é–‹å§‹ã—ã¾ã—ã‚‡ã†
                </div>
              ) : (
                messages.map((msg) => {
                  const isMe = msg.senderId === currentUser.id;
                  const isFreeMessage = msg.isFree;
                  
                  let bgColor, textColor, border;
                  if (isFreeMessage) {
                    bgColor = 'white';
                    textColor = '#1f2937';
                    border = '1px solid #e5e7eb';
                  } else {
                    bgColor = '#ec4899';
                    textColor = 'white';
                    border = 'none';
                  }
                  
                  const displayText = isFreeMessage ? `ã€ç„¡æ–™ã€‘${msg.text}` : msg.text;
                  
                  return (
                    <div key={msg.id} style={{
                      display: 'flex',
                      justifyContent: isMe ? 'flex-end' : 'flex-start',
                      marginBottom: '12px'
                    }}>
                      <div style={{ display: 'flex', alignItems: 'start', gap: '8px', maxWidth: '70%' }}>
                        {!isMe && (
                          <div style={{
                            width: '40px',
                            height: '40px',
                            borderRadius: '50%',
                            background: 'linear-gradient(135deg, #ec4899, #a855f7)',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            flexShrink: 0
                          }}>
                            <span style={{ color: 'white', fontSize: '14px', fontWeight: 'bold' }}>
                              {selectedFortuneTeller.name[0]}
                            </span>
                          </div>
                        )}
                        <div>
                          <div style={{
                            padding: '12px 16px',
                            borderRadius: '16px',
                            background: bgColor,
                            color: textColor,
                            border: border,
                            borderBottomRightRadius: isMe ? '4px' : '16px',
                            borderBottomLeftRadius: isMe ? '16px' : '4px'
                          }}>
                            <p style={{ whiteSpace: 'pre-line', wordBreak: 'break-word', margin: 0 }}>{displayText}</p>
                          </div>
                          <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginTop: '4px', justifyContent: isMe ? 'flex-end' : 'flex-start' }}>
                            <p style={{ fontSize: '12px', color: '#6b7280', margin: 0 }}>
                              {msg.createdAt ? new Date(msg.createdAt).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }) : ''}
                            </p>
                          </div>
                        </div>
                        {isMe && (
                          <div style={{
                            width: '40px',
                            height: '40px',
                            borderRadius: '50%',
                            background: 'linear-gradient(135deg, #fbbf24, #f59e0b)',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            flexShrink: 0
                          }}>
                            <span style={{ color: 'white', fontSize: '14px', fontWeight: 'bold' }}>
                              {currentUser.name[0]}
                            </span>
                          </div>
                        )}
                      </div>
                    </div>
                  );
                })
              )}
              <div ref={messagesEndRef} />
            </div>

            {/* å…¥åŠ›ã‚¨ãƒªã‚¢ */}
            <div style={{ padding: '16px', background: 'white', borderTop: '1px solid #e5e7eb', maxWidth: '1024px', width: '100%', margin: '0 auto', flexShrink: 0 }}>
              {/* ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ */}
              <div style={{ marginBottom: '12px', display: 'flex', gap: '8px', alignItems: 'center', flexWrap: 'wrap' }}>
                {isClient ? (
                  <>
                    <button
                      onClick={() => setShowTemplates(!showTemplates)}
                      style={{
                        padding: '8px 16px',
                        background: '#16a34a',
                        color: 'white',
                        borderRadius: '8px',
                        border: 'none',
                        fontWeight: '600',
                        cursor: 'pointer',
                        fontSize: '14px'
                      }}
                    >
                      å®šå‹æ–‡ï¼ˆç„¡æ–™ï¼‰
                    </button>
                    <span style={{ fontSize: '14px', color: '#6b7280', fontWeight: '500' }}>
                      æ‰€æŒãƒã‚¤ãƒ³ãƒˆ: <span style={{ color: '#ec4899', fontWeight: 'bold' }}>{currentUser.points}pt</span>
                    </span>
                  </>
                ) : (
                  <>
                    <button
                      onClick={() => setIsFreeMode(true)}
                      style={{
                        padding: '8px 16px',
                        background: isFreeMode ? 'white' : '#6b7280',
                        color: isFreeMode ? '#1f2937' : 'white',
                        borderRadius: '8px',
                        border: isFreeMode ? '2px solid #1f2937' : 'none',
                        fontWeight: '600',
                        cursor: 'pointer',
                        fontSize: '14px'
                      }}
                    >
                      ç„¡æ–™ãƒãƒ£ãƒƒãƒˆ
                    </button>
                    <button
                      onClick={() => setIsFreeMode(false)}
                      style={{
                        padding: '8px 16px',
                        background: !isFreeMode ? '#ec4899' : '#6b7280',
                        color: 'white',
                        borderRadius: '8px',
                        border: !isFreeMode ? '2px solid #ec4899' : 'none',
                        fontWeight: '600',
                        cursor: 'pointer',
                        fontSize: '14px'
                      }}
                    >
                      æœ‰æ–™ãƒãƒ£ãƒƒãƒˆ
                    </button>
                    <button
                      onClick={() => setShowTemplates(!showTemplates)}
                      style={{
                        padding: '8px 16px',
                        background: '#6b7280',
                        color: 'white',
                        borderRadius: '8px',
                        border: 'none',
                        fontWeight: '600',
                        cursor: 'pointer',
                        fontSize: '14px'
                      }}
                    >
                      å®šå‹æ–‡
                    </button>
                  </>
                )}
              </div>

              {/* å®šå‹æ–‡ãƒªã‚¹ãƒˆ */}
              {showTemplates && isClient && (
                <div style={{
                  marginBottom: '12px',
                  background: 'white',
                  border: '1px solid #e5e7eb',
                  borderRadius: '8px',
                  padding: '12px'
                }}>
                  {['ã”ç›¸è«‡ãŒã‚ã‚Šã¾ã™', 'ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™', 'ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™'].map((template, index) => (
                    <button
                      key={index}
                      onClick={async () => {
                        const chatId = [currentUser.id, selectedFortuneTeller.id].sort().join('_');
                        await db.collection('chats').doc(chatId).collection('messages').add({
                          text: template,
                          senderId: currentUser.id,
                          senderName: currentUser.name,
                          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                          createdAt: new Date().toISOString(),
                          isFree: true
                        });
                        setShowTemplates(false);
                      }}
                      style={{
                        width: '100%',
                        textAlign: 'left',
                        padding: '12px',
                        background: '#f3f4f6',
                        border: '1px solid #e5e7eb',
                        borderRadius: '4px',
                        marginBottom: '8px',
                        cursor: 'pointer',
                        fontSize: '14px',
                        color: '#1f2937'
                      }}
                    >
                      {template}
                    </button>
                  ))}
                </div>
              )}

              {showTemplates && !isClient && (
                <div style={{
                  marginBottom: '12px',
                  background: '#1f2937',
                  border: '1px solid #374151',
                  borderRadius: '8px',
                  padding: '16px'
                }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                    <h4 style={{ fontSize: '14px', fontWeight: 'bold', color: 'white', marginTop: 0, marginBottom: 0 }}>å®šå‹æ–‡</h4>
                    <button
                      onClick={() => {
                        setTempTemplates([...fortuneTellerTemplates]);
                        setEditingTemplates(true);
                      }}
                      style={{
                        padding: '6px 12px',
                        background: '#374151',
                        color: 'white',
                        borderRadius: '6px',
                        border: 'none',
                        cursor: 'pointer',
                        fontSize: '12px',
                        fontWeight: '600'
                      }}
                    >
                      âœï¸ ç·¨é›†
                    </button>
                  </div>
                  {fortuneTellerTemplates.map((template, index) => (
                    <button
                      key={index}
                      onClick={async () => {
                        const chatId = [currentUser.id, selectedFortuneTeller.id].sort().join('_');
                        await db.collection('chats').doc(chatId).collection('messages').add({
                          text: template,
                          senderId: currentUser.id,
                          senderName: currentUser.name,
                          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                          createdAt: new Date().toISOString(),
                          isFree: true
                        });
                        setShowTemplates(false);
                      }}
                      style={{
                        width: '100%',
                        textAlign: 'left',
                        padding: '12px',
                        background: '#374151',
                        border: 'none',
                        borderRadius: '4px',
                        marginBottom: '8px',
                        cursor: 'pointer',
                        fontSize: '14px',
                        color: 'white'
                      }}
                    >
                      {template}
                    </button>
                  ))}
                </div>
              )}

              {/* å®šå‹æ–‡ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« */}
              {editingTemplates && !isClient && (
                <div 
                  style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    background: 'rgba(0,0,0,0.5)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    zIndex: 1000
                  }} 
                  onClick={() => setEditingTemplates(false)}
                >
                  <div 
                    style={{
                      background: 'white',
                      borderRadius: '12px',
                      padding: '24px',
                      width: '90%',
                      maxWidth: '600px',
                      maxHeight: '80vh',
                      overflowY: 'auto'
                    }} 
                    onClick={(e) => e.stopPropagation()}
                  >
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                      <h3 style={{ fontSize: '18px', fontWeight: 'bold', margin: 0 }}>å®šå‹æ–‡ã‚’ç·¨é›†</h3>
                      <button
                        onClick={() => setEditingTemplates(false)}
                        style={{
                          background: 'transparent',
                          border: 'none',
                          cursor: 'pointer',
                          padding: '4px',
                          fontSize: '24px',
                          color: '#6b7280'
                        }}
                      >
                        Ã—
                      </button>
                    </div>

                    <div style={{ marginBottom: '24px' }}>
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                        <h4 style={{ fontSize: '16px', fontWeight: 'bold', color: '#1f2937', margin: 0 }}>å®šå‹æ–‡</h4>
                        <button
                          onClick={() => {
                            setTempTemplates([...tempTemplates, '']);
                          }}
                          style={{
                            padding: '6px 12px',
                            background: '#a855f7',
                            color: 'white',
                            borderRadius: '6px',
                            border: 'none',
                            cursor: 'pointer',
                            fontSize: '14px',
                            fontWeight: '600'
                          }}
                        >
                          â• å®šå‹æ–‡ã‚’è¿½åŠ 
                        </button>
                      </div>
                      {tempTemplates.map((template, index) => (
                        <div key={index} style={{ display: 'flex', gap: '8px', marginBottom: '8px' }}>
                          <input
                            type="text"
                            value={template}
                            onChange={(e) => {
                              const newTemplates = [...tempTemplates];
                              newTemplates[index] = e.target.value;
                              setTempTemplates(newTemplates);
                            }}
                            style={{
                              flex: 1,
                              padding: '8px 12px',
                              border: '1px solid #e5e7eb',
                              borderRadius: '6px',
                              fontSize: '14px'
                            }}
                            placeholder="å®šå‹æ–‡ã‚’å…¥åŠ›"
                          />
                          <button
                            onClick={() => {
                              const newTemplates = tempTemplates.filter((_, i) => i !== index);
                              setTempTemplates(newTemplates);
                            }}
                            style={{
                              padding: '8px',
                              background: '#ef4444',
                              color: 'white',
                              border: 'none',
                              borderRadius: '6px',
                              cursor: 'pointer',
                              fontSize: '16px'
                            }}
                          >
                            Ã—
                          </button>
                        </div>
                      ))}
                    </div>

                    <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                      <button
                        onClick={() => setEditingTemplates(false)}
                        style={{
                          padding: '10px 20px',
                          background: '#e5e7eb',
                          color: '#374151',
                          borderRadius: '8px',
                          border: 'none',
                          cursor: 'pointer',
                          fontWeight: '600'
                        }}
                      >
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                      </button>
                      <button
                        onClick={() => {
                          setFortuneTellerTemplates([...tempTemplates]);
                          setEditingTemplates(false);
                        }}
                        style={{
                          padding: '10px 20px',
                          background: 'linear-gradient(to right, #ec4899, #a855f7)',
                          color: 'white',
                          borderRadius: '8px',
                          border: 'none',
                          cursor: 'pointer',
                          fontWeight: '600'
                        }}
                      >
                        ä¿å­˜
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* ãƒã‚¤ãƒ³ãƒˆä¸è¶³è­¦å‘Š */}
              {isClient && currentUser.points < pointsPerChar && (
                <div style={{
                  background: '#fef2f2',
                  border: '1px solid #fecaca',
                  borderRadius: '8px',
                  padding: '12px',
                  marginBottom: '12px',
                  fontSize: '14px',
                  color: '#991b1b'
                }}>
                  âš ï¸ ãƒã‚¤ãƒ³ãƒˆãŒä¸è¶³ã—ã¦ã„ã¾ã™
                  <button
                    onClick={() => setScreen('purchase')}
                    style={{
                      marginLeft: '8px',
                      background: '#ef4444',
                      color: 'white',
                      padding: '4px 12px',
                      borderRadius: '4px',
                      border: 'none',
                      cursor: 'pointer',
                      fontSize: '12px'
                    }}
                  >
                    ãƒã‚¤ãƒ³ãƒˆè³¼å…¥
                  </button>
                </div>
              )}

              {/* æ–‡å­—æ•°ã¨ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤º */}
              <div style={{ marginBottom: '8px', fontSize: '12px', color: '#6b7280', textAlign: 'right' }}>
                {messageText.length}/{maxAllowedChars}æ–‡å­— 
                {isClient && ` (${messageText.length * pointsPerChar}pt)`}
                {!isClient && !isFreeMode && ` (${messageText.length * pointsPerChar}pt)`}
              </div>

              {/* å…¥åŠ›æ¬„ã¨é€ä¿¡ãƒœã‚¿ãƒ³ */}
              <div style={{ display: 'flex', gap: '12px' }}>
                <textarea
                  value={messageText}
                  onChange={(e) => {
                    if (e.target.value.length <= maxAllowedChars) {
                      setMessageText(e.target.value);
                    }
                  }}
                  onKeyPress={(e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                      e.preventDefault();
                      handleSendMessage();
                    }
                  }}
                  placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."
                  style={{
                    flex: 1,
                    padding: '12px 16px',
                    border: '1px solid #d1d5db',
                    borderRadius: '8px',
                    fontSize: '14px',
                    minHeight: '60px',
                    resize: 'vertical',
                    fontFamily: 'inherit'
                  }}
                />
                <button
                  onClick={async () => {
                    if (!messageText.trim()) return;
                    
                    const pointCost = isClient || !isFreeMode ? messageText.length * pointsPerChar : 0;
                    
                    if (isClient && currentUser.points < pointCost) {
                      alert(`ãƒã‚¤ãƒ³ãƒˆãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚${pointCost}ptå¿…è¦ã§ã™ã€‚`);
                      return;
                    }
                    
                    const textToSend = messageText;
                    setMessageText('');
                    
                    try {
                      await db.collection('chats').doc(currentChat).collection('messages').add({
                        text: textToSend,
                        senderId: currentUser.id,
                        senderName: currentUser.name,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        createdAt: new Date().toISOString(),
                        isFree: !isClient ? isFreeMode : false
                      });
                      
                      if (isClient && pointCost > 0) {
                        await db.collection('users').doc(currentUser.id).update({
                          points: firebase.firestore.FieldValue.increment(-pointCost)
                        });
                      }
                    } catch (error) {
                      alert('é€ä¿¡å¤±æ•—: ' + error.message);
                      setMessageText(textToSend);
                    }
                  }}
                  disabled={!messageText.trim() || (isClient && currentUser.points < messageText.length * pointsPerChar)}
                  style={{
                    padding: '12px 20px',
                    background: (messageText.trim() && !(isClient && currentUser.points < messageText.length * pointsPerChar))
                      ? 'linear-gradient(to right, #ec4899, #a855f7)' 
                      : '#d1d5db',
                    color: 'white',
                    borderRadius: '8px',
                    border: 'none',
                    cursor: (messageText.trim() && !(isClient && currentUser.points < messageText.length * pointsPerChar))
                      ? 'pointer' 
                      : 'not-allowed',
                    fontSize: '14px',
                    fontWeight: '600'
                  }}
                >
                  é€ä¿¡
                </button>
              </div>
            </div>
          </div>
        );
      }
      
      return <div style={{ padding: '20px', textAlign: 'center' }}>ç”»é¢: {screen}</div>;
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<FortuneServiceApp />);
  </script>
</body>
</html>

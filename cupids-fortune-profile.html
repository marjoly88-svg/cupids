<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å ã„å¸«ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« - ã‚­ãƒ¥ãƒ¼ãƒ”ãƒƒã‚º</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Hiragino Sans", sans-serif;
            background: #f9fafb;
            color: #111827;
        }

        .page {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            position: sticky;
            top: 0;
            z-index: 20;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: #ffffff;
            box-shadow: 0 1px 6px rgba(0,0,0,0.06);
        }

        .back-button {
            border: none;
            background: none;
            font-size: 18px;
            cursor: pointer;
            padding: 4px 8px;
        }

        .header-title {
            font-size: 16px;
            font-weight: 600;
        }

        /* ãƒ¡ã‚¤ãƒ³ */
        .main {
            flex: 1;
            padding: 16px;
            padding-bottom: 96px; /* ä¸‹ã®ãƒãƒ£ãƒƒãƒˆãƒœã‚¿ãƒ³ã¶ã‚“ä½™ç™½ */
            max-width: 900px;
            margin: 0 auto;
        }

        .profile-container {
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(15,23,42,0.08);
            padding: 24px 20px 16px;
        }

        .loading {
            text-align: center;
            padding: 40px 0;
            color: #6b7280;
        }

        /* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .profile-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            margin-bottom: 16px;
        }

        .profile-avatar {
            width: 96px;
            height: 96px;
            border-radius: 999px;
            overflow: hidden;
            margin-bottom: 12px;
            border: 3px solid #f9a8d4;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            font-weight: 600;
            color: #4b5563;
            object-fit: cover;
        }

        .profile-name {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .profile-rating {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 10px;
        }

        .profile-rating .star {
            color: #fbbf24;
            font-size: 18px;
        }

        .profile-status {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 4px 12px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .profile-status.available {
            background: #dcfce7;
            color: #166534;
        }

        .profile-status.accepting {
            background: #e0f2fe;
            color: #075985;
        }

        .profile-status.stopped {
            background: #fee2e2;
            color: #b91c1c;
        }

        .profile-price {
            font-size: 14px;
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 8px;
        }

        .point-purchase-link {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-top: 4px;
            padding: 8px 18px;
            border-radius: 999px;
            font-size: 13px;
            font-weight: 600;
            border: none;
            text-decoration: none;
            background: #fef3c7;
            color: #92400e;
        }

        /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .profile-section {
            margin-top: 18px;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 8px;
        }

        .profile-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .profile-tag {
            padding: 4px 10px;
            border-radius: 999px;
            background: #eff6ff;
            color: #1d4ed8;
            font-size: 12px;
        }

        .profile-description {
            font-size: 14px;
            line-height: 1.7;
            color: #374151;
            white-space: pre-wrap;
        }

        /* ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¦‹ã‚‹ãƒœã‚¿ãƒ³ */
        .review-button {
            width: 100%;
            padding: 10px 16px;
            border-radius: 999px;
            border: 1px solid #e5e7eb;
            background: #ffffff;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            color: #6b21a8;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        }

        .review-button:hover {
            background: #f9fafb;
        }

        /* ãƒãƒ£ãƒƒãƒˆãƒœã‚¿ãƒ³ï¼ˆä¸‹å›ºå®šï¼‰ */
        .chat-button-container {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 8px 16px 14px;
            background: linear-gradient(to top, rgba(15,23,42,0.18), rgba(15,23,42,0.02));
            z-index: 30;
        }

        #chatButton {
            width: 100%;
            padding: 14px 18px;
            border-radius: 999px;
            border: none;
            font-size: 16px;
            font-weight: 700;
            color: #ffffff;
            cursor: pointer;
            background: linear-gradient(to right, #ec4899, #a855f7);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 8px 18px rgba(236,72,153,0.4);
        }

        #chatButton:disabled {
            background: #9ca3af;
            box-shadow: none;
            cursor: not-allowed;
        }

        /* ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(15,23,42,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 40;
            padding: 16px;
        }

        .modal.active {
            display: flex;
        }

        .modal-inner {
            background: #ffffff;
            border-radius: 16px;
            max-width: 520px;
            width: 100%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .modal-header {
            padding: 14px 18px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 15px;
            font-weight: 600;
        }

        .modal-close {
            border: none;
            background: none;
            font-size: 22px;
            cursor: pointer;
            padding: 0 4px;
            color: #6b7280;
        }

        .modal-body {
            padding: 12px 16px 16px;
            overflow-y: auto;
        }

        .review-item {
            padding: 10px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
            font-size: 12px;
            color: #6b7280;
        }

        .review-stars {
            color: #fbbf24;
            font-size: 14px;
        }

        .review-comment {
            font-size: 14px;
            line-height: 1.6;
            color: #374151;
            white-space: pre-wrap;
        }

        .no-reviews {
            text-align: center;
            padding: 24px 0;
            color: #6b7280;
            font-size: 14px;
        }

        @media (min-width: 768px) {
            .main {
                padding-top: 24px;
            }
        }
    </style>
</head>
<body>
<div class="page">
    <header class="header">
        <button class="back-button" onclick="goBack()">â†</button>
        <div class="header-title">å ã„å¸«ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</div>
    </header>

    <main class="main">
        <div id="profileContent" class="profile-container">
            <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
    </main>

    <div class="chat-button-container">
        <button id="chatButton" onclick="startChat()">ğŸ’¬ ãƒãƒ£ãƒƒãƒˆã‚’å§‹ã‚ã‚‹</button>
    </div>
</div>

<!-- ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal" id="reviewModal">
    <div class="modal-inner">
        <div class="modal-header">
            <div class="modal-title">ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸€è¦§</div>
            <button class="modal-close" onclick="closeReviewModal()">Ã—</button>
        </div>
        <div class="modal-body" id="modalReviewsList">
            <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
    </div>
</div>

<!-- Firebase åˆæœŸåŒ– -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
        getFirestore,
        doc,
        getDoc,
        collection,
        getDocs,
        query,
        where,
        orderBy,
        addDoc
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA52uJ31HzLkbz32lA-3WWSmhM10xYjjCg",
        authDomain: "cupids-chat.firebaseapp.com",
        projectId: "cupids-chat",
        storageBucket: "cupids-chat.firebasestorage.app",
        messagingSenderId: "44532110483",
        appId: "1:44532110483:web:d6266e8abba8582b8b6966"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.firebaseApp = app;
    window.firebaseDB = db;
    window.firebaseDoc = doc;
    window.firebaseGetDoc = getDoc;
    window.firebaseCollection = collection;
    window.firebaseGetDocs = getDocs;
    window.firebaseQuery = query;
    window.firebaseWhere = where;
    window.firebaseOrderBy = orderBy;
    window.firebaseAddDoc = addDoc;

    window.firebaseReady = true;
    window.dispatchEvent(new Event('firebaseReady'));
</script>

<!-- ã‚¢ãƒ—ãƒªæœ¬ä½“ -->
<script>
    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å ã„å¸«IDã‚’å–å¾—
    const urlParams = new URLSearchParams(window.location.search);
    const fortuneTellerId = urlParams.get('id');

    if (!fortuneTellerId) {
        alert('å ã„å¸«ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        window.location.href = 'cupids-top.html';
    }

    let fortuneTellerData = null;

    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«èª­ã¿è¾¼ã¿
    async function loadProfile() {
        try {
            const ftRef = window.firebaseDoc(window.firebaseDB, 'fortuneTellers', fortuneTellerId);
            const ftDoc = await window.firebaseGetDoc(ftRef);

            if (!ftDoc.exists()) {
                document.getElementById('profileContent').innerHTML =
                    '<div class="loading">å ã„å¸«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            const ftData = ftDoc.data() || {};

            // ã¾ãšã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå´ã®å€¤ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¨ã—ã¦ä½¿ã†
            let actualReviewCount =
                typeof ftData.actualReviewCount === 'number' && !isNaN(ftData.actualReviewCount)
                    ? ftData.actualReviewCount
                    : 0;

            let commentReviewCount =
                typeof ftData.commentReviewCount === 'number' && !isNaN(ftData.commentReviewCount)
                    ? ftData.commentReviewCount
                    : 0;

            // reviews ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰å–å¾— & å†è¨ˆç®—ï¼ˆèª­ã‚ã‚‹å ´åˆã ã‘ï¼‰
            try {
                const reviewsRef = window.firebaseCollection(window.firebaseDB, 'reviews');
                const reviewsQuery = window.firebaseQuery(
                    reviewsRef,
                    window.firebaseWhere('fortuneTellerId', '==', fortuneTellerId)
                );
                const reviewsSnapshot = await window.firebaseGetDocs(reviewsQuery);

                actualReviewCount = 0;
                commentReviewCount = 0;

                reviewsSnapshot.forEach(docSnap => {
                    const r = docSnap.data() || {};
                    actualReviewCount++;
                    if (r.comment && String(r.comment).trim() !== '') {
                        commentReviewCount++;
                    }
                });
            } catch (reviewError) {
                console.warn('ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸãŒãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã¯è¡¨ç¤ºã—ã¾ã™:', reviewError);
                // èª­ã¿è¾¼ã‚ãªã‹ã£ãŸå ´åˆã¯ ftData ã«å…¥ã£ã¦ã„ã‚‹å€¤ï¼ˆã¾ãŸã¯ 0ï¼‰ã®ã¾ã¾ä½¿ã†
            }

            fortuneTellerData = {
                id: ftDoc.id,
                ...ftData,
                actualReviewCount,
                commentReviewCount
            };

            displayProfile(fortuneTellerData);
        } catch (error) {
            console.error('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            document.getElementById('profileContent').innerHTML =
                '<div class="loading">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        }
    }

    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤º
    function displayProfile(ft) {
        const statusText =
            ft.status === 'available'
                ? 'ã™ãå ãˆã¾ã™'
                : ft.status === 'accepting'
                    ? 'é‘‘å®šå—ä»˜ä¸­ï¼ˆ24æ™‚é–“ä»¥å†…ã«è¿”ä¿¡ï¼‰'
                    : 'é‘‘å®šåœæ­¢ä¸­';

        const statusClass =
            ft.status === 'available'
                ? 'available'
                : ft.status === 'accepting'
                    ? 'accepting'
                    : 'stopped';

        const imageUrl = ft.photoURL || ft.profileImageUrl || ft.imageUrl;
        const avatarContent = imageUrl
            ? `<img src="${imageUrl}" class="profile-avatar" />`
            : `<div class="profile-avatar">${(ft.name || 'ï¼Ÿ').charAt(0)}</div>`;

        const tags = ft.specialty
            ? ft.specialty.split(',').map(tag => tag.trim()).filter(Boolean)
            : [];

        // å®Ÿãƒ¬ãƒ“ãƒ¥ãƒ¼ç·æ•°
        const actualReviewCount =
            typeof ft.actualReviewCount === 'number' && !isNaN(ft.actualReviewCount)
                ? ft.actualReviewCount
                : typeof ft.reviewCount === 'number' && !isNaN(ft.reviewCount)
                    ? ft.reviewCount
                    : 0;

        // åŸºæº–ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°ï¼ˆï¼‹10ã¨ã‹ï¼‰
        const baseCountRaw =
            typeof ft.baseReviewCount === 'number' && !isNaN(ft.baseReviewCount)
                ? ft.baseReviewCount
                : typeof ft.dummyReviewCount === 'number' && !isNaN(ft.dummyReviewCount)
                    ? ft.dummyReviewCount
                    : 0;
        const baseReviewCount = Math.max(0, baseCountRaw);

        // è¡¨ç¤ºç”¨ã®é‘‘å®šæ•°
        const totalReviewCount = actualReviewCount + baseReviewCount;

        // ã‚³ãƒ¡ãƒ³ãƒˆä»˜ããƒ¬ãƒ“ãƒ¥ãƒ¼ä»¶æ•°
        const commentReviewCount =
            typeof ft.commentReviewCount === 'number' && !isNaN(ft.commentReviewCount)
                ? ft.commentReviewCount
                : 0;

        // å¹³å‡è©•ä¾¡
        const averageRating =
            typeof ft.averageRating === 'number' && !isNaN(ft.averageRating)
                ? Number(ft.averageRating).toFixed(1)
                : '5.0';

        // 1æ–‡å­—å˜ä¾¡
        const pricePerChar =
            typeof ft.pricePerChar === 'number' && !isNaN(ft.pricePerChar)
                ? ft.pricePerChar
                : typeof ft.price === 'number' && !isNaN(ft.price)
                    ? ft.price
                    : 10;

        if (fortuneTellerData) {
            fortuneTellerData.pricePerChar = pricePerChar;
        }

        const html = `
            <div class="profile-header">
                ${avatarContent}
                <div class="profile-name">${ft.name || 'å ã„å¸«'}</div>
                <div class="profile-rating">
                    <span class="star">â­</span>
                    <span>${averageRating}</span>
                    <span>|</span>
                    <span>é‘‘å®šæ•° ${totalReviewCount}ä»¶</span>
                </div>
                <div class="profile-status ${statusClass}">${statusText}</div>
                <div class="profile-price">1æ–‡å­— ${pricePerChar}pt</div>
                <a href="https://minamisan.square.site/" target="_blank" class="point-purchase-link">
                    ğŸ’³ ãƒã‚¤ãƒ³ãƒˆè³¼å…¥
                </a>
            </div>

            ${tags.length > 0 ? `
            <div class="profile-section">
                <div class="section-title">å¾—æ„åˆ†é‡</div>
                <div class="profile-tags">
                    ${tags.map(tag => `<span class="profile-tag">${tag}</span>`).join('')}
                </div>
            </div>
            ` : ''}

            <div class="profile-section">
                <div class="section-title">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</div>
                <div class="profile-description">
                    ${ft.profileMessage || 'ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“'}
                </div>
            </div>

            <div class="profile-section">
                <button class="review-button" onclick="openReviewModal()">
                    ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¦‹ã‚‹ï¼ˆ${commentReviewCount}ä»¶ï¼‰
                </button>
            </div>
        `;

        document.getElementById('profileContent').innerHTML = html;

        const chatButton = document.getElementById('chatButton');
        if (ft.status === 'stopped') {
            chatButton.disabled = true;
            chatButton.textContent = 'ç¾åœ¨é‘‘å®šã‚’å—ã‘ä»˜ã‘ã¦ã„ã¾ã›ã‚“';
        } else {
            chatButton.disabled = false;
            chatButton.textContent = 'ğŸ’¬ ãƒãƒ£ãƒƒãƒˆã‚’å§‹ã‚ã‚‹';
        }
    }

    // ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    async function openReviewModal() {
        const modal = document.getElementById('reviewModal');
        const reviewsList = document.getElementById('modalReviewsList');

        modal.classList.add('active');
        reviewsList.innerHTML = '<div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>';

        try {
            const reviewsRef = window.firebaseCollection(window.firebaseDB, 'reviews');
            const reviewsQuery = window.firebaseQuery(
                reviewsRef,
                window.firebaseWhere('fortuneTellerId', '==', fortuneTellerId)
            );
            const reviewsSnapshot = await window.firebaseGetDocs(reviewsQuery);

            if (reviewsSnapshot.empty) {
                reviewsList.innerHTML = '<div class="no-reviews">ã¾ã ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            const reviews = [];
            reviewsSnapshot.forEach(doc => {
                reviews.push(doc.data());
            });

            reviews.sort((a, b) => {
                const aTime = a.createdAt ? new Date(a.createdAt).getTime() : 0;
                const bTime = b.createdAt ? new Date(b.createdAt).getTime() : 0;
                return bTime - aTime;
            });

            reviewsList.innerHTML = '';
            let commentCount = 0;

            reviews.forEach(review => {
                if (!review.comment || review.comment.trim() === '') return;

                commentCount++;

                const item = document.createElement('div');
                item.className = 'review-item';

                const stars = 'â­'.repeat(review.rating || 5);
                const date = review.createdAt
                    ? new Date(review.createdAt).toLocaleDateString('ja-JP')
                    : '';
                const comment = review.comment || '';

                item.innerHTML = `
                    <div class="review-header">
                        <div class="review-date">${date}</div>
                        <div class="review-stars">${stars}</div>
                    </div>
                    <div class="review-comment">${comment}</div>
                `;
                reviewsList.appendChild(item);
            });

            if (commentCount === 0) {
                reviewsList.innerHTML = '<div class="no-reviews">ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆä»˜ããƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“</div>';
            }

            const btn = document.querySelector('.review-button');
            if (btn) {
                btn.textContent = `ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¦‹ã‚‹ï¼ˆ${commentCount}ä»¶ï¼‰`;
            }
        } catch (error) {
            console.error('ãƒ¬ãƒ“ãƒ¥ãƒ¼èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            reviewsList.innerHTML = '<div class="no-reviews">ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        }
    }

    function closeReviewModal() {
        const modal = document.getElementById('reviewModal');
        modal.classList.remove('active');
    }

    window.addEventListener('click', function (event) {
        const modal = document.getElementById('reviewModal');
        if (event.target === modal) {
            closeReviewModal();
        }
    });

    // ãƒãƒ£ãƒƒãƒˆé–‹å§‹
    async function startChat() {
        const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');

        if (!currentUser || currentUser.type !== 'client') {
            localStorage.setItem('returnToFortuneTeller', fortuneTellerId);
            window.location.href = 'cupids-client-login.html';
            return;
        }

        if (!window.firebaseDB) {
            alert('ã‚·ã‚¹ãƒ†ãƒ ã‚’æº–å‚™ä¸­ã§ã™ã€‚å°‘ã—ãŠå¾…ã¡ãã ã•ã„ã€‚');
            return;
        }

        try {
            const conversationsRef = window.firebaseCollection(window.firebaseDB, 'conversations');
            const q = window.firebaseQuery(
                conversationsRef,
                window.firebaseWhere('clientId', '==', currentUser.uid),
                window.firebaseWhere('fortuneTellerId', '==', fortuneTellerId)
            );
            const querySnapshot = await window.firebaseGetDocs(q);

            let conversationId;
            if (!querySnapshot.empty) {
                conversationId = querySnapshot.docs[0].id;
            } else {
                const nowIso = new Date().toISOString();
                const newConvRef = await window.firebaseAddDoc(conversationsRef, {
                    clientId: currentUser.uid,
                    fortuneTellerId,
                    status: 'not-started',
                    createdAt: nowIso,
                    lastMessage: '',
                    lastMessageAt: nowIso
                });
                conversationId = newConvRef.id;
            }

            const ft = fortuneTellerData || {};
            const displayName = ft.name || ft.displayName || 'å ã„å¸«';
            const pricePerChar =
                typeof ft.pricePerChar === 'number' && !isNaN(ft.pricePerChar)
                    ? ft.pricePerChar
                    : typeof ft.price === 'number' && !isNaN(ft.price)
                        ? ft.price
                        : 10;

            localStorage.setItem('selectedConversationId', conversationId);
            localStorage.setItem('selectedFortuneTellerId', fortuneTellerId);
            localStorage.setItem('selectedFortuneTellerName', displayName);
            localStorage.setItem('selectedFortuneTellerPrice', pricePerChar);

            window.location.href =
                `cupids-chat-v2.html?fortuneTellerId=${fortuneTellerId}&conversationId=${conversationId}`;
        } catch (error) {
            console.error('ãƒãƒ£ãƒƒãƒˆé–‹å§‹ã‚¨ãƒ©ãƒ¼:', error);
            alert('ãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
        }
    }

    function goBack() {
        window.location.href = 'cupids-top.html';
    }

    // åˆæœŸèª­ã¿è¾¼ã¿
    if (window.firebaseReady) {
        loadProfile();
    } else {
        window.addEventListener('firebaseReady', () => {
            loadProfile();
        });
    }
</script>
</body>
</html>

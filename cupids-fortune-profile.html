<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å ã„å¸«ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« - ã‚­ãƒ¥ãƒ¼ãƒ”ãƒƒã‚º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', sans-serif;
            background: #F5F5F5;
            min-height: 100vh;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            background: white;
            padding: 12px 16px;
            border-bottom: 1px solid #E0E0E0;
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .back-button {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0;
        }

        /* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .profile-header {
            background: white;
            padding: 30px 20px;
            text-align: center;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 0 auto 15px;
            background: linear-gradient(135deg, #ff6ec4 0%, #7873f5 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 40px;
            font-weight: bold;
            object-fit: cover;
        }

        .profile-name {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .profile-rating {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-size: 16px;
            color: #666;
            margin-bottom: 12px;
        }

        .star {
            color: #ffc107;
        }

        .profile-status {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .profile-status.available {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
            color: white;
        }

        .profile-status.accepting {
            background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%);
            color: white;
        }

        .profile-status.stopped {
            background: #ccc;
            color: #666;
        }

        .profile-price {
            font-size: 18px;
            color: #9370DB;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .point-purchase-link {
            display: inline-block;
            padding: 8px 16px;
            background: linear-gradient(to right, #EC4899, #A855F7);
            color: white;
            text-decoration: none;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            margin-top: 8px;
            transition: all 0.2s;
        }
        
        .point-purchase-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(236, 72, 153, 0.3);
        }

        /* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .profile-section {
            background: white;
            margin: 12px 0;
            padding: 20px;
        }

        .section-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .profile-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .profile-tag {
            background: #f0f0f0;
            color: #666;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
        }

        .profile-description {
            color: #666;
            line-height: 1.8;
            font-size: 14px;
            white-space: pre-wrap;
        }

        /* ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
        .review-item {
            padding: 16px;
            border-bottom: 1px solid #f0f0f0;
        }

        .review-item:last-child {
            border-bottom: none;
        }

        .review-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .review-user {
            font-size: 14px;
            font-weight: bold;
            color: #333;
        }

        .review-stars {
            color: #ffc107;
            font-size: 14px;
        }

        .review-date {
            font-size: 12px;
            color: #999;
        }

        .review-comment {
            font-size: 14px;
            color: #666;
            line-height: 1.6;
        }

        .no-reviews {
            text-align: center;
            color: #999;
            padding: 30px;
            font-size: 14px;
        }

        /* ãƒãƒ£ãƒƒãƒˆé–‹å§‹ãƒœã‚¿ãƒ³ */
        .chat-button-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 15px 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .chat-button {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            display: block;
            background: linear-gradient(135deg, #ff6ec4 0%, #7873f5 100%);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chat-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255,110,196,0.4);
        }

        .chat-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        /* ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ */
        .review-button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #ff6ec4 0%, #7873f5 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .review-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255,110,196,0.4);
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h2 {
            font-size: 20px;
            color: #333;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 32px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: #333;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }
    </style>
</head>
<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="header">
        <button class="back-button" onclick="goBack()">â†</button>
        <div class="header-title">å ã„å¸«ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</div>
    </div>

    <div class="container">
        <div id="profileContent">
            <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
    </div>

    <!-- ãƒãƒ£ãƒƒãƒˆé–‹å§‹ãƒœã‚¿ãƒ³ -->
    <div class="chat-button-container">
        <button id="chatButton" class="chat-button" onclick="startChat()">
            ğŸ’¬ ãƒãƒ£ãƒƒãƒˆã‚’å§‹ã‚ã‚‹
        </button>
    </div>

    <!-- ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="reviewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
                <button class="modal-close" onclick="closeReviewModal()">Ã—</button>
            </div>
            <div class="modal-body" id="modalReviewsList">
                <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, addDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyA52uJ31HzLkbz32lA-3WWSmhM10xYjjCg",
            authDomain: "cupids-chat.firebaseapp.com",
            projectId: "cupids-chat",
            storageBucket: "cupids-chat.firebasestorage.app",
            messagingSenderId: "44532110483",
            appId: "1:44532110483:web:d6266e8abba8582b8b6966"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.firebaseAuth = auth;
        window.firebaseDB = db;
        window.firebaseDoc = doc;
        window.firebaseGetDoc = getDoc;
        window.firebaseCollection = collection;
        window.firebaseQuery = query;
        window.firebaseWhere = where;
        window.firebaseGetDocs = getDocs;
        window.firebaseAddDoc = addDoc;
        window.firebaseUpdateDoc = updateDoc;

        window.firebaseReady = true;
        window.dispatchEvent(new Event('firebaseReady'));
        console.log('âœ… FirebaseåˆæœŸåŒ–å®Œäº†!');
    </script>

    <script>
        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å ã„å¸«IDã‚’å–å¾—
        const urlParams = new URLSearchParams(window.location.search);
        const fortuneTellerId = urlParams.get('id');
        
        if (!fortuneTellerId) {
            alert('å ã„å¸«ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
            window.location.href = 'cupids-client-login.html';
        }

        let fortuneTellerData = null;

        // å ã„å¸«ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’èª­ã¿è¾¼ã¿
        async function loadProfile() {
            try {
                const ftRef = window.firebaseDoc(window.firebaseDB, 'fortuneTellers', fortuneTellerId);
                const ftDoc = await window.firebaseGetDoc(ftRef);

                if (!ftDoc.exists()) {
                    document.getElementById('profileContent').innerHTML = 
                        '<div class="loading">å ã„å¸«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>';
                    return;
                }

                fortuneTellerData = { id: ftDoc.id, ...ftDoc.data() };
                
                // reviewsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰å®Ÿéš›ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ä»¶æ•°ã‚’å–å¾—
                const reviewsRef = window.firebaseCollection(window.firebaseDB, 'reviews');
                const reviewsQuery = window.firebaseQuery(
                    reviewsRef,
                    window.firebaseWhere('fortuneTellerId', '==', fortuneTellerId)
                );
                const reviewsSnapshot = await window.firebaseGetDocs(reviewsQuery);
                // å®Ÿãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°ã¯ actualReviewCount ã«å…¥ã‚Œã‚‹ï¼ˆreviewCountã¯ä¸Šæ›¸ãã—ãªã„ï¼ï¼‰
                fortuneTellerData.actualReviewCount = reviewsSnapshot.size;

                // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’è¡¨ç¤º
                displayProfile(fortuneTellerData);

            } catch (error) {
                console.error('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('profileContent').innerHTML = 
                    '<div class="loading">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            }
        }

        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’è¡¨ç¤º
        function displayProfile(ft) {
            const statusText = ft.status === 'available' ? 'ã™ãå ãˆã¾ã™' : 
                              ft.status === 'accepting' ? 'é‘‘å®šå—ä»˜ä¸­ï¼ˆ24æ™‚é–“ä»¥å†…ã«è¿”ä¿¡ï¼‰' : 
                              'é‘‘å®šåœæ­¢ä¸­';
            const statusClass = ft.status === 'available' ? 'available' : 
                               ft.status === 'accepting' ? 'accepting' : 
                               'stopped';

            const imageUrl = ft.photoURL || ft.profileImageUrl || ft.imageUrl;
            const avatarContent = imageUrl
                ? `<img src="${imageUrl}" class="profile-avatar" />` 
                : `<div class="profile-avatar">${ft.name.charAt(0)}</div>`;

            const tags = ft.specialty ? ft.specialty.split(',').map(tag => tag.trim()) : [];
            
            // ãƒ¬ãƒ“ãƒ¥ãƒ¼ä»¶æ•°ï¼ˆé‘‘å®šæ•°è¡¨ç¤ºç”¨ï¼‰
            let totalReviewCount;
            
            // â‘  ç®¡ç†ç”»é¢ã§ totalReviews ã‚’ç›´æ¥å…¥ã‚Œã¦ã„ã‚‹ãªã‚‰ãã‚Œã‚’å„ªå…ˆ
            if (typeof ft.totalReviews === 'number' && !isNaN(ft.totalReviews)) {
                totalReviewCount = ft.totalReviews;
            } else {
                // â‘¡ å®Ÿãƒ¬ãƒ“ãƒ¥ãƒ¼æ•° + ãƒ™ãƒ¼ã‚¹ã®æ•°ï¼ˆãƒ€ãƒŸãƒ¼/åŠ ç®—åˆ†ï¼‰
                const actualReviewCount =
                    typeof ft.actualReviewCount === 'number' ? ft.actualReviewCount :
                    typeof ft.reviewCount === 'number' ? ft.reviewCount : 0;

                const baseCount =
                    typeof ft.baseReviewCount === 'number' ? ft.baseReviewCount :
                    typeof ft.dummyReviewCount === 'number' ? ft.dummyReviewCount : 0;

                totalReviewCount = actualReviewCount + baseCount;
            }

            const html = `
                <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ -->
                <div class="profile-header">
                    ${avatarContent}
                    <div class="profile-name">${ft.name}</div>
                    <div class="profile-rating">
                        <span class="star">â­</span>
                        <span>${ft.averageRating || 5.0}</span>
                        <span>|</span>
                        <span>é‘‘å®šæ•° ${totalReviewCount}ä»¶</span>
                    </div>
                    <div class="profile-status ${statusClass}">${statusText}</div>
                    <div class="profile-price">1æ–‡å­— ${ft.price || 10}pt</div>
                    <a href="https://minamisan.square.site/" target="_blank" class="point-purchase-link">ğŸ’³ ãƒã‚¤ãƒ³ãƒˆè³¼å…¥</a>
                </div>

                <!-- å¾—æ„åˆ†é‡ -->
                ${tags.length > 0 ? `
                <div class="profile-section">
                    <div class="section-title">å¾—æ„åˆ†é‡</div>
                    <div class="profile-tags">
                        ${tags.map(tag => `<span class="profile-tag">${tag}</span>`).join('')}
                    </div>
                </div>
                ` : ''}

                <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« -->
                <div class="profile-section">
                    <div class="section-title">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</div>
                    <div class="profile-description">${ft.profileMessage || 'ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“'}</div>
                </div>

                <!-- ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
                <div class="profile-section">
                    <div class="section-title">ãƒ¬ãƒ“ãƒ¥ãƒ¼ (${totalReviewCount}ä»¶)</div>
                    <button class="review-button" onclick="openReviewModal()">
                        ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¦‹ã‚‹
                    </button>
                </div>
            `;

            document.getElementById('profileContent').innerHTML = html;

            // ãƒãƒ£ãƒƒãƒˆãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’è¨­å®š
            const chatButton = document.getElementById('chatButton');
            if (ft.status === 'stopped') {
                chatButton.disabled = true;
                chatButton.textContent = 'ç¾åœ¨é‘‘å®šã‚’å—ã‘ä»˜ã‘ã¦ã„ã¾ã›ã‚“';
            }
        }

        // ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        async function openReviewModal() {
            const modal = document.getElementById('reviewModal');
            const reviewsList = document.getElementById('modalReviewsList');
            
            modal.classList.add('active');
            reviewsList.innerHTML = '<div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>';
            
            try {
                // reviewsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰å–å¾—
                const reviewsRef = window.firebaseCollection(window.firebaseDB, 'reviews');
                const reviewsQuery = window.firebaseQuery(
                    reviewsRef,
                    window.firebaseWhere('fortuneTellerId', '==', fortuneTellerId)
                );
                const reviewsSnapshot = await window.firebaseGetDocs(reviewsQuery);
                
                if (reviewsSnapshot.empty) {
                    reviewsList.innerHTML = '<div class="no-reviews">ã¾ã ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                    return;
                }

                const reviews = [];
                reviewsSnapshot.forEach(doc => {
                    reviews.push(doc.data());
                });

                // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
                reviews.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                reviewsList.innerHTML = '';
                reviews.forEach(review => {
                    // ã‚³ãƒ¡ãƒ³ãƒˆãŒãªã„ï¼ˆâ˜…ã ã‘ã®ï¼‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ã‚¹ã‚­ãƒƒãƒ—
                    if (!review.comment || review.comment.trim() === '') {
                        return;
                    }

                    const reviewDiv = document.createElement('div');
                    reviewDiv.className = 'review-item';

                    const stars = 'â­'.repeat(review.rating || 5);
                    const date = review.createdAt ? new Date(review.createdAt).toLocaleDateString('ja-JP') : '';
                    const comment = review.comment || '';

                    reviewDiv.innerHTML = `
                        <div class="review-header">
                            <div class="review-date">${date}</div>
                            <div class="review-stars">${stars}</div>
                        </div>
                        <div class="review-comment">${comment}</div>
                    `;

                    reviewsList.appendChild(reviewDiv);
                });
                
                // å…¨ã¦ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã‚³ãƒ¡ãƒ³ãƒˆãªã—ã®å ´åˆ
                if (reviewsList.children.length === 0) {
                    reviewsList.innerHTML = '<div class="no-reviews">ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆä»˜ããƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                }

            } catch (error) {
                console.error('ãƒ¬ãƒ“ãƒ¥ãƒ¼èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                reviewsList.innerHTML = '<div class="no-reviews">ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            }
        }

        // ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeReviewModal() {
            const modal = document.getElementById('reviewModal');
            modal.classList.remove('active');
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        window.onclick = function(event) {
            const modal = document.getElementById('reviewModal');
            if (event.target === modal) {
                closeReviewModal();
            }
        }


        // ãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹
        async function startChat() {
            // ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
            
            if (!currentUser || currentUser.type !== 'client') {
                // æœªãƒ­ã‚°ã‚¤ãƒ³ã®å ´åˆã¯ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸ï¼ˆå ã„å¸«IDã‚’ä¿æŒï¼‰
                localStorage.setItem('returnToFortuneTeller', fortuneTellerId);
                window.location.href = 'cupids-client-login.html';
                return;
            }

            // FirebaseãŒæº–å‚™ã§ãã¦ã„ã‚‹ã‹ç¢ºèª
            if (!window.firebaseDB) {
                alert('ã‚·ã‚¹ãƒ†ãƒ ã‚’æº–å‚™ä¸­ã§ã™ã€‚å°‘ã—ãŠå¾…ã¡ãã ã•ã„ã€‚');
                return;
            }

            try {
                // æ—¢å­˜ã®conversationã‚’æ¤œç´¢
                const conversationsRef = window.firebaseCollection(window.firebaseDB, 'conversations');
                const q = window.firebaseQuery(
                    conversationsRef,
                    window.firebaseWhere('clientId', '==', currentUser.uid),
                    window.firebaseWhere('fortuneTellerId', '==', fortuneTellerId)
                );
                
                const querySnapshot = await window.firebaseGetDocs(q);
                
                let conversationId;
                
                if (!querySnapshot.empty) {
                    // æ—¢å­˜ã®conversationãŒã‚ã‚‹
                    conversationId = querySnapshot.docs[0].id;
                } else {
                    // æ–°ã—ã„conversationã‚’ä½œæˆ
                    const newConvRef = await window.firebaseAddDoc(conversationsRef, {
                        clientId: currentUser.uid,
                        fortuneTellerId: fortuneTellerId,
                        status: 'not-started',
                        createdAt: new Date().toISOString(),
                        lastMessage: '',
                        lastMessageAt: new Date().toISOString()
                    });
                    conversationId = newConvRef.id;
                }
                
                // localStorageã«ä¿å­˜
                localStorage.setItem('selectedConversationId', conversationId);
                localStorage.setItem('selectedFortuneTellerId', fortuneTellerId);
                localStorage.setItem('selectedFortuneTellerName', fortuneTellerData.name || fortuneTellerData.displayName || 'å ã„å¸«');
                localStorage.setItem('selectedFortuneTellerPrice', fortuneTellerData.pricePerChar || 10);
                
                // ãƒãƒ£ãƒƒãƒˆç”»é¢ã¸
                window.location.href = `cupids-chat-v2.html?fortuneTellerId=${fortuneTellerId}&conversationId=${conversationId}`;
            } catch (error) {
                console.error('ãƒãƒ£ãƒƒãƒˆé–‹å§‹ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
            }
        }

        // æˆ»ã‚‹
        function goBack() {
            // å¸¸ã«TOPãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹
            window.location.href = 'cupids-top.html';
        }

        // FirebaseåˆæœŸåŒ–ã‚’å¾…ã£ã¦ã‹ã‚‰åˆæœŸåŒ–
        if (window.firebaseReady) {
            loadProfile();
        } else {
            window.addEventListener('firebaseReady', () => {
                loadProfile();
            });
        }
    </script>
</body>
</html>

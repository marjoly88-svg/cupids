<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„É°„Éº„É´„ÉÅ„É£„ÉÉ„Éà - „Ç≠„É•„Éº„Éî„ÉÉ„Ç∫</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', sans-serif;
            background: #F0F0F0;
            color: #333;
        }

        .page {
            max-width: 480px;
            margin: 0 auto;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: white;
        }

        /* „Éò„ÉÉ„ÉÄ„Éº */
        .header {
            background: linear-gradient(135deg, #E967A5 0%, #B565D8 100%);
            color: white;
            padding: 12px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .back-button {
            background: rgba(255,255,255,0.15);
            border: none;
            border-radius: 999px;
            padding: 6px 10px;
            color: white;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
        }

        .header-title {
            font-size: 14px;
            font-weight: 600;
        }

        .header-right {
            text-align: right;
        }

        .header-points {
            font-size: 12px;
            font-weight: 600;
        }

        .header-points span {
            font-size: 16px;
        }

        .header-points button {
            margin-top: 3px;
            padding: 3px 7px;
            font-size: 11px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.7);
            background: rgba(255,255,255,0.15);
            color: white;
            cursor: pointer;
        }

        .karte-button {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.5);
            color: white;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 3px;
        }

        /* „Çπ„ÉÜ„Éº„Çø„Çπ„Éê„Éä„Éº */
        .status-banner {
            background: #FFF7FA;
            border-bottom: 1px solid #FDE0EC;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
        }

        .status-badge {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 999px;
            background: #EC4899;
            color: white;
            font-weight: 600;
        }

        .status-text {
            color: #7C3A6A;
        }

        /* ÂÆå‰∫Ü„Éê„Éä„Éº */
        .completed-banner {
            display: none;
            background: #ECFEFF;
            border-bottom: 1px solid #BAE6FD;
            padding: 8px 12px;
            font-size: 11px;
            color: #0369A1;
        }

        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .info-banner {
            padding: 8px 12px;
            font-size: 11px;
            color: #6B7280;
            background: #F9FAFB;
            border-bottom: 1px solid #E5E7EB;
        }

        .chat-area {
            flex: 1;
            padding: 12px;
            overflow-y: auto;
            background: #F3F4F6;
        }

        .message {
            margin-bottom: 10px;
            display: flex;
        }

        .message.client {
            justify-content: flex-end;
        }

        .message-content {
            max-width: 80%;
            padding: 8px 10px;
            border-radius: 12px;
            font-size: 13px;
        }

        .message.client .message-content {
            background: #EC4899;
            color: white;
            border-bottom-right-radius: 3px;
        }

        .message.fortune-teller .message-content {
            background: white;
            border-bottom-left-radius: 3px;
        }

        .message-meta {
            font-size: 10px;
            color: #9CA3AF;
            margin-top: 2px;
        }

        /* ÂÖ•Âäõ„Ç®„É™„Ç¢ - Â§ßÂπÖ„Å´ÊîπÂñÑ */
        .input-area {
            border-top: 1px solid #E5E7EB;
            padding: 10px 12px 12px;
            background: white;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .input-area.disabled {
            opacity: 0.6;
        }

        #messageInput {
            width: 100%;
            min-height: 80px;
            max-height: 150px;
            padding: 10px 12px;
            border: 1px solid #D1D5DB;
            border-radius: 12px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            line-height: 1.5;
            transition: border-color 0.2s;
        }

        #messageInput:focus {
            outline: none;
            border-color: #EC4899;
            box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1);
        }

        #messageInput::placeholder {
            color: #9CA3AF;
        }

        #messageInput:disabled {
            background: #F3F4F6;
            cursor: not-allowed;
        }

        .send-button {
            width: 100%;
            padding: 12px 16px;
            border-radius: 999px;
            border: none;
            background: linear-gradient(135deg, #EC4899 0%, #D946EF 100%);
            color: white;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
        }

        .send-button:active:not(:disabled) {
            transform: scale(0.98);
        }

        .send-button:disabled {
            background: #E5E7EB;
            color: #9CA3AF;
            cursor: not-allowed;
            opacity: 0.7;
        }

    </style>
</head>

<body>
<div class="page">

    <!-- „Éò„ÉÉ„ÉÄ„Éº -->
    <header class="header">
        <div class="header-left">
            <button class="back-button" onclick="goBackToTop()">
                ‚Üê Êàª„Çã
            </button>
            <div class="header-title" id="fortuneName">Âç†„ÅÑÂ∏´</div>
        </div>

        <div class="header-right">
            <div class="header-points">
                ÊâÄÊåÅ„Éù„Ç§„É≥„Éà<br>
                <span id="userPoints">0</span> pt
            </div>
            <button onclick="window.location.href='purchase.html'">„Éù„Ç§„É≥„ÉàË≥ºÂÖ•</button>
            <button class="karte-button" onclick="goToKarte()">üìã „Ç´„É´„ÉÜ</button>
        </div>
    </header>

    <!-- „Çπ„ÉÜ„Éº„Çø„Çπ -->
    

    <div class="completed-banner" id="completedBanner">
        „Åì„ÅÆÈëëÂÆö„ÅØÁµÇ‰∫Ü„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ
    </div>

    <main class="main">

        <div class="info-banner" id="infoBanner">
            100ÊñáÂ≠ó‰ª•ÂÜÖ„Åß„ÅîÁõ∏Ë´áÂÜÖÂÆπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
        </div>

        <div class="chat-area" id="chatArea">
            <div class="empty-state">
                <div>„É°„ÉÉ„Çª„Éº„Ç∏Â±•Ê≠¥„ÇíË™≠„ÅøËæº„Çì„Åß„ÅÑ„Åæ„Åô...</div>
            </div>
        </div>

        <!-- ÂÖ•Âäõ„Ç®„É™„Ç¢ -->
        <div class="input-area" id="inputArea">
            <textarea id="messageInput" maxlength="100" placeholder="100ÊñáÂ≠ó‰ª•ÂÜÖ„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ"></textarea>
            <button class="send-button" id="sendButton" disabled>
                <span id="sendButtonText">ÈÄÅ‰ø°</span>
            </button>
        </div>

    </main>
</div>

<!-- Firebase SDK -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { 
        getFirestore, doc, getDoc, collection, query, where, getDocs, addDoc, updateDoc,
        onSnapshot, orderBy, serverTimestamp, increment
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA52uJ31HzLkbz32lA-3WWSmhM10xYjjCg",
        authDomain: "cupids-chat.firebaseapp.com",
        projectId: "cupids-chat",
        storageBucket: "cupids-chat.firebasestorage.app",
        messagingSenderId: "44532110483",
        appId: "1:44532110483:web:d6266e8abba8582b8b6966"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    window.db = db;
    window.auth = auth;

    window.firebaseDoc = doc;
    window.firebaseGetDoc = getDoc;
    window.firebaseAddDoc = addDoc;
    window.firebaseUpdateDoc = updateDoc;
    window.firebaseCollection = collection;
    window.firebaseQuery = query;
    window.firebaseWhere = where;
    window.firebaseOrderBy = orderBy;
    window.firebaseOnSnapshot = onSnapshot;
    window.firebaseServerTimestamp = serverTimestamp;
    window.firebaseIncrement = increment;

    window.dispatchEvent(new Event("firebaseReady"));
</script>

<script>
/* ============================
      „Åó„Çá„Éº„Å°„ÇÉ„ÇìÂ∞ÇÁî®„É≠„Ç∏„ÉÉ„ÇØ
   ============================ */

let currentUser = JSON.parse(localStorage.getItem("currentUser") || "null");

if (!currentUser || currentUser.type !== "client") {
    alert("„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
    window.location.href = "client-login.html";
}

const urlParams = new URLSearchParams(window.location.search);
const conversationId =
    urlParams.get("conversationId") ||
    localStorage.getItem("selectedConversationId");

let conversationData = null;
let fortuneTellerData = null;
let currentPrice = 800;  // ‚Üê ÂàùÂõûÂà∂Â∫¶Ê∂à„Åó„Åü„ÅÆ„ÅßÂõ∫ÂÆö

/* ----------- Êàª„Çã„ÅØTOP„Å∏ ----------- */
function goBackToTop() {
    window.location.href = "index.html";
}

/* -------- „Ç´„É´„ÉÜ„Å∏ -------- */
function goToKarte() {
    if (conversationId) {
        localStorage.setItem("selectedConversationId", conversationId);
    }
    window.location.href = `karte.html?clientId=${currentUser.uid}`;
}

/* -------- „É¶„Éº„Ç∂„Éº„Éù„Ç§„É≥„ÉàÁõ£Ë¶ñ -------- */
async function loadUserPoints() {
    const userRef = window.firebaseDoc(window.db, "users", currentUser.uid);
    window.firebaseOnSnapshot(userRef, (snap) => {
        if (snap.exists()) {
            currentUser.points = snap.data().points || 0;
            document.getElementById("userPoints").textContent = currentUser.points;
        }
    });
}

/* ---------- ‰ºöË©±„ÉªÂç†„ÅÑÂ∏´Ë™≠„ÅøËæº„Åø ---------- */
async function init() {
    try {
        const convRef = window.firebaseDoc(window.db, "conversations", conversationId);
        const convSnap = await window.firebaseGetDoc(convRef);

        if (!convSnap.exists()) throw new Error("‰ºöË©±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì");

        conversationData = convSnap.data();

        window.firebaseOnSnapshot(convRef, (snap) => {
            if (snap.exists()) {
                conversationData = snap.data();
                updateUIByStatus();
            }
        });

        const ftRef = window.firebaseDoc(window.db, "fortuneTellers", conversationData.fortuneTellerId);
        const ftSnap = await window.firebaseGetDoc(ftRef);

        if (ftSnap.exists()) {
            fortuneTellerData = ftSnap.data();
            document.getElementById("fortuneName").textContent = fortuneTellerData.name;
            currentPrice = fortuneTellerData.regularPrice || 800;
            updateSendButton();
        }

        updateUIByStatus();
        loadMessages();
        loadUserPoints();
    } catch (e) {
        alert("„Ç®„É©„Éº:" + e.message);
        window.location.href = "index.html";
    }
}

/* ----------- UIÊõ¥Êñ∞ ----------- */
function updateSendButton() {
    document.getElementById("sendButtonText").textContent = `${currentPrice}pt„ÅßÈÄÅ‰ø°`;
}

function updateUIByStatus() {
    if (!conversationData) return;

    const clientHasSent = !!conversationData.clientHasSent;
    const tellerSent = !!conversationData.fortuneTellerHasSent;

    const canSend = (!clientHasSent && !tellerSent) || (clientHasSent && tellerSent);

    const inputArea = document.getElementById("inputArea");
    const messageInput = document.getElementById("messageInput");
    const sendButton = document.getElementById("sendButton");
    const infoBanner = document.getElementById("infoBanner");

    if (conversationData.status === "closed") {
        inputArea.classList.add("disabled");
        messageInput.disabled = true;
        sendButton.disabled = true;
        document.getElementById("completedBanner").style.display = "block";
        return;
    }

    if (canSend) {
        infoBanner.innerHTML = `100ÊñáÂ≠ó‰ª•ÂÜÖ„ÅßË≥™Âïè„Åß„Åç„Åæ„ÅôÔºà1ÂæÄÂæ© ${currentPrice}ptÔºâ`;
        inputArea.classList.remove("disabled");
        messageInput.disabled = false;
        sendButton.disabled = messageInput.value.trim().length === 0;
    } else {
        infoBanner.innerHTML = `Âç†„ÅÑÂ∏´„Åã„Çâ„ÅÆËøî‰ø°„Çí„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ`;
        inputArea.classList.add("disabled");
        messageInput.disabled = true;
        sendButton.disabled = true;
    }
}

/* ----------- „É°„ÉÉ„Çª„Éº„Ç∏Ë™≠„ÅøËæº„Åø ----------- */
function loadMessages() {
    const messagesRef = window.firebaseCollection(window.db, "messages");
    const q = window.firebaseQuery(
        messagesRef,
        window.firebaseWhere("conversationId", "==", conversationId),
        window.firebaseOrderBy("createdAt", "asc")
    );

    window.firebaseOnSnapshot(q, (snap) => {
        const chatArea = document.getElementById("chatArea");

        if (snap.empty) {
            chatArea.innerHTML = `<div>„Åæ„Å†„É°„ÉÉ„Çª„Éº„Ç∏„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>`;
            return;
        }

        chatArea.innerHTML = "";

        snap.forEach((doc) => {
            const msg = doc.data();
            const isClient = msg.senderId === currentUser.uid;

            const div = document.createElement("div");
            div.className = "message " + (isClient ? "client" : "fortune-teller");

            div.innerHTML = `
                <div>
                    <div class="message-content">${msg.text}</div>
                    <div class="message-meta">
                        ${(msg.createdAt?.toDate?.() || "").toLocaleTimeString("ja-JP", {
                            hour: "2-digit",
                            minute: "2-digit"
                        })}
                    </div>
                </div>
            `;

            chatArea.appendChild(div);
        });

        chatArea.scrollTop = chatArea.scrollHeight;
    });
}

/* ----------- ÈÄÅ‰ø° ----------- */
document.getElementById("messageInput").addEventListener("input", () => {
    const sendButton = document.getElementById("sendButton");
    sendButton.disabled = document.getElementById("messageInput").value.trim().length === 0;
    updateUIByStatus();
});

document.getElementById("sendButton").addEventListener("click", async () => {
    const text = document.getElementById("messageInput").value.trim();
    if (!text) return;

    if (currentUser.points < currentPrice) {
        alert("„Éù„Ç§„É≥„Éà„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô");
        window.location.href = "purchase.html";
        return;
    }

    const msgRef = window.firebaseCollection(window.db, "messages");
    await window.firebaseAddDoc(msgRef, {
        conversationId,
        senderId: currentUser.uid,
        senderType: "client",
        text,
        createdAt: window.firebaseServerTimestamp()
    });

    // ‰ºöË©±Êõ¥Êñ∞
    const convRef = window.firebaseDoc(window.db, "conversations", conversationId);
    await window.firebaseUpdateDoc(convRef, {
        clientHasSent: true,
        fortuneTellerHasSent: false,
        status: 'active',
        lastMessage: text,
        updatedAt: window.firebaseServerTimestamp()
    });

    // „Éù„Ç§„É≥„ÉàÊ∂àË≤ª
    const userRef = window.firebaseDoc(window.db, "users", currentUser.uid);
    await window.firebaseUpdateDoc(userRef, {
        points: window.firebaseIncrement(-currentPrice)
    });

    document.getElementById("messageInput").value = "";
});

window.addEventListener("firebaseReady", init);
</script>

</body>
</html>

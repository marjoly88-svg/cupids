<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¡ãƒ¼ãƒ«ãƒãƒ£ãƒƒãƒˆ - ã‚­ãƒ¥ãƒ¼ãƒ”ãƒƒã‚º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', sans-serif;
            background: #F0F0F0;
            color: #333;
        }

        .page {
            max-width: 480px;
            margin: 0 auto;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: white;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            background: linear-gradient(135deg, #E967A5 0%, #B565D8 100%);
            color: white;
            padding: 12px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .back-button {
            background: rgba(255,255,255,0.15);
            border: none;
            border-radius: 999px;
            padding: 6px 10px;
            color: white;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
        }

        .header-title {
            font-size: 14px;
            font-weight: 600;
        }

        .header-right {
            text-align: right;
        }

        .header-points {
            font-size: 12px;
            font-weight: 600;
        }

        .header-points span {
            font-size: 16px;
        }

        .header-points button {
            margin-top: 3px;
            padding: 3px 7px;
            font-size: 11px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.7);
            background: rgba(255,255,255,0.15);
            color: white;
            cursor: pointer;
        }

        .karte-button {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.5);
            color: white;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 3px;
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒŠãƒ¼ */
        .status-banner {
            background: #FFF7FA;
            border-bottom: 1px solid #FDE0EC;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
        }

        .status-badge {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 999px;
            background: #EC4899;
            color: white;
            font-weight: 600;
        }

        .status-text {
            color: #7C3A6A;
        }

        /* å®Œäº†ãƒãƒŠãƒ¼ */
        .completed-banner {
            display: none;
            background: #ECFEFF;
            border-bottom: 1px solid #BAE6FD;
            padding: 8px 12px;
            font-size: 11px;
            color: #0369A1;
        }

        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .info-banner {
            padding: 8px 12px;
            font-size: 11px;
            color: #6B7280;
            background: #F9FAFB;
            border-bottom: 1px solid #E5E7EB;
        }

        .chat-area {
            flex: 1;
            padding: 12px;
            overflow-y: auto;
            background: #F3F4F6;
        }

        .message {
            margin-bottom: 10px;
            display: flex;
        }

        .message.client {
            justify-content: flex-end;
        }

        .message-content {
            max-width: 80%;
            padding: 8px 10px;
            border-radius: 12px;
            font-size: 13px;
        }

        .message.client .message-content {
            background: #EC4899;
            color: white;
            border-bottom-right-radius: 3px;
        }

        .message.fortune-teller .message-content {
            background: white;
            border-bottom-left-radius: 3px;
        }

        .message-meta {
            font-size: 10px;
            color: #9CA3AF;
            margin-top: 2px;
        }

        /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
        .input-area {
            border-top: 1px solid #E5E7EB;
            padding: 8px 10px 10px;
            background: white;
        }

        .send-button {
            flex: 1;
            padding: 8px 10px;
            border-radius: 999px;
            border: none;
            background: linear-gradient(135deg, #EC4899 0%, #D946EF 100%);
            color: white;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
        }

        .send-button:disabled {
            background: #E5E7EB;
            color: #9CA3AF;
            cursor: not-allowed;
        }

    </style>
</head>

<body>
<div class="page">

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="header">
        <div class="header-left">
            <button class="back-button" onclick="goBackToTop()">
                â† æˆ»ã‚‹
            </button>
            <div class="header-title" id="fortuneName">å ã„å¸«</div>
        </div>

        <div class="header-right">
            <div class="header-points">
                æ‰€æŒãƒã‚¤ãƒ³ãƒˆ<br>
                <span id="userPoints">0</span> pt
            </div>
            <button onclick="window.location.href='purchase.html'">ãƒã‚¤ãƒ³ãƒˆè³¼å…¥</button>
            <button class="karte-button" onclick="goToKarte()">ğŸ“‹ ã‚«ãƒ«ãƒ†</button>
        </div>
    </header>

    <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
    <div class="status-banner">
        <div class="status-badge" id="statusBadge">èª­ã¿è¾¼ã¿ä¸­</div>
        <div class="status-text" id="statusText">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™...</div>
    </div>

    <div class="completed-banner" id="completedBanner">
        ã“ã®é‘‘å®šã¯çµ‚äº†ã—ã¦ã„ã¾ã™ã€‚
    </div>

    <main class="main">

        <div class="info-banner" id="infoBanner">
            100æ–‡å­—ä»¥å†…ã§ã”ç›¸è«‡å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
        </div>

        <div class="chat-area" id="chatArea">
            <div class="empty-state">
                <div>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
            </div>
        </div>

        <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
        <div class="input-area" id="inputArea">
            <textarea id="messageInput" maxlength="100" placeholder="100æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
            <button class="send-button" id="sendButton" disabled>
                <span id="sendButtonText">é€ä¿¡</span>
            </button>
        </div>

    </main>
</div>

<!-- Firebase SDK -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { 
        getFirestore, doc, getDoc, collection, query, where, getDocs, addDoc, updateDoc,
        onSnapshot, orderBy, serverTimestamp, increment
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA52uJ31HzLkbz32lA-3WWSmhM10xYjjCg",
        authDomain: "cupids-chat.firebaseapp.com",
        projectId: "cupids-chat",
        storageBucket: "cupids-chat.firebasestorage.app",
        messagingSenderId: "44532110483",
        appId: "1:44532110483:web:d6266e8abba8582b8b6966"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    window.db = db;
    window.auth = auth;

    window.firebaseDoc = doc;
    window.firebaseGetDoc = getDoc;
    window.firebaseAddDoc = addDoc;
    window.firebaseUpdateDoc = updateDoc;
    window.firebaseCollection = collection;
    window.firebaseQuery = query;
    window.firebaseWhere = where;
    window.firebaseOrderBy = orderBy;
    window.firebaseOnSnapshot = onSnapshot;
    window.firebaseServerTimestamp = serverTimestamp;
    window.firebaseIncrement = increment;

    window.dispatchEvent(new Event("firebaseReady"));
</script>

<script>
/* ============================
      ã—ã‚‡ãƒ¼ã¡ã‚ƒã‚“å°‚ç”¨ãƒ­ã‚¸ãƒƒã‚¯
   ============================ */

let currentUser = JSON.parse(localStorage.getItem("currentUser") || "null");

if (!currentUser || currentUser.type !== "client") {
    alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„");
    window.location.href = "client-login.html";
}

const urlParams = new URLSearchParams(window.location.search);
const conversationId =
    urlParams.get("conversationId") ||
    localStorage.getItem("selectedConversationId");

let conversationData = null;
let fortuneTellerData = null;
let currentPrice = 800;  // â† åˆå›åˆ¶åº¦æ¶ˆã—ãŸã®ã§å›ºå®š

/* ----------- æˆ»ã‚‹ã¯TOPã¸ ----------- */
function goBackToTop() {
    window.location.href = "index.html";
}

/* -------- ã‚«ãƒ«ãƒ†ã¸ -------- */
function goToKarte() {
    if (conversationId) {
        localStorage.setItem("selectedConversationId", conversationId);
    }
    window.location.href = `karte.html?clientId=${currentUser.uid}`;
}

/* -------- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒã‚¤ãƒ³ãƒˆç›£è¦– -------- */
async function loadUserPoints() {
    const userRef = window.firebaseDoc(window.db, "users", currentUser.uid);
    window.firebaseOnSnapshot(userRef, (snap) => {
        if (snap.exists()) {
            currentUser.points = snap.data().points || 0;
            document.getElementById("userPoints").textContent = currentUser.points;
        }
    });
}

/* ---------- ä¼šè©±ãƒ»å ã„å¸«èª­ã¿è¾¼ã¿ ---------- */
async function init() {
    try {
        const convRef = window.firebaseDoc(window.db, "conversations", conversationId);
        const convSnap = await window.firebaseGetDoc(convRef);

        if (!convSnap.exists()) throw new Error("ä¼šè©±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");

        conversationData = convSnap.data();

        window.firebaseOnSnapshot(convRef, (snap) => {
            if (snap.exists()) {
                conversationData = snap.data();
                updateUIByStatus();
            }
        });

        const ftRef = window.firebaseDoc(window.db, "fortuneTellers", conversationData.fortuneTellerId);
        const ftSnap = await window.firebaseGetDoc(ftRef);

        if (ftSnap.exists()) {
            fortuneTellerData = ftSnap.data();
            document.getElementById("fortuneName").textContent = fortuneTellerData.name;
            currentPrice = fortuneTellerData.regularPrice || 800;
            updateSendButton();
        }

        updateUIByStatus();
        loadMessages();
        loadUserPoints();
    } catch (e) {
        alert("ã‚¨ãƒ©ãƒ¼ï¼š" + e.message);
        window.location.href = "index.html";
    }
}

/* ----------- UIæ›´æ–° ----------- */
function updateSendButton() {
    document.getElementById("sendButtonText").textContent = `${currentPrice}ptã§é€ä¿¡`;
}

function updateUIByStatus() {
    if (!conversationData) return;

    const clientHasSent = !!conversationData.clientHasSent;
    const tellerSent = !!conversationData.fortuneTellerHasSent;

    const canSend = (!clientHasSent && !tellerSent) || (clientHasSent && tellerSent);

    const inputArea = document.getElementById("inputArea");
    const messageInput = document.getElementById("messageInput");
    const sendButton = document.getElementById("sendButton");
    const infoBanner = document.getElementById("infoBanner");

    if (conversationData.status === "closed") {
        inputArea.classList.add("disabled");
        messageInput.disabled = true;
        sendButton.disabled = true;
        document.getElementById("completedBanner").style.display = "block";
        return;
    }

    if (canSend) {
        infoBanner.innerHTML = `100æ–‡å­—ä»¥å†…ã§è³ªå•ã§ãã¾ã™ï¼ˆ1å¾€å¾© ${currentPrice}ptï¼‰`;
        inputArea.classList.remove("disabled");
        messageInput.disabled = false;
        sendButton.disabled = messageInput.value.trim().length === 0;
    } else {
        infoBanner.innerHTML = `å ã„å¸«ã‹ã‚‰ã®è¿”ä¿¡ã‚’ãŠå¾…ã¡ãã ã•ã„`;
        inputArea.classList.add("disabled");
        messageInput.disabled = true;
        sendButton.disabled = true;
    }
}

/* ----------- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸èª­ã¿è¾¼ã¿ ----------- */
function loadMessages() {
    const messagesRef = window.firebaseCollection(window.db, "messages");
    const q = window.firebaseQuery(
        messagesRef,
        window.firebaseWhere("conversationId", "==", conversationId),
        window.firebaseOrderBy("createdAt", "asc")
    );

    window.firebaseOnSnapshot(q, (snap) => {
        const chatArea = document.getElementById("chatArea");

        if (snap.empty) {
            chatArea.innerHTML = `<div>ã¾ã ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“</div>`;
            return;
        }

        chatArea.innerHTML = "";

        snap.forEach((doc) => {
            const msg = doc.data();
            const isClient = msg.senderId === currentUser.uid;

            const div = document.createElement("div");
            div.className = "message " + (isClient ? "client" : "fortune-teller");

            div.innerHTML = `
                <div>
                    <div class="message-content">${msg.text}</div>
                    <div class="message-meta">
                        ${(msg.createdAt?.toDate?.() || "").toLocaleTimeString("ja-JP", {
                            hour: "2-digit",
                            minute: "2-digit"
                        })}
                    </div>
                </div>
            `;

            chatArea.appendChild(div);
        });

        chatArea.scrollTop = chatArea.scrollHeight;
    });
}

/* ----------- é€ä¿¡ ----------- */
document.getElementById("messageInput").addEventListener("input", () => {
    const sendButton = document.getElementById("sendButton");
    sendButton.disabled = document.getElementById("messageInput").value.trim().length === 0;
    updateUIByStatus();
});

document.getElementById("sendButton").addEventListener("click", async () => {
    const text = document.getElementById("messageInput").value.trim();
    if (!text) return;

    if (currentUser.points < currentPrice) {
        alert("ãƒã‚¤ãƒ³ãƒˆãŒä¸è¶³ã—ã¦ã„ã¾ã™");
        window.location.href = "purchase.html";
        return;
    }

    const msgRef = window.firebaseCollection(window.db, "messages");
    await window.firebaseAddDoc(msgRef, {
        conversationId,
        senderId: currentUser.uid,
        senderType: "client",
        text,
        createdAt: window.firebaseServerTimestamp()
    });

    // ä¼šè©±æ›´æ–°
    const convRef = window.firebaseDoc(window.db, "conversations", conversationId);
    await window.firebaseUpdateDoc(convRef, {
        clientHasSent: true,
        fortuneTellerHasSent: false,
        lastMessage: text,
        updatedAt: window.firebaseServerTimestamp()
    });

    // ãƒã‚¤ãƒ³ãƒˆæ¶ˆè²»
    const userRef = window.firebaseDoc(window.db, "users", currentUser.uid);
    await window.firebaseUpdateDoc(userRef, {
        points: window.firebaseIncrement(-currentPrice)
    });

    document.getElementById("messageInput").value = "";
});

window.addEventListener("firebaseReady", init);
</script>

</body>
</html>
